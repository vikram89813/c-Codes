<!doctype html>
<html amp lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
	
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="GotW #90 Solution: Factories" />
<meta property="og:url" content="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/" />
<meta property="og:description" content="NOTE: Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is…" />
<meta property="article:published_time" content="2013-05-30T23:04:45+00:00" />
<meta property="article:modified_time" content="2013-06-04T17:31:37+00:00" />
<meta property="og:site_name" content="Sutter’s Mill" />
<meta property="og:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=200&amp;ts=1542965379" />
<meta property="og:image:width" content="200" />
<meta property="og:image:height" content="200" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta name="twitter:text:title" content="GotW #90 Solution: Factories" />
<meta name="twitter:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=240" />
<meta name="twitter:card" content="summary" />
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom" />

<!-- End Jetpack Open Graph Tags -->
	<title>GotW #90 Solution: Factories &#8211; Sutter’s Mill</title>
		<link rel="canonical" href="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/" />
	<script src="https://cdn.ampproject.org/v0.js" async></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic">	<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
		<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"BlogPosting","mainEntityOfPage":"https:\/\/herbsutter.com\/2013\/05\/30\/gotw-90-solution-factories\/","publisher":{"@type":"Organization","name":"Sutter\u2019s Mill","logo":{"@type":"ImageObject","url":"https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=60&d=https%3A%2F%2Fs0.wp.com%2Fi%2Ffavicons%2Fapple-touch-icon-60x60.png","width":60,"height":60}},"headline":"GotW #90 Solution: Factories","datePublished":"2013-05-30T15:04:45+00:00","dateModified":"2013-06-04T09:31:37+00:00","author":{"@type":"Person","name":"Herb Sutter"},"image":{"@type":"ImageObject","url":"https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=200","width":200,"height":200}}</script>
	<meta name="generator" content="AMP Plugin v0.6.2" />	<style amp-custom>
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}

.amp-wp-unknown-size img {
	/** Worst case scenario when we can't figure out dimensions for an image. **/
	/** Force the image into a box of fixed dimensions and use object-fit to scale. **/
	object-fit: contain;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 500px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: 'Merriweather', 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}

/* Site Icon */

.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://s2.wp.com/wp-content/plugins/amp/assets/images/placeholder-icon.png ) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		/* Inline styles */
.amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe{background:#ffffcc;margin-left:14pt;}.amp-wp-inline-e118b89cb574341583297a20935ac54c{color:#2e74b5;}.amp-wp-inline-67e1925c715f5c48af6b92757f5a6f7b{color:#5a5a5a;}	</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://herbsutter.com">
									<span class="amp-site-title">
				Sutter’s Mill			</span>
		</a>
	</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">GotW #90 Solution: Factories</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=24&#038;d=identicon&#038;r=g" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">Herb Sutter</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2013-05-30T15:04:45+00:00">
		5 years ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn’t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #104.
</p>
</blockquote><p>
 </p><p><span class="amp-wp-inline-67e1925c715f5c48af6b92757f5a6f7b"><em>What should factory functions return, and why?<br/></em></span></p><p>
 </p><h1>Problem<br/></h1><p>While spelunking through the code of a new project you recently joined, you find the following factory function declaration:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>widget* load_widget( widget::id desired );
</code></pre><h2>JG Question<br/></h2><p>1. What’s wrong with this return type?
</p><h2>Guru Questions<br/></h2><p>2. Assuming that <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span> is a polymorphic type, what is the recommended return type? Explain your answer, including any tradeoffs.
</p><p>3. You’d like to actually change the return type to match the recommendation in #2, but at first you worry about breaking source compatibility with existing calling code; recompiling existing callers is fine, but having to go change them all is not. Then you have an “aha!” moment, realizing that this is a fairly new project and all of your calling code is written using modern C++ idioms, and you go ahead and change the return type without fear, knowing it will require few or no code changes to callers. What makes you so confident?
</p><p>4. If <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span> is not a polymorphic type, what is the recommended return type? Explain.
</p><p>
 </p><h1>Solution<br/></h1><h2>1. What’s wrong with this return type?<br/></h2><p>First, what can we know or reasonably expect from the two-line problem description?
</p><p>We’re told <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">load_widget</span> is a factory function. It produces an object by “loading” it in some way and then returning it to the caller. Since the return type is a pointer, the result might be null.
</p><p>The caller will reasonably expect to use the object, whether by calling member functions on it or passing it to other functions or in some other way. That isn’t safe unless the caller owns the object to ensure it is alive—either the caller gets exclusive ownership, or it gets shared ownership if the factory also maintains an internal strong or weak reference.
</p><p>Because the caller has or shares ownership, he has to do something when the object is no longer needed. If the ownership is exclusive, he should destroy the object somehow. Otherwise, if the ownership is shared, he should decrement some shared reference count.
</p><p>Unfortunately, returning a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget*</span> has two major problems. First, it’s unsafe by default, because the default mode of operation (i.e., when the caller writes whitespace) is to leak a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span>:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>// Example 1: Leak by default. Really, this is just so 20th-century...<br/>// <br/>widget* load_widget( widget::id desired );<br/><br/>:::<br/><br/>load_widget( some_id ); // oops
</code></pre><p>The Example 1 code compiles cleanly, runs, and (un)happily leaks the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span>.
</p><blockquote>
<p><strong>Guideline:</strong> Don’t use explicit <strong>new</strong>, <strong>delete</strong>, and owning <strong>*</strong> pointers, except in rare cases encapsulated inside the implementation of a low-level data structure.
</p>
</blockquote><p>Second, the signature conveys absolutely no information other than “a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span>? sure, here you go! enjoy.” The documentation may state that (and how) the caller is to own the object, but the function declaration doesn’t—it’s either exclusive ownership or shared ownership, but which? Read and remember the function’s documentation, because the function declaration isn’t telling. The signature alone doesn’t even say whether the caller shares in ownership at all.
</p><h2>2. Assuming that widget is a polymorphic type, what is the recommended return type? Explain your answer, including any tradeoffs.<br/></h2><p>If <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span> is a type that’s intended to be used polymorphically and held by pointer or reference, the factory should normally return a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> to transfer ownership to the caller, or a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> if the factory shares ownership by retaining a strong reference inside its internal data structures.
</p><blockquote>
<p><strong>Guideline:</strong> A factory that produces a reference type should return a <strong>unique_ptr</strong> by default, or a <strong>shared_ptr</strong> if ownership is to be shared with the factory.
</p>
</blockquote><p>This solves both problems: safety, and self-documentation.
</p><p>First, consider how this immediately solves the safety problem in Example 1:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>// Example 2: Clean up by default. Much better...<br/>// <br/>unique_ptr&lt;widget&gt; load_widget( widget::id desired );<br/><br/>:::<br/><br/>load_widget( some_id ); // cleans up
</code></pre><p>The Example 2 code compiles cleanly, runs, and happily cleans up the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span>. But it’s not just correct by default—it’s correct by construction, because there’s no way to make a mistake that results in a leak.
</p><p>Aside: Someone might say, “but can’t someone still write <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">load_widget(some_id).release()</span>?” Of course they can, if they’re pathological; the correct answer is, “don’t do that.” Remember, our concern is to protect against Murphy, not Machiavelli—against bugs and mistakes, not deliberate crimes—and such pathological abuses fall into the latter category. That’s no different from, and doesn’t violate type safety any more than, explicitly calling <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">Dispose</span> early in a C# <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">using</span> block or explicitly calling <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">close</span> early in a Java <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">try</span>-with-resources block.
</p><p>What if the cleanup should be done by something other than a plain <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">delete</span> call? Easy: Just use a custom deleter. The icing on the cake is that the factory itself knows which deleter is appropriate and can state it at the time it constructs the return value; the caller doesn’t need to worry about it, especially if he takes the result using an <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">auto</span> variable.
</p><p>Second, this is self-documenting: A function that returns a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> or a value clearly documents that it’s a pure “source” function, and one that returns a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> clearly documents that it’s returning shared ownership and/or observation.
</p><p>Finally, why prefer <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> by default, if you don’t need to express shared ownership? Because it’s the Right Thing To Do for both performance and correctness, as noted in GotW #89, and leaves all options open to the caller:
</p><ul><li>Returning <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> expresses returning unique ownership, which is the norm for a pure “source” factory function.
</li>
<li><span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> can’t be beat in efficiency—moving one is about as cheap as moving/copying a raw pointer.
</li>
<li>If the caller wants to manage the produced object’s lifetime via <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span>, they can easily convert to <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> via an implicit move operation—no need to say <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">std::move</span> because the compiler already knows that the returned value is a temporary object.
</li>
<li>If the caller is using any other arbitrary method of maintaining the object’s lifetime, he can convert to a custom smart pointer or other lifetime management scheme simply by calling <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">.release()</span>. This can be useful, and isn’t  possible with <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span>.
</li>
</ul><p>Here it is in action:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>// Example 2, continued<br/>//<br/><br/>// Accept as a unique_ptr (by default)<br/>auto up = load_widget(1);<br/><br/>// Accept as a shared_ptr (if desired)<br/>auto sp = shared_ptr&lt;widget&gt;{ load_widget(2) };<br/><br/>// Accept as your own smart pointer (if desired)<br/>auto msp = my::smart_ptr&lt;widget&gt;{ load_widget(3).release() };
</code></pre><p>Of course, if the factory retains some shared ownership or observation, whether via an internal <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> or <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">weak_ptr</span>, return <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span>. The caller will be forced to continue using it as a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span>, but in that case that’s appropriate.
</p><h2>3. […] you go ahead and change the return type without fear, knowing it will require few or no code changes to callers. What makes you so confident?<br/></h2><p>Modern portable C++ code uses <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span>, <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span>, and <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">auto</span>. Returning <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> works with all three; returning <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> works with the last two.
</p><p>If the caller accepts the return value in an <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">auto</span> variables, such as <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">auto w = load_widget(whatever);</span>, then the type will just naturally be correct, normal dereferencing will just work, and the only source ripple will be if the caller tries to explicitly <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">delete</span> (if so, the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">delete</span> line can rather appropriately be deleted) or tries to store into a non-local object of a different type.
</p><blockquote>
<p><strong>Guideline:</strong> Prefer declaring variables using <strong>auto</strong>. It’s shorter, and helps to insulate your code from needless source ripples due to minor type changes.
</p>
</blockquote><p>Otherwise, if the caller isn’t using <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">auto</span>, then it’s likely already using the result to initialize a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> or <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> because modern C++ calling code does not traffick in raw pointers for non-parameter variables (more on this next time). In either case, returning a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> just works: A <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">unique_ptr</span> can be seamlessly moved into either of those types, and if the semantics are to return shared ownership and then the caller should already be using a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> and things will again work just fine (only probably better than before, because for the original return by raw pointer to work correctly the return type was probably forced to jump through the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">enable_shared_from_this</span> hoop, which isn’t needed if we just return a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">shared_ptr</span> explicitly).
</p><h2>4. If widget is not a polymorphic type, what is the recommended return type? Explain.<br/></h2><p>If <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span> is not a polymorphic type, which typically means it’s a copyable value type or a move-only type, the factory should return a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span> by value. But what kind of value?
</p><p>In C++98, programmers would often resort to returning a large object by pointer just to avoid the penalty of copying its state:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>// Example 4(a): Obsolete convention: return a * just to avoid a copy <br/>//<br/>/*BAD*/ vector&lt;gadget&gt;* load_gadgets() {<br/>    vector&lt;gadget&gt;* ret = new vector&lt;gadget&gt;();<br/>    // ... populate *ret ...<br/>    return ret;<br/>}<br/><br/>// Obsolete calling code (note: NOT exception-safe) <br/>vector&lt;gadget&gt;* p = load_gadgets();<br/>if(p) use(*p);<br/>delete p;
</code></pre><p>This has all of the usability and fragility problems discussed in #1. Today, normally we should just return by value, because we will incur only a cheap move operation, not a deep copy, to hand the result to the caller:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>// Example 4(b): Default recommendation: return the value<br/>//<br/>vector&lt;gadget&gt; load_gadgets() {<br/>    vector&lt;gadget&gt; ret;<br/>    // ... populate ret ...<br/>    return ret;<br/>}<br/><br/>// Calling code (exception-safe)<br/>auto v = load_gadgets();<br/>use(v);
</code></pre><p>Most of the time, return movable objects by value. That’s all there is to it, if the only reason for the pointer on the return type was to avoid the copy.
</p><p>There could be one additional reason the function might have returned a pointer, namely to return <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">nullptr</span> to indicate failure to produce an object. Normally it’s better throw an exception to report an error if we fail to load the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span>. However, if not being able to load the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">widget</span> is normal operation and should not be considered an error, return an <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">optional&lt;widget&gt;</span>, and probably make the factory <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">noexcept</span> if no other kinds of errors need to be reported than are communicated well by returning an empty <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">optional&lt;widget&gt;</span>.
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>// Example 4(c): Alternative if not returning an object is normal<br/>//<br/>optional&lt;vector&lt;gadget&gt;&gt; load_gadgets() noexcept {<br/>    vector&lt;gadget&gt; ret;<br/>    // ... populate ret ...<br/>    if( success )            // return vector (might be empty)<br/>        return move(ret);    // note: move() here to avoid a silent copy<br/>    else<br/>        return {};           // not returning anything<br/>}<br/><br/>// Calling code (exception-safe)<br/>auto v = load_gadgets();<br/>if(v) use(*v);
</code></pre><blockquote>
<p><strong>Guideline:</strong> A factory that produces a non-reference type should return a value by default, and throw an exception if it fails to create the object. If not creating the object can be a normal result, return an <strong>optional&lt;&gt;</strong> value.
</p>
</blockquote><h2>Coda<br/></h2><p>By the way, see that test for <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">if(v)</span> in the last line of Example 4(c)? It calls a cool function of <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">optional&lt;T&gt;</span>, namely <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator bool</span>. What makes bool so cool? In part because of how many C++ features it exercises. Here is its declaration… just think of what this lets you safely do, including at compile time! Enjoy.
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>constexpr explicit optional&lt;T&gt;::operator bool() const noexcept;
</code></pre><h2>Acknowledgments<br/></h2><p>Thanks in particular to the following for their feedback to improve this article: Johannes Schaub, Leo, Vincent Jacquet.</p>	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a>	</div>

		<div class="amp-wp-meta amp-wp-comments-link">
		<a href="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/#comments">
			View Comments		</a>
	</div>
	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>Sutter’s Mill</h2>
		<p>
			<a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a>
		</p>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>


	<amp-pixel src="https://pixel.wp.com/b.gif?rand=RANDOM&#038;host=herbsutter.com&#038;ref=DOCUMENT_REFERRER&#038;amp=1&#038;blog=3379246&#038;v=wpcom&#038;tz=-8&#038;user_id=0&#038;post=2068&#038;subd=herbsutter"></amp-pixel>
	<amp-pixel src="https://pixel.wp.com/b.gif?rand=RANDOM&#038;v=wpcom-no-pv&#038;crypt=UE40eW5QN0p8M2Y%2FRE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29%2BSmw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8%2FMkNtblkvY1d1TjBELytHc0k%2FMXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sNGdONE9GczNGJkhCfGxfSzIsTTFVZWlnc0ZuY2gxOWx5cjdVaF0%2FTFA5c0pUeHpGYS9pL1BFeTE1al1hcFZyLFM9JXNjM24tais1N1NYOUg5OUYueG02Y21OMy5aT1UzcSV4"></amp-pixel>
	
</body>
</html>
