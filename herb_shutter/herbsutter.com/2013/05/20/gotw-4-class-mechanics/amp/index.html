<!doctype html>
<html amp lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
	
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="GotW #4 Solution: Class Mechanics" />
<meta property="og:url" content="https://herbsutter.com/2013/05/20/gotw-4-class-mechanics/" />
<meta property="og:description" content="How good are you at the details of writing classes? This item focuses not only on blatant errors, but even more so on professional style. Understanding these principles will help you to design clas…" />
<meta property="article:published_time" content="2013-05-20T18:22:22+00:00" />
<meta property="article:modified_time" content="2013-05-21T21:13:45+00:00" />
<meta property="og:site_name" content="Sutter’s Mill" />
<meta property="og:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=200&amp;ts=1542965409" />
<meta property="og:image:width" content="200" />
<meta property="og:image:height" content="200" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta name="twitter:text:title" content="GotW #4 Solution: Class Mechanics" />
<meta name="twitter:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=240" />
<meta name="twitter:card" content="summary" />
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom" />

<!-- End Jetpack Open Graph Tags -->
	<title>GotW #4 Solution: Class Mechanics &#8211; Sutter’s Mill</title>
		<link rel="canonical" href="https://herbsutter.com/2013/05/20/gotw-4-class-mechanics/" />
	<script src="https://cdn.ampproject.org/v0.js" async></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic">	<style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
		<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"BlogPosting","mainEntityOfPage":"https:\/\/herbsutter.com\/2013\/05\/20\/gotw-4-class-mechanics\/","publisher":{"@type":"Organization","name":"Sutter\u2019s Mill","logo":{"@type":"ImageObject","url":"https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=60&d=https%3A%2F%2Fs0.wp.com%2Fi%2Ffavicons%2Fapple-touch-icon-60x60.png","width":60,"height":60}},"headline":"GotW #4 Solution: Class Mechanics","datePublished":"2013-05-20T10:22:22+00:00","dateModified":"2013-05-21T13:13:45+00:00","author":{"@type":"Person","name":"Herb Sutter"},"image":{"@type":"ImageObject","url":"https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=200","width":200,"height":200}}</script>
	<meta name="generator" content="AMP Plugin v0.6.2" />	<style amp-custom>
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}

.amp-wp-unknown-size img {
	/** Worst case scenario when we can't figure out dimensions for an image. **/
	/** Force the image into a box of fixed dimensions and use object-fit to scale. **/
	object-fit: contain;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 500px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: 'Merriweather', 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}

/* Site Icon */

.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://s2.wp.com/wp-content/plugins/amp/assets/images/placeholder-icon.png ) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		/* Inline styles */
.amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe{background:#ffffcc;margin-left:14pt;}.amp-wp-inline-e118b89cb574341583297a20935ac54c{color:#2e74b5;}.amp-wp-inline-67e1925c715f5c48af6b92757f5a6f7b{color:#5a5a5a;}	</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://herbsutter.com">
									<span class="amp-site-title">
				Sutter’s Mill			</span>
		</a>
	</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">GotW #4 Solution: Class Mechanics</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=24&#038;d=identicon&#038;r=g" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">Herb Sutter</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2013-05-20T10:22:22+00:00">
		6 years ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<p><span class="amp-wp-inline-67e1925c715f5c48af6b92757f5a6f7b"><em>How good are you at the details of writing classes? This item focuses not only on blatant errors, but even more so on professional style. Understanding these principles will help you to design classes that are easier to use and easier to maintain.<br/></em></span></p><p>
 </p><h1>Problem<br/></h1><h2>JG Question<br/></h2><p>1. What makes interfaces “easy to use correctly, hard to use incorrectly”? Explain.
</p><h2>Guru Question<br/></h2><p>2. You are doing a code review. A programmer has written the following class, which shows some poor style and has some real errors. How many can you find, and how would you fix them?
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>class complex {<br/>public:<br/>    complex( double r, double i = 0 )<br/>        : real(r), imag(i)<br/>    { }<br/><br/>    void operator+ ( complex other ) {<br/>        real = real + other.real;<br/>        imag = imag + other.imag;<br/>    }<br/><br/>    void operator&lt;&lt;( ostream os ) {<br/>        os &lt;&lt; "(" &lt;&lt; real &lt;&lt; "," &lt;&lt; imag &lt;&lt; ")";<br/>    }<br/><br/>    complex operator++() {<br/>        ++real;<br/>        return *this;<br/>    }<br/><br/>    complex operator++( int ) {<br/>        auto temp = *this;<br/>        ++real;<br/>        return temp;<br/>    }<br/><br/>    // ... more functions that complement the above ...<br/><br/>private:<br/>    double real, imag;<br/>};
</code></pre><p>Note: This is not intended to be a complete class. For example, if you provide <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator++</span> you would normally also provide <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator–</span>. Rather, this is an instructive example to focus on the mechanics of writing correctly the kinds of functions this class is trying to support.
</p><p>
 </p><h1>Solution<br/></h1><h2>1. What makes interfaces “easy to use correctly, hard to use incorrectly”? Explain.<br/></h2><p>We want to enable a <a href="http://blogs.msdn.com/b/brada/archive/2003/10/02/50420.aspx">“pit of success”</a> where users of our type just naturally fall into good practices—they just naturally write code that is valid, correct, and efficient.
</p><p>On the other hand, we want to make it hard for our users to get into trouble—we want code that would be incorrect or inefficient to be invalid (a compile time error if possible) or at least inconvenient and hard to write silently so that we can protect the user from unwelcome surprises.
</p><p>Scott Meyers <a href="http://programmer.97things.oreilly.com/wiki/index.php/Make_Interfaces_Easy_to_Use_Correctly_and_Hard_to_Use_Incorrectly">popularized</a> this guidance. See his concise writeup for further examples.
</p><p>
 </p><h2>2. You are doing a code review. A programmer has written the following class, which shows some poor style and has some real errors. How many can you find, and how would you fix them?<br/></h2><p>This class has a lot of problems—even more than I will show explicitly here. The point of this puzzle was primarily to highlight class mechanics (issues like “what is the canonical form of <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator&lt;&lt;</span>?” and “should <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> be a member?”) rather than point out where the interface is just plain poorly designed. However, I will start off with perhaps the two most useful observation first:
</p><p>First, this is a code review but the developer doesn’t seem to have tried to even unit-test his code, else he would have found some glaring problems.
</p><p>Second, why write a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> class when one already exists in the standard library? And, what’s more, when the standard one isn’t plagued with any of the following problems and has been crafted based on years of practice by the best people in our industry? Humble thyself and reuse.
</p><blockquote>
<p><strong>Guideline:</strong> Reuse code—especially standard library code—instead of handcrafting your own. It’s faster, easier, and safer.
</p>
</blockquote><p>Perhaps the best way to fix the problems in the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> code is to avoid using the class at all, and use the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">std::complex</span> template instead.
</p><p>Having said that, it’s an instructive example, so let’s go through the class as written and fix the problems as we go. First, the constructor:
</p><h3>1. The default constructor is missing.<br/></h3><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>    complex( double r, double i = 0 )<br/>        : real(r), imag(i)<br/>    { }
</code></pre><p>Once we supply a user-written constructor, we suppress the implicit generation of the default constructor. Beyond “easy to use correctly,” not having a default constructor makes the class annoying to use at all. In this case, we could either default both parameters, or provide a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex() = default;</span> and declare the data members with initializers such as <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">double real = 0, imag = 0;</span> , or just delegate with <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex() : complex(0) { }</span> . Just defaulting the parameter is the simplest here.
</p><p>Also, as explained in GotW #1, prefer to use <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">{ }</span> consistently for initialization rather than <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">( )</span> just as a good modern habit. The two mean exactly the same thing in this case, but <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">{ }</span> lets us be more consistent, and could catch a few errors during maintenance, such as typos that would invoke <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">double</span>-to-<span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">float</span> narrowing conversions.
</p><h3>2. operator+ passes by value.<br/></h3><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>    void operator+ ( complex other ) {<br/>        real = real + other.real;<br/>        imag = imag + other.imag;<br/>    }
</code></pre><p>Although we’re about make other changes to this function in a moment, as written this parameter should be passed by <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">const&amp;</span> because all we do is read from it.
</p><blockquote>
<p><strong>Guideline:</strong> Prefer passing a read-only parameter by <strong>const&amp;</strong> if you are only going to read from it (not make a copy of it).
</p>
</blockquote><h3>3. operator+ modifies this object’s value.<br/></h3><p>Instead of returning <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">void</span>, <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> should return a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> containing the sum and not modify this object’s value. Users who write <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">val1 + val2</span> and see <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">val1</span> changed are unlikely to be impressed by these gratuitously weird semantics. As Scott Meyers is wont to say, when writing a value type, “do as the <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">int</span>s do” and follow the conventions of the built-in types.
</p><h3>4. operator+ is not written in terms of operator+= (which is missing).<br/></h3><p>Really, this <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> is trying to be <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+=</span>. It should be split into an actual <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> and <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+=</span>, with the former calling the latter.
</p><blockquote>
<p><strong>Guideline: </strong>If you supply a standalone version of an operator (e.g., <strong>operator+</strong>), always supply an assignment version of the same operator (e.g., <strong>operator+=</strong>) and prefer implementing the former in terms of the latter. Also, always preserve the natural relationship between op and op= (where op stands for any operator).
</p>
</blockquote><p>Having <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">+=</span> is good, because users should prefer using it. Even in the above code, <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">real = real + other.real;</span> should be <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">real += other.real;</span> and similarly for the second line.
</p><blockquote>
<p><strong>Guideline:</strong> Prefer writing <strong>a op= b</strong> instead of <strong>a = a op b</strong> (where op stands for any operator). It’s clearer, and it’s often more efficient.
</p>
</blockquote><p>The reason why <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+=</span> is more efficient is that it operates on the left-hand object directly and returns only a reference, not a temporary object. On the other hand, <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> must return a temporary object. To see why, consider the following canonical forms for how <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+=</span> and <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> should normally be implemented for some type <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">T</span>.
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>T&amp; T::operator+=( const T&amp; other ) {<br/>    //...<br/>    return *this;<br/>}<br/><br/>T operator+( T a, const T&amp; b ) {<br/>    a += b;<br/>    return a;<br/>}
</code></pre><p>Did you notice that one parameter is passed by value, and one by reference? That’s because if you’re going to copy from a parameter anyway, it’s often better to pass it by value, which will naturally enable a move operation if the caller passes a temporary object such as in expressions like <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">(val1 * val2) + val3</span>. This is a good habit to follow even in cases like <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> where a move is the same cost as a copy, since it doesn’t cost any efficiency when move and copy are the same, and arguably makes for cleaner code than passing by reference and adding an extra named local object. We’ll see more on parameter passing in a future GotW.
</p><blockquote>
<p><strong>Guideline:</strong> Prefer passing a read-only parameter by value if you’re going to make a copy of the parameter anyway, because it enables move from rvalue arguments.
</p>
</blockquote><p>Implementing <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">+</span> in terms of <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">+=</span> both makes the code simpler and guarantees consistent semantics as the two functions are less likely to diverge during maintenance.
</p><h3>5. operator+ should not be a member function.<br/></h3><p>If <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> is made a member function, as it is here, then it won’t work as naturally as your users may expect when you do decide to allow implicit conversions from other types. Here, an implicit conversion from <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">double</span> to <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> makes sense, but with the original class users have an asymmetry: Specifically, when adding <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> objects to numeric values, you can write <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">a = b + 1.0</span> but not <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">a = 1.0 + b</span> because a member <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> requires a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> (and not a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">double</span>) as its left-hand argument.
</p><p>Finally, the other reason to prefer non-members is because they provide better encapsulation, as <a href="http://www.drdobbs.com/cpp/how-non-member-functions-improve-encapsu/184401197">pointed out by Scott Meyers</a>.
</p><blockquote>
<p><strong>Guideline: </strong>Prefer these guidelines for making an operator a member vs. nonmember function: unary operators are members; <strong>= () []</strong> and <strong>-&gt;</strong> must be members; the assignment operators (<strong>+= –= /= *=</strong> etc.) must be members; all other binary operators are nonmembers.
</p>
</blockquote><h3>6. operator&lt;&lt; should not be a member function.<br/></h3><p>The author of this code didn’t really mean to enable the syntax <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">my_complex &lt;&lt; cout</span>, did they?
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>    void operator&lt;&lt;( ostream os ) {<br/>        os &lt;&lt; "(" &lt;&lt; real &lt;&lt; "," &lt;&lt; imag &lt;&lt; ")";<br/>    }
</code></pre><p>The same reasons already given to show why <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator+</span> should be a nonmember apply also to <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator&lt;&lt;</span>, only more so because a member the first parameter has to be a stream, not a <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span>. Further, the parameters should be references: <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">(ostream&amp;, const complex &amp;)</span>.
</p><p>Note also that the nonmember <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator&lt;&lt;</span> should normally be implemented in terms of a(n often virtual) <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">const</span> member function that does the work, usually named something like <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">print</span>.
</p><h3>7. operator&lt;&lt; should return ostream&amp;.<br/></h3><p>Further, <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator&lt;&lt;</span> should have a return type of <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">ostream&amp;</span> and should return a reference to the stream in order to permit chaining. That way, users can use your <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">operator&lt;&lt;</span> naturally in code like <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">cout &lt;&lt; a &lt;&lt; b;</span>.
</p><blockquote>
<p><strong>Guideline: </strong>Always return stream references from <strong>operator&lt;&lt;</strong> and <strong>operator&gt;&gt;</strong>.
</p>
</blockquote><h3>8. The preincrement operator’s return type is incorrect.<br/></h3><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>    complex operator++() {<br/>        ++real;<br/>        return *this;<br/>    }
</code></pre><p>Ignoring for the sake of argument whether preincrement is meaningful for <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">complex</span> numbers, if the function exists it should return a reference. This lets client code operate more intuitively and avoids needless inefficiency.
</p><blockquote>
<p><strong>Guideline: </strong>When you <strong>return *this</strong>, the return type should usually be a reference.
</p>
</blockquote><h3>9. Postincrement should be implemented in terms of preincrement.<br/></h3><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>    complex operator++( int ) {<br/>        auto temp = *this;<br/>        ++real;<br/>        return temp;<br/>    }
</code></pre><p>Instead of repeating the work, prefer to call <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">++*this</span>. See GotW #2 for the full canonical form for postincrement.
</p><blockquote>
<p><strong>Guideline: </strong>For consistency, always implement postincrement in terms of preincrement, otherwise your users will get surprising (and often unpleasant) results.
</p>
</blockquote><h3>Summary<br/></h3><p>That’s it. There are other modern C++ features we could apply here, but they would be arguably gratuitous and not appropriate for general recommendations. For example, this is a value type not designed to be inherited from, so we could prevent inheritance by making the class <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">final</span>, but that would be protecting against Machiavelli, not Murphy, and there’s no need for a general guideline that tells everyone they should now write <span class="amp-wp-inline-e118b89cb574341583297a20935ac54c">final</span> on every value type; that would just be tedious and unnecessary.
</p><p>Here’s a corrected version of the class, ignoring design and style issues not explicitly noted above:
</p><p class="amp-wp-inline-fecf5a659d98c4adc4aafde3be4a8abe">
</p><pre><code>class complex {<br/>public:<br/>    complex( double r = 0, double i = 0 )<br/>        : real{r}, imag{i}<br/>    { }<br/><br/>    complex&amp; operator+=( const complex&amp; other ) {<br/>        real += other.real;<br/>        imag += other.imag;<br/>        return *this;<br/>    }<br/><br/>    complex&amp; operator++() {<br/>        ++real;<br/>        return *this;<br/>    }<br/><br/>    complex operator++( int ) {<br/>        auto temp = *this;<br/>        ++*this;<br/>        return temp;<br/>    }<br/><br/>    ostream&amp; print( ostream&amp; os ) const {<br/>        return os &lt;&lt; "(" &lt;&lt; real &lt;&lt; "," &lt;&lt; imag &lt;&lt; ")";<br/>    }<br/><br/>private:<br/>    double real, imag;<br/>};<br/><br/>complex operator+( complex lhs, const complex&amp; rhs ) {<br/>    lhs += rhs;<br/>    return lhs;<br/>}<br/><br/>ostream&amp; operator&lt;&lt;( ostream&amp; os, const complex&amp; c ) {<br/>    return c.print(os);<br/>}
</code></pre><h2>Acknowledgments<br/></h2><p>Thanks in particular to the following for their feedback to improve this article: Mikhail Belyaev, jlehrer, Olaf van der Spek, Marshall, litb1, hm, Dave Harris, nosenseetal.</p>	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a>	</div>

		<div class="amp-wp-meta amp-wp-comments-link">
		<a href="https://herbsutter.com/2013/05/20/gotw-4-class-mechanics/#comments">
			View Comments		</a>
	</div>
	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>Sutter’s Mill</h2>
		<p>
			<a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a>
		</p>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>


	<amp-pixel src="https://pixel.wp.com/b.gif?rand=RANDOM&#038;host=herbsutter.com&#038;ref=DOCUMENT_REFERRER&#038;amp=1&#038;blog=3379246&#038;v=wpcom&#038;tz=-8&#038;user_id=0&#038;post=1957&#038;subd=herbsutter"></amp-pixel>
	<amp-pixel src="https://pixel.wp.com/b.gif?rand=RANDOM&#038;v=wpcom-no-pv&#038;crypt=UE40eW5QN0p8M2Y%2FRE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29%2BSmw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8%2FMkNtblkvY1d1TjBELytHc0k%2FMXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sbVJiMkYuKz1XUnVaX0lsJmh3L2xxcHNhKzVFcDhfWklkZkImNjl5OFdzKy5CNHlwT1QvQmduQ2xKY1Z0Ty02ck02W2lPd1k5Vy9KUStHdkotUWdXMER4VzdLcm9lVnZ1eFA3"></amp-pixel>
	
</body>
</html>
