<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>GotW #89 Solution: Smart Pointers | Sutter’s Mill</title>
<link rel="pingback" href="https://herbsutter.com/xmlrpc.php" />
<script type="text/javascript">
  WebFontConfig = {"typekit":{"id":"eyo0tqd"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://s0.wp.com/wp-content/plugins/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active #header h1{font-size:2.12em;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active body{font-size:89.7%;font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation{font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation ul li.search{font-size:1.06em}.wf-active #navigation ul li.search input#searchsubmit{font-size:1.06em}.wf-active #content .post-info, .wf-active #content .postmetadata{font-size:1.06em}.wf-active #sidebar{font-size:1.06em}.wf-active #footer p.right{font-size:1.06em}.wf-active .commentnum{font-size:1.77em}.wf-active .commentlist li .cmtinfo{font-size:1.18em}.wf-active .commentlist li .cmtinfo em{font-size:1.06em}.wf-active #respond label{font-size:11.8px}.wf-active #respond .required{font-size:11.8px}.wf-active #respond .subscribe-label{font-size:14.2px}.wf-active #respond .comment-notes{font-size:13px}.wf-active .wp-caption p.wp-caption-text{font-size:13px}.wf-active #content h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active h5, .wf-active h6{font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active #header h2{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active #content h3{font-size:1.65em;font-weight:400;font-style:normal}.wf-active #content h4{font-size:1.3em;font-style:normal;font-weight:400}.wf-active #content h5{font-size:1.18em;font-style:normal;font-weight:400}.wf-active #content .post h2{font-size:1.65em;font-weight:400;font-style:normal}.wf-active li.sidebox h2{font-weight:400;font-size:1.89em;font-style:normal}.wf-active .post h4{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active .post h4 em{font-style:normal;font-weight:400}</style>
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=herbsutter.com&amp;id=3379246&amp;t=1542965307&amp;back=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F29%2Fgotw-89-solution-smart-pointers%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//herbsutter.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Feed" href="https://herbsutter.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Comments Feed" href="https://herbsutter.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; GotW #89 Solution: Smart&nbsp;Pointers Comments Feed" href="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s1.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1532082729h&ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s2.wp.com/_static/??-eJyNkN1uwjAMhV9onsUG69W0Z0laE0zzp8QR6tvjUlUCwSpuonOS81knxkuGPkWhKBgaZN8cx4qeR6p4JsmmH+HmPvtaP/B1nOORI8uEcqKgYG4WA1eZfErjFtinQnofspE5EWhgQ15nRNnCQv5ZqVmetORmv0vWNFibC9UKegZuAZayT9wKuabWUnEwt0Tb2A9ofbotxBZTJpx/SE8DXi3hn+h9Rx4cSUVJGXKqqt5GaurZeGCNPJoFZoxJlsdVbE11lEB/aYRTfDBw9IbLFlpI9+NUOtTUnZ2hv/C7O+y/uu9uf+jOV8Xg7sY=?cssminify=yes' type='text/css' media='all' />
<link rel='stylesheet' id='print-css-1-1' href='https://s2.wp.com/wp-content/mu-plugins/global-print/global-print.css?m=1465851035h&cssminify=yes' type='text/css' media='print' />
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??/wp-content/mu-plugins/actionbar/actionbar.css,/wp-content/themes/h4/global.css?m=1516985148j&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyFztEKwjAMBdAfsquTiXsRv6XWOFKXtDbphn69HeiDMBQCgdzDJXZOBtmP5QJiQ517gfx4rybIxv4ChnDITqEh5A/2kRVYF0vxjCOYIpDdUG+16BpXXIqiBCIVraTfLyFPCPNfFkCT8zeTQfC5tJ7o2Hb9Yde3+24bXjRNW9I='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://herbsutter.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='GotW #89: Smart&nbsp;Pointers' href='https://herbsutter.com/2013/05/28/gotw-89-smart-pointers/' />
<link rel='next' title='GotW #90: Factories' href='https://herbsutter.com/2013/05/29/gotw-90-factories/' />
<meta name="generator" content="WordPress.com" />
<link rel="canonical" href="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/" />
<link rel='shortlink' href='https://wp.me/peb5Y-wP' />
<link rel="alternate" type="application/json+oembed" href="https://public-api.wordpress.com/oembed/?format=json&amp;url=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F29%2Fgotw-89-solution-smart-pointers%2F&amp;for=wpcom-auto-discovery" /><link rel="alternate" type="application/xml+oembed" href="https://public-api.wordpress.com/oembed/?format=xml&amp;url=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F29%2Fgotw-89-solution-smart-pointers%2F&amp;for=wpcom-auto-discovery" />
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="GotW #89 Solution: Smart Pointers" />
<meta property="og:url" content="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/" />
<meta property="og:description" content="NOTE: Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is…" />
<meta property="article:published_time" content="2013-05-29T18:49:21+00:00" />
<meta property="article:modified_time" content="2013-05-30T21:39:27+00:00" />
<meta property="og:site_name" content="Sutter’s Mill" />
<meta property="og:image" content="https://herbsutter.files.wordpress.com/2013/05/053013_2139_gotw89solut2.png" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta name="twitter:text:title" content="GotW #89 Solution: Smart&nbsp;Pointers" />
<meta name="twitter:card" content="summary" />
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom" />

<!-- End Jetpack Open Graph Tags -->
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=114" />
<link rel='openid.server' href='https://herbsutter.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://herbsutter.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://herbsutter.com/osd.xml" title="Sutter’s Mill" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<script type="text/javascript" id="webfont-output">
  
  WebFontConfig = {"typekit":{"id":"cjs1oxc"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<meta name="application-name" content="Sutter’s Mill" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Herb Sutter on software development" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://herbsutter.com/feed/;icon-uri=https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=16" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="description" content="NOTE: Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#039;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #103.  There&#039;s a lot to love about standard smart pointers in general, and&hellip;" />
<style type="text/css">
			#header h1 a,
		#header h2 {
			color: #265E15 !important;
		}
				#headerimage {
			background: url('https://herbsutter.files.wordpress.com/2011/10/cropped-blog-header.jpg') no-repeat;
			height: 200px;
		}
	</style>
<link rel="amphtml" href="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/amp/"><style type="text/css" id="syntaxhighlighteranchor"></style>
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=eb5Y&#038;cscache=6&#038;csrev=60" />
		</head>
<body id="section-index" class="post-template-default single single-post postid-2035 single-format-standard mp6 customizer-styles-applied highlander-enabled highlander-light">


<div id="navigation" class="clearfix">
		<div class="menu">
		<ul>
			<li ><a href="https://herbsutter.com/" title="Home">Home</a></li>
			<li class="page_item page-item-912"><a href="https://herbsutter.com/welcome-to-the-jungle/">Welcome to the&nbsp;Jungle</a></li>
<li class="page_item page-item-864 page_item_has_children"><a href="https://herbsutter.com/gotw/">GotW</a></li>
<li class="page_item page-item-761"><a href="https://herbsutter.com/elements-of-modern-c-style/">Elements of Modern C++&nbsp;Style</a></li>
<li class="page_item page-item-2 page_item_has_children"><a href="https://herbsutter.com/about/">About</a></li>
									<li class="search"><form method="get" id="searchform" action="https://herbsutter.com"><input type="text" class="textbox" value="" name="s" id="s" /><input type="submit" id="searchsubmit" value="Search" /></form></li>
					</ul>
	</div>
</div><!-- end id:navigation -->

<div id="container">

<div id="header">
<h1><a href="https://herbsutter.com/" title="Sutter’s Mill">Sutter’s Mill</a></h1>
<h2>Herb Sutter on software development</h2>
</div><!-- end id:header -->


	
		<div id="feedarea">
	<dl>
		<dt><strong>Feeds:</strong></dt>

			<dd><a href="https://herbsutter.com/feed/">Posts</a></dd>
	
			<dd><a href="https://herbsutter.com/comments/feed/">Comments</a></dd>
		</dl>
	</div><!-- end id:feedarea -->
	
	<div id="headerimage">
</div><!-- end id:headerimage -->

<div id="content">
<div id="content-main">

		
									<div class="postnav">
				<div class="alignleft">&laquo; <a href="https://herbsutter.com/2013/05/28/gotw-89-smart-pointers/" rel="prev">GotW #89: Smart&nbsp;Pointers</a></div>
				<div class="alignright"><a href="https://herbsutter.com/2013/05/29/gotw-90-factories/" rel="next">GotW #90: Factories</a> &raquo;</div>
			</div>
			
			<div class="post-2035 post type-post status-publish format-standard hentry category-gotw" id="post-2035">
				<div class="posttitle">
					<h2>GotW #89 Solution: Smart&nbsp;Pointers</h2>
					<p class="post-info">2013-05-29 by <a href="https://herbsutter.com/author/herbsutter/" title="Posts by Herb Sutter">Herb Sutter</a>  </p>
				</div>

				<div class="entry">
					<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #103.
</p>
</blockquote>
<p>
 </p>
<p><span style="color:#5a5a5a;"><em>There&#8217;s a lot to love about standard smart pointers in general, and unique_ptr in particular.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. When should you use <span style="color:#2e74b5;">shared_ptr</span> vs. <span style="color:#2e74b5;">unique_ptr</span>? List as many considerations as you can.
</p>
<h2>Guru Question<br />
</h2>
<p>2. Why should you almost always use <span style="color:#2e74b5;">make_shared</span> to create an object to be owned by <span style="color:#2e74b5;">shared_ptr</span>s? Explain.
</p>
<p>3. Why should you almost always use <span style="color:#2e74b5;">make_unique</span> to create an object to be initially owned by a <span style="color:#2e74b5;">unique_ptr</span>? Explain.
</p>
<p>4. What&#8217;s the deal with <span style="color:#2e74b5;">auto_ptr</span>?
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>1. When should you use shared_ptr vs. unique_ptr?<br />
</h2>
<p>When in doubt, prefer <span style="color:#2e74b5;">unique_ptr</span> by default, and you can always later move-convert to <span style="color:#2e74b5;">shared_ptr</span> if you need it. If you do know from the start you need shared ownership, however, go directly to <span style="color:#2e74b5;">shared_ptr</span> via <span style="color:#2e74b5;">make_shared</span> (see #2 below).
</p>
<p>There are three major reasons to say &#8220;when in doubt, prefer <span style="color:#2e74b5;">unique_ptr</span>.&#8221;
</p>
<p>First, use the simplest semantics that are sufficient<em>:</em> Choose the right smart pointer to most directly express your intent, and what you need (now). If you are creating a new object and don&#8217;t know that you&#8217;ll eventually need shared ownership, use <span style="color:#2e74b5;">unique_ptr</span> which expresses unique ownership. You can still put it in a container (e.g., <span style="color:#2e74b5;">vector&lt;unique_ptr&lt;widget&gt;&gt;</span>) and do most other things you want to do with a raw pointer, only safely. If you later need shared ownership, you can always move-convert the <span style="color:#2e74b5;">unique_ptr</span> to a <span style="color:#2e74b5;">shared_ptr</span>.
</p>
<p>Second, a  <span style="color:#2e74b5;">unique_ptr</span> is more efficient than a <span style="color:#2e74b5;">shared_ptr</span>. A <span style="color:#2e74b5;">unique_ptr</span> doesn&#8217;t need to maintain reference count information and a control block under the covers, and is designed to be just about as cheap to move and use as a raw pointer. When you don&#8217;t ask for more than you need, you don&#8217;t incur overheads you won&#8217;t use.
</p>
<p>Third, starting with <span style="color:#2e74b5;">unique_ptr</span> is more flexible and keeps your options open. If you start with a <span style="color:#2e74b5;">unique_ptr</span>, you can always later convert to a <span style="color:#2e74b5;">shared_ptr</span> via move, or to another custom smart pointer (or even to a raw pointer) via <span style="color:#2e74b5;">.get()</span> or <span style="color:#2e74b5;">.release()</span>.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer to use the standard smart pointers, <strong>unique_ptr</strong> by default and <strong>shared_ptr</strong> if sharing is needed. They are the common types that all C++ libraries can understand. Use other smart pointer types only if necessary for interoperability with other libraries, or when necessary for custom behavior you can&#8217;t achieve with deleters and allocators on the standard pointers.
</p>
</blockquote>
<h2>2. Why should you almost always use make_shared to create an object to be owned by shared_ptrs? Explain.<br />
</h2>
<p>Note: If you need to create an object using a custom allocator, which is rare, you can use <span style="color:#2e74b5;">allocate_shared</span>. Note that even though its name is slightly different, <span style="color:#2e74b5;">allocate_shared</span> should be viewed as &#8220;just the flavor of <span style="color:#2e74b5;">make_shared</span> that lets you specify an allocator,&#8221; so I&#8217;m mainly going to talk about them both as <span style="color:#2e74b5;">make_shared</span> here and not distinguish much between them.
</p>
<p>There are two main cases where you can&#8217;t use <span style="color:#2e74b5;">make_shared</span> (or <span style="color:#2e74b5;">allocate_shared</span>) to create an object that you know will be owned by <span style="color:#2e74b5;">shared_ptr</span>s: (a) if you need a custom deleter, such as because of using <span style="color:#2e74b5;">shared_ptr</span>s to manage a non-memory resource or an object allocated in a nonstandard memory area, you can&#8217;t use <span style="color:#2e74b5;">make_shared</span> because it doesn&#8217;t support specifying a deleter; and (b) if you are adopting a raw pointer to an object being handed to you from other (usually legacy) code, you would construct a <span style="color:#2e74b5;">shared_ptr</span> from that raw pointer directly.
</p>
<blockquote>
<p><strong>Guideline:</strong> Use <strong>make_shared</strong> (or, if you need a custom allocator, <strong>allocate_shared</strong>) to create an object you know will be owned by <strong>shared_ptr</strong>s, unless you need a custom deleter or are adopting a raw pointer from elsewhere.
</p>
</blockquote>
<p>So, why use <span style="color:#2e74b5;">make_shared</span> (or, if you need a custom allocator, <span style="color:#2e74b5;">allocate_shared</span>) whenever you can, which is nearly always? There are two main reasons: simplicity, and efficiency.
</p>
<p>First, with <span style="color:#2e74b5;">make_shared</span> the code is simpler. Write for clarity and correctness first.
</p>
<p>Second, using <span style="color:#2e74b5;">make_shared</span> is more efficient. The <span style="color:#2e74b5;">shared_ptr</span> implementation has to maintain housekeeping information in a control block shared by all <span style="color:#2e74b5;">shared_ptr</span>s and <span style="color:#2e74b5;">weak_ptr</span>s referring to a given object. In particular, that housekeeping information has to include not just one but two reference counts:
</p>
<ul>
<li>A &#8220;strong reference&#8221; count to track the number of <span style="color:#2e74b5;">shared_ptr</span>s currently keeping the object alive. The shared object is destroyed (and possibly deallocated) when the last strong reference goes away.
</li>
<li>A &#8220;weak reference&#8221; count to track the number of <span style="color:#2e74b5;">weak_ptr</span>s currently observing the object. The shared housekeeping control block is destroyed and deallocated (and the shared object is deallocated if it was not already) when the last weak reference goes away.
</li>
</ul>
<p>If you allocate the object separately via a raw <span style="color:#2e74b5;">new</span> expression, then pass it to <span style="color:#2e74b5;">a shared_ptr</span>, the <span style="color:#2e74b5;">shared_ptr</span> implementation has no alternative but to allocate the control block separately, as shown in Example 2(a) and Figure 2(a).
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 2(a): Separate allocation<br />auto sp1 = shared_ptr&lt;widget&gt;{ new widget{} };<br />auto sp2 = sp1;
</code></pre>
</p>
<p style="text-align:center;"><img src="https://herbsutter.files.wordpress.com/2013/05/053013_2139_gotw89solut1.png?w=500" alt="" />
	</p>
<p style="text-align:center;">Figure 2(a): Approximate memory layout for Example 2(a).
</p>
<p>We&#8217;d like to avoid doing two separate allocations here. If you use <span style="color:#2e74b5;">make_shared</span> to allocate the object and the <span style="color:#2e74b5;">shared_ptr</span> all in one go, then the implementation can fold them together in a single allocation, as shown in Example 2(b) and Figure 2(b).
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 2(b): Single allocation<br />auto sp1 = make_shared&lt;widget&gt;();<br />auto sp2 = sp1;
</code></pre>
</p>
<p style="text-align:center;"><img src="https://herbsutter.files.wordpress.com/2013/05/053013_2139_gotw89solut2.png?w=500" alt="" />
	</p>
<p style="text-align:center;">Figure 2(b): Approximate memory layout for Example 2(b).
</p>
<p>Note that combining the allocations has two major advantages:
</p>
<ul>
<li>It reduces allocation overhead, including memory fragmentation. First, the most obvious way it does this is by reducing the number of allocation requests, which are typically more expensive operations. This also helps reduce contention on allocators (some allocators don&#8217;t scale well). Second, using only one chunk of memory instead of two reduces the per-allocation overhead. Whenever you ask for a chunk of memory, the system must give you at least that many bytes, and often gives you a few more because of using fixed-size pools or tacking on housekeeping information per allocation. So by using a single chunk of memory, we tend to reduce the total extra overhead. Finally, we also naturally reduce the number of &#8220;dead&#8221; extra in-between gaps that cause fragmentation.
</li>
<li>It improves locality. The reference counts are frequently used with the object, and for small objects are likely to be on the same cache line, which improves cache performance (as long as there isn&#8217;t some thread copying the smart pointer in a tight loop; don&#8217;t do that).
</li>
</ul>
<p>As always, when you can express more of what you&#8217;re trying to achieve as a single function call, you&#8217;re giving the system a better chance to figure out a way to do the job more efficiently. This is just as true when inserting 100 elements into a <span style="color:#2e74b5;">vector</span> using a single range-insert call to <span style="color:#2e74b5;">v.insert( first, last )</span> instead of 100 calls to <span style="color:#2e74b5;">v.insert( value )</span> as it is when using a single call to <span style="color:#2e74b5;">make_shared</span> instead of separate calls to <span style="color:#2e74b5;">new widget()</span> and <span style="color:#2e74b5;">shared_ptr( widget* )</span>.
</p>
<p>There are two more advantages: Using <span style="color:#2e74b5;">make_shared</span> avoids explicit <span style="color:#2e74b5;">new</span> and avoids an exception safety issue. Both of these also apply to <span style="color:#2e74b5;">make_unique</span>, so we&#8217;ll cover them under #3.
</p>
<h2>3. Why should you almost always use make_unique to create an object to be initially owned by a unique_ptr? Explain.<br />
</h2>
<p>As with <span style="color:#2e74b5;">make_shared</span>, there are two main cases where you can&#8217;t use <span style="color:#2e74b5;">make_unique</span> to create an object that you know will be owned (at least initially) by a <span style="color:#2e74b5;">unique_ptr</span>: if you need a custom deleter, or if you are adopting a raw pointer.
</p>
<p>Otherwise, which is nearly always, prefer <span style="color:#2e74b5;">make_unique</span>.
</p>
<blockquote>
<p><strong>Guideline:</strong> Use <strong>make_unique</strong> to create an object that isn&#8217;t shared (at least not yet), unless you need a custom deleter or are adopting a raw pointer from elsewhere.
</p>
</blockquote>
<p>Besides symmetry with <span style="color:#2e74b5;">make_shared</span>, <span style="color:#2e74b5;">make_unique</span> offers at least two other advantages. First, you should prefer use <span style="color:#2e74b5;">make_unique&lt;T&gt;()</span>  instead of the more-verbose <span style="color:#2e74b5;">unique_ptr&lt;T&gt;{ new T{} }</span> because you should avoid explicit <span style="color:#2e74b5;">new</span> in general:
</p>
<blockquote>
<p><strong>Guideline:</strong> Don&#8217;t use explicit <strong>new</strong>, <strong>delete</strong>, and owning <strong>*</strong> pointers, except in rare cases encapsulated inside the implementation of a low-level data structure.
</p>
</blockquote>
<p>Second, it avoids some known exception safety issues with naked <span style="color:#2e74b5;">new</span>. Here&#8217;s an example:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void sink( unique_ptr&lt;widget&gt;, unique_ptr&lt;gadget&gt; );<br /><br />sink( unique_ptr&lt;widget&gt;{new widget{}},<br />      unique_ptr&lt;gadget&gt;{new gadget{}} ); // Q1: do you see the problem?
</code></pre>
</p>
<p>Briefly, if you allocate and construct the <span style="color:#2e74b5;">new widget</span> first, then get an exception while allocating or constructing the <span style="color:#2e74b5;">new gadget</span>, the <span style="color:#2e74b5;">widget</span> is leaked. You might think: &#8220;Well, I could just change <span style="color:#2e74b5;">new widget{}</span> to <span style="color:#2e74b5;">make_unique&lt;widget&gt;()</span> and this problem would go away, right?&#8221; To wit:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>sink( make_unique&lt;widget&gt;(),<br />      unique_ptr&lt;gadget&gt;{new gadget{}} );         // Q2: is this better?
</code></pre>
</p>
<p>The answer is no, because C++ leaves the order of evaluation of function arguments unspecified and so either the <span style="color:#2e74b5;">new widget</span> or the <span style="color:#2e74b5;">new gadget</span> could be performed first. If the <span style="color:#2e74b5;">new gadget</span> is allocated and constructed first, then the <span style="color:#2e74b5;">make_unique&lt;widget&gt;</span> throws, we have the same problem.
</p>
<p>But while just changing one of the arguments to use <span style="color:#2e74b5;">make_unique</span> doesn&#8217;t close the hole, changing them both to <span style="color:#2e74b5;">make_unique</span> really does completely eliminate the problem:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>sink( make_unique&lt;widget&gt;(), make_unique&lt;gadget&gt;() );  // exception-safe
</code></pre>
</p>
<p>This exception safety issue is covered in more detail in GotW #56.
</p>
<blockquote>
<p><strong>Guideline:</strong> To allocate an object, prefer to write <strong>make_unique</strong> by default, and write <strong>make_shared</strong> when you know the object&#8217;s lifetime is going to be managed by using <strong>shared_ptr</strong>s.
</p>
</blockquote>
<h2>4. What&#8217;s the deal with auto_ptr?<br />
</h2>
<p><span style="color:#2e74b5;">auto_ptr</span> is most charitably characterized as a valiant attempt to create a <span style="color:#2e74b5;">unique_ptr</span> before C++ had move semantics. <span style="color:#2e74b5;">auto_ptr</span> is now deprecated, and should not be used in new code.
</p>
<p>If you have <span style="color:#2e74b5;">auto_ptr</span> in an existing code base, when you get a chance try doing a global search-and-replace of <span style="color:#2e74b5;">auto_ptr</span> to <span style="color:#2e74b5;">unique_ptr</span>; the vast majority of uses will work the same, and it might expose (as a compile-time error) or fix (silently) a bug or two you didn&#8217;t know you had.
</p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: celeborn2bealive, Andy Prowl, Chris Vine, Marek.</p>
									</div>

				<p class="postmetadata">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> | 											53 Comments									</p>
				
<!-- You can start editing here. -->

<h3 id="comments">53 Responses</h3>

	<ol class="commentlist">
			<li class="pingback even thread-even depth-1 highlander-comment" id="comment-34416">
		<div id="div-comment-34416">
		<div class="cmtinfo"><em> on <a href="#comment-34416" title="">2014-12-27 at 2:44 pm</a></em>  <cite><a href='http://sevennet.org/2014/12/27/fix-stdauto_ptr-to-stdunique_ptr-answer-fix-development/' rel='external nofollow' class='url'>Fix: std::auto_ptr to std::unique_ptr #answer #fix #development | SevenNet</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_34416"></div><p>[&#8230;] Herb Sutter has a nice explanation on GotW #89: [&#8230;]</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-29613">
		<div id="div-comment-29613">
		<div class="cmtinfo"><em> on <a href="#comment-29613" title="">2014-10-10 at 7:51 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/566d3c834c35555f27dd83776ef4f80c?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Funky16Corners</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_29613"></div><p>One big downside of make_shared() is that it doesn&#8217;t work with private/protected constructors. We instead have to jump through hoops / define our own factory functions to do this&#8211;or at least from what I&#8217;ve found so far.  The best workaround I&#8217;ve found is this: (from <a href="https://gist.github.com/RklAlx/6727537" rel="nofollow">https://gist.github.com/RklAlx/6727537</a>)</p>
<pre class="brush: plain; title: ; notranslate" title="">

#include &lt;memory&gt;
 
class CC
{
public:
  static std::shared_ptr&lt;CC&gt; CreateCC(int value);
 
    class Key {
    private:
        friend std::shared_ptr&lt;CC&gt; CC::CreateCC(int value);
        Key() {}
    };
 
    CC(const Key&amp;, int y);
    
    ~CC(void);
 
    void Show();
 
private:
    int y;
};


std::shared_ptr&lt;CC&gt; CC::CreateCC(int x)
{
  return std::make_shared&lt;CC&gt;(CC::Key(),x);
}
 
CC::CC(const Key&amp; rk, int xy)
{
    y = xy;
}
 
CC::~CC(void)
{
}
 
 
void CC::Show()
{
    printf(&quot;Value: %d\n&quot;, y);
}

</pre>
<p>make_shared seems pretty broken in this case.  Is there a better way to make this work?  I wasn&#8217;t able to get &#8220;friend&#8221; to work for this&#8211;maybe some one here &#8220;haz teh codez&#8221;.  However, this SO post at least suggests that &#8220;friend&#8221; is not a good solution anyway:</p>
<p><a href="http://stackoverflow.com/questions/8147027/how-do-i-call-stdmake-shared-on-a-class-with-only-protected-or-private-const/8147213#8147213" rel="nofollow">http://stackoverflow.com/questions/8147027/how-do-i-call-stdmake-shared-on-a-class-with-only-protected-or-private-const/8147213#8147213</a></p>
<p>Thoughts? </p>
<p>Thanks.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-25358">
		<div id="div-comment-25358">
		<div class="cmtinfo"><em> on <a href="#comment-25358" title="">2014-08-27 at 7:40 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/924270a1ddbb41c258a8560b25b93766?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Volker Diesel</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25358"></div><p>Ah, I see. My confusion came from the fact, that the arguments to a function are described in the standard as &#8220;a comma separated list of initilizer-clauses&#8221;.</p>
<p>In appendix A (Grammar summary), an initializer-clause is expressed as:</p>
<pre class="brush: plain; title: ; notranslate" title="">
initializer-clause:
    assignment-expression
    braced-init-list
</pre>
<p>and &#8220;assignment expression&#8221; goes all the way down to &#8220;expression , assignmend-expression&#8221;:</p>
<pre class="brush: plain; title: ; notranslate" title="">
assignment-expression:
    conditional-expression
    logical-or-expression assignment-operator initializer-clause
    throw-expression

assignment-operator: one of
    = *= /= %= += -= &gt;&gt;= &lt;&lt;= &amp;= ˆ= |=

expression:
    assignment-expression
    expression , assignment-expression
</pre>
<p>Note the comma in the last line: &#8220;expression , assignment-expression&#8221;. To my understanding, that comma really is the comma-operator, right?<br />
So in your example, when adding additional params, e.g. f( (a,b) , c), then (a , b) would make a comma-expression, while the second comma is just a more or less meaningless character (besides the fact that it separates initializers.</p>
<p>So, what I did was confusing the &#8220;meaningless&#8221; comma in &#8220;comma-separated list of initializer-clauses&#8221; with the comma in the grammar of expressions.</p>
<p>Last question: Is this a typical standard notation? Does a sentence like &#8220;a list of items seperated by comma&#8221; in the standard always refer to a &#8220;meaningless&#8221; comma, not an &#8220;expression comma&#8221;?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-25356">
		<div id="div-comment-25356">
		<div class="cmtinfo"><em> on <a href="#comment-25356" title="">2014-08-27 at 6:53 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25356"></div><p>Not all commas are the comma operator.</p>
<p>In an ordinary expression like x=(a,b,c), that&#8217;s the comma operator, and yes it could invoke an overloaded comma operator.</p>
<p>In a function call like f(a,b,c), however, the (a,b,c) is a parameter list and that comma is not the comma operator. If you wanted the comma operator there could express that, but it would require another set of parens. For example, if you wanted to make the first comma use a comma operator, you could write: g((a,b),c).</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-25332">
		<div id="div-comment-25332">
		<div class="cmtinfo"><em> on <a href="#comment-25332" title="">2014-08-27 at 12:16 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/924270a1ddbb41c258a8560b25b93766?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Volker Diesel</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25332"></div><p>According to ISO/IEC N3690, §1.9<br />
Operators can be regrouped according to the usual mathematical rules ONLY WHERE THE OPERATORS REALLY ARE ASSOCIATIVE OR COMMUTATIVE.</p>
<p>So let me write the following expression&#8230;</p>
<pre class="brush: plain; title: ; notranslate" title="">
func(shared_ptr&lt;A&gt;(new A), shared_ptr&lt;B&gt;(new B));
</pre>
<p>&#8230;a bit more verbose as pseudo-code:</p>
<pre class="brush: plain; title: ; notranslate" title="">
operator()(func, operator ,(operator()(shared_ptr&lt;A&gt;, operator new(A))), (operator()(shared_ptr&lt;B&gt;, operator new(B))))
</pre>
<p>Note that the function call operators () have highest precedence in this expression. According to the standard, an implementation is allowed to evaluate the left side of the comma before or after the right side of the comma, but it is not allowed to overrule the precedence of the stronger binding operator () and the weaker binding comma operator.</p>
<p>At least, that&#8217;s my understanding :-)</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-25306">
		<div id="div-comment-25306">
		<div class="cmtinfo"><em> on <a href="#comment-25306" title="">2014-08-26 at 2:16 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/6e5508b29d6d964efbd50701ceb23a5a?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://gravatar.com/paercebal' rel='external nofollow' class='url'>paercebal</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25306"></div><p>@Volker Diesel</p>
<p>In addition to my previous post (I hope it succeeded, because I don&#8217;t see it there)</p>
<pre class="brush: cpp; title: ; notranslate" title="">void func(const std::string &amp; arg1, const std::string &amp; arg2);
void caller()
{
    func(&quot;Hello&quot;, &quot;world&quot;);
}</pre>
<p>When you create a std::string object, it will (possibly) allocate the memory INSIDE the constructor, which means the exception safety issue must be dealt there.</p>
<p>When you write:</p>
<pre class="brush: cpp; title: ; notranslate" title="">void func(std::shared_ptr arg1, std::shared_ptr arg2);
void caller()
{
    // BEFORE
    func(shared_ptr&lt;C&gt;{new C{}}, shared_ptr&lt;C&gt;{new C{}});
    // AFTER
}</pre>
<p>The allocation is done NOT inside the shared_ptr constructor.<br />
It is done somewhere BEFORE the shared_ptr constructor is called,t hat is, somewhere in the function &#8220;caller&#8221;.</p>
<p>Somewhere is the source of the &#8220;problem&#8221;, because we can&#8217;t know for sure where. We only know it is done AFTER the full-expression that precedes the &#8220;func&#8221; function call expression, BEFORE we effectively enter the &#8220;func&#8221; function, and BEFORE we enter the shared_ptr constructor.</p>
<p>This is the point of the make_shared and make_unique function: To make sure that the actual allocation is done in a controlled setting, that is, INSIDE the make_* function, where its exception safety can be controlled.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-25305">
		<div id="div-comment-25305">
		<div class="cmtinfo"><em> on <a href="#comment-25305" title="">2014-08-26 at 2:05 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/6e5508b29d6d964efbd50701ceb23a5a?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://gravatar.com/paercebal' rel='external nofollow' class='url'>paercebal</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25305"></div><p>@Volker Diesel:</p>
<p>I know this is an argument of authority, but I guess that when one of the member of the C++ standardization committee says:</p>
<blockquote><p>Second, it avoids some known exception safety issues with naked new. Here’s an example:</p>
<pre class="brush: cpp; title: ; notranslate" title="">void sink( unique_ptr&lt;widget&gt;, unique_ptr&lt;gadget&gt; );

sink( unique_ptr&lt;widget&gt;{new widget{}},
      unique_ptr&lt;gadget&gt;{new gadget{}} ); // Q1: do you see the problem?
</pre>
<p>Briefly, if you allocate and construct the new widget first, then get an exception while allocating or constructing the new gadget, the widget is leaked.</p></blockquote>
<p>Then perhaps you should consider the possibility he/she is right. (I know I would).</p>
<p>:-)</p>
<p>Using your compiler does not mean your reasoning is right. It only means that your example and your belief of how it should behave correlates, nothing more.</p>
<p>But, for the sake of not appearing like &#8220;that guy in the classroom telling you to blindly follow the teacher&#8217;s advice&#8221;, I&#8217;ll eat my own dog food, and I&#8217;ll try to see if I can by myself find in the C++ standard the exact quotes about your problem because the truth is, I don&#8217;t know.</p>
<p>So&#8230;</p>
<p><b>Standardese Interpretation</b></p>
<blockquote><p>No matter, in which order arguments are evaluated, and no matter which of the constructors of class C throws, the first two calls are always leak-safe. The reason is, that the entire expression of each single argument is first fully evaluated, before the next argument evaluation starts.</p></blockquote>
<p>That is an assertion that should have backed up with a quote of the standard.</p>
<p>I searched a bit, and found none.</p>
<p>Note that I am not a language lawyer, and I am quite unfamiliar with the standard&#8217;s wordings and style. Which means everything I could write below could be wrong. Someone with more experience should validate that.</p>
<p>Still, I searched, and I found at 1.9/15 (n3797 draft for C++14):</p>
<blockquote><p>[ Note: Value computations and side effects associated with different argument expressions are unsequenced. —end note ]</p></blockquote>
<p>As I understand it, when you evaluate argument A and argument B, the computations (plural forms) to evaluate A are unsequenced in regard to the computations (plural forms) to evaluate B. (the plural form is important, because it acknowledges that there can be multiple computations and side effects for one argument evaluation)</p>
<p>Now, the signification of <b>unsequenced</b>, and its consequence even within one thread:</p>
<blockquote><p>[ Note: The execution of unsequenced evaluations can overlap. —end note ]</p></blockquote>
<p>If I understood correctly, this means that the evaluation of two arguments in a function call are not sequenced, and thus, can <b>overlap</b>.</p>
<p>The keyword is overlap, here. If I understand it correctly, it means, for example in the following code:</p>
<pre class="brush: cpp; title: ; notranslate" title="">foo(a + b + c, d + e + f) ;</pre>
<p>&#8230; that the implementation could well decide to first execute &#8220;a + b&#8221;, and put the result in a temporary a2, then execute &#8220;d + e&#8221;, put the result in a temporary d2, then execute &#8220;d2 + f&#8221;, and then &#8220;a2 + c&#8221;&#8230; Or any other combination.</p>
<p><b>Application on your shared_ptr example</b></p>
<p>Now that we understand expression overlaping, we can look at the shared_ptr construction.</p>
<p>This is a bit devious because when you write &#8220;new A()&#8221; (there is no arguments for simplicity&#8217;s sake), you are doing (at least) two things in one apparent expression:</p>
<p>1 &#8211; allocate memory<br />
2 &#8211; launch the constructor at that allocated address.</p>
<p>This example with new is explicitly mentioned in 1.9/15, and it redirect us to 5.3.4, which describes the unary expression &#8220;new&#8221;. In that section, there is a very interesting subsection 5.3.4/18:</p>
<blockquote><p>Initialization of the allocated object is sequenced before the value computation of the new-expression.</p></blockquote>
<p>(the section is a bit more complex, and handle what happens with arguments, that is: arguments can be evaluated after or before [but not overlaping] the memory allocation, but before construction call, of course)</p>
<p>So, when you write (I simplified your example):</p>
<pre class="brush: cpp; title: ; notranslate" title="">func(shared_ptr{new C{}}, shared_ptr{new C{}]);</pre>
<p>&#8230; what you have on your hands is the following actions:</p>
<p>1.a &#8211; allocation of memory for the first C object<br />
1.b &#8211; construction of the first C object<br />
1.c &#8211; construction of the first shared_ptr<br />
2.a &#8211; allocation of memory for the second C object<br />
2.b &#8211; construction of the second C object<br />
2.c &#8211; construction of the second shared_ptr</p>
<p>So while 1.a should happen before 1.b, and 1.b before 1.c, and 2.a should happen before 2.b, and 2.b before 2.c, the standard specifically says that the two operations 1 and 2 could overlap, which means it could be executed as:</p>
<p>1.a &#8211; allocation of memory for the first C object<br />
2.a &#8211; allocation of memory for the second C object<br />
1.b &#8211; construction of the first C object<br />
2.b &#8211; construction of the second C object<br />
1.c &#8211; construction of the first shared_ptr<br />
2.c &#8211; construction of the second shared_ptr</p>
<p>And this is where it becomes a problem, because both X.a and X.b could throw, and sometimes, they could throw before any shared_ptr had the chance of taking ownership of any pointer.</p>
<p>If you add arguments to the constructors, then the problem goes even more complicated (I won&#8217;t go there, because I believe my point is done)</p>
<p><b>Conclusion</b></p>
<p>Unless I messed up somewhere (could someone validate my [naive] reasoning?), I believe I offered the proof your reasoning is wrong, and that you always need to use make_* functions to make sure your code is exception safe.</p>
<p>You could ask why this is so complicated, and why some parts are left unspecified. My guess is <b>performance</b>. By letting the compiler implementers more freedom on a few topics we should usually not care about, we let them more optimization options.</p>
<p>Thanks,</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-25301">
		<div id="div-comment-25301">
		<div class="cmtinfo"><em> on <a href="#comment-25301" title="">2014-08-26 at 1:18 pm</a></em> <img alt='' src='https://1.gravatar.com/avatar/db892012bc52cc6cbfd27db9d98acf8b?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Greg Marr</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25301"></div><p>&#8220;No matter, in which order arguments are evaluated, and no matter which of the constructors of class C throws, the first two calls are always leak-safe. The reason is, that the entire expression of each single argument is first fully evaluated, before the next argument evaluation starts. This means, after one argument is full evaluated, a temporary shared_ptr object already exists, that holds the pointer to new C object. If during evaluation of the next argument an exception is thrown, that temporary object is destroyed and so is the newly created C object.&#8221;</p>
<p>Are you basing this assertion on just your experimentation, or do you have actual requirements from the standard that says that one entire parameter expression has to be fully evaluated before another can be started?</p>
<p>Are you *absolutely sure* that the compiler is not allowed to take this:</p>
<pre class="brush: plain; title: ; notranslate" title="">func(shared_ptr{new C{args1}}, shared_ptr{new C{args2}]);</pre>
<p>and make it work like this:</p>
<pre class="brush: plain; title: ; notranslate" title="">
C *t1 = new C{args1};
C *t2 = new C{args2};
shared_ptr&lt;C&gt; p1(t1);
shared_ptr&lt;C&gt; p2(t2);
func(p1, p2);
</pre>
<p>or even this:</p>
<pre class="brush: plain; title: ; notranslate" title="">
C *t2 = new C{args2};
C *t1 = new C{args1};
shared_ptr&lt;C&gt; p2(t2);
shared_ptr&lt;C&gt; p1(t1);
func(p1, p2);
</pre>
<p>The reason that make_shared(args1) works is that there is no way for the compiler to move code from inside make_shared before or after the call to make_shared itself.</p>
<p>&#8220;Clearly, for such calls to work, the compiler must generate temporary std::string objects, and clearly std::string’s constructor might allocate memory and therefore throw bad_alloc. &#8221;</p>
<p>That&#8217;s different.  You aren&#8217;t allocating memory and passing it to the std::string constructor, it&#8217;s the std::string constructor that is allocating the memory.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-25294">
		<div id="div-comment-25294">
		<div class="cmtinfo"><em> on <a href="#comment-25294" title="">2014-08-26 at 10:48 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/924270a1ddbb41c258a8560b25b93766?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Volker Diesel</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25294"></div><p>Here are my code snippets again, this time enclosed in code blocks. See also my additional comment at the bottom of this posting.</p>
<pre class="brush: plain; title: ; notranslate" title="">
void func(shared_ptr&lt;C&gt; a, shared_ptr&lt;C&gt; b); // function declaration
func(make_shared{args1}, make_shared{args2}); // call with make_shared, no leak.
func(shared_ptr{new C{args1}}, shared_ptr{new C{args2}]); // call with explicitly constructed shared_ptr, no leak.
func(new C{args1}, new C{args2}); // call with naked new. compile error: no implicit conversion.
</pre>
<p>Example program:</p>
<pre class="brush: plain; title: ; notranslate" title="">
#include &lt;memory&gt;
#include &lt;iostream&gt;
#include &lt;exception&gt;

class Ex : public std::logic_error
{
public:
    Ex(const std::string &amp; what) : std::logic_error{what} {}
};

class Data
{
public:
    Data(const std::string &amp; data) : m_data(data) { std::cout &lt;&lt; &quot;Data::Data(&quot; &lt;&lt; m_data &lt;&lt; &quot;)&quot; &lt;&lt; std::endl; }
    ~Data() { std::cout &lt;&lt; &quot;Data::~Data(&quot; &lt;&lt; m_data &lt;&lt; &quot;)&quot; &lt;&lt; std::endl; };
    const std::string &amp; data() const { return m_data; }
private:
    std::string m_data;
};

class C
{
public:
    C(const std::string &amp; name, bool throwSomething = false) : m_data{name}
    {
        std::cout &lt;&lt; &quot;C::C(&quot; &lt;&lt; m_data.data() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;
        if ( throwSomething )
        {
            throw Ex{m_data.data()};
        }
    }
    ~C() { std::cout &lt;&lt; &quot;C::~C(&quot; &lt;&lt; m_data.data() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl; }
private:
    Data m_data;
};

void f(std::shared_ptr&lt;C&gt; a1, std::shared_ptr&lt;C&gt; a2) {}

void test(bool useMakeShared, bool throwInFirst, bool throwInSecond)
{
    std::cout &lt;&lt; std::boolalpha &lt;&lt;
            &quot;*** Test: useMakeUnique= &quot; &lt;&lt; useMakeShared &lt;&lt;
            &quot;, throwInFirst=&quot; &lt;&lt; throwInFirst &lt;&lt;
            &quot;, throwInSecond=&quot; &lt;&lt; throwInSecond &lt;&lt; std::endl;
    try
    {
        if ( useMakeShared )
        {
            f(std::make_shared&lt;C&gt;(&quot;first&quot;, throwInFirst), std::make_shared&lt;C&gt;(&quot;second&quot;, throwInSecond));
        }
        else
        {
            f(std::shared_ptr&lt;C&gt;{new C{&quot;first&quot;, throwInFirst}}, std::shared_ptr&lt;C&gt;{new C{&quot;second&quot;, throwInSecond}});
        }
    }
    catch ( const std::exception &amp; ex )
    {
        std::cout &lt;&lt; &quot;Caught exception: &quot; &lt;&lt; ex.what() &lt;&lt; std::endl;
    }
}

int main()
{
//    test(false, false, false);
//    test(true, false, false);

//    test(false, false, true);
//    test(true, false, true);

    test(false, true, false);
    test(true, true, false);

//    test(false, true, true);
//    test(true, true, true);
}
</pre>
<p>Additional comment&#8230; consider a much more trivial and frequently used example:</p>
<pre class="brush: plain; title: ; notranslate" title="">
void func(const std::string &amp; arg1, const std::string &amp; arg2);
void caller()
{
    func(&quot;Hello&quot;, &quot;world&quot;);
}
</pre>
<p>I guess, we all have already written code like this without scratching out heads because of exception (un)safety (even in my example program above, I use such calls when creating objects of class &#8220;C&#8221; with c-style strings like &#8220;first&#8221; and &#8220;second&#8221;).<br />
Clearly, for such calls to work, the compiler must generate temporary std::string objects, and clearly std::string&#8217;s constructor might allocate memory and therefore throw bad_alloc. What, if that happens? Again, the answer is: nothing special and nothing wrong.For each argument, temporary std::string objects are placed on the stack. If that is successfully done, the function call is made, and the called function takes the temporaries on the stack as its arguments. If the creation of one of the temporaries fails (e.g. due to bad_alloc), the stack is unwound and all temporaries that have already been created are properly destroyed.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-25291">
		<div id="div-comment-25291">
		<div class="cmtinfo"><em> on <a href="#comment-25291" title="">2014-08-26 at 9:05 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/924270a1ddbb41c258a8560b25b93766?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Volker Diesel</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25291"></div><p>&#8230;and sorry&#8230; I really should have read first how to format code blocks :-)</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-25290">
		<div id="div-comment-25290">
		<div class="cmtinfo"><em> on <a href="#comment-25290" title="">2014-08-26 at 8:59 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/924270a1ddbb41c258a8560b25b93766?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Volker Diesel</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_25290"></div><p>I agree with most of the things posted here, but I&#8217;d like to point out one wrong information as well: There is no problem with memory leaks when passing multiple smart pointers to a function! No matter how it is done, it&#8217;s always leak-safe. Consider:</p>
<p>void func(shared_ptr a, shared_ptr b); // function declaration<br />
func(make_shared{args1}, make_shared{args2}); // call with make_shared, no leak.<br />
func(shared_ptr{new C{args1}}, shared_ptr{new C{args2}]); // call with explicitly constructed shared_ptr, no leak.<br />
func(new C{args1}, new C{args2}); // call with naked new. compile error: no implicit conversion.</p>
<p>No matter, in which order arguments are evaluated, and no matter which of the constructors of class C throws, the first two calls are always leak-safe. The reason is, that the entire expression of each single argument is first fully evaluated, before the next argument evaluation starts. This means, after one argument is full evaluated, a temporary shared_ptr object already exists, that holds the pointer to new C object. If during evaluation of the next argument an exception is thrown, that temporary object is destroyed and so is the newly created C object.</p>
<p>Here&#8217;s an example program, that demonstrates this behavior:</p>
<p>// =========================================<br />
#include<br />
#include<br />
#include </p>
<p>class Ex : public std::logic_error<br />
{<br />
public:<br />
    Ex(const std::string &amp; what) : std::logic_error{what} {}<br />
};</p>
<p>class Data<br />
{<br />
public:<br />
    Data(const std::string &amp; data) : m_data(data) { std::cout &lt;&lt; &quot;Data::Data(&quot; &lt;&lt; m_data &lt;&lt; &quot;)&quot; &lt;&lt; std::endl; }<br />
    ~Data() { std::cout &lt;&lt; &quot;Data::~Data(&quot; &lt;&lt; m_data &lt;&lt; &quot;)&quot; &lt;&lt; std::endl; };<br />
    const std::string &amp; data() const { return m_data; }<br />
private:<br />
    std::string m_data;<br />
};</p>
<p>class C<br />
{<br />
public:<br />
    C(const std::string &amp; name, bool throwSomething = false) : m_data{name}<br />
    {<br />
        std::cout &lt;&lt; &quot;C::C(&quot; &lt;&lt; m_data.data() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;<br />
        if ( throwSomething )<br />
        {<br />
            throw Ex{m_data.data()};<br />
        }<br />
    }<br />
    ~C() { std::cout &lt;&lt; &quot;C::~C(&quot; &lt;&lt; m_data.data() &lt;&lt; &quot;)&quot; &lt;&lt; std::endl; }<br />
private:<br />
    Data m_data;<br />
};</p>
<p>void f(std::shared_ptr a1, std::shared_ptr a2) {}</p>
<p>void test(bool useMakeShared, bool throwInFirst, bool throwInSecond)<br />
{<br />
    std::cout &lt;&lt; std::boolalpha &lt;&lt;<br />
            &quot;*** Test: useMakeUnique= &quot; &lt;&lt; useMakeShared &lt;&lt;<br />
            &quot;, throwInFirst=&quot; &lt;&lt; throwInFirst &lt;&lt;<br />
            &quot;, throwInSecond=&quot; &lt;&lt; throwInSecond &lt;&lt; std::endl;<br />
    try<br />
    {<br />
        if ( useMakeShared )<br />
        {<br />
            f(std::make_shared(&#8220;first&#8221;, throwInFirst), std::make_shared(&#8220;second&#8221;, throwInSecond));<br />
        }<br />
        else<br />
        {<br />
            f(std::shared_ptr{new C{&#8220;first&#8221;, throwInFirst}}, std::shared_ptr{new C{&#8220;second&#8221;, throwInSecond}});<br />
        }<br />
    }<br />
    catch ( const std::exception &amp; ex )<br />
    {<br />
        std::cout &lt;&lt; &quot;Caught exception: &quot; &lt;&lt; ex.what() &lt;&lt; std::endl;<br />
    }<br />
}</p>
<p>int main()<br />
{<br />
//    test(false, false, false);<br />
//    test(true, false, false);</p>
<p>//    test(false, false, true);<br />
//    test(true, false, true);</p>
<p>    test(false, true, false);<br />
    test(true, true, false);</p>
<p>//    test(false, true, true);<br />
//    test(true, true, true);<br />
}<br />
// =========================================</p>
<p>The interesting case in my environment is case number three (construction of first argument throws), because arguments are evaluated right to left on my system.</p>
<p>Here&#039;s the output:<br />
*** Test: useMakeUnique= false, throwInFirst=true, throwInSecond=false<br />
Data::Data(second)<br />
C::C(second)<br />
Data::Data(first)<br />
C::C(first)<br />
Data::~Data(first)<br />
C::~C(second)<br />
Data::~Data(second)<br />
Caught exception: first<br />
*** Test: useMakeUnique= true, throwInFirst=true, throwInSecond=false<br />
Data::Data(second)<br />
C::C(second)<br />
Data::Data(first)<br />
C::C(first)<br />
Data::~Data(first)<br />
C::~C(second)<br />
Data::~Data(second)<br />
Caught exception: first</p>
<p>First, as you can see, the output is identical, no matter whether make_shared is used or shared_ptr explicitly constructed. Second, the the output show, that there&#039;s no leak.<br />
Construction of arguments:<br />
1) Data member m_data of seconds argument is fully constructed.<br />
2) C part for second argument is fully constructed. Had I modified class shared_ptr to ouput something in its constructor, at that point we would see this output, namely the construction of a temporary shared_ptr holding the newly created second argument.<br />
3) Data member m_data of first argument is fully constructed.<br />
4) C&#039;s constructor body of first argument throws.<br />
Destruction after exception.<br />
1) The Data member m_data of the first argument is destroyed.<br />
2) The &quot;C&quot; part of the first argument is NOT destroyed, because the object has not been fully constructed.<br />
3) The &quot;C&quot; part of the second argument is destroyed.<br />
4) The data member m_data of the second argument is destroyed.  Again, had I modified class shared_ptr to output something, we would see output from ~shared_ptr of temporary object created for second argument here.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-16995">
		<div id="div-comment-16995">
		<div class="cmtinfo"><em> on <a href="#comment-16995" title="">2014-03-15 at 8:42 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/6e5508b29d6d964efbd50701ceb23a5a?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://gravatar.com/paercebal' rel='external nofollow' class='url'>paercebal</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_16995"></div><p>Having a pointer suddenly becoming null is not limited to C++&#8217;s unique_ptr.</p>
<p>C++&#8217;s shared_ptr and even C#/Java&#8217;s references can become null, just by assigning null to them, or even (in C++/C#), passing them as non-const references to functions (after that call, you can&#8217;t guarantee the pointer doesn&#8217;t point to another object&#8230; or to null).</p>
<p>We do use smart pointers to control lifetime (or more precisely, to give exclusive or shared ownership), but the lifetime of an object is a design problem which must be solved before coding.</p>
<p>This is all about RAII: Make sure the lifetime of your object is tied, directly or indirectly, to a level of the stack. Above that level, your object is always valid. Under that level, your object isn&#8217;t anymore. And in practice (my own professional experience), it works.</p>
<p>IMHO, ownership of an object can be determined by how it is passed around (in order of preference):</p>
<p>&#8211; a raw pointer: There is no ownership involved. The object is valid (or the pointer is null). Pass it by value.<br />
&#8211; a unique_ptr: Usually pass it by value (using std::move), which gives ownership.<br />
&#8211; a shared_ptr: Usually pass it by value, which shares ownership. If possible, use weak_ptr for weak shared ownership.</p>
<p>Passing a (smart or not) pointer by reference (or const reference) blurs a code review, for the reasons you mention (it is not clear if the pointer is still the same after the function call), unless the function is quite clear about what it is doing (e.g. the C++ swap function, or the C# TryParse function).</p>
<p>The return value is another problem: After all, a function could return a pointer (or a reference) to an object it owns, thus insuring a dangling pointer/reference return. In my own experience, returning a dangling pointer/reference usually happens on object declared on the stack (usually in the very same function). This is a newbie mistake, easily learned.</p>
<p>The solution is NOT relying on shared_ptr to enable a &#8220;I don&#8217;t need to care&#8221; mode where all objects are shared by everyone to play with (this is what global objects are for, and last time I checked, global objects are supposed to be an antipattern).</p>
<p>The solution is a design solution: Don&#8217;t return a pointer to something that wasn&#8217;t given to you as a pointer by the calling function (if it was given to you as a pointer, then it is owned by a level lower in the stack, so it is still alive after the return), unless you can guarantee the object&#8217;s lifetime goes beyond the function call.</p>
<p>Now, your solution is to use shared_ptr everywhere. While I did show above even shared_ptr can point to null at one moment&#8217;s notice, shared_ptr have other problems. For example, let&#8217;s say you want to close that connection to a distant server. This means calling that &#8220;close()&#8221; method of your shared object. The consequence is that every part of the code having a shared_ptr to that connection will now have an unusable object because you can&#8217;t anymore use it for anything. Isn&#8217;t that the problem you wanted to avoid the first place?</p>
<p>And this is not limited to C++: C# and Java can have the same problem, and both ended with RAII-like features (the using/disposable for C#, try-with-resource/autoclosable) in addition to their massively shared ownership semantics.</p>
<p>So, in the end, yes, you always have to think about object lifetimes. But this is a design problem. Not a smart pointer problem. The solution is a design solution. And it will involve using this or that kind of pointer which is best adapted to that decision.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-permaquid even thread-even depth-1 highlander-comment" id="comment-16991">
		<div id="div-comment-16991">
		<div class="cmtinfo"><em> on <a href="#comment-16991" title="">2014-03-15 at 6:51 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/bbc0a2b4f845be4a8d10d42734e94865?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://permaquid.wordpress.com' rel='external nofollow' class='url'>permaquid</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_16991"></div><p>The semantics of unique_ptr are more complex than shared_ptr. You have to use std::move with it; after you do so, the scope in which that was done effectively has a null pointer that can be accidentally used. Shared_ptr has neither of these problems. These things suggest the opposite conclusion: prefer shared_ptr. Also, I see that coders seem to use unique_ptr to control lifetime, but feel free to pass around raw pointers and references as if that were safe and maintainable. If various places in the code are going to use a smart pointer, it should be treated as shared.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-14278">
		<div id="div-comment-14278">
		<div class="cmtinfo"><em> on <a href="#comment-14278" title="">2014-01-31 at 1:57 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/ed625e77db7636d6b9b854d427d06848?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>J. J. Lee</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_14278"></div><p>Is there any helper template to relieve pain from make_unique to make_shared, if I decide to change from unique_ptr to shared_ptr later?</p>
<p>For example,</p>
<pre class="brush: plain; title: ; notranslate" title="">
template &lt;class SP&gt; class smart_ptr_switch
{
    template &lt;class... Args&gt; static SP make_smart(Args&amp;&amp;... args)
    {
        if (SP is some kind of unique_ptr&lt;T&gt;) {
            return std::make_unique&lt;T&gt;(new T(std::forward&lt;Args&gt;(args)...));
        } else if (SP is some kind of shared_ptr&lt;T&gt;) {
             return std::make_shared&lt;T&gt;(new T(std::forward&lt;Args&gt;(args)...));
        } else {
             static_assert ???
        }
    }
};
</pre>
<p>So I can typedef my_smart_pointer to a std::unique_ptr first. If later I change typedef my_smart_pointer to a std::shared_ptr, I don&#8217;t need to change all std::make_unque to std::make_shared.</p>
<p>If I call smart_ptr_switch::make_smart(&#8230;) and typedef std::unique_ptr my_smart_pointer, this method will return a result from make_unique.<br />
If I call smart_ptr_switch::make_smart(&#8230;) and typedef std::shared_ptr my_smart_pointer, this method will return a result from make_shared.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-14182">
		<div id="div-comment-14182">
		<div class="cmtinfo"><em> on <a href="#comment-14182" title="">2014-01-23 at 7:12 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/29d03a96b1718886fb44fb10d94f2378?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Rob Stewart</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_14182"></div><p>@Marco<br />
You are correct that the block cannot be released until the last shared_ptr/weak_ptr is destroyed. However, the object&#8217;s destructor is invoked when the last shared_ptr is destroyed.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-11242">
		<div id="div-comment-11242">
		<div class="cmtinfo"><em> on <a href="#comment-11242" title="">2013-06-12 at 5:54 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/65b9cd72cff48cb3d18ccead5ddfa238?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.lichtzeichner.li' rel='external nofollow' class='url'>Marco</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_11242"></div><p>@Herb: Another question popped up when looking at figure 2(b): make_shared allocates one single block of memory holding the strong and weak reference counters and the object itself. So if there are no shared_ptr left, but at least one weak_ptr, the whole block cannot be released, correct? So if one&#8217;s handling large objects and using shared_ptr the recommendation should be not to use make_shared? Or is there something I&#8217;m missing?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="pingback even thread-even depth-1 highlander-comment" id="comment-10999">
		<div id="div-comment-10999">
		<div class="cmtinfo"><em> on <a href="#comment-10999" title="">2013-06-05 at 11:45 pm</a></em>  <cite><a href='http://musingstudio.com/2013/06/06/herb-sutter-gotw89-smart-pointers/' rel='external nofollow' class='url'>Herb Sutter GotW89: Smart Pointers | musingstudio</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10999"></div><p>[&#8230;] Sutter&#8217;s GotW89 Smart Pointers post includes good reasons to use make_shared/make_unique instead of naked new. Avoiding memory [&#8230;]</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10895">
		<div id="div-comment-10895">
		<div class="cmtinfo"><em> on <a href="#comment-10895" title="">2013-06-04 at 11:38 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10895"></div><p>@Marco: Yes, that&#8217;s the kind of case the internal synchronization on the refcount is needed for &#8212; the user is allowed to do concurrent operations where not all are const on different objects, just not on the same object. The same case arises with polygon::area when two threads do const operations but might modify mutable state.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-nosenseetal even thread-even depth-1 highlander-comment" id="comment-10890">
		<div id="div-comment-10890">
		<div class="cmtinfo"><em> on <a href="#comment-10890" title="">2013-06-04 at 10:17 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/6aea6e2f57f2a7b1cd6870375fbdc42f?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>nosenseetal</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10890"></div><p>@herb tnx for the A,<br />
now when you explain it is doh. :D<br />
like Scott says shared prt is actually ptr_to_shared :D</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10866">
		<div id="div-comment-10866">
		<div class="cmtinfo"><em> on <a href="#comment-10866" title="">2013-06-03 at 11:04 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/65b9cd72cff48cb3d18ccead5ddfa238?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.lichtzeichner.li' rel='external nofollow' class='url'>Marco</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10866"></div><p>@Herb: Thank you very much for your explanations. I&#8217;m still not sure we are talking about the same thing.</p>
<p> class A<br />
 {   public:<br />
         int GetValue() const;<br />
 };</p>
<p>There cannot be any writers, so that is no concern here and would have to be handled externaly, anyway. But what if two threads do the following at exactly the same time:</p>
<p> shared_ptr<a> sp1(make_shared</a><a>());   // shared ptr in T1.<br />
 weak_ptr</a><a> wA(sp1);                                // weak ptr in T2.</p>
<p> T1: sp1 = nullptr;<br />
 T2: shared_ptr</a><a> sp2(wA.lock());</p>
<p>So, both threads keep a smart pointer to the same data element, one shared and one weak. At the moment T1 releases its reference T2 tries to get a new reference. This means that T1 is changing the strong refs counter at the very moment T2 is changing it as well. Do the reference counters have a barrier that guarantees thread safety in this context?</p>
<p>I&#8217;m looking forward to the GotW on thread safety. Thanks again!</a></p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10847">
		<div id="div-comment-10847">
		<div class="cmtinfo"><em> on <a href="#comment-10847" title="">2013-06-03 at 4:14 am</a></em> <img alt='' src='https://1.gravatar.com/avatar/7ac54dd1f64876196b262bd7689f2000?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Norbert Riedlin</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10847"></div><p>When I implement a class deriving from enable_shared_from_this, I usually make all constructors private and add static factory functions that create and return shared pointers to the class. As the constructors are private I cannot use make_shared in these factory functions but I have to resort to using new. At least this is true for boost::make_shared. I haven&#8217;t found a way like making some function or function template instantiation a friend of the said class to be able to use make_shared. Do I miss something?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10808">
		<div id="div-comment-10808">
		<div class="cmtinfo"><em> on <a href="#comment-10808" title="">2013-06-01 at 1:52 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10808"></div><p>@nosenseetal: No, you can&#8217;t use a unique_ptr or a shared_ptr that way. A given shared_ptr object is like any other normal object &#8212; if you have multiple concurrent accesses and one is a writer (non-const) you have to protect it using a mutex or other synchronization. What synchronization shared_ptr does internally is to protect the reference counts when they are read/written via *different* shared_ptr objects, because the caller can&#8217;t possibly know which shared_ptrs share state and figure out the right external synchronization, nor should he. The same issue arises when two strings share implementations because of refcounted copy-on-write, or with the polygon::area discussed in GotW #6b.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-nosenseetal even thread-even depth-1 highlander-comment" id="comment-10747">
		<div id="div-comment-10747">
		<div class="cmtinfo"><em> on <a href="#comment-10747" title="">2013-05-30 at 3:24 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/6aea6e2f57f2a7b1cd6870375fbdc42f?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>nosenseetal</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10747"></div><p>@herb<br />
what about my example of &#8220;spinlock&#8221; on up and sp?<br />
Isnt sp version correct program, while up is UB?<br />
Or maybe sp counter is incremented with non_seq_const mem order ?</p>
<p>btw I think you need to mention bitfields as odd(if you get how hw works not so odd) exception when talking about thread safety.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10739">
		<div id="div-comment-10739">
		<div class="cmtinfo"><em> on <a href="#comment-10739" title="">2013-05-30 at 1:34 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10739"></div><p>@Marek: Yes, unspecified. Thanks, updated.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor even thread-even depth-1 highlander-comment" id="comment-10738">
		<div id="div-comment-10738">
		<div class="cmtinfo"><em> on <a href="#comment-10738" title="">2013-05-30 at 1:31 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10738"></div><p>@Tom: I can&#8217;t easily share that, but you could try something like this (untested code follows, yours to test and fix).</p>
<pre class="brush: plain; title: ; notranslate" title="">
template&lt;typename T, typename A1&gt;
std::unique_ptr&lt;T&gt; make_unique( A1&amp;&amp; a1 )
    { return std::unique_ptr&lt;T&gt;( new T( std::forward&lt;A1&gt;(a1) ) ); }

template&lt;typename T, typename A1, typename A2&gt;
std::unique_ptr&lt;T&gt; make_unique( A1&amp;&amp; a1, A2&amp;&amp; a2 )
    { return std::unique_ptr&lt;T&gt;( new T( std::forward&lt;A1&gt;(a1), std::forward&lt;A2&gt;(a2) ) ); }

// etc. for as many constructor parameters as you want to support
</pre>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10737">
		<div id="div-comment-10737">
		<div class="cmtinfo"><em> on <a href="#comment-10737" title="">2013-05-30 at 1:26 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10737"></div><p>@andyprowl, @Chris Vine: Right you are. The issue is as described, now the spelling is fixed, thanks.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor even thread-even depth-1 highlander-comment" id="comment-10736">
		<div id="div-comment-10736">
		<div class="cmtinfo"><em> on <a href="#comment-10736" title="">2013-05-30 at 1:20 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10736"></div><p>@Marco, @nosenseetal: Virtually all types, including shared_ptr (and vector, and other types) are just as thread-safe as any old type including int &#8212; safe for concurrent reads (const operations) but require external synchronization if you know the object is shared and will have multiple threads trying to use it concurrently and at least one is a writer. The reason GotW #6b&#8217;s polygon needed &#8220;some&#8221; internal synchronization is the same reason std::shared_ptr needs &#8220;some&#8221; internal synchronization: to synchronize the under-the-covers shared state the caller can&#8217;t see and that isn&#8217;t covered by the usual external synchronization. The easy way to spot such *internal* shared state is that it&#8217;s shared state that can be modified in a const operation. That needs internal synchronization so that the caller&#8217;s usual external-sync duty of care is sufficient.</p>
<p>The only types that are not like that are basically those designed to perform inter-thread communication and synchronization, like mutex and condition_variable and atomic.</p>
<p>This is a FAQ, alas. I need to write that GotW on thread safety. Maybe later this summer&#8230;</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10735">
		<div id="div-comment-10735">
		<div class="cmtinfo"><em> on <a href="#comment-10735" title="">2013-05-30 at 1:14 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10735"></div><p>@celeborn2bealive: You’re right, I’ve updated the wording to try to make these be phrased as “prefer” rather than “always.” There are two parts to this: 1. unique_ptr and shared_ptr are to be preferred whenever possible, but you might have a reason to use another smart pointer type, such as legacy or for custom behavior you can’t achieve with deleters and allocators on unique_ptr and shared_ptr. 2. make_unique and make_shared also should be preferred wherever possible, but you might have a reason not to use make_unique or {make|allocate}_shared if you need a custom deleter or are adopting a pointer. I’ve now added this to the discussion, including mentioning allocate_shared. Thanks!</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-jlehrer even thread-even depth-1 highlander-comment" id="comment-10732">
		<div id="div-comment-10732">
		<div class="cmtinfo"><em> on <a href="#comment-10732" title="">2013-05-30 at 11:59 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c6ad1c1c64ff7192f4dac3c4c3eb1c0f?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.lehrerfamily.com/' rel='external nofollow' class='url'>jlehrer</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10732"></div><p>&#8220;c/c++ malloc works very deterministic and there is no intelligence. first free block that fits the size or more (requested) will be returned.&#8221;<br />
“system tries to minimize fragmentation”</p>
<p>None of this is true.  C++ does not dictate how the memory allocation routines should allocate their memory.  This is completely implementation defined (as long as certain rules are followed regarding alignment).</p>
<p>On my highly specialized platform we wrote a custom allocator that has zero overhead for the common allocation sizes while maintaining the normal overhead for all other allocation sizes.  We also don&#8217;t have a fragmentation problem with these common sizes.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10716">
		<div id="div-comment-10716">
		<div class="cmtinfo"><em> on <a href="#comment-10716" title="">2013-05-30 at 8:22 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/f6830f73ecf9a6bda6d1fe61f2655cf0?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Eric Fortin</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10716"></div><p>@Andrew Marshall weak_ptr gets notified when the object is deleted and will prevent you from accessing it where a raw pointer will let you do anything with the already deleted object sending you in undefined land.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10711">
		<div id="div-comment-10711">
		<div class="cmtinfo"><em> on <a href="#comment-10711" title="">2013-05-30 at 5:02 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c7d819019894a38e26620c9b659c22f6?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://twitter.com/ppetrovdotnet' rel='external nofollow' class='url'>pip010 (@ppetrovdotnet)</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10711"></div><p>@Herb<br />
&#8220;If you use make_shared to allocate the object and the shared_ptr all in one go, then the implementation can fold them together in a single allocation&#8221;<br />
could you please elaborate more on the impl. details, how?</p>
<p>looking at VS2012 ans std::make_shared<br />
I see 2 new calls:</p>
<p>new _Ref_count_obj(LIST(_FORWARD_ARG)); //inside make_shared<br />
::new ((void *)&amp;_Storage) _Ty(LIST(_FORWARD_ARG));//inside _Ref_count_obj</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10710">
		<div id="div-comment-10710">
		<div class="cmtinfo"><em> on <a href="#comment-10710" title="">2013-05-30 at 3:50 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c7d819019894a38e26620c9b659c22f6?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://twitter.com/ppetrovdotnet' rel='external nofollow' class='url'>pip010 (@ppetrovdotnet)</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10710"></div><p>@Marco<br />
&#8220;The two memory blocks will in general have very different sizes &#8221; &#8211; thats ok.<br />
&#8220;may life in far far away areas of the memory because the system tries to minimize fragmentation&#8221; &#8211; c/c++ malloc works very deterministic and there is no intelligence. first free block that fits the size or more (requested) will be returned. AFIK there is no such thing: &#8220;system tries to minimize fragmentation&#8221;<br />
now considering the &#8216;administration&#8217; data along each shared_ptr is minimal , chances are it wont cause allocation to come from another block, but most likely same block will fit the two counts and the data you ask.<br />
but now that I explained what malloc will do. YES I can answer my own question, that it is indeed possible to defragment the mem, regardless whether you have a malloc in between !</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10707">
		<div id="div-comment-10707">
		<div class="cmtinfo"><em> on <a href="#comment-10707" title="">2013-05-30 at 2:28 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/65b9cd72cff48cb3d18ccead5ddfa238?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.lichtzeichner.li' rel='external nofollow' class='url'>Marco</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10707"></div><p>@pip010: The two memory blocks will in general have very different sizes and may life in far far away areas of the memory because the system tries to minimize fragmentation.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10705">
		<div id="div-comment-10705">
		<div class="cmtinfo"><em> on <a href="#comment-10705" title="">2013-05-30 at 2:21 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c7d819019894a38e26620c9b659c22f6?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://twitter.com/ppetrovdotnet' rel='external nofollow' class='url'>pip010 (@ppetrovdotnet)</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10705"></div><p>well, instead:<br />
void sink( unique_ptr, unique_ptr );</p>
<p>unique_ptr arg1(new widget{});<br />
unique_ptr arg2(new gadget{});<br />
//&#8211;exception line<br />
sink(arg1,arg2);</p>
<p>so here it goes. same exception-safety :)</p>
<p>about: &#8220;It reduces allocation overhead, including memory fragmentation&#8221;<br />
correct me if I&#8217;m mistaken but in order to really create fragmentation.<br />
something needs to allocate between new gadget() and new unique_ptr().<br />
is that even possible? if we assume we are in 1process-1thread app?</p>
<p>same goes for locality?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10704">
		<div id="div-comment-10704">
		<div class="cmtinfo"><em> on <a href="#comment-10704" title="">2013-05-30 at 2:20 am</a></em> <img alt='' src='https://1.gravatar.com/avatar/4a5e5ded3c766d9731b52b213cb4cf2a?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Marek</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10704"></div><p>&gt; The answer is no, because C++ leaves the order of evaluation of function arguments undefined&#8230;</p>
<p>I think it is unspecified not undefined.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10701">
		<div id="div-comment-10701">
		<div class="cmtinfo"><em> on <a href="#comment-10701" title="">2013-05-30 at 1:40 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/b08e83da5a83b24f103521ec7d5c6889?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>tr3w</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10701"></div><p>If I&#8217;m not mistaken, the smart and weak ptr works like this:<br />
Let say we have a smart and a weak ptr pointing to the same object.<br />
Now we destroy the smart_ptr: since no other owning ptr is present, it call&#8217;s the destructor of the pointed object, and it even deallocates it. But it won&#8217;t deallocate the control block.<br />
Now we destroy the weak_ptr, and it will deallocate the control block.</p>
<p>But here is the catch: If we used make_shared, the shared_ptr destructor can&#8217;t deallocate the area of the pointed object, only the weak_ptr will deallocate it (when it gets rid of the control block).</p>
<p>Am I right?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10699">
		<div id="div-comment-10699">
		<div class="cmtinfo"><em> on <a href="#comment-10699" title="">2013-05-29 at 11:46 pm</a></em> <img alt='' src='https://1.gravatar.com/avatar/a44537592779786cdf01199e35a44690?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Jeff Sullivan</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10699"></div><p>Given that make_unique and make_shared can aggregate the memory allocation for the ref –counting together with that for the pointed at T, how does that play with class member operator::new() and operator::delete()? Depending on how this is managed you are either going to inherit the custom operators (which would be bad if it an allocator that assumes it only ever has to allocate sizeof(T)  objects), or you are going to entirely circumvent efforts by a class designer to provide specific allocation facilities (which might lead to memory fragmentation and poor performance due to broken cache coherency, or simple failure to work if all members of a class are supposed to be in some shared memory pool). </p>
<p>It would seem to be worthwhile pointing out that mixing classes with custom allocators together with make_shared or make_unique is  a Bad Idea.</p>
<p>To solve the problem for shared_ptr there is allocate_shared() that will take an allocator  for generating  shared_ptr which  will get the same result  as a custom operator::new()/operator ::delete() set (with a little rewriting) ,  However the only references I can find to “allocate_unique” are to Oracle DBMS systems…. Is this another candidate for the “Oops, we should have done that” C++14 list, or are there some subtleties I haven’t considered?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10697">
		<div id="div-comment-10697">
		<div class="cmtinfo"><em> on <a href="#comment-10697" title="">2013-05-29 at 10:44 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/65b9cd72cff48cb3d18ccead5ddfa238?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.lichtzeichner.li' rel='external nofollow' class='url'>Marco</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10697"></div><p>Thanks for the answer. I was referring to the reference counter. Good to know it is thread safe. We have had our own implementation of smart and weak pointers. Now we&#8217;re about to go to VS 2012, so I&#8217;m looking forward using all these great new features!</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10682">
		<div id="div-comment-10682">
		<div class="cmtinfo"><em> on <a href="#comment-10682" title="">2013-05-29 at 3:26 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/56eb8367539a955ed8433201230eb28d?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Chris Vine</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10682"></div><p>&#8220;sink( new widget{}, new gadget{} );     // Q1: can you spot the problem?&#8221;</p>
<p>The principal problem with this is that it will not compile, because unique_ptr&#8217;s constructor taking a pointer is explicit.</p>
<pre class="brush: plain; title: ; notranslate" title="">
sink(std::unique_ptr&lt;widget&gt;{new widget{}}, std::unique_ptr&lt;gadget&gt;{new gadget{}});
</pre>
<p>will compile but is not exception safe.  Not only is the order of evaluation of the arguments unspecified, but the compiler is entitled to to construct gadget, and then before initializing the unique_ptr to take gadget construct widget, and only then construct the unique_ptr objects.  Of course, it would be a very odd compiler which did it this way.  Allowing this loose evaluation is in my view a defect in the standard, but I know that most others disagree.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10678">
		<div id="div-comment-10678">
		<div class="cmtinfo"><em> on <a href="#comment-10678" title="">2013-05-29 at 2:52 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/8e9440a2ced114d8d21ee7e53fbf7293?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>David Svoboda</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10678"></div><p>Great article but I have one question. I always assumed that you cannot make a vector of unique pointers of objects because the vector demands that an object always be copyable. And unique pointers are definitely not copyable. Perhaps the move semantics in C++ 11 Are what enables the creation of a vector of unique pointers.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-jlehrer even thread-even depth-1 highlander-comment" id="comment-10677">
		<div id="div-comment-10677">
		<div class="cmtinfo"><em> on <a href="#comment-10677" title="">2013-05-29 at 2:46 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c6ad1c1c64ff7192f4dac3c4c3eb1c0f?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.lehrerfamily.com/' rel='external nofollow' class='url'>jlehrer</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10677"></div><p>Responding to celeborn2bealive</p>
<p>&#8220;when you allocate memory from a dynamic library, that memory must be freed in the code of the library.&#8221;</p>
<p>says who?  the C++ library says nothing about that.  I know that with Visual C++, given certain compiler flags, that might be true.  But it certainly isn&#8217;t true on any platform I use.</p>
<p>If that is true on your platform, then you have some choices. My preferred method is to use an object factory which returns a shared_ptr.  The shared_ptr, at construction time, encodes a pointer to the destruction function.  The object factory then both constructs the new object AND encodes the destructor function, for free.  When the shared_ptr&#8217;s counts go to 0, the caller, even if in a different library/toolkit/translation unit, still calls back into the same TU as the object factory to free the memory.  Again, this happens automatically because the destructor function is populated in the same TU as the initial construction of the referenced object in the shared_ptr.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10673">
		<div id="div-comment-10673">
		<div class="cmtinfo"><em> on <a href="#comment-10673" title="">2013-05-29 at 2:10 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/f4bc264d728be2aba65da525976ecbcb?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Michael Winterberg</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10673"></div><p>nosenseetal: I think that you need to use the overloads of atomic_load and atomic_store that take shared_ptr for that to be acceptable. i.e. I&#8217;m pretty sure that individual instances of shared_ptr are not thread safe, only the reference counts that may be shared between multiple instances of a shared_ptr are.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-andyprowl even thread-even depth-1 highlander-comment" id="comment-10672">
		<div id="div-comment-10672">
		<div class="cmtinfo"><em> on <a href="#comment-10672" title="">2013-05-29 at 2:04 pm</a></em> <img alt='' src='https://1.gravatar.com/avatar/d1ca7ad4c0405d5cea6aaff0da1718fa?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>andyprowl</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10672"></div><p>I think the first two calls to sink() (in the answer to Q3) should not compile, since the constructor of unique_ptr that accepts a raw pointer is marked as explicit. Am I overlooking something?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10669">
		<div id="div-comment-10669">
		<div class="cmtinfo"><em> on <a href="#comment-10669" title="">2013-05-29 at 12:51 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/ca391c038b300a739462dae91c5e8cbc?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Adrian</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10669"></div><p>What happens if the class being instantiated with make_shared has class-specific new and delete operators? Will make_shared use that one (and thus still make a separate allocation for the control block)?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10668">
		<div id="div-comment-10668">
		<div class="cmtinfo"><em> on <a href="#comment-10668" title="">2013-05-29 at 12:38 pm</a></em> <img alt='' src='https://1.gravatar.com/avatar/d2a97fcba555c029723d7c353345a974?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Kobi Cohen-Arazi</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10668"></div><p>@herb<br />
One of the nice things in C++ is that you don&#8217;t pay for something you do not use.<br />
However, using shared_ptr in the context of a single threaded env/module incur the atomic op overhead.<br />
It might be negligible in some scenarios, but in others, it might be a good reason not to use it.<br />
Any thoughts about it? Are we going to see a shared_ptr w/o locks somewhere in the future?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10667">
		<div id="div-comment-10667">
		<div class="cmtinfo"><em> on <a href="#comment-10667" title="">2013-05-29 at 12:29 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/6e5508b29d6d964efbd50701ceb23a5a?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://gravatar.com/paercebal' rel='external nofollow' class='url'>paercebal</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10667"></div><p>@Anders Dalvander</p>
<p>A solution is to write your own &#8220;make_my_shared&#8221; insuring it will be expection safe and the new will be done outside the standard make_shared.</p>
<p>This way, you keep the exception safety and follow the &#8220;don&#8217;t-write-naked-new&#8221; guideline, all the while separating the memory for the reference counters from the memory for your very-large-object.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10665">
		<div id="div-comment-10665">
		<div class="cmtinfo"><em> on <a href="#comment-10665" title="">2013-05-29 at 12:10 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/21f707f19f0310b7094e7142f52a6107?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Anders Dalvander</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10665"></div><p>make_shared can be wasteful if you have large objects and weak_ptr to these shared objects as the memory for the large object cannot be deallocated before the last weak_ptr has been destroyed. Sometimes it is better to use new instead of make_shared.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-nosenseetal odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10664">
		<div id="div-comment-10664">
		<div class="cmtinfo"><em> on <a href="#comment-10664" title="">2013-05-29 at 11:49 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/6aea6e2f57f2a7b1cd6870375fbdc42f?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>nosenseetal</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10664"></div><p>@herb<br />
There are three major reasons to say “when in doubt, prefer unique_ptr.”<br />
well I have one reason to prefer SP:<br />
by default it is &#8220;thread safe&#8221; (big &#8220;&#8221;)<br />
aka afaik<br />
(this is ok, but wasteful)<br />
while (!sp)<br />
{<br />
}<br />
//use sp</p>
<p>(this is not ok)<br />
while (!up)<br />
{<br />
}<br />
//use up</p>
<p>(up, sp set in other thread)<br />
Am I wrong to think that SP is thread &#8220;safer&#8221;  :P than UP ? </p>
<p>@marco<br />
yes but that doesnt mean that what it points to is magically &#8220;locked&#8221; when you use it. :)<br />
boost sp has option to disalbe thread safety<br />
If your program is single-threaded and does not link to any libraries that might have used shared_ptr in its default configuration, you can #define the macro BOOST_SP_DISABLE_THREADS on a project-wide basis to switch to ordinary non-atomic reference count updates.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10660">
		<div id="div-comment-10660">
		<div class="cmtinfo"><em> on <a href="#comment-10660" title="">2013-05-29 at 11:27 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/65b9cd72cff48cb3d18ccead5ddfa238?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://lichtzeichner.li' rel='external nofollow' class='url'>Marco</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10660"></div><p>One thing we were discussing about a lot: are c++ shared_ptr threadsafe?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-tomkirbygreen odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10659">
		<div id="div-comment-10659">
		<div class="cmtinfo"><em> on <a href="#comment-10659" title="">2013-05-29 at 11:24 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/6da9993d8784d5bfacf9f781dfa8ea39?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://tomkirbygreen.wordpress.com' rel='external nofollow' class='url'>Tom Kirby-Green</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10659"></div><p>Hi Herb, is there any chance you could post somewhere your preferred pre &#8216;Milan&#8217; (variadics) implementation for VS2012 Update 2 MSVC developers who want to use a pseudo blessed implementation of make_unique today?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-10658">
		<div id="div-comment-10658">
		<div class="cmtinfo"><em> on <a href="#comment-10658" title="">2013-05-29 at 11:22 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/56fcb2c98bd1ccf4fd6b7d94bcf2bf70?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://gravatar.com/celeborn2bealive' rel='external nofollow' class='url'>celeborn2bealive</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10658"></div><p>Very interesting, I love your articles :) But I have a question about make_unique() and make_shared(): If i don&#8217;t say bullshit, when you allocate memory from a dynamic library, that memory must be freed in the code of the library. So for exemple if I have a function with the following signature in my library:</p>
<pre class="brush: plain; title: ; notranslate" title=""> std::unique_ptr&lt;Widget&gt; createButton(); </pre>
<p>I don&#8217;t understand how the compiler do things right to release the memory for the Widget in the library code (if it does&#8230;) since unique_ptr is a template class and I think its code will be instanciated in the client code.</p>
<p>I know I can provide a custom deleter for the pointer (std::unique_ptr createButton();) to be sure, but in that case I cannot use make_unique() to create it (the same question holds for shared_ptr and it&#8217;s Deleter functor).</p>
<p>Thank you for your answer and correct me if I&#8217;m wrong :)</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-10654">
		<div id="div-comment-10654">
		<div class="cmtinfo"><em> on <a href="#comment-10654" title="">2013-05-29 at 11:04 am</a></em> <img alt='' src='https://i1.wp.com/a0.twimg.com/profile_images/3405601452/bf59b691af357d59f6b49f121361c675_normal.jpeg?resize=48%2C48' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://twitter.com/planetmarshall' rel='external nofollow' class='url'>Andrew Marshall (@planetmarshall)</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10654"></div><p>What&#8217;s the advantage (if any) of weak_ptr over a non-owning raw pointer?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-herbsutter bypostauthor even thread-even depth-1 highlander-comment" id="comment-10652">
		<div id="div-comment-10652">
		<div class="cmtinfo"><em> on <a href="#comment-10652" title="">2013-05-29 at 10:52 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c0ba56bfd231f8f04feb057728975181?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.herbsutter.com' rel='external nofollow' class='url'>Herb Sutter</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_10652"></div><p>BTW, the reason I&#8217;m posting #89 to #91 in faster succession is because we already saw versions of these exactly one year ago, as then-numbered #103 to #105, so some of the comment discussion about them would be duplicated and I also wanted to get more quickly to the solution for the third which I didn&#8217;t post last year. I think you&#8217;ll see that all three have been considerably updated since the initial three questions and two solutions I posted a year ago &#8212; and not just because of make_unique, and its corollary don&#8217;t-write-new, but also some other C++14-isms including in the one after this.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>
	<br />

  	<p class="nocomments">Comments are closed.</p>
  <div class="post-content">
<p>
</p>
</div>

			</div>

		
		<p align="center"></p>

	</div><!-- end id:content-main -->
<div id="sidebar">
<ul>
<li class="sidebox"><h2><label for="subscribe-field">Follow by email</label></h2>
				<form action="https://subscribe.wordpress.com" method="post" accept-charset="utf-8" id="subscribe-blog">
																	<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" placeholder="Enter your email address" value="" id="subscribe-field"/></p>
					
					<p>
						<input type="hidden" name="action" value="subscribe"/>
						<input type="hidden" name="blog_id" value="3379246"/>
						<input type="hidden" name="source" value="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/"/>
						<input type="hidden" name="sub-type" value="widget"/>
						<input type="hidden" name="redirect_fragment" value="blog_subscription-3" />
						<input type="hidden" id="_wpnonce" name="_wpnonce" value="4590924cc6" />						<input type="submit" value="Subscribe" />
					</p>
				</form>
			
</li><li class="sidebox"><h2><a href='http://twitter.com/herbsutter'>Tweets</a></h2><ul class='tweets'></ul><a href="http://twitter.com/herbsutter"  class='twitter-follow-button' data-show-count='false' data-link-color='#265e15' data-text-color='#333333'>Follow @herbsutter</a></li><li class="sidebox"><h2>Popular</h2><ul>				<li>
										<a href="https://herbsutter.com/2018/11/13/trip-report-fall-iso-c-standards-meeting-san-diego/" class="bump-view" data-bump-view="tp">
						Trip report: Fall ISO C++ standards meeting (San Diego)					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/gotw/" class="bump-view" data-bump-view="tp">
						GotW					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/2018/09/20/lifetime-profile-v1-0-posted/" class="bump-view" data-bump-view="tp">
						Lifetime profile v1.0 posted					</a>
										</li>
				</ul></li><li class="sidebox"><h2>Categories</h2>		<ul>
				<li class="cat-item cat-item-291"><a href="https://herbsutter.com/category/apple/" >Apple</a>
</li>
	<li class="cat-item cat-item-49277"><a href="https://herbsutter.com/category/c-net/" >C# / .NET</a>
</li>
	<li class="cat-item cat-item-2426"><a href="https://herbsutter.com/category/c/" >C++</a>
</li>
	<li class="cat-item cat-item-69816"><a href="https://herbsutter.com/category/cloud/" >Cloud</a>
</li>
	<li class="cat-item cat-item-214618"><a href="https://herbsutter.com/category/concurrency/" >Concurrency</a>
</li>
	<li class="cat-item cat-item-8259773"><a href="https://herbsutter.com/category/effective-concurrency/" >Effective Concurrency</a>
</li>
	<li class="cat-item cat-item-3696745"><a href="https://herbsutter.com/category/friday-thoughts/" >Friday Thoughts</a>
</li>
	<li class="cat-item cat-item-3867746"><a href="https://herbsutter.com/category/c/gotw/" >GotW</a>
</li>
	<li class="cat-item cat-item-79"><a href="https://herbsutter.com/category/hardware/" >Hardware</a>
</li>
	<li class="cat-item cat-item-1017"><a href="https://herbsutter.com/category/java/" >Java</a>
</li>
	<li class="cat-item cat-item-637"><a href="https://herbsutter.com/category/microsoft/" >Microsoft</a>
</li>
	<li class="cat-item cat-item-420845"><a href="https://herbsutter.com/category/opinion-editorial/" >Opinion &amp; Editorial</a>
</li>
	<li class="cat-item cat-item-1633077"><a href="https://herbsutter.com/category/reader-qa/" >Reader Q&amp;A</a>
</li>
	<li class="cat-item cat-item-2301"><a href="https://herbsutter.com/category/software-development/" >Software Development</a>
</li>
	<li class="cat-item cat-item-393523"><a href="https://herbsutter.com/category/talks-events/" >Talks &amp; Events</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://herbsutter.com/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-151"><a href="https://herbsutter.com/category/web/" >Web</a>
</li>
		</ul>
			</li></ul>
</div><!-- end id:sidebar -->
</div><!-- end id:content -->
</div><!-- end id:container -->
<div id="footer">
	<div id="colophon">
		<p><a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></p>
		<p>WPThemes.</p>
		<br class="clear" />
	</div><!-- end #colophon-->
</div><!-- end #footer-->
<!--  -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201847y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	<div class="grofile-hash-map-566d3c834c35555f27dd83776ef4f80c">
	</div>
	<div class="grofile-hash-map-924270a1ddbb41c258a8560b25b93766">
	</div>
	<div class="grofile-hash-map-c0ba56bfd231f8f04feb057728975181">
	</div>
	<div class="grofile-hash-map-6e5508b29d6d964efbd50701ceb23a5a">
	</div>
	<div class="grofile-hash-map-db892012bc52cc6cbfd27db9d98acf8b">
	</div>
	<div class="grofile-hash-map-bbc0a2b4f845be4a8d10d42734e94865">
	</div>
	<div class="grofile-hash-map-ed625e77db7636d6b9b854d427d06848">
	</div>
	<div class="grofile-hash-map-29d03a96b1718886fb44fb10d94f2378">
	</div>
	<div class="grofile-hash-map-65b9cd72cff48cb3d18ccead5ddfa238">
	</div>
	<div class="grofile-hash-map-6aea6e2f57f2a7b1cd6870375fbdc42f">
	</div>
	<div class="grofile-hash-map-7ac54dd1f64876196b262bd7689f2000">
	</div>
	<div class="grofile-hash-map-c6ad1c1c64ff7192f4dac3c4c3eb1c0f">
	</div>
	<div class="grofile-hash-map-f6830f73ecf9a6bda6d1fe61f2655cf0">
	</div>
	<div class="grofile-hash-map-c7d819019894a38e26620c9b659c22f6">
	</div>
	<div class="grofile-hash-map-4a5e5ded3c766d9731b52b213cb4cf2a">
	</div>
	<div class="grofile-hash-map-b08e83da5a83b24f103521ec7d5c6889">
	</div>
	<div class="grofile-hash-map-a44537592779786cdf01199e35a44690">
	</div>
	<div class="grofile-hash-map-56eb8367539a955ed8433201230eb28d">
	</div>
	<div class="grofile-hash-map-8e9440a2ced114d8d21ee7e53fbf7293">
	</div>
	<div class="grofile-hash-map-f4bc264d728be2aba65da525976ecbcb">
	</div>
	<div class="grofile-hash-map-d1ca7ad4c0405d5cea6aaff0da1718fa">
	</div>
	<div class="grofile-hash-map-ca391c038b300a739462dae91c5e8cbc">
	</div>
	<div class="grofile-hash-map-d2a97fcba555c029723d7c353345a974">
	</div>
	<div class="grofile-hash-map-21f707f19f0310b7094e7142f52a6107">
	</div>
	<div class="grofile-hash-map-6da9993d8784d5bfacf9f781dfa8ea39">
	</div>
	<div class="grofile-hash-map-56fcb2c98bd1ccf4fd6b7d94bcf2bf70">
	</div>
	<div class="grofile-hash-map-77693c1d64689d85b9d91bf05be1ac6e">
	</div>
	</div>
<script type='text/javascript' charset='UTF-8' id='polldaddyRatings'><!--//--><![CDATA[//><!--
PDRTJS_settings_468178_comm_34416={"id":468178,"unique_id":"wp-comment-34416","title":"%26%23091%3B%26%238230%3B%26%23093%3B%20Herb%20Sutter%20has%20a%20nice%20explanation%20on%20GotW%20%2389%3A%20%26%23091%3B%26%238230%3B%26%23093%3B...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-34416","item_id":"_comm_34416"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_34416 == 'undefined' ){PDRTJS_468178_comm_34416 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_34416 );}}PDRTJS_settings_468178_comm_29613={"id":468178,"unique_id":"wp-comment-29613","title":"One%20big%20downside%20of%20make_shared%28%29%20is%20that%20it%20doesn%26%23039%3Bt%20work%20with%20private%2Fprotected%20constructors.%20We%20instead%20have%20to%20jump%20through%20hoops%20%2F%20define%20our%20own%20factory%20functions%20to%20do%20this--or%20at%20least%20fro...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-29613","item_id":"_comm_29613"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_29613 == 'undefined' ){PDRTJS_468178_comm_29613 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_29613 );}}PDRTJS_settings_468178_comm_25358={"id":468178,"unique_id":"wp-comment-25358","title":"Ah%2C%20I%20see.%20My%20confusion%20came%20from%20the%20fact%2C%20that%20the%20arguments%20to%20a%20function%20are%20described%20in%20the%20standard%20as%20%26quot%3Ba%20comma%20separated%20list%20of%20initilizer-clauses%26quot%3B.In%20appendix%20A%20%28Grammar%20summary%29%2C%20an%20in...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25358","item_id":"_comm_25358"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25358 == 'undefined' ){PDRTJS_468178_comm_25358 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25358 );}}PDRTJS_settings_468178_comm_25356={"id":468178,"unique_id":"wp-comment-25356","title":"Not%20all%20commas%20are%20the%20comma%20operator.In%20an%20ordinary%20expression%20like%20x%3D%28a%2Cb%2Cc%29%2C%20that%26%23039%3Bs%20the%20comma%20operator%2C%20and%20yes%20it%20could%20invoke%20an%20overloaded%20comma%20operator.In%20a%20function%20call%20like%20f%28a%2Cb%2Cc%29%2C%20h...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25356","item_id":"_comm_25356"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25356 == 'undefined' ){PDRTJS_468178_comm_25356 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25356 );}}PDRTJS_settings_468178_comm_25332={"id":468178,"unique_id":"wp-comment-25332","title":"According%20to%20ISO%2FIEC%20N3690%2C%201.9Operators%20can%20be%20regrouped%20according%20to%20the%20usual%20mathematical%20rules%20ONLY%20WHERE%20THE%20OPERATORS%20REALLY%20ARE%20ASSOCIATIVE%20OR%20COMMUTATIVE.So%20let%20me%20write%20the%20following%20ex...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25332","item_id":"_comm_25332"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25332 == 'undefined' ){PDRTJS_468178_comm_25332 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25332 );}}PDRTJS_settings_468178_comm_25306={"id":468178,"unique_id":"wp-comment-25306","title":"%40Volker%20DieselIn%20addition%20to%20my%20previous%20post%20%28I%20hope%20it%20succeeded%2C%20because%20I%20don%26%23039%3Bt%20see%20it%20there%29%26%23091%3Bcode%20language%3D%26quot%3Bcpp%26quot%3B%26%23093%3Bvoid%20func%28const%20std%3A%3Astring%20%26amp%3B%20arg1%2C%20const%20std%3A%3Astring%20%26amp%3B%20arg2%29%3Bvoid%20ca...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25306","item_id":"_comm_25306"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25306 == 'undefined' ){PDRTJS_468178_comm_25306 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25306 );}}PDRTJS_settings_468178_comm_25305={"id":468178,"unique_id":"wp-comment-25305","title":"%40Volker%20Diesel%3AI%20know%20this%20is%20an%20argument%20of%20authority%2C%20but%20I%20guess%20that%20when%20one%20of%20the%20member%20of%20the%20C%2B%2B%20standardization%20committee%20says%3A%26lt%3Bblockquote%26gt%3BSecond%2C%20it%20avoids%20some%20known%20exception%20safety...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25305","item_id":"_comm_25305"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25305 == 'undefined' ){PDRTJS_468178_comm_25305 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25305 );}}PDRTJS_settings_468178_comm_25301={"id":468178,"unique_id":"wp-comment-25301","title":"%26quot%3BNo%20matter%2C%20in%20which%20order%20arguments%20are%20evaluated%2C%20and%20no%20matter%20which%20of%20the%20constructors%20of%20class%20C%20throws%2C%20the%20first%20two%20calls%20are%20always%20leak-safe.%20The%20reason%20is%2C%20that%20the%20entire%20expression%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25301","item_id":"_comm_25301"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25301 == 'undefined' ){PDRTJS_468178_comm_25301 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25301 );}}PDRTJS_settings_468178_comm_25294={"id":468178,"unique_id":"wp-comment-25294","title":"Here%20are%20my%20code%20snippets%20again%2C%20this%20time%20enclosed%20in%20code%20blocks.%20See%20also%20my%20additional%20comment%20at%20the%20bottom%20of%20this%20posting.%26%23091%3Bcode%26%23093%3Bvoid%20func%28shared_ptr%26lt%3BC%26gt%3B%20a%2C%20shared_ptr%26lt%3BC%26gt%3B%20b%29%3B%20%2F%2F%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25294","item_id":"_comm_25294"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25294 == 'undefined' ){PDRTJS_468178_comm_25294 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25294 );}}PDRTJS_settings_468178_comm_25291={"id":468178,"unique_id":"wp-comment-25291","title":"...and%20sorry...%20I%20really%20should%20have%20read%20first%20how%20to%20format%20code%20blocks%20%3A-%29...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25291","item_id":"_comm_25291"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25291 == 'undefined' ){PDRTJS_468178_comm_25291 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25291 );}}PDRTJS_settings_468178_comm_25290={"id":468178,"unique_id":"wp-comment-25290","title":"I%20agree%20with%20most%20of%20the%20things%20posted%20here%2C%20but%20I%26%23039%3Bd%20like%20to%20point%20out%20one%20wrong%20information%20as%20well%3A%20There%20is%20no%20problem%20with%20memory%20leaks%20when%20passing%20multiple%20smart%20pointers%20to%20a%20function%21%20No%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-25290","item_id":"_comm_25290"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_25290 == 'undefined' ){PDRTJS_468178_comm_25290 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_25290 );}}PDRTJS_settings_468178_comm_16995={"id":468178,"unique_id":"wp-comment-16995","title":"Having%20a%20pointer%20suddenly%20becoming%20null%20is%20not%20limited%20to%20C%2B%2B%26%23039%3Bs%20unique_ptr.C%2B%2B%26%23039%3Bs%20shared_ptr%20and%20even%20C%23%2FJava%26%23039%3Bs%20references%20can%20become%20null%2C%20just%20by%20assigning%20null%20to%20them%2C%20or%20even%20%28in%20C%2B%2B%2FC%23%29%2C%20pas...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-16995","item_id":"_comm_16995"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_16995 == 'undefined' ){PDRTJS_468178_comm_16995 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_16995 );}}PDRTJS_settings_468178_comm_16991={"id":468178,"unique_id":"wp-comment-16991","title":"The%20semantics%20of%20unique_ptr%20are%20more%20complex%20than%20shared_ptr.%20You%20have%20to%20use%20std%3A%3Amove%20with%20it%3B%20after%20you%20do%20so%2C%20the%20scope%20in%20which%20that%20was%20done%20effectively%20has%20a%20null%20pointer%20that%20can%20be%20accid...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-16991","item_id":"_comm_16991"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_16991 == 'undefined' ){PDRTJS_468178_comm_16991 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_16991 );}}PDRTJS_settings_468178_comm_14278={"id":468178,"unique_id":"wp-comment-14278","title":"Is%20there%20any%20helper%20template%20to%20relieve%20pain%20from%20make_unique%20to%20make_shared%2C%20if%20I%20decide%20to%20change%20from%20unique_ptr%20to%20shared_ptr%20later%3FFor%20example%2C%26%23091%3Bcode%26%23093%3Btemplate%20%26lt%3Bclass%20SP%26gt%3B%20class%20smart_ptr...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-14278","item_id":"_comm_14278"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_14278 == 'undefined' ){PDRTJS_468178_comm_14278 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_14278 );}}PDRTJS_settings_468178_comm_14182={"id":468178,"unique_id":"wp-comment-14182","title":"%40MarcoYou%20are%20correct%20that%20the%20block%20cannot%20be%20released%20until%20the%20last%20shared_ptr%2Fweak_ptr%20is%20destroyed.%20However%2C%20the%20object%26%23039%3Bs%20destructor%20is%20invoked%20when%20the%20last%20shared_ptr%20is%20destroyed....","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-14182","item_id":"_comm_14182"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_14182 == 'undefined' ){PDRTJS_468178_comm_14182 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_14182 );}}PDRTJS_settings_468178_comm_11242={"id":468178,"unique_id":"wp-comment-11242","title":"%40Herb%3A%20Another%20question%20popped%20up%20when%20looking%20at%20figure%202%28b%29%3A%20make_shared%20allocates%20one%20single%20block%20of%20memory%20holding%20the%20strong%20and%20weak%20reference%20counters%20and%20the%20object%20itself.%20So%20if%20there%20a...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-11242","item_id":"_comm_11242"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_11242 == 'undefined' ){PDRTJS_468178_comm_11242 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_11242 );}}PDRTJS_settings_468178_comm_10999={"id":468178,"unique_id":"wp-comment-10999","title":"%26%23091%3B%26%238230%3B%26%23093%3B%20Sutter%26%238217%3Bs%20GotW89%20Smart%20Pointers%20post%20includes%20good%20reasons%20to%20use%20make_shared%2Fmake_unique%20instead%20of%20naked%20new.%20Avoiding%20memory%20%26%23091%3B%26%238230%3B%26%23093%3B...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10999","item_id":"_comm_10999"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10999 == 'undefined' ){PDRTJS_468178_comm_10999 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10999 );}}PDRTJS_settings_468178_comm_10895={"id":468178,"unique_id":"wp-comment-10895","title":"%40Marco%3A%20Yes%2C%20that%26%23039%3Bs%20the%20kind%20of%20case%20the%20internal%20synchronization%20on%20the%20refcount%20is%20needed%20for%20--%20the%20user%20is%20allowed%20to%20do%20concurrent%20operations%20where%20not%20all%20are%20const%20on%20different%20objects%2C%20ju...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10895","item_id":"_comm_10895"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10895 == 'undefined' ){PDRTJS_468178_comm_10895 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10895 );}}PDRTJS_settings_468178_comm_10890={"id":468178,"unique_id":"wp-comment-10890","title":"%40herb%20tnx%20for%20the%20A%2Cnow%20when%20you%20explain%20it%20is%20doh.%20%3ADlike%20Scott%20says%20shared%20prt%20is%20actually%20ptr_to_shared%20%3AD...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10890","item_id":"_comm_10890"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10890 == 'undefined' ){PDRTJS_468178_comm_10890 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10890 );}}PDRTJS_settings_468178_comm_10866={"id":468178,"unique_id":"wp-comment-10866","title":"%40Herb%3A%20Thank%20you%20very%20much%20for%20your%20explanations.%20I%26%23039%3Bm%20still%20not%20sure%20we%20are%20talking%20about%20the%20same%20thing.%20class%20A%20%7B%20%20%20public%3A%20%20%20%20%20%20%20%20%20int%20GetValue%28%29%20const%3B%20%7D%3BThere%20cannot%20be%20any%20writers%2C%20so%20that%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10866","item_id":"_comm_10866"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10866 == 'undefined' ){PDRTJS_468178_comm_10866 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10866 );}}PDRTJS_settings_468178_comm_10847={"id":468178,"unique_id":"wp-comment-10847","title":"When%20I%20implement%20a%20class%20deriving%20from%20enable_shared_from_this%2C%20I%20usually%20make%20all%20constructors%20private%20and%20add%20static%20factory%20functions%20that%20create%20and%20return%20shared%20pointers%20to%20the%20class.%20As%20th...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10847","item_id":"_comm_10847"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10847 == 'undefined' ){PDRTJS_468178_comm_10847 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10847 );}}PDRTJS_settings_468178_comm_10808={"id":468178,"unique_id":"wp-comment-10808","title":"%40nosenseetal%3A%20No%2C%20you%20can%26%23039%3Bt%20use%20a%20unique_ptr%20or%20a%20shared_ptr%20that%20way.%20A%20given%20shared_ptr%20object%20is%20like%20any%20other%20normal%20object%20--%20if%20you%20have%20multiple%20concurrent%20accesses%20and%20one%20is%20a%20writer%20%28n...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10808","item_id":"_comm_10808"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10808 == 'undefined' ){PDRTJS_468178_comm_10808 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10808 );}}PDRTJS_settings_468178_comm_10747={"id":468178,"unique_id":"wp-comment-10747","title":"%40herbwhat%20about%20my%20example%20of%20%26quot%3Bspinlock%26quot%3B%20on%20up%20and%20sp%3FIsnt%20sp%20version%20correct%20program%2C%20while%20up%20is%20UB%3FOr%20maybe%20sp%20counter%20is%20incremented%20with%20non_seq_const%20mem%20order%20%3Fbtw%20I%20think%20you%20need%20to%20ment...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10747","item_id":"_comm_10747"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10747 == 'undefined' ){PDRTJS_468178_comm_10747 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10747 );}}PDRTJS_settings_468178_comm_10739={"id":468178,"unique_id":"wp-comment-10739","title":"%40Marek%3A%20Yes%2C%20unspecified.%20Thanks%2C%20updated....","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10739","item_id":"_comm_10739"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10739 == 'undefined' ){PDRTJS_468178_comm_10739 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10739 );}}PDRTJS_settings_468178_comm_10738={"id":468178,"unique_id":"wp-comment-10738","title":"%40Tom%3A%20I%20can%26%23039%3Bt%20easily%20share%20that%2C%20but%20you%20could%20try%20something%20like%20this%20%28untested%20code%20follows%2C%20yours%20to%20test%20and%20fix%29.%26%23091%3Bcode%26%23093%3Btemplate%26lt%3Btypename%20T%2C%20typename%20A1%26gt%3Bstd%3A%3Aunique_ptr%26lt%3BT%26gt%3B%20make_un...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10738","item_id":"_comm_10738"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10738 == 'undefined' ){PDRTJS_468178_comm_10738 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10738 );}}PDRTJS_settings_468178_comm_10737={"id":468178,"unique_id":"wp-comment-10737","title":"%40andyprowl%2C%20%40Chris%20Vine%3A%20Right%20you%20are.%20The%20issue%20is%20as%20described%2C%20now%20the%20spelling%20is%20fixed%2C%20thanks....","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10737","item_id":"_comm_10737"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10737 == 'undefined' ){PDRTJS_468178_comm_10737 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10737 );}}PDRTJS_settings_468178_comm_10736={"id":468178,"unique_id":"wp-comment-10736","title":"%40Marco%2C%20%40nosenseetal%3A%20Virtually%20all%20types%2C%20including%20shared_ptr%20%28and%20vector%2C%20and%20other%20types%29%20are%20just%20as%20thread-safe%20as%20any%20old%20type%20including%20int%20--%20safe%20for%20concurrent%20reads%20%28const%20operations%29...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10736","item_id":"_comm_10736"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10736 == 'undefined' ){PDRTJS_468178_comm_10736 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10736 );}}PDRTJS_settings_468178_comm_10735={"id":468178,"unique_id":"wp-comment-10735","title":"%40celeborn2bealive%3A%20Youre%20right%2C%20Ive%20updated%20the%20wording%20to%20try%20to%20make%20these%20be%20phrased%20as%20prefer%20rather%20than%20always.%20There%20are%20two%20parts%20to%20this%3A%201.%20unique_ptr%20and%20shared_ptr%20are%20to%20be%20preferred...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10735","item_id":"_comm_10735"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10735 == 'undefined' ){PDRTJS_468178_comm_10735 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10735 );}}PDRTJS_settings_468178_comm_10732={"id":468178,"unique_id":"wp-comment-10732","title":"%26quot%3Bc%2Fc%2B%2B%20malloc%20works%20very%20deterministic%20and%20there%20is%20no%20intelligence.%20first%20free%20block%20that%20fits%20the%20size%20or%20more%20%28requested%29%20will%20be%20returned.%26quot%3Bsystem%20tries%20to%20minimize%20fragmentationNone%20of%20this%20i...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10732","item_id":"_comm_10732"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10732 == 'undefined' ){PDRTJS_468178_comm_10732 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10732 );}}PDRTJS_settings_468178_comm_10716={"id":468178,"unique_id":"wp-comment-10716","title":"%40Andrew%20Marshall%20weak_ptr%20gets%20notified%20when%20the%20object%20is%20deleted%20and%20will%20prevent%20you%20from%20accessing%20it%20where%20a%20raw%20pointer%20will%20let%20you%20do%20anything%20with%20the%20already%20deleted%20object%20sending%20you%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10716","item_id":"_comm_10716"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10716 == 'undefined' ){PDRTJS_468178_comm_10716 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10716 );}}PDRTJS_settings_468178_comm_10711={"id":468178,"unique_id":"wp-comment-10711","title":"%40Herb%26quot%3BIf%20you%20use%20make_shared%20to%20allocate%20the%20object%20and%20the%20shared_ptr%20all%20in%20one%20go%2C%20then%20the%20implementation%20can%20fold%20them%20together%20in%20a%20single%20allocation%26quot%3Bcould%20you%20please%20elaborate%20more%20on%20the%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10711","item_id":"_comm_10711"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10711 == 'undefined' ){PDRTJS_468178_comm_10711 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10711 );}}PDRTJS_settings_468178_comm_10710={"id":468178,"unique_id":"wp-comment-10710","title":"%40Marco%26quot%3BThe%20two%20memory%20blocks%20will%20in%20general%20have%20very%20different%20sizes%20%26quot%3B%20-%20thats%20ok.%20%26quot%3Bmay%20life%20in%20far%20far%20away%20areas%20of%20the%20memory%20because%20the%20system%20tries%20to%20minimize%20fragmentation%26quot%3B%20-%20c%2Fc%2B%2B%20mall...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10710","item_id":"_comm_10710"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10710 == 'undefined' ){PDRTJS_468178_comm_10710 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10710 );}}PDRTJS_settings_468178_comm_10707={"id":468178,"unique_id":"wp-comment-10707","title":"%40pip010%3A%20The%20two%20memory%20blocks%20will%20in%20general%20have%20very%20different%20sizes%20and%20may%20life%20in%20far%20far%20away%20areas%20of%20the%20memory%20because%20the%20system%20tries%20to%20minimize%20fragmentation....","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10707","item_id":"_comm_10707"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10707 == 'undefined' ){PDRTJS_468178_comm_10707 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10707 );}}PDRTJS_settings_468178_comm_10705={"id":468178,"unique_id":"wp-comment-10705","title":"well%2C%20instead%3Avoid%20sink%28%20unique_ptr%2C%20unique_ptr%20%29%3Bunique_ptr%20arg1%28new%20widget%7B%7D%29%3Bunique_ptr%20arg2%28new%20gadget%7B%7D%29%3B%2F%2F--exception%20linesink%28arg1%2Carg2%29%3Bso%20here%20it%20goes.%20same%20exception-safety%20%3A%29about%3A%20%26quot%3BIt...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10705","item_id":"_comm_10705"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10705 == 'undefined' ){PDRTJS_468178_comm_10705 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10705 );}}PDRTJS_settings_468178_comm_10704={"id":468178,"unique_id":"wp-comment-10704","title":"%26gt%3B%20The%20answer%20is%20no%2C%20because%20C%2B%2B%20leaves%20the%20order%20of%20evaluation%20of%20function%20arguments%20undefined...I%20think%20it%20is%20unspecified%20not%20undefined....","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10704","item_id":"_comm_10704"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10704 == 'undefined' ){PDRTJS_468178_comm_10704 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10704 );}}PDRTJS_settings_468178_comm_10701={"id":468178,"unique_id":"wp-comment-10701","title":"If%20I%26%23039%3Bm%20not%20mistaken%2C%20the%20smart%20and%20weak%20ptr%20works%20like%20this%3ALet%20say%20we%20have%20a%20smart%20and%20a%20weak%20ptr%20pointing%20to%20the%20same%20object.Now%20we%20destroy%20the%20smart_ptr%3A%20since%20no%20other%20owning%20ptr%20is%20present%2C%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10701","item_id":"_comm_10701"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10701 == 'undefined' ){PDRTJS_468178_comm_10701 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10701 );}}PDRTJS_settings_468178_comm_10699={"id":468178,"unique_id":"wp-comment-10699","title":"Given%20that%20make_unique%20and%20make_shared%20can%20aggregate%20the%20memory%20allocation%20for%20the%20ref%20counting%20together%20with%20that%20for%20the%20pointed%20at%20T%2C%20how%20does%20that%20play%20with%20class%20member%20operator%3A%3Anew%28%29%20and%20o...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10699","item_id":"_comm_10699"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10699 == 'undefined' ){PDRTJS_468178_comm_10699 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10699 );}}PDRTJS_settings_468178_comm_10697={"id":468178,"unique_id":"wp-comment-10697","title":"Thanks%20for%20the%20answer.%20I%20was%20referring%20to%20the%20reference%20counter.%20Good%20to%20know%20it%20is%20thread%20safe.%20We%20have%20had%20our%20own%20implementation%20of%20smart%20and%20weak%20pointers.%20Now%20we%26%23039%3Bre%20about%20to%20go%20to%20VS%202012%2C%20s...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10697","item_id":"_comm_10697"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10697 == 'undefined' ){PDRTJS_468178_comm_10697 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10697 );}}PDRTJS_settings_468178_comm_10682={"id":468178,"unique_id":"wp-comment-10682","title":"%26quot%3Bsink%28%20new%20widget%7B%7D%2C%20new%20gadget%7B%7D%20%29%3B%20%20%20%20%20%2F%2F%20Q1%3A%20can%20you%20spot%20the%20problem%3F%26quot%3BThe%20principal%20problem%20with%20this%20is%20that%20it%20will%20not%20compile%2C%20because%20unique_ptr%26%23039%3Bs%20constructor%20taking%20a%20pointer%20is%20explici...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10682","item_id":"_comm_10682"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10682 == 'undefined' ){PDRTJS_468178_comm_10682 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10682 );}}PDRTJS_settings_468178_comm_10678={"id":468178,"unique_id":"wp-comment-10678","title":"Great%20article%20but%20I%20have%20one%20question.%20I%20always%20assumed%20that%20you%20cannot%20make%20a%20vector%20of%20unique%20pointers%20of%20objects%20because%20the%20vector%20demands%20that%20an%20object%20always%20be%20copyable.%20And%20unique%20pointe...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10678","item_id":"_comm_10678"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10678 == 'undefined' ){PDRTJS_468178_comm_10678 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10678 );}}PDRTJS_settings_468178_comm_10677={"id":468178,"unique_id":"wp-comment-10677","title":"Responding%20to%20celeborn2bealive%26quot%3Bwhen%20you%20allocate%20memory%20from%20a%20dynamic%20library%2C%20that%20memory%20must%20be%20freed%20in%20the%20code%20of%20the%20library.%26quot%3Bsays%20who%3F%20%20the%20C%2B%2B%20library%20says%20nothing%20about%20that.%20%20I%20know%20t...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10677","item_id":"_comm_10677"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10677 == 'undefined' ){PDRTJS_468178_comm_10677 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10677 );}}PDRTJS_settings_468178_comm_10673={"id":468178,"unique_id":"wp-comment-10673","title":"nosenseetal%3A%20I%20think%20that%20you%20need%20to%20use%20the%20overloads%20of%20atomic_load%20and%20atomic_store%20that%20take%20shared_ptr%20for%20that%20to%20be%20acceptable.%20i.e.%20I%26%23039%3Bm%20pretty%20sure%20that%20individual%20instances%20of%20shared_pt...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10673","item_id":"_comm_10673"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10673 == 'undefined' ){PDRTJS_468178_comm_10673 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10673 );}}PDRTJS_settings_468178_comm_10672={"id":468178,"unique_id":"wp-comment-10672","title":"I%20think%20the%20first%20two%20calls%20to%20sink%28%29%20%28in%20the%20answer%20to%20Q3%29%20should%20not%20compile%2C%20since%20the%20constructor%20of%20unique_ptr%20that%20accepts%20a%20raw%20pointer%20is%20marked%20as%20explicit.%20Am%20I%20overlooking%20something%3F...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10672","item_id":"_comm_10672"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10672 == 'undefined' ){PDRTJS_468178_comm_10672 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10672 );}}PDRTJS_settings_468178_comm_10669={"id":468178,"unique_id":"wp-comment-10669","title":"What%20happens%20if%20the%20class%20being%20instantiated%20with%20make_shared%20has%20class-specific%20new%20and%20delete%20operators%3F%20Will%20make_shared%20use%20that%20one%20%28and%20thus%20still%20make%20a%20separate%20allocation%20for%20the%20control...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10669","item_id":"_comm_10669"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10669 == 'undefined' ){PDRTJS_468178_comm_10669 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10669 );}}PDRTJS_settings_468178_comm_10668={"id":468178,"unique_id":"wp-comment-10668","title":"%40herbOne%20of%20the%20nice%20things%20in%20C%2B%2B%20is%20that%20you%20don%26%23039%3Bt%20pay%20for%20something%20you%20do%20not%20use.However%2C%20using%20shared_ptr%20in%20the%20context%20of%20a%20single%20threaded%20env%2Fmodule%20incur%20the%20atomic%20op%20overhead.It%20migh...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10668","item_id":"_comm_10668"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10668 == 'undefined' ){PDRTJS_468178_comm_10668 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10668 );}}PDRTJS_settings_468178_comm_10667={"id":468178,"unique_id":"wp-comment-10667","title":"%40Anders%20DalvanderA%20solution%20is%20to%20write%20your%20own%20%26quot%3Bmake_my_shared%26quot%3B%20insuring%20it%20will%20be%20expection%20safe%20and%20the%20new%20will%20be%20done%20outside%20the%20standard%20make_shared.This%20way%2C%20you%20keep%20the%20exception%20saf...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10667","item_id":"_comm_10667"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10667 == 'undefined' ){PDRTJS_468178_comm_10667 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10667 );}}PDRTJS_settings_468178_comm_10665={"id":468178,"unique_id":"wp-comment-10665","title":"make_shared%20can%20be%20wasteful%20if%20you%20have%20large%20objects%20and%20weak_ptr%20to%20these%20shared%20objects%20as%20the%20memory%20for%20the%20large%20object%20cannot%20be%20deallocated%20before%20the%20last%20weak_ptr%20has%20been%20destroyed.%20So...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10665","item_id":"_comm_10665"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10665 == 'undefined' ){PDRTJS_468178_comm_10665 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10665 );}}PDRTJS_settings_468178_comm_10664={"id":468178,"unique_id":"wp-comment-10664","title":"%40herbThere%20are%20three%20major%20reasons%20to%20say%20when%20in%20doubt%2C%20prefer%20unique_ptr.%20well%20I%20have%20one%20reason%20to%20prefer%20SP%3Aby%20default%20it%20is%20%26quot%3Bthread%20safe%26quot%3B%20%28big%20%26quot%3B%26quot%3B%29aka%20afaik%20%28this%20is%20ok%2C%20but%20wasteful%29while%20%28%21...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10664","item_id":"_comm_10664"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10664 == 'undefined' ){PDRTJS_468178_comm_10664 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10664 );}}PDRTJS_settings_468178_comm_10660={"id":468178,"unique_id":"wp-comment-10660","title":"One%20thing%20we%20were%20discussing%20about%20a%20lot%3A%20are%20c%2B%2B%20shared_ptr%20threadsafe%3F...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10660","item_id":"_comm_10660"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10660 == 'undefined' ){PDRTJS_468178_comm_10660 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10660 );}}PDRTJS_settings_468178_comm_10659={"id":468178,"unique_id":"wp-comment-10659","title":"Hi%20Herb%2C%20is%20there%20any%20chance%20you%20could%20post%20somewhere%20your%20preferred%20pre%20%26%23039%3BMilan%26%23039%3B%20%28variadics%29%20implementation%20for%20VS2012%20Update%202%20MSVC%20developers%20who%20want%20to%20use%20a%20pseudo%20blessed%20implementation%20of%20...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10659","item_id":"_comm_10659"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10659 == 'undefined' ){PDRTJS_468178_comm_10659 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10659 );}}PDRTJS_settings_468178_comm_10658={"id":468178,"unique_id":"wp-comment-10658","title":"Very%20interesting%2C%20I%20love%20your%20articles%20%3A%29%20But%20I%20have%20a%20question%20about%20make_unique%28%29%20and%20make_shared%28%29%3A%20If%20i%20don%26%23039%3Bt%20say%20bullshit%2C%20when%20you%20allocate%20memory%20from%20a%20dynamic%20library%2C%20that%20memory%20must%20b...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10658","item_id":"_comm_10658"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10658 == 'undefined' ){PDRTJS_468178_comm_10658 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10658 );}}PDRTJS_settings_468178_comm_10654={"id":468178,"unique_id":"wp-comment-10654","title":"What%26%23039%3Bs%20the%20advantage%20%28if%20any%29%20of%20weak_ptr%20over%20a%20non-owning%20raw%20pointer%3F...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10654","item_id":"_comm_10654"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10654 == 'undefined' ){PDRTJS_468178_comm_10654 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10654 );}}PDRTJS_settings_468178_comm_10652={"id":468178,"unique_id":"wp-comment-10652","title":"BTW%2C%20the%20reason%20I%26%23039%3Bm%20posting%20%2389%20to%20%2391%20in%20faster%20succession%20is%20because%20we%20already%20saw%20versions%20of%20these%20exactly%20one%20year%20ago%2C%20as%20then-numbered%20%23103%20to%20%23105%2C%20so%20some%20of%20the%20comment%20discussion%20abou...","permalink":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/#comment-10652","item_id":"_comm_10652"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_10652 == 'undefined' ){PDRTJS_468178_comm_10652 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_10652 );}}
//--><!]]></script><script type='text/javascript' charset='UTF-8' src='https://polldaddy.com/js/rating/rating.js'></script><script type='text/javascript' src='https://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript' src='https://s1.wp.com/_static/??-eJzTLy/QTc7PK0nNK9EvyClNz8wr1i+uzCtJrMjITM/IAeKS1CJMEWP94uSizIISoOIM5/yiVL2sYh19yo1yKiotzgjISczMo6aBzgUFQOPsc20NTYyMjE2MDI1NsgB4yV92'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://s1.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "https://s2.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?m=1363304414h&amp;ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	if ( typeof( jQuery ) !== 'undefined' ) {
		jQuery( function( $ ) {
			$( document.body ).on( 'post-load', function() {
				SyntaxHighlighter.highlight();
			} );
		} );
	}
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"3379246","siteName":"Sutter\u2019s Mill","siteURL":"https:\/\/herbsutter.com","icon":"<img alt='' src='https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=50&d=https%3A%2F%2Fs2.wp.com%2Fi%2Flogo%2Fwpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/mistylook","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F29%2Fgotw-89-solution-smart-pointers%2F","themeURL":"","xhrURL":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"8fb9818ae2","isSingular":"1","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"4590924cc6\" \/>","referer":"https:\/\/herbsutter.com\/2013\/05\/29\/gotw-89-solution-smart-pointers\/","canFollow":"1","feedID":"171936","statusMessage":"","customizeLink":"https:\/\/herbsutter.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fherbsutter.wordpress.com%2F2013%2F05%2F29%2Fgotw-89-solution-smart-pointers%2F","postID":"2035","shortlink":"https:\/\/wp.me\/peb5Y-wP","canEditPost":"","editLink":"https:\/\/wordpress.com\/post\/herbsutter.com\/2035","statsLink":"https:\/\/wordpress.com\/stats\/post\/2035\/herbsutter.com","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: MistyLook","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 19,532 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F29%2Fgotw-89-solution-smart-pointers%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVjcEOgjAQRH/IuoIYT8Zvqe2GLrQLdlvAv7ceJEYTEg+bTGbe7MA8KjNwQk7QCVicyOC47DvZwUcUshp9bokFPPUocM+Y0Wm2HuM3/CblwUkvjlrnyyWMv87GjraBWN10hKCloEWpYcIYyZb91fvzQ4ra9LJVMokGfpVWVehruFSnujo0x+Zcd0+y+3Rn'></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'3379246','blog_tz':'-8','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'3379246','v':'wpcom','tz':'-8','user_id':'0','post':'2035','subd':'herbsutter'}]);
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29+Smw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8/MkNtblkvY1d1TjBELytHc0k/MXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sNGpOU1M5X0RockJaSDI2ZFhrSD8rM1orK29nTzhfNmJMWkM0fG5qXV1tSEpsLjFuWlB8c1JWNjBrfjd4NDdFMkJYJkFORnBRJVZlQmZ3NmxQQ3l+Z1gwVXdCbmJJbEo0Z0NRbi5OKyxCTyVDdWdvRWRvQXAwRzladldOOUdiLCYtL05Gaz0rc2NiT1BuNEp0dDUmb3dLUlAuWzVoWmV1S1VRWVY3Zjh+NWEyaTFXbVdRZGhPN3RaOSZJYm9qOENleUFoSz9MNQ=='}]);
_stq.push([ 'clickTrackerInit', '3379246', '2035' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>
<!--
	generated in 0.205 seconds
	164221 bytes batcached for 300 seconds
-->
