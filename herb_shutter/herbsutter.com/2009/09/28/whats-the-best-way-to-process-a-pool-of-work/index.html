<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>&ldquo;What&rsquo;s the Best Way To Process a Pool of Work?&rdquo; | Sutter’s Mill</title>
<link rel="pingback" href="https://herbsutter.com/xmlrpc.php" />
<script type="text/javascript">
  WebFontConfig = {"typekit":{"id":"eyo0tqd"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://s0.wp.com/wp-content/plugins/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active #header h1{font-size:2.12em;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active body{font-size:89.7%;font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation{font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation ul li.search{font-size:1.06em}.wf-active #navigation ul li.search input#searchsubmit{font-size:1.06em}.wf-active #content .post-info, .wf-active #content .postmetadata{font-size:1.06em}.wf-active #sidebar{font-size:1.06em}.wf-active #footer p.right{font-size:1.06em}.wf-active .commentnum{font-size:1.77em}.wf-active .commentlist li .cmtinfo{font-size:1.18em}.wf-active .commentlist li .cmtinfo em{font-size:1.06em}.wf-active #respond label{font-size:11.8px}.wf-active #respond .required{font-size:11.8px}.wf-active #respond .subscribe-label{font-size:14.2px}.wf-active #respond .comment-notes{font-size:13px}.wf-active .wp-caption p.wp-caption-text{font-size:13px}.wf-active #content h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active h5, .wf-active h6{font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active #header h2{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active #content h3{font-size:1.65em;font-weight:400;font-style:normal}.wf-active #content h4{font-size:1.3em;font-style:normal;font-weight:400}.wf-active #content h5{font-size:1.18em;font-style:normal;font-weight:400}.wf-active #content .post h2{font-size:1.65em;font-weight:400;font-style:normal}.wf-active li.sidebox h2{font-weight:400;font-size:1.89em;font-style:normal}.wf-active .post h4{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active .post h4 em{font-style:normal;font-weight:400}</style>
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=herbsutter.com&amp;id=3379246&amp;t=1542965787&amp;back=https%3A%2F%2Fherbsutter.com%2F2009%2F09%2F28%2Fwhats-the-best-way-to-process-a-pool-of-work%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//herbsutter.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Feed" href="https://herbsutter.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Comments Feed" href="https://herbsutter.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; &ldquo;What&rsquo;s the Best Way To Process a Pool of&nbsp;Work?&rdquo; Comments Feed" href="https://herbsutter.com/2009/09/28/whats-the-best-way-to-process-a-pool-of-work/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s1.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1532082729h&ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s2.wp.com/_static/??-eJyNkN1uwjAMhV9onsUG69W0Z0laE0zzp8QR6tvjUlUCwSpuonOS81knxkuGPkWhKBgaZN8cx4qeR6p4JsmmH+HmPvtaP/B1nOORI8uEcqKgYG4WA1eZfErjFtinQnofspE5EWhgQ15nRNnCQv5ZqVmetORmv0vWNFibC9UKegZuAZayT9wKuabWUnEwt0Tb2A9ofbotxBZTJpx/SE8DXi3hn+h9Rx4cSUVJGXKqqt5GaurZeGCNPJoFZoxJlsdVbE11lEB/aYRTfDBw9IbLFlpI9+NUOtTUnZ2hv/C7O+y/uu9uf+jOV8Xg7sY=?cssminify=yes' type='text/css' media='all' />
<link rel='stylesheet' id='print-css-1-1' href='https://s2.wp.com/wp-content/mu-plugins/global-print/global-print.css?m=1465851035h&cssminify=yes' type='text/css' media='print' />
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??/wp-content/mu-plugins/actionbar/actionbar.css,/wp-content/themes/h4/global.css?m=1516985148j&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyFztEKwjAMBdAfsquTiXsRv6XWOFKXtDbphn69HeiDMBQCgdzDJXZOBtmP5QJiQ517gfx4rybIxv4ChnDITqEh5A/2kRVYF0vxjCOYIpDdUG+16BpXXIqiBCIVraTfLyFPCPNfFkCT8zeTQfC5tJ7o2Hb9Yde3+24bXjRNW9I='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://herbsutter.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='When is a zero-length array&nbsp;okay?' href='https://herbsutter.com/2009/09/02/when-is-a-zero-length-array-okay/' />
<link rel='next' title='Effective Concurrency: Avoid Exposing Concurrency &ndash; Hide It Inside Synchronous&nbsp;Methods' href='https://herbsutter.com/2009/10/12/effective-concurrency-avoid-exposing-concurrency-hide-it-inside-synchronous-methods/' />
<meta name="generator" content="WordPress.com" />
<link rel="canonical" href="https://herbsutter.com/2009/09/28/whats-the-best-way-to-process-a-pool-of-work/" />
<link rel='shortlink' href='https://wp.me/peb5Y-4M' />
<link rel="alternate" type="application/json+oembed" href="https://public-api.wordpress.com/oembed/?format=json&amp;url=https%3A%2F%2Fherbsutter.com%2F2009%2F09%2F28%2Fwhats-the-best-way-to-process-a-pool-of-work%2F&amp;for=wpcom-auto-discovery" /><link rel="alternate" type="application/xml+oembed" href="https://public-api.wordpress.com/oembed/?format=xml&amp;url=https%3A%2F%2Fherbsutter.com%2F2009%2F09%2F28%2Fwhats-the-best-way-to-process-a-pool-of-work%2F&amp;for=wpcom-auto-discovery" />
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="&ldquo;What&rsquo;s the Best Way To Process a Pool of Work?&rdquo;" />
<meta property="og:url" content="https://herbsutter.com/2009/09/28/whats-the-best-way-to-process-a-pool-of-work/" />
<meta property="og:description" content="“What’s the best way to process a pool of work?” is a recurring question. As usual, the answer is “it depends” because the optimal answer often depends on both the characteristics of the work itsel…" />
<meta property="article:published_time" content="2009-09-28T22:34:16+00:00" />
<meta property="article:modified_time" content="2009-09-28T22:34:16+00:00" />
<meta property="og:site_name" content="Sutter’s Mill" />
<meta property="og:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=200&amp;ts=1542965787" />
<meta property="og:image:width" content="200" />
<meta property="og:image:height" content="200" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta name="twitter:text:title" content="&ldquo;What&rsquo;s the Best Way To Process a Pool of&nbsp;Work?&rdquo;" />
<meta name="twitter:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=240" />
<meta name="twitter:card" content="summary" />
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom" />

<!-- End Jetpack Open Graph Tags -->
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=114" />
<link rel='openid.server' href='https://herbsutter.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://herbsutter.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://herbsutter.com/osd.xml" title="Sutter’s Mill" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<script type="text/javascript" id="webfont-output">
  
  WebFontConfig = {"typekit":{"id":"cjs1oxc"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<meta name="application-name" content="Sutter’s Mill" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Herb Sutter on software development" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://herbsutter.com/feed/;icon-uri=https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=16" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="description" content="“What’s the best way to process a pool of work?” is a recurring question. As usual, the answer is “it depends” because the optimal answer often depends on both the characteristics of the work itself and the constraints imposed by run-time system resources. For example, I recently received the following email from reader Sören Meyer-Eppler,&hellip;" />
<style type="text/css">
			#header h1 a,
		#header h2 {
			color: #265E15 !important;
		}
				#headerimage {
			background: url('https://herbsutter.files.wordpress.com/2011/10/cropped-blog-header.jpg') no-repeat;
			height: 200px;
		}
	</style>
<link rel="amphtml" href="https://herbsutter.com/2009/09/28/whats-the-best-way-to-process-a-pool-of-work/amp/"><style type="text/css" id="syntaxhighlighteranchor"></style>
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=eb5Y&#038;cscache=6&#038;csrev=60" />
		</head>
<body id="section-index" class="post-template-default single single-post postid-296 single-format-standard mp6 customizer-styles-applied highlander-enabled highlander-light">


<div id="navigation" class="clearfix">
		<div class="menu">
		<ul>
			<li ><a href="https://herbsutter.com/" title="Home">Home</a></li>
			<li class="page_item page-item-912"><a href="https://herbsutter.com/welcome-to-the-jungle/">Welcome to the&nbsp;Jungle</a></li>
<li class="page_item page-item-864 page_item_has_children"><a href="https://herbsutter.com/gotw/">GotW</a></li>
<li class="page_item page-item-761"><a href="https://herbsutter.com/elements-of-modern-c-style/">Elements of Modern C++&nbsp;Style</a></li>
<li class="page_item page-item-2 page_item_has_children"><a href="https://herbsutter.com/about/">About</a></li>
									<li class="search"><form method="get" id="searchform" action="https://herbsutter.com"><input type="text" class="textbox" value="" name="s" id="s" /><input type="submit" id="searchsubmit" value="Search" /></form></li>
					</ul>
	</div>
</div><!-- end id:navigation -->

<div id="container">

<div id="header">
<h1><a href="https://herbsutter.com/" title="Sutter’s Mill">Sutter’s Mill</a></h1>
<h2>Herb Sutter on software development</h2>
</div><!-- end id:header -->


	
		<div id="feedarea">
	<dl>
		<dt><strong>Feeds:</strong></dt>

			<dd><a href="https://herbsutter.com/feed/">Posts</a></dd>
	
			<dd><a href="https://herbsutter.com/comments/feed/">Comments</a></dd>
		</dl>
	</div><!-- end id:feedarea -->
	
	<div id="headerimage">
</div><!-- end id:headerimage -->

<div id="content">
<div id="content-main">

		
									<div class="postnav">
				<div class="alignleft">&laquo; <a href="https://herbsutter.com/2009/09/02/when-is-a-zero-length-array-okay/" rel="prev">When is a zero-length array&nbsp;okay?</a></div>
				<div class="alignright"><a href="https://herbsutter.com/2009/10/12/effective-concurrency-avoid-exposing-concurrency-hide-it-inside-synchronous-methods/" rel="next">Effective Concurrency: Avoid Exposing Concurrency &ndash; Hide It Inside Synchronous&nbsp;Methods</a> &raquo;</div>
			</div>
			
			<div class="post-296 post type-post status-publish format-standard hentry category-concurrency" id="post-296">
				<div class="posttitle">
					<h2>&ldquo;What&rsquo;s the Best Way To Process a Pool of&nbsp;Work?&rdquo;</h2>
					<p class="post-info">2009-09-28 by <a href="https://herbsutter.com/author/herbsutter/" title="Posts by Herb Sutter">Herb Sutter</a>  </p>
				</div>

				<div class="entry">
					<p>“What’s the best way to process a pool of work?” is a recurring question. As usual, the answer is “it depends” because the optimal answer often depends on both the characteristics of the work itself and the constraints imposed by run-time system resources.</p>
<p>For example, I recently received the following email from reader Sören Meyer-Eppler, where the key was to avoid oversubscribing system resources (in this case, memory):</p>
<blockquote>
<p>I have an application that has multiple threads processing work from a todo queue. I have no influence over what gets into the queue and in what order (it is fed externally by the user). A single work item from the queue may take anywhere between a couple of seconds to several hours of runtime and should not be interrupted while processing. Also, a single work item may consume between a couple of megabytes to around 2GBs of memory. The memory consumption is my problem. I&#8217;m running as a 64bit process on a 8GB machine with 8 parallel threads. If each of them hits a worst case work item at the same time I run out of memory. I&#8217;m wondering about the best way to work around this.</p>
<p>1. plan conservatively and run 4 threads only. The worst case shouldn&#8217;t be a problem anymore, but we waste a lot of parallelism, making the average case a lot slower.</p>
<p>2. make each thread check available memory (or rather total allocated memory by all threads) before starting with a new item. Only start when more than 2GB memory are left. Recheck periodically, hoping that other threads will finish their memory hogs and we may start eventually. Still dangerous if the check happens when all threads are just starting out with their allocations.</p>
<p>3. try to predict how much memory items from the queue will need (hard) and plan accordingly. We could reorder the queue (overriding user choice) or simply adjust the number of running worker threads.</p>
<p>4. more ideas?</p>
<p>I&#8217;m currently tending towards number 2 because it seems simple to implement and solve most cases. However, I&#8217;m still wondering what standard ways of handling situations like this exist? The operating system must do something very similar on a process level after all&#8230;</p>
</blockquote>
<p>I replied:</p>
<blockquote>
<p>I don&#8217;t have time to write a detailed answer right now, but also consider two queues (one for big tasks and one for small tasks), or having work items give a rough size estimate (possibly by doing an extra lightweight pass over the data up front).</p>
<p>May I post an extract of your mail on my blog? Then others may comment and provide useful hints.</p>
</blockquote>
<p>He said yes, and so here it is for your consideration.</p>
<p>Note also <a href="http://groups.google.com/group/comp.programming.threads/browse_thread/thread/ea1bc898bbc103e0">this similar question</a> that came up a few days ago on comp.programming threads, but with different constraints &#8212; in that case, it was about avoiding idleness rather than avoiding oversubscription.</p>
									</div>

				<p class="postmetadata">
					Posted in <a href="https://herbsutter.com/category/concurrency/" rel="category tag">Concurrency</a> | 											15 Comments									</p>
				
<!-- You can start editing here. -->

<h3 id="comments">15 Responses</h3>

	<ol class="commentlist">
			<li class="comment even thread-even depth-1 highlander-comment" id="comment-1632">
		<div id="div-comment-1632">
		<div class="cmtinfo"><em> on <a href="#comment-1632" title="">2009-12-25 at 11:03 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/04eff7a93a3d211d00c4c896cfd90964?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>sparc</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1632"></div><p>Dmitry Vyukov&#8217;s solution would be suitable in your problem scenario simply because the tasks seem to consume memory in terms of GBs. Neither Pooling nor Sub-Pooling might help in this Scenario. And hence it is better to get closest to the Host OS.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1498">
		<div id="div-comment-1498">
		<div class="cmtinfo"><em> on <a href="#comment-1498" title="">2009-10-05 at 6:37 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c1db7b28cf9aaf18783339639b72f8e8?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.BuschnicK.net' rel='external nofollow' class='url'>BuschnicK</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1498"></div><p>Thank you all for the suggestions! Very productive discussion indeed. </p>
<p>@Leo: no, I&#8217;m not tracking per thread yet, but your idea sounds doable &#8211; I&#8217;ll give it a try.</p>
<p>cheers,</p>
<p>    Sören</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1497">
		<div id="div-comment-1497">
		<div class="cmtinfo"><em> on <a href="#comment-1497" title="">2009-10-02 at 8:05 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/0a78e39fdc91872f840361b94889ead2?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Leo Sutic</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1497"></div><p>@BuschnicK: But are you tracking the memory usage on a *per worker thread* basis? If you are, then the solution is simple: Create a semaphore with one permit that is shared among all worker threads. As soon as an item allocates more than 800MB, acquire a permit and set a local flag. When finished and local flag is set, release the permit.</p>
<p>That way you&#8217;ll only ever have one work item using up more than 800MB, and with 8 threads you are capped at 7 * 800MB + 2GB = 5.6GB + 2GB = 7.6GB.</p>
<p>/LS</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1496">
		<div id="div-comment-1496">
		<div class="cmtinfo"><em> on <a href="#comment-1496" title="">2009-09-30 at 8:37 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/be64e83253cd34fec0971f728cefcf2a?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>JeffreyTan</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1496"></div><p>Isn&#8217;t this a similar problem facing by ThreadPool implementation? </p>
<p>We can use a dedicated dispatching thread to serve the task queue and a pool of threads to serving the tasks. Whenever the task queue is not empty, the main dispatching thread will wake and check the memory consumption of system, if the consumption is still not bad, fetch a thread from the pool to process the new task. Also, the threadpool worker threads will sleep or end based on the current free threads count. This way, the threadpool can increase/decrease based on the work load dynamically. </p>
<p>Jeffrey Richter&#8217;s Win2000 Server-side programming has the code snippet for implementing this type of thread pool. </p>
<p>Let me know if there is any problem in this design.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1495">
		<div id="div-comment-1495">
		<div class="cmtinfo"><em> on <a href="#comment-1495" title="">2009-09-30 at 1:42 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/6cc723af63c997317ef6242791cef495?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Sharon</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1495"></div><p>If the jobs can be aborted with no side effect i would use priority in the following way:<br />
Have memory management keep track of the amount of memory allocated by each thread.<br />
If memory run low start to abort tasks according to priority.<br />
Priority should be a mix of :<br />
1. how much memory the thread allocated (i.e. how much advantage we get from aborting this thread)<br />
2. how much time the thread been running on it current job (i.e. how much CPU resource we waste by aborting the job).<br />
After aborting job the aborted job is put back to the jobs queue. It can either be put to the front of the queue in this case no thread will start that job again until at least one other job finished. The job can be  put to the back of the queue in which case the next job (which might have smaller memory footprint) can be fetched.<br />
It is also possible to remember for each aborted job how much memory / time they consumed before they were aborted to gain some insight if they should be started again in the current memory situation etc.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1494">
		<div id="div-comment-1494">
		<div class="cmtinfo"><em> on <a href="#comment-1494" title="">2009-09-30 at 9:55 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/692f53bc61954ab1101ff91823c890e7?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>fool</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1494"></div><p>&#8230;Just be careful if suspending work on any thread that you can never have *all* threads suspended!</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1493">
		<div id="div-comment-1493">
		<div class="cmtinfo"><em> on <a href="#comment-1493" title="">2009-09-29 at 11:30 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c1db7b28cf9aaf18783339639b72f8e8?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.BuschnicK.net' rel='external nofollow' class='url'>BuschnicK</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1493"></div><p>@kert: What&#8217;s the difference between an explicitly shared memory pool and the regular heap? What advantage would I gain?</p>
<p>@Leo: I am already using custom allocators (boost pool allocators for small allocations and global overrides for new and delete). So tracking the memory used is not much of a problem. The question is how to use this knowledge to not run out&#8230;</p>
<p>@SDR: Upgrading the target machine isn&#8217;t as easy as it sounds because we:<br />
a) have lots of them not only one (it is not only parallel per machine but also distributed over several boxes)<br />
b) some have already been shipped to customers and we can easily upgrade the software but not the hardware<br />
c) we are also using Amazon&#8217;s EC2 cloud where you only have limited control over hardware resources.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1492">
		<div id="div-comment-1492">
		<div class="cmtinfo"><em> on <a href="#comment-1492" title="">2009-09-29 at 3:59 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/b4aa34d4f6c2ceb71ee82a7222767056?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>kert</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1492"></div><p>Implement a memory pool that is shared between the threads.</p>
<p>Such design problems and patterns are common in embedded systems which consider memory as a finite resource in every context.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1491">
		<div id="div-comment-1491">
		<div class="cmtinfo"><em> on <a href="#comment-1491" title="">2009-09-29 at 3:22 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/0a78e39fdc91872f840361b94889ead2?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Leo Sutic</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1491"></div><p>Sören,</p>
<p>the idea was to track memory consumption by somehow hooking into the allocator. That way, you can accurately track memory use on a per-work item basis, and suspend when a work item has grown too big.</p>
<p>How does the code analyzer work? Is it your own C/C++ code, or someone elses? A mixture of both? Is there any chance at all to intercept malloc/new calls?</p>
<p>/LS</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1490">
		<div id="div-comment-1490">
		<div class="cmtinfo"><em> on <a href="#comment-1490" title="">2009-09-29 at 11:16 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/9306efaae777a3f5ceb7d444863be299?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>SDR</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1490"></div><p>If your requirements permit, you may consider upgrading the target machine.  Doubling the RAM will remove your concern.  This is probably more cost effective than devoting development resources.</p>
<p>If you don&#8217;t have control of your target machine, you may choose to do nothing.  If you expect events where the memory usage exceeds 8GB to be rare, you may accept the performance hit of paging.</p>
<p>Otherwise, is there a reliable pattern to the timing of memory usage?  Or is both the amplitude and velocity of memory use random?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1489">
		<div id="div-comment-1489">
		<div class="cmtinfo"><em> on <a href="#comment-1489" title="">2009-09-29 at 7:51 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/56de2929d6f26ac0d47e97276f729ced?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Dmitry Vyukov</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1489"></div><p>You may try to move processing to separate OS processes, this way you will get an easy way to determine resource consumption and to temporary suspend individual processing (OS must provide such functions).<br />
I.e. main process accepts requests and distributes them among a pool of worker processes, when processing completes it receives results and send them back to a user. Besides that main process periodically checks memory consumption of worker processes and suspends some of them if needed. Suspended processes are known to be &#8220;large&#8221;, they are resumed later when total memory consumption drops down. Suspended processes will occupy some space in page file (must not be a problem taking into account sizes of modern hard drives), but will release physical memory.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1488">
		<div id="div-comment-1488">
		<div class="cmtinfo"><em> on <a href="#comment-1488" title="">2009-09-29 at 6:38 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/0755c3f045e276f52d7c9f38db8ca573?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Michael Cederberg</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1488"></div><p>Without knowing your problem in details, I would do something along the lines of your solution #3:</p>
<p>Create a resource manager that tracks resource usage (e.g. memory, long running work).</p>
<p>When adding work to the queue, then add info about the work describing resource usage.</p>
<p>When choosing which work item to process next, then choose the first work item that will not overuse available resources. Update resource manager whenever a processing of a work item begins and ends. In your example, it sounds like initial available resources are: 8GB memory and X allowed long running tasks (assuming you would not like all your threads to process long running work items).</p>
<p>If you have difficulty estimating the resource consumption, then try to split work items into multiple stages. That way, estimation of resource consumption becomes easier. In addition it becomes less of a problem if you are too conservative when estimating resource consumption.</p>
<p>If there are requirements for certain work items to be processed in sequence, then that should be possible too. The key thing is to enforce the sequencing only when there is an actual requirement for it.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1487">
		<div id="div-comment-1487">
		<div class="cmtinfo"><em> on <a href="#comment-1487" title="">2009-09-29 at 5:47 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/c1db7b28cf9aaf18783339639b72f8e8?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://www.BuschnicK.net' rel='external nofollow' class='url'>BuschnicK</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1487"></div><p>More info about the problem: <a href="http://www.vxclass.com" rel="nofollow">http://www.vxclass.com</a><br />
I&#8217;m trying to optimize the diffing back-end of vxClass. </p>
<p>@Leo: Handling out of memory situations after they have occured is very hard because unfortunately they don&#8217;t always manifest in a simple out-of-memory exception but in all kinds of other nasty ways.<br />
Your suggestion 1. sounds a bit like my 2.. I&#8217;ll certainly use something like that.<br />
Splitting into two queues for small and large items is a good idea &#8211; although predicting how much memory one item will take is a tough problem in our case.</p>
<p>@Bob: We have already thought about how we can parallelize a single task from the queue. We couldn&#8217;t think of a good way. The way the algorithm works every subsequent step is dependent on the results of all previous ones.</p>
<p>Anyways, thank you very much for the suggestions thus far!</p>
<p>    Sören</p>
<p>I&#8217;m the one who asked the original question btw ;-)</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-1486">
		<div id="div-comment-1486">
		<div class="cmtinfo"><em> on <a href="#comment-1486" title="">2009-09-29 at 5:06 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/820d0e4ee14e986a44d33782ca852f51?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Bob</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1486"></div><p>Just use a single thread to process the queue. That way you will never have fights between threads over memory.</p>
<p>If you need to get performance back up, then use multi-threading inside a single task process.</p>
<p>You might find this link useful: <a href="http://blog.mrmeyer.com/?p=4646" rel="nofollow">http://blog.mrmeyer.com/?p=4646</a></p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-1485">
		<div id="div-comment-1485">
		<div class="cmtinfo"><em> on <a href="#comment-1485" title="">2009-09-29 at 4:07 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/0a78e39fdc91872f840361b94889ead2?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Leo Sutic</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_1485"></div><p>It is very difficult to give advice, since we are told so very little of the finer points of the problem, for example, what means we have to track memory allocation on a per-item basis. Anyway:</p>
<p>0. When dealing with random and unknowable input, don&#8217;t expect to make optimal decisions. Just so you don&#8217;t kill yourself over this.</p>
<p>1. Continuously check available memory while processing. If it looks to be running out, use some ordering scheme to decide which work item should either (a) dump everything and be put back into the queue or (b) just suspend execution for a little while or (c) flush itself to disk and suspend.</p>
<p>2. Put in some code to handle out of memory conditions. Then just run.</p>
<p>3. If the size of work items are known up front, use two queues. If not, check when a work item has allocated more than 1GB. That makes it &#8220;large&#8221;. If another item being processed is also large, suspend until the other item has completed. Worst case here is that you have one 2GB item and then 7 &#8220;large&#8221; ones of 1GB each, so maybe set the threshold a bit lower &#8211; 800MB for 7&#215;0.8 + 2 = 7.6GB max, giving yourself a nice 400MB margin.</p>
<p>/LS</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>
	<br />

  	<p class="nocomments">Comments are closed.</p>
  <div class="post-content">
<p>
</p>
</div>

			</div>

		
		<p align="center"></p>

	</div><!-- end id:content-main -->
<div id="sidebar">
<ul>
<li class="sidebox"><h2><label for="subscribe-field">Follow by email</label></h2>
				<form action="https://subscribe.wordpress.com" method="post" accept-charset="utf-8" id="subscribe-blog">
																	<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" placeholder="Enter your email address" value="" id="subscribe-field"/></p>
					
					<p>
						<input type="hidden" name="action" value="subscribe"/>
						<input type="hidden" name="blog_id" value="3379246"/>
						<input type="hidden" name="source" value="https://herbsutter.com/2009/09/28/whats-the-best-way-to-process-a-pool-of-work/"/>
						<input type="hidden" name="sub-type" value="widget"/>
						<input type="hidden" name="redirect_fragment" value="blog_subscription-3" />
						<input type="hidden" id="_wpnonce" name="_wpnonce" value="4590924cc6" />						<input type="submit" value="Subscribe" />
					</p>
				</form>
			
</li><li class="sidebox"><h2><a href='http://twitter.com/herbsutter'>Tweets</a></h2><ul class='tweets'></ul><a href="http://twitter.com/herbsutter"  class='twitter-follow-button' data-show-count='false' data-link-color='#265e15' data-text-color='#333333'>Follow @herbsutter</a></li><li class="sidebox"><h2>Popular</h2><ul>				<li>
										<a href="https://herbsutter.com/2018/11/13/trip-report-fall-iso-c-standards-meeting-san-diego/" class="bump-view" data-bump-view="tp">
						Trip report: Fall ISO C++ standards meeting (San Diego)					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/gotw/" class="bump-view" data-bump-view="tp">
						GotW					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/2018/09/20/lifetime-profile-v1-0-posted/" class="bump-view" data-bump-view="tp">
						Lifetime profile v1.0 posted					</a>
										</li>
				</ul></li><li class="sidebox"><h2>Categories</h2>		<ul>
				<li class="cat-item cat-item-291"><a href="https://herbsutter.com/category/apple/" >Apple</a>
</li>
	<li class="cat-item cat-item-49277"><a href="https://herbsutter.com/category/c-net/" >C# / .NET</a>
</li>
	<li class="cat-item cat-item-2426"><a href="https://herbsutter.com/category/c/" >C++</a>
</li>
	<li class="cat-item cat-item-69816"><a href="https://herbsutter.com/category/cloud/" >Cloud</a>
</li>
	<li class="cat-item cat-item-214618"><a href="https://herbsutter.com/category/concurrency/" >Concurrency</a>
</li>
	<li class="cat-item cat-item-8259773"><a href="https://herbsutter.com/category/effective-concurrency/" >Effective Concurrency</a>
</li>
	<li class="cat-item cat-item-3696745"><a href="https://herbsutter.com/category/friday-thoughts/" >Friday Thoughts</a>
</li>
	<li class="cat-item cat-item-3867746"><a href="https://herbsutter.com/category/c/gotw/" >GotW</a>
</li>
	<li class="cat-item cat-item-79"><a href="https://herbsutter.com/category/hardware/" >Hardware</a>
</li>
	<li class="cat-item cat-item-1017"><a href="https://herbsutter.com/category/java/" >Java</a>
</li>
	<li class="cat-item cat-item-637"><a href="https://herbsutter.com/category/microsoft/" >Microsoft</a>
</li>
	<li class="cat-item cat-item-420845"><a href="https://herbsutter.com/category/opinion-editorial/" >Opinion &amp; Editorial</a>
</li>
	<li class="cat-item cat-item-1633077"><a href="https://herbsutter.com/category/reader-qa/" >Reader Q&amp;A</a>
</li>
	<li class="cat-item cat-item-2301"><a href="https://herbsutter.com/category/software-development/" >Software Development</a>
</li>
	<li class="cat-item cat-item-393523"><a href="https://herbsutter.com/category/talks-events/" >Talks &amp; Events</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://herbsutter.com/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-151"><a href="https://herbsutter.com/category/web/" >Web</a>
</li>
		</ul>
			</li></ul>
</div><!-- end id:sidebar -->
</div><!-- end id:content -->
</div><!-- end id:container -->
<div id="footer">
	<div id="colophon">
		<p><a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></p>
		<p>WPThemes.</p>
		<br class="clear" />
	</div><!-- end #colophon-->
</div><!-- end #footer-->
<!--  -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201847y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	<div class="grofile-hash-map-04eff7a93a3d211d00c4c896cfd90964">
	</div>
	<div class="grofile-hash-map-c1db7b28cf9aaf18783339639b72f8e8">
	</div>
	<div class="grofile-hash-map-0a78e39fdc91872f840361b94889ead2">
	</div>
	<div class="grofile-hash-map-be64e83253cd34fec0971f728cefcf2a">
	</div>
	<div class="grofile-hash-map-6cc723af63c997317ef6242791cef495">
	</div>
	<div class="grofile-hash-map-692f53bc61954ab1101ff91823c890e7">
	</div>
	<div class="grofile-hash-map-b4aa34d4f6c2ceb71ee82a7222767056">
	</div>
	<div class="grofile-hash-map-9306efaae777a3f5ceb7d444863be299">
	</div>
	<div class="grofile-hash-map-56de2929d6f26ac0d47e97276f729ced">
	</div>
	<div class="grofile-hash-map-0755c3f045e276f52d7c9f38db8ca573">
	</div>
	<div class="grofile-hash-map-820d0e4ee14e986a44d33782ca852f51">
	</div>
	</div>
<script type='text/javascript' charset='UTF-8' id='polldaddyRatings'><!--//--><![CDATA[//><!--
PDRTJS_settings_468178_comm_1632={"id":468178,"unique_id":"wp-comment-1632","title":"Dmitry%20Vyukov%26%23039%3Bs%20solution%20would%20be%20suitable%20in%20your%20problem%20scenario%20simply%20because%20the%20tasks%20seem%20to%20consume%20memory%20in%20terms%20of%20GBs.%20Neither%20Pooling%20nor%20Sub-Pooling%20might%20help%20in%20this%20Scenario.%20A...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1632","item_id":"_comm_1632"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1632 == 'undefined' ){PDRTJS_468178_comm_1632 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1632 );}}PDRTJS_settings_468178_comm_1498={"id":468178,"unique_id":"wp-comment-1498","title":"Thank%20you%20all%20for%20the%20suggestions%21%20Very%20productive%20discussion%20indeed.%20%40Leo%3A%20no%2C%20I%26%23039%3Bm%20not%20tracking%20per%20thread%20yet%2C%20but%20your%20idea%20sounds%20doable%20-%20I%26%23039%3Bll%20give%20it%20a%20try.cheers%2C%20%20%20%20Sren...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1498","item_id":"_comm_1498"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1498 == 'undefined' ){PDRTJS_468178_comm_1498 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1498 );}}PDRTJS_settings_468178_comm_1497={"id":468178,"unique_id":"wp-comment-1497","title":"%40BuschnicK%3A%20But%20are%20you%20tracking%20the%20memory%20usage%20on%20a%20%2Aper%20worker%20thread%2A%20basis%3F%20If%20you%20are%2C%20then%20the%20solution%20is%20simple%3A%20Create%20a%20semaphore%20with%20one%20permit%20that%20is%20shared%20among%20all%20worker%20threa...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1497","item_id":"_comm_1497"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1497 == 'undefined' ){PDRTJS_468178_comm_1497 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1497 );}}PDRTJS_settings_468178_comm_1496={"id":468178,"unique_id":"wp-comment-1496","title":"Isn%26%23039%3Bt%20this%20a%20similar%20problem%20facing%20by%20ThreadPool%20implementation%3F%20We%20can%20use%20a%20dedicated%20dispatching%20thread%20to%20serve%20the%20task%20queue%20and%20a%20pool%20of%20threads%20to%20serving%20the%20tasks.%20Whenever%20the%20task%20q...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1496","item_id":"_comm_1496"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1496 == 'undefined' ){PDRTJS_468178_comm_1496 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1496 );}}PDRTJS_settings_468178_comm_1495={"id":468178,"unique_id":"wp-comment-1495","title":"If%20the%20jobs%20can%20be%20aborted%20with%20no%20side%20effect%20i%20would%20use%20priority%20in%20the%20following%20way%3AHave%20memory%20management%20keep%20track%20of%20the%20amount%20of%20memory%20allocated%20by%20each%20thread.%20If%20memory%20run%20low%20star...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1495","item_id":"_comm_1495"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1495 == 'undefined' ){PDRTJS_468178_comm_1495 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1495 );}}PDRTJS_settings_468178_comm_1494={"id":468178,"unique_id":"wp-comment-1494","title":"...Just%20be%20careful%20if%20suspending%20work%20on%20any%20thread%20that%20you%20can%20never%20have%20%2Aall%2A%20threads%20suspended%21...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1494","item_id":"_comm_1494"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1494 == 'undefined' ){PDRTJS_468178_comm_1494 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1494 );}}PDRTJS_settings_468178_comm_1493={"id":468178,"unique_id":"wp-comment-1493","title":"%40kert%3A%20What%26%23039%3Bs%20the%20difference%20between%20an%20explicitly%20shared%20memory%20pool%20and%20the%20regular%20heap%3F%20What%20advantage%20would%20I%20gain%3F%40Leo%3A%20I%20am%20already%20using%20custom%20allocators%20%28boost%20pool%20allocators%20for%20small...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1493","item_id":"_comm_1493"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1493 == 'undefined' ){PDRTJS_468178_comm_1493 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1493 );}}PDRTJS_settings_468178_comm_1492={"id":468178,"unique_id":"wp-comment-1492","title":"Implement%20a%20memory%20pool%20that%20is%20shared%20between%20the%20threads.Such%20design%20problems%20and%20patterns%20are%20common%20in%20embedded%20systems%20which%20consider%20memory%20as%20a%20finite%20resource%20in%20every%20context....","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1492","item_id":"_comm_1492"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1492 == 'undefined' ){PDRTJS_468178_comm_1492 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1492 );}}PDRTJS_settings_468178_comm_1491={"id":468178,"unique_id":"wp-comment-1491","title":"Sren%2Cthe%20idea%20was%20to%20track%20memory%20consumption%20by%20somehow%20hooking%20into%20the%20allocator.%20That%20way%2C%20you%20can%20accurately%20track%20memory%20use%20on%20a%20per-work%20item%20basis%2C%20and%20suspend%20when%20a%20work%20item%20has%20grown...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1491","item_id":"_comm_1491"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1491 == 'undefined' ){PDRTJS_468178_comm_1491 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1491 );}}PDRTJS_settings_468178_comm_1490={"id":468178,"unique_id":"wp-comment-1490","title":"If%20your%20requirements%20permit%2C%20you%20may%20consider%20upgrading%20the%20target%20machine.%20%20Doubling%20the%20RAM%20will%20remove%20your%20concern.%20%20This%20is%20probably%20more%20cost%20effective%20than%20devoting%20development%20resources.I...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1490","item_id":"_comm_1490"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1490 == 'undefined' ){PDRTJS_468178_comm_1490 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1490 );}}PDRTJS_settings_468178_comm_1489={"id":468178,"unique_id":"wp-comment-1489","title":"You%20may%20try%20to%20move%20processing%20to%20separate%20OS%20processes%2C%20this%20way%20you%20will%20get%20an%20easy%20way%20to%20determine%20resource%20consumption%20and%20to%20temporary%20suspend%20individual%20processing%20%28OS%20must%20provide%20such%20f...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1489","item_id":"_comm_1489"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1489 == 'undefined' ){PDRTJS_468178_comm_1489 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1489 );}}PDRTJS_settings_468178_comm_1488={"id":468178,"unique_id":"wp-comment-1488","title":"Without%20knowing%20your%20problem%20in%20details%2C%20I%20would%20do%20something%20along%20the%20lines%20of%20your%20solution%20%233%3ACreate%20a%20resource%20manager%20that%20tracks%20resource%20usage%20%28e.g.%20memory%2C%20long%20running%20work%29.When%20adding...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1488","item_id":"_comm_1488"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1488 == 'undefined' ){PDRTJS_468178_comm_1488 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1488 );}}PDRTJS_settings_468178_comm_1487={"id":468178,"unique_id":"wp-comment-1487","title":"More%20info%20about%20the%20problem%3A%20http%3A%2F%2Fwww.vxclass.comI%26%23039%3Bm%20trying%20to%20optimize%20the%20diffing%20back-end%20of%20vxClass.%20%40Leo%3A%20Handling%20out%20of%20memory%20situations%20after%20they%20have%20occured%20is%20very%20hard%20because%20unf...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1487","item_id":"_comm_1487"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1487 == 'undefined' ){PDRTJS_468178_comm_1487 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1487 );}}PDRTJS_settings_468178_comm_1486={"id":468178,"unique_id":"wp-comment-1486","title":"Just%20use%20a%20single%20thread%20to%20process%20the%20queue.%20That%20way%20you%20will%20never%20have%20fights%20between%20threads%20over%20memory.If%20you%20need%20to%20get%20performance%20back%20up%2C%20then%20use%20multi-threading%20inside%20a%20single%20tas...","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1486","item_id":"_comm_1486"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1486 == 'undefined' ){PDRTJS_468178_comm_1486 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1486 );}}PDRTJS_settings_468178_comm_1485={"id":468178,"unique_id":"wp-comment-1485","title":"It%20is%20very%20difficult%20to%20give%20advice%2C%20since%20we%20are%20told%20so%20very%20little%20of%20the%20finer%20points%20of%20the%20problem%2C%20for%20example%2C%20what%20means%20we%20have%20to%20track%20memory%20allocation%20on%20a%20per-item%20basis.%20Anyway%3A0....","permalink":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/#comment-1485","item_id":"_comm_1485"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_1485 == 'undefined' ){PDRTJS_468178_comm_1485 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_1485 );}}
//--><!]]></script><script type='text/javascript' charset='UTF-8' src='https://polldaddy.com/js/rating/rating.js'></script><script type='text/javascript' src='https://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"3379246","siteName":"Sutter\u2019s Mill","siteURL":"https:\/\/herbsutter.com","icon":"<img alt='' src='https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=50&d=https%3A%2F%2Fs2.wp.com%2Fi%2Flogo%2Fwpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/mistylook","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2009%2F09%2F28%2Fwhats-the-best-way-to-process-a-pool-of-work%2F","themeURL":"","xhrURL":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"8fb9818ae2","isSingular":"1","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"4590924cc6\" \/>","referer":"https:\/\/herbsutter.com\/2009\/09\/28\/whats-the-best-way-to-process-a-pool-of-work\/","canFollow":"1","feedID":"171936","statusMessage":"","customizeLink":"https:\/\/herbsutter.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fherbsutter.wordpress.com%2F2009%2F09%2F28%2Fwhats-the-best-way-to-process-a-pool-of-work%2F","postID":"296","shortlink":"https:\/\/wp.me\/peb5Y-4M","canEditPost":"","editLink":"https:\/\/wordpress.com\/post\/herbsutter.com\/296","statsLink":"https:\/\/wordpress.com\/stats\/post\/296\/herbsutter.com","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: MistyLook","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 19,532 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2009%2F09%2F28%2Fwhats-the-best-way-to-process-a-pool-of-work%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVjcEOgjAQRH/IuoIYT8Zvqe2GLrQLdlvAv7ceJEYTEg+bTGbe7MA8KjNwQk7QCVicyOC47DvZwUcUshp9bokFPPUocM+Y0Wm2HuM3/CblwUkvjlrnyyWMv87GjraBWN10hKCloEWpYcIYyZb91fvzQ4ra9LJVMokGfpVWVehruFSnujo0x+Zcd0+y+3Rn'></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'3379246','blog_tz':'-8','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'3379246','v':'wpcom','tz':'-8','user_id':'0','post':'296','subd':'herbsutter'}]);
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29+Smw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8/MkNtblkvY1d1TjBELytHc0k/MXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sQmp5PTlaVVYsJVRvWTBMR0d3Sks5W3ZvU1FFaltLd0c4RE5BVUVlQnNpZXRHSmJ1c2NDN2xNa1syaFQwTGlPaFRseThHY1dUclNZc2gyZlJ0ZGx3Rkl4XyUvcDF8MTU4blVaWUg/LyVTRjMxY2VaanpTJXVyMTdvLS5HaVJkeFVEK2xhMHJzUWV5dGNXd1BQRkhSNzBSeUpZQXQ2c2FFekNUblMtfkFBZ2d4TWJFdi52R0FFbTU3XUlLelFud2gvRFI1R2hINQ=='}]);
_stq.push([ 'clickTrackerInit', '3379246', '296' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>
<!--
	generated in 0.090 seconds
	60169 bytes batcached for 300 seconds
-->
