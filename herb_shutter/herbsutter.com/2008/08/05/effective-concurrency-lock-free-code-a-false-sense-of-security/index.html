<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Effective Concurrency: Lock-Free Code &#8212; A False Sense of Security | Sutter’s Mill</title>
<link rel="pingback" href="https://herbsutter.com/xmlrpc.php" />
<script type="text/javascript">
  WebFontConfig = {"typekit":{"id":"eyo0tqd"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://s0.wp.com/wp-content/plugins/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active #header h1{font-size:2.12em;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active body{font-size:89.7%;font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation{font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation ul li.search{font-size:1.06em}.wf-active #navigation ul li.search input#searchsubmit{font-size:1.06em}.wf-active #content .post-info, .wf-active #content .postmetadata{font-size:1.06em}.wf-active #sidebar{font-size:1.06em}.wf-active #footer p.right{font-size:1.06em}.wf-active .commentnum{font-size:1.77em}.wf-active .commentlist li .cmtinfo{font-size:1.18em}.wf-active .commentlist li .cmtinfo em{font-size:1.06em}.wf-active #respond label{font-size:11.8px}.wf-active #respond .required{font-size:11.8px}.wf-active #respond .subscribe-label{font-size:14.2px}.wf-active #respond .comment-notes{font-size:13px}.wf-active .wp-caption p.wp-caption-text{font-size:13px}.wf-active #content h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active h5, .wf-active h6{font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active #header h2{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active #content h3{font-size:1.65em;font-weight:400;font-style:normal}.wf-active #content h4{font-size:1.3em;font-style:normal;font-weight:400}.wf-active #content h5{font-size:1.18em;font-style:normal;font-weight:400}.wf-active #content .post h2{font-size:1.65em;font-weight:400;font-style:normal}.wf-active li.sidebox h2{font-weight:400;font-size:1.89em;font-style:normal}.wf-active .post h4{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active .post h4 em{font-style:normal;font-weight:400}</style>
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=herbsutter.com&amp;id=3379246&amp;t=1542965851&amp;back=https%3A%2F%2Fherbsutter.com%2F2008%2F08%2F05%2Feffective-concurrency-lock-free-code-a-false-sense-of-security%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//herbsutter.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Feed" href="https://herbsutter.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Comments Feed" href="https://herbsutter.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Effective Concurrency: Lock-Free Code &#8212; A False Sense of&nbsp;Security Comments Feed" href="https://herbsutter.com/2008/08/05/effective-concurrency-lock-free-code-a-false-sense-of-security/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s1.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1532082729h&ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s2.wp.com/_static/??-eJyNkN1uwjAMhV9onsUG69W0Z0laE0zzp8QR6tvjUlUCwSpuonOS81knxkuGPkWhKBgaZN8cx4qeR6p4JsmmH+HmPvtaP/B1nOORI8uEcqKgYG4WA1eZfErjFtinQnofspE5EWhgQ15nRNnCQv5ZqVmetORmv0vWNFibC9UKegZuAZayT9wKuabWUnEwt0Tb2A9ofbotxBZTJpx/SE8DXi3hn+h9Rx4cSUVJGXKqqt5GaurZeGCNPJoFZoxJlsdVbE11lEB/aYRTfDBw9IbLFlpI9+NUOtTUnZ2hv/C7O+y/uu9uf+jOV8Xg7sY=?cssminify=yes' type='text/css' media='all' />
<link rel='stylesheet' id='print-css-1-1' href='https://s2.wp.com/wp-content/mu-plugins/global-print/global-print.css?m=1465851035h&cssminify=yes' type='text/css' media='print' />
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??/wp-content/mu-plugins/actionbar/actionbar.css,/wp-content/themes/h4/global.css?m=1516985148j&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyFztEKwjAMBdAfsquTiXsRv6XWOFKXtDbphn69HeiDMBQCgdzDJXZOBtmP5QJiQ517gfx4rybIxv4ChnDITqEh5A/2kRVYF0vxjCOYIpDdUG+16BpXXIqiBCIVraTfLyFPCPNfFkCT8zeTQfC5tJ7o2Hb9Yde3+24bXjRNW9I='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://herbsutter.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Server Concurrency != Client&nbsp;Concurrency' href='https://herbsutter.com/2008/08/01/server-concurrency-client-concurrency/' />
<link rel='next' title='Embedded Multicore Development Webinar with Lee, Reinders, and&nbsp;Truchard' href='https://herbsutter.com/2008/08/06/embedded-multicore-development-webinar-with-lee-reinders-and-truchard/' />
<meta name="generator" content="WordPress.com" />
<link rel="canonical" href="https://herbsutter.com/2008/08/05/effective-concurrency-lock-free-code-a-false-sense-of-security/" />
<link rel='shortlink' href='https://wp.me/peb5Y-27' />
<link rel="alternate" type="application/json+oembed" href="https://public-api.wordpress.com/oembed/?format=json&amp;url=https%3A%2F%2Fherbsutter.com%2F2008%2F08%2F05%2Feffective-concurrency-lock-free-code-a-false-sense-of-security%2F&amp;for=wpcom-auto-discovery" /><link rel="alternate" type="application/xml+oembed" href="https://public-api.wordpress.com/oembed/?format=xml&amp;url=https%3A%2F%2Fherbsutter.com%2F2008%2F08%2F05%2Feffective-concurrency-lock-free-code-a-false-sense-of-security%2F&amp;for=wpcom-auto-discovery" />
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Effective Concurrency: Lock-Free Code &#8212; A False Sense of Security" />
<meta property="og:url" content="https://herbsutter.com/2008/08/05/effective-concurrency-lock-free-code-a-false-sense-of-security/" />
<meta property="og:description" content="DDJ posted the next Effective Concurrency column a couple of weeks earlier than usual. You can find it here: &#8220;Lock-Free Code: A False Sense of Security&#8221;, just went live on DDJ&#8217;s s…" />
<meta property="article:published_time" content="2008-08-06T00:31:41+00:00" />
<meta property="article:modified_time" content="2008-11-02T17:33:48+00:00" />
<meta property="og:site_name" content="Sutter’s Mill" />
<meta property="og:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=200&amp;ts=1542965851" />
<meta property="og:image:width" content="200" />
<meta property="og:image:height" content="200" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta name="twitter:text:title" content="Effective Concurrency: Lock-Free Code &#8212; A False Sense of&nbsp;Security" />
<meta name="twitter:image" content="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=240" />
<meta name="twitter:card" content="summary" />
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom" />

<!-- End Jetpack Open Graph Tags -->
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=114" />
<link rel='openid.server' href='https://herbsutter.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://herbsutter.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://herbsutter.com/osd.xml" title="Sutter’s Mill" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<script type="text/javascript" id="webfont-output">
  
  WebFontConfig = {"typekit":{"id":"cjs1oxc"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<meta name="application-name" content="Sutter’s Mill" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Herb Sutter on software development" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://herbsutter.com/feed/;icon-uri=https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=16" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="description" content="DDJ posted the next Effective Concurrency column a couple of weeks earlier than usual. You can find it here: &quot;Lock-Free Code: A False Sense of Security&quot;, just went live on DDJ&#039;s site, and also appears in the print magazine.   This is a special column in a way, because I rarely critique someone else&#039;s published&hellip;" />
<style type="text/css">
			#header h1 a,
		#header h2 {
			color: #265E15 !important;
		}
				#headerimage {
			background: url('https://herbsutter.files.wordpress.com/2011/10/cropped-blog-header.jpg') no-repeat;
			height: 200px;
		}
	</style>
<link rel="amphtml" href="https://herbsutter.com/2008/08/05/effective-concurrency-lock-free-code-a-false-sense-of-security/amp/"><style type="text/css" id="syntaxhighlighteranchor"></style>
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=eb5Y&#038;cscache=6&#038;csrev=60" />
		</head>
<body id="section-index" class="post-template-default single single-post postid-131 single-format-standard mp6 customizer-styles-applied highlander-enabled highlander-light">


<div id="navigation" class="clearfix">
		<div class="menu">
		<ul>
			<li ><a href="https://herbsutter.com/" title="Home">Home</a></li>
			<li class="page_item page-item-912"><a href="https://herbsutter.com/welcome-to-the-jungle/">Welcome to the&nbsp;Jungle</a></li>
<li class="page_item page-item-864 page_item_has_children"><a href="https://herbsutter.com/gotw/">GotW</a></li>
<li class="page_item page-item-761"><a href="https://herbsutter.com/elements-of-modern-c-style/">Elements of Modern C++&nbsp;Style</a></li>
<li class="page_item page-item-2 page_item_has_children"><a href="https://herbsutter.com/about/">About</a></li>
									<li class="search"><form method="get" id="searchform" action="https://herbsutter.com"><input type="text" class="textbox" value="" name="s" id="s" /><input type="submit" id="searchsubmit" value="Search" /></form></li>
					</ul>
	</div>
</div><!-- end id:navigation -->

<div id="container">

<div id="header">
<h1><a href="https://herbsutter.com/" title="Sutter’s Mill">Sutter’s Mill</a></h1>
<h2>Herb Sutter on software development</h2>
</div><!-- end id:header -->


	
		<div id="feedarea">
	<dl>
		<dt><strong>Feeds:</strong></dt>

			<dd><a href="https://herbsutter.com/feed/">Posts</a></dd>
	
			<dd><a href="https://herbsutter.com/comments/feed/">Comments</a></dd>
		</dl>
	</div><!-- end id:feedarea -->
	
	<div id="headerimage">
</div><!-- end id:headerimage -->

<div id="content">
<div id="content-main">

		
									<div class="postnav">
				<div class="alignleft">&laquo; <a href="https://herbsutter.com/2008/08/01/server-concurrency-client-concurrency/" rel="prev">Server Concurrency != Client&nbsp;Concurrency</a></div>
				<div class="alignright"><a href="https://herbsutter.com/2008/08/06/embedded-multicore-development-webinar-with-lee-reinders-and-truchard/" rel="next">Embedded Multicore Development Webinar with Lee, Reinders, and&nbsp;Truchard</a> &raquo;</div>
			</div>
			
			<div class="post-131 post type-post status-publish format-standard hentry category-c-net category-c category-concurrency category-java" id="post-131">
				<div class="posttitle">
					<h2>Effective Concurrency: Lock-Free Code &#8212; A False Sense of&nbsp;Security</h2>
					<p class="post-info">2008-08-05 by <a href="https://herbsutter.com/author/herbsutter/" title="Posts by Herb Sutter">Herb Sutter</a>  </p>
				</div>

				<div class="entry">
					<div>DDJ posted the next <strong>Effective Concurrency</strong> column a couple of weeks earlier than usual. You can find it here: <a href="http://www.ddj.com/cpp/210600279"><strong>&#8220;Lock-Free Code: A False Sense of Security&#8221;</strong></a>, just went live on DDJ&#8217;s site, and also appears in the print magazine.</div>
<div> </div>
<div>This is a special column in a way, because I rarely critique someone else&#8217;s published code. However, mere weeks ago DDJ itself published <a href="http://www.ddj.com/208801974">an article with fundamentally broken code</a> that tried to show how to write a simplified lock-free queue. I corresponded with the author, Petru Marginean, and his main reviewer, Andrei Alexandrescu, to discuss the problems, and they have patched the code somewhat and added a disclaimer to the article. But the issues need to be addressed, and so Petru kindly let me vivisect his code in public in this column (and the next, not yet available, which will show how to do it right).</div>
<div> </div>
<div>From the article:</div>
<blockquote><p>[Lock-free code is] hard even for experts. It&#8217;s easy to write lock-free code that appears to work, but it&#8217;s very difficult to write lock-free code that is correct and performs well. Even good magazines and refereed journals have published a substantial amount of lock-free code that was actually broken in subtle ways and needed correction.</p>
<p>To illustrate, let&#8217;s dissect some peer-reviewed lock-free code that was published here in <em>DDJ</em> just two months ago &#8230;</p></blockquote>
<div>I hope you enjoy it. (Note: Yes, the title is a riff on Tom Cargill&#8217;s classic article <a href="http://www.informit.com/content/images/020163371x/supplements/Exception_Handling_Article.html">&#8220;Exception Handling: A False Sense of Security&#8221;</a>, one of Scott Meyers&#8217; five <a href="http://www.artima.com/cppsource/top_cpp_publications.html">&#8220;Most Important C++ Non-Book Publications&#8230;Ever&#8221;</a>.)</div>
<div> </div>
<div>Finally, here are links to previous Effective Concurrency columns (based on the magazine print issue dates):</div>
<table border="0" cellspacing="5" cellpadding="5" width="555">
<tbody>
<tr>
<td width="114" valign="top">August 2007</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/200001985">The Pillars of Concurrency</a></td>
</tr>
<tr>
<td width="114" valign="top">September 2007</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/201202924">How Much Scalability Do You Have or Need?</a></td>
</tr>
<tr>
<td width="114" valign="top">October 2007</td>
<td width="422" valign="top"><a title="Use Critical Sections (Preferably Locks) to Eliminate Races" href="http://ddj.com/cpp/201804238">Use Critical Sections (Preferably Locks) to Eliminate Races</a></td>
</tr>
<tr>
<td width="114" valign="top">November 2007</td>
<td width="422" valign="top"><a title="Use Critical Sections (Preferably Locks) to Eliminate Races" href="http://www.ddj.com/hpc-high-performance-computing/202401098">Apply Critical Sections Consistently</a></td>
</tr>
<tr>
<td width="114" valign="top">December 2007</td>
<td width="422" valign="top"><a href="http://herbsutter.spaces.live.com/blog/cns!2D4327CC297151BB!342.entry"></a><a title="Avoid Calling Unknown Code While Inside a Critical Section" href="http://ddj.com/architect/202802983">Avoid Calling Unknown Code While Inside a Critical Section</a></td>
</tr>
<tr>
<td width="114" valign="top">January 2007</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/204801163">Use Lock Hierarchies to Avoid Deadlock</a></td>
</tr>
<tr>
<td width="114" valign="top">February 2008</td>
<td width="422" valign="top"><a href="http://www.ddj.com/cpp/205900309">Break Amdahl&#8217;s Law!</a></td>
</tr>
<tr>
<td width="114" valign="top">March 2008</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/206100542">Going Superlinear</a></td>
</tr>
<tr>
<td width="114" valign="top">April 2008</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/206903306">Super Linearity and the Bigger Machine</a></td>
</tr>
<tr>
<td width="114" valign="top">May 2008</td>
<td width="422" valign="top"><a href="http://ddj.com/architect/207100682">Interrupt Politely</a></td>
</tr>
<tr>
<td width="114" valign="top">June 2008</td>
<td width="422" valign="top"><a href="http://ddj.com/architect/208200273">Maximize Locality, Minimize Contention</a></td>
</tr>
<tr>
<td width="114" valign="top">July 2008</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/208801371">Choose Concurrency-Friendly Data Structures</a></td>
</tr>
<tr>
<td width="114" valign="top">August 2008</td>
<td width="422" valign="top"><a href="http://www.ddj.com/hpc-high-performance-computing/209900973">The Many Faces of Deadlock</a></td>
</tr>
<tr>
<td width="114" valign="top">September 2008</td>
<td width="422" valign="top"><a href="http://www.ddj.com/cpp/210600279">&#8220;Lock-Free Code: A False Sense of Security&#8221;</a></td>
</tr>
</tbody>
</table>
									</div>

				<p class="postmetadata">
					Posted in <a href="https://herbsutter.com/category/c-net/" rel="category tag">C# / .NET</a>, <a href="https://herbsutter.com/category/c/" rel="category tag">C++</a>, <a href="https://herbsutter.com/category/concurrency/" rel="category tag">Concurrency</a>, <a href="https://herbsutter.com/category/java/" rel="category tag">Java</a> | 											13 Comments									</p>
				
<!-- You can start editing here. -->

<h3 id="comments">13 Responses</h3>

	<ol class="commentlist">
			<li class="pingback even thread-even depth-1 highlander-comment" id="comment-978">
		<div id="div-comment-978">
		<div class="cmtinfo"><em> on <a href="#comment-978" title="">2009-01-05 at 7:04 am</a></em>  <cite><a href='http://stevehuston.wordpress.com/2009/01/05/theres-no-substitute-for-experience-with-threads/' rel='external nofollow' class='url'>There&#8217;s No Substitute for Experience with Threads &laquo; Steve Huston&#8217;s Networked Programming Blog</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_978"></div><p>[&#8230;] Code: A False Sense of Security&#8221; by Herb Sutter (his blog entry related to the article is here). His &#8220;Effective Concurrency&#8221; column is a regular favorite of mine. The article is a [&#8230;]</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="pingback odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-836">
		<div id="div-comment-836">
		<div class="cmtinfo"><em> on <a href="#comment-836" title="">2008-10-14 at 8:09 am</a></em> <img alt='' src='https://secure.gravatar.com/blavatar/4398ebc6749de91dafb2df141817d8ac?s=48' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://rhnatiuk.wordpress.com/2008/10/14/interesting-concurrency-articles/' rel='external nofollow' class='url'>Interesting Concurrency Articles &laquo; Roman&#8217;s Blog</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_836"></div><p>[&#8230;] info  By Roman Hnatiuk   Categories: Software Development                     Effective Concurrency: Lock-Free Code &#8211; A False Sense of Security by Herb Sutter talks about lock-free code and its pitfalls. Also it contains pointers to many other [&#8230;]</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-802">
		<div id="div-comment-802">
		<div class="cmtinfo"><em> on <a href="#comment-802" title="">2008-09-25 at 12:14 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/c807a3c309c36a74b02b74d09341ee24?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Majkara</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_802"></div><p>Hi Herb,</p>
<p>Critique is good. Not long ago, I remember when you and Alexandrescu, and friends got pretty much slaughtered on a C++ list for not figuring out atomic semantics and barriers and ordering problems, in a very similar fashion.</p>
<p>It all kicked off with a reference counted string implementation or similiar. Even source was provided and compilers could have adopted to support it in fact. And no one ever did anything about that?</p>
<p>It is common knowledge these days a few barriers eliminate the problem of single consumer, single producer scenarios. I guess that is what is taking over a month to publish as people eagerly await a common and trivial solution. At least it has been common since 2001.</p>
<p>So, critique is good, and no you are no different than anyone else out there regarding parallel programming.</p>
<p>It is all trickery against moving target that is hardware. Hence working on VMs and C++/CLI is a waste of time really. They even go against stack as the main culprit, which is symptomatic of going the bloated, slow, framework route (ie. doomed, in terms of performance and time it will be adopted for ).</p>
<p>Regards,<br />
Majka</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="pingback odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-792">
		<div id="div-comment-792">
		<div class="cmtinfo"><em> on <a href="#comment-792" title="">2008-08-29 at 11:34 pm</a></em>  <cite><a href='http://mkseo.pe.kr/blog/?p=1785' rel='external nofollow' class='url'>Passion is like genius; a miracle. - 흥미롭게 읽은, 읽을 concurrency 글들</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_792"></div><p>[&#8230;] 제대로 구현한 lock-free queue 일 듯. 이 글은 그 유명하신 Herb Sutter가 쓴 글로 시리즈 물로 ddj 에서 [&#8230;]</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-785">
		<div id="div-comment-785">
		<div class="cmtinfo"><em> on <a href="#comment-785" title="">2008-08-17 at 8:53 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/22b1c1e8ce63f27b7b32bdd701d64b04?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Rainer Koppler</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_785"></div><p>I think that the topic of this month&#8217;s column has already been covered by an enlightening paper by Scott Meyers and Andrei Alexandrescu, which appeared in Dr. Dobb&#8217;s Journal four years ago:</p>
<p>C++ and the Perils of Double-Checked Locking<br />
<a href="http://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf" rel="nofollow">http://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf</a><br />
<a href="http://www.nwcpp.org/Downloads/2004/DCLP_notes.pdf" rel="nofollow">http://www.nwcpp.org/Downloads/2004/DCLP_notes.pdf</a></p>
<p>In a nutshell, all concurrent software we have written in C++98 up to now that does not rely on threading libraries with operating system support (which includes numerous beloved non-blocking algorithms employing volatile) works by accident. In fact, volatile with its optimization-prevention semantics is often sufficient for single-processor parallelism (by accident, however), but that does not mean that optimization prevention using volatile is the key to thread safety under all circumstances, including multi-processor parallelism with weak memory consistency. The following part of the Linux kernel documentation offers a good treatment of volatile and its abuse for achieving thread safety:</p>
<p>Why the &#8220;volatile&#8221; type class should not be used<br />
<a href="http://www.mjmwired.net/kernel/Documentation/volatile-considered-harmful.txt" rel="nofollow">http://www.mjmwired.net/kernel/Documentation/volatile-considered-harmful.txt</a></p>
<p>Following Scott and Andrei, the only way to guarantee thread safety using C++98 is the use of platform-specific memory barriers (in other words: there is no portable solution in C++98), which are essentially also used in platform-specific implementations of threading libraries. So if you roll your own data structures, there&#8217;s no way around these operations.</p>
<p>However, in the realm of embedded systems the world can look quite different: Many low-cost controllers do not confront the programmer with topics like memory consistency, so you mostly get along without barriers or the like. Your code works, but &#8212; from the language lawyers&#8217;s perspective &#8212; by accident.</p>
<p>Regarding Fred&#8217;s ring implementation: When we assume that reading and writing the index variables is done atomically, the protocols described in Scott&#8217;s slides (DCLP_notes, slide 29-32) can be employed: ring_get needs an Acquire between reading write_index and accessing buffer, and ring_put needs a Release between writing to buffe and updating write_index.</p>
<p>By the way: During my lectures I discovered Petru Marginean&#8217;s name in the Acknowledgements section of Scott&#8217;s and Andrei&#8217;s paper. Now the circle closes&#8230;</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-784">
		<div id="div-comment-784">
		<div class="cmtinfo"><em> on <a href="#comment-784" title="">2008-08-16 at 6:16 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/e6238b3a86066745f5f725ebde62f383?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Fred Roeber</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_784"></div><p>As others have mentioned, I have a hard time believing that we have to worry about some of the transformations and reorderings mentioned near the end of the article. Or, stated a different way I have trouble believing it&#8217;s possible to write any valid lock free program if such transformations and reorderings are really possible. This bothers me a lot because I&#8217;ve worked with a lot of embedded system&#8217;s code (including the source code for more than a few of the proprietary and very popular embedded operating systems). I&#8217;ve had to verify and correct the operation of a lot of this code for some pretty safety critical applications. I now wonder, &#8220;is the code I thought was safe really safe&#8221;.</p>
<p>I&#8217;d sort of like to get an opinion about one bit of C code that I have seen used over and over to do &#8220;lock free&#8221; &#8220;single reader &#8211; single writer&#8221; communication. I&#8217;ve seen this used on many of the processors out there with lots of compilers and never known there to be a problem. But if processors can insert false writes and totally ignore sequential consistency then maybe this code isn&#8217;t valid.  </p>
<p>typedef struct {<br />
    volatile size_t read_index;  /* index of next data to get/read */<br />
    volatile size_t write_index; /* index of next place to put/write data */<br />
    size_t          buffer_size; /* size of ring &#8216;buffer&#8217; in bytes */<br />
    uint8_t        *buffer;      /* pointer to start of buffer */<br />
} RING_T;</p>
<p>typedef RING_T *RING_ID;</p>
<p>/**<br />
 * Get one byte from a ring buffer.<br />
 *<br />
 * @Param ring_id   Ring buffer to manipulate<br />
 * @Param byte_ptr  Where to store returned byte<br />
 *<br />
 * @Return true if there was a byte to return, false otherwise<br />
 */<br />
bool<br />
ring_get(RING_ID ring_id, uint8_t *byte_ptr)<br />
{<br />
    size_t read_index;</p>
<p>    read_index = ring_id-&gt;read_index;<br />
    if (read_index == ring_id-&gt;write_index) {<br />
        /* Ring is empty */<br />
        return false;<br />
    } else {<br />
        /* Pull byte out of ring and advance ring index */<br />
        *byte_ptr = ring_id-&gt;buffer[read_index];<br />
        if (++read_index == ring_id-&gt;buffer_size) {<br />
            read_index = 0;<br />
        }<br />
        ring_id-&gt;read_index = read_index;<br />
        return true;<br />
    }<br />
}</p>
<p>/**<br />
 * Initialize ring buffer to be empty.<br />
 *<br />
 * Create a ring buffer of size &#8216;nbytes&#8217;, and initialize<br />
 * it. Note, a ring buffer can store a<br />
 * maximum of one byte less than &#8216;nbytes&#8217;.<br />
 *<br />
 * @Param  ring_id  Preallocated ring buffer control structure to initialize<br />
 * @Param  buffer   Buffer that ring buffer data to be stored in<br />
 * @Param  nbytes   Size of &#8216;buffer&#8217; in bytes<br />
 */<br />
void<br />
ring_init(RING_ID ring_id, uint8_t *buffer, size_t nbytes)<br />
{<br />
    /* Save the buffer info in the ring control structure. */<br />
    ring_id-&gt;buffer      = buffer;<br />
    ring_id-&gt;buffer_size = nbytes;</p>
<p>    /* Make sure ring buffer starts out empty */<br />
    ring_id-&gt;read_index  = 0;<br />
    ring_id-&gt;write_index = 0;<br />
}</p>
<p>/**<br />
 * Put one byte into a ring buffer.<br />
 *<br />
 * @Param ring_id  Ring buffer to manipulate<br />
 * @Param byte     Byte to put into ring<br />
 *<br />
 * @Return true if there was space for byte, false otherwise<br />
 */<br />
bool<br />
ring_put(RING_ID ring_id, uint8_t byte)<br />
{<br />
    size_t write_index;</p>
<p>    write_index = ring_id-&gt;write_index;<br />
    if (write_index == ring_id-&gt;read_index &#8211; 1) {<br />
        /* Ring is full so can&#8217;t write any more */<br />
        return false;<br />
    } else {<br />
        if (write_index == ring_id-&gt;buffer_size &#8211; 1) {<br />
            if (ring_id-&gt;read_index == 0) {<br />
                /* Ring is full so can&#8217;t write any more */<br />
                return false;<br />
            } else {<br />
                ring_id-&gt;buffer[write_index] = byte;<br />
                ring_id-&gt;write_index = 0;<br />
                return true;<br />
            }<br />
        } else {<br />
            ring_id-&gt;buffer[write_index] = byte;<br />
            ring_id-&gt;write_index = write_index + 1;<br />
            return true;<br />
        }<br />
    }<br />
}</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-772">
		<div id="div-comment-772">
		<div class="cmtinfo"><em> on <a href="#comment-772" title="">2008-08-11 at 6:45 pm</a></em> <img alt='' src='https://0.gravatar.com/avatar/361baa67583dc1033f2f3b3c97761c2c?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://notes.dpdx.net' rel='external nofollow' class='url'>Brooks Moses</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_772"></div><p>To Jaroslav Sevcik:</p>
<p>Thanks for the explanation!  And I see the larger issue underlying the &#8220;why not make &#8220;data&#8221; volatile&#8221; part of it, too; it may only be at very specific points in a program that one cares about the volatility of a variable, and prohibitively expensive to make it volatile throughout.</p>
<p>I would have thought that it would generally be possible to encapsulate the relevant portions of the code in a function and only declare data to be volatile within that function, though.  I gather that that isn&#8217;t as general as I think?</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-768">
		<div id="div-comment-768">
		<div class="cmtinfo"><em> on <a href="#comment-768" title="">2008-08-08 at 3:13 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/0266a80d7d5fbc4df7b7f3001da53848?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://homepages.inf.ed.ac.uk/s0566973/' rel='external nofollow' class='url'>Jaroslav Sevcik</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_768"></div><p>To Brooks Moses:</p>
<p>The problem with the C++ volatile is that it is too weak for safe multi-threading, because it only prevents optimizations on the volatile variable itself, but it does not prevent interfering optimization on other variables, such as the &#8216;payload&#8217; data in the queue.</p>
<p>While I do not have an example showing where real compiler does something wrong with this particular implementation of queue, I can show you an example, where C++ volatile is just not enough:</p>
<p>int data = 0;</p>
<p>volatile bool requestReady = false;<br />
volatile bool responseReady = false;</p>
<p>void thread1() {<br />
  data = 1;<br />
  requestReady = true;</p>
<p>  if (responseReady)<br />
    std::cout &lt;&lt; data;<br />
}</p>
<p>void thread2() {<br />
  if (requestReady) {<br />
    data = 2;<br />
    responseReady = true;<br />
  }<br />
}</p>
<p>Note this program can never print 1. However, compilers will happily replace &#8216;std::cout &lt;&lt; data&#8217; by &#8216;std::cout &lt;&lt; 1&#8217;. Suddenly, your program can print 1! </p>
<p>In Java, this program is data race free (because data races can only happen on volatile variables). In C++0x the program would be data race free, if requestReady and ResponseReady were atomic variables. Both Java and C++0x guarantee sequentially consistent behaviours for data race free program. That means that Java and C++0x guarantee sane behaviours, i.e., the program can only print 2.</p>
<p>You might suggest that programmers should make the &#8216;data&#8217; variable volatile, too. However, the &#8216;data&#8217; variable might be a pointer to some big data structure that is defined in a library, so you cannot make all fields of the data structure volatile. And you certainly do not want create a &#8216;volatile&#8217; copy of the entire structure just because you want to send a pointer&#8230;</p>
<p>Below is the real example that prints 1 (compile with gcc -O and pthreads):</p>
<p>#include<br />
#include </p>
<p>int data = 0;</p>
<p>volatile bool requestReady = false;<br />
volatile bool responseReady = false;</p>
<p>void *thread_proc(void *arg) {<br />
  //Wait for request<br />
  for(volatile int i = 0; i &lt; 500000000; i++) ; </p>
<p>  if (requestReady) {<br />
    data = 2;<br />
    responseReady = true;<br />
  }<br />
  return NULL;<br />
}</p>
<p>int main() {<br />
  pthread_t t1;<br />
  pthread_create(&amp;t1, NULL, thread_proc, NULL);</p>
<p>  data = 1;<br />
  requestReady = true;</p>
<p>  // Wait for response<br />
  for(volatile int i = 0; i &lt; 1000000000; i++) ; </p>
<p>  if (responseReady)<br />
    std::cout &lt;&lt; data &lt;&lt; std::endl;<br />
  return 0;<br />
}</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-767">
		<div id="div-comment-767">
		<div class="cmtinfo"><em> on <a href="#comment-767" title="">2008-08-07 at 11:46 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/361baa67583dc1033f2f3b3c97761c2c?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://notes.dpdx.net' rel='external nofollow' class='url'>Brooks Moses</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_767"></div><p>I&#8217;m curious about some of the compiler code-reorganization that you refer to in the article &#8212; why isn&#8217;t the solution to this problem to declare the relevant variables as &#8220;volatile&#8221;?  After all, the whole point of volatile is to tell the compiler that the variable in question may be changed or read by things outside the scope of the code being compiled, while that code is running, and thus that optimizations which would be broken by that (such as reordering the reads to be after other function calls, or inserting additional writes) should be avoided.</p>
<p>(See, for example, this DDJ article about the subject: <a href="http://www.ddj.com/cpp/184403766" rel="nofollow">http://www.ddj.com/cpp/184403766</a>.)</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-763">
		<div id="div-comment-763">
		<div class="cmtinfo"><em> on <a href="#comment-763" title="">2008-08-06 at 6:40 am</a></em> <img alt='' src='https://2.gravatar.com/avatar/239e18525e4c29872d85b2b553b2e4d2?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite>Maxim Yegorushkin</cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_763"></div><p>If we look closely at the queue constructor and Produce code:</p>
<p> LockFreeQueue() {<br />
    list.push_back(T());<br />
    iHead = list.begin();<br />
    iTail = list.end(); // &lt;&#8212; here<br />
  }</p>
<p>  void Produce(const T&amp; t) {<br />
    list.push_back(t);<br />
    iTail = list.end(); // &lt;&#8212; and here<br />
    list.erase(list.begin(), iHead);<br />
  }</p>
<p>In a typical list implementation list::end() always returns the very same iterator regardless of prior insertion and removals. It is no surprise, because a straigt forward implemenation would use a dummy list node to maintain the list. dummy_node.next is the return value of list::begin(), &amp;dummy_node is the return value of list::end() and dummy_node.prev is the last node (if any) of the list. When the list is empty &amp;dummy_node == dummy_node.next, so that list::begin() == list::end().</p>
<p>In other words, the necessity of iTail member is implementation defined and is rather questionable.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-761">
		<div id="div-comment-761">
		<div class="cmtinfo"><em> on <a href="#comment-761" title="">2008-08-06 at 3:09 am</a></em> <img alt='' src='https://0.gravatar.com/avatar/0266a80d7d5fbc4df7b7f3001da53848?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://homepages.inf.ed.ac.uk/s0566973/' rel='external nofollow' class='url'>Jaroslav Sevcik</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_761"></div><p>Thanks for the nice article. While I agree that the code you show is flawed, I am somewhat skeptical that compilers/processors perform the transformations you show on the last page. </p>
<p>As for the insertion of write: Is there any processor that can introduce new writes of a different value from the ones that are already in the execution? As far as I know, Intel IA-32, AMD and Sun TSO cannot introduce new writes. Intel Itanium sort of can but only with the same value as the existing ones. As for compilers, .NET cannot introduce writes at all, and Java cannot introduce writes out-of-thin-air, which is the case you show. C++0x could insert the write you show, but I am somewhat doubtful that any implementation would do that.</p>
<p>The speculation on the outcome of if-statement seems to be even more suspicious, because it violates sequential consistency for correctly synchronized programs.</p>
<p>For example, consider this program:</p>
<p>LockFreeQueue q;<br />
main() {start_thread(t2); int r; if (q.Consume(r)) printf(&#8220;!&#8221;);}<br />
t2() {int r; if (q.Consume(r)) printf(&#8220;!&#8221;);}</p>
<p>The program does not have any data races, because after initialization it only reads. Moreover, it cannot print in any sequentially consistent execution, because  q is always an empty queue. However, after your speculation transformation, there is an interleaving where the program can print in a sequentially consistent execution (e.g., if first thread performs iNext=iHead;iNext++;__temp=iHead;iHead=iNext; then the second thread goes iNext=iHead;iNext++;__temp=iHead;iHead=iNext;if (iNext==iTail) &#8230; {t=*Head;return true;}). This implies that neither Java, nor C#, nor C++ can perform such transformation, because they guarantee that you only get sequentially consistent behaviors from data race free programs.</p>
<p>Am I wrong somewhere? Do you know any compiler/hardware that performs these transformations? I am sorry for the long comment.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 highlander-comment" id="comment-760">
		<div id="div-comment-760">
		<div class="cmtinfo"><em> on <a href="#comment-760" title="">2008-08-05 at 8:22 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/8d9023bdc5cbadf3221a0b66a46a34e6?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://blog.reverberate.org' rel='external nofollow' class='url'>Joshua Haberman</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_760"></div><p>I suppose I should have scanned your recent articles and read the one about deadlock before posting &#8212; I am sure you will correct me and explain that deadlock *can* exist in lock-free designs.  :)  I think it&#8217;s still the case that lock-based designs do force programmers to contend with lots of error-prone issues like lock granularity, ordering, etc.   Maybe lock-free approaches will have lots of issues of their own, but I think they&#8217;re at least worth a shot, and I think people should understand that lock-free data structures are analogous to mutexes themselves.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 highlander-comment" id="comment-759">
		<div id="div-comment-759">
		<div class="cmtinfo"><em> on <a href="#comment-759" title="">2008-08-05 at 8:08 pm</a></em> <img alt='' src='https://2.gravatar.com/avatar/8d9023bdc5cbadf3221a0b66a46a34e6?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /> <cite><a href='http://blog.reverberate.org' rel='external nofollow' class='url'>Joshua Haberman</a></cite></div>
						<div class="pd-rating" id="pd_rating_holder_468178_comm_759"></div><p>There&#8217;s no doubt that lock-free data structures are extremely difficult to write and get right.  But I disagree with the subtext that I perceive from this blog entry and your article that says &#8220;lock-free == risky, locks == safe.&#8221;  To me that seems like the wrong message to be sending.</p>
<p>There&#8217;s no doubt that only the experts should be writing lock-free data structures.  But the same is true of locks themselves: only experts who are familiar with the architecture (memory visibility model, barriers, etc) should be writing them.  Everyone else just uses the work that the experts do.  For example, it doesn&#8217;t take an expert to *use* a lock-free queue to coordinate a bunch of threads that are acting in a producer/consumer relationship.</p>
<p>From the perspective of the average programmer, *using* lock-free data structures shouldn&#8217;t be significantly more error-prone than using locks.  In fact it could be less so: lock-based programming forces you to deal with deadlock, priority inversion, etc. none of which arise in lock-free designs.</p>
<p>Good, robust lock-free data structures aren&#8217;t ubiquitous like locks are today, but to me that just means that the field is immature, not that lock-free approaches are inherently risky.</p>
			<br style="clear: both" />
		</div>
</li><!-- #comment-## -->
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>
	<br />

  	<p class="nocomments">Comments are closed.</p>
  <div class="post-content">
<p>
</p>
</div>

			</div>

		
		<p align="center"></p>

	</div><!-- end id:content-main -->
<div id="sidebar">
<ul>
<li class="sidebox"><h2><label for="subscribe-field">Follow by email</label></h2>
				<form action="https://subscribe.wordpress.com" method="post" accept-charset="utf-8" id="subscribe-blog">
																	<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" placeholder="Enter your email address" value="" id="subscribe-field"/></p>
					
					<p>
						<input type="hidden" name="action" value="subscribe"/>
						<input type="hidden" name="blog_id" value="3379246"/>
						<input type="hidden" name="source" value="https://herbsutter.com/2008/08/05/effective-concurrency-lock-free-code-a-false-sense-of-security/"/>
						<input type="hidden" name="sub-type" value="widget"/>
						<input type="hidden" name="redirect_fragment" value="blog_subscription-3" />
						<input type="hidden" id="_wpnonce" name="_wpnonce" value="4590924cc6" />						<input type="submit" value="Subscribe" />
					</p>
				</form>
			
</li><li class="sidebox"><h2><a href='http://twitter.com/herbsutter'>Tweets</a></h2><ul class='tweets'></ul><a href="http://twitter.com/herbsutter"  class='twitter-follow-button' data-show-count='false' data-link-color='#265e15' data-text-color='#333333'>Follow @herbsutter</a></li><li class="sidebox"><h2>Popular</h2><ul>				<li>
										<a href="https://herbsutter.com/2018/11/13/trip-report-fall-iso-c-standards-meeting-san-diego/" class="bump-view" data-bump-view="tp">
						Trip report: Fall ISO C++ standards meeting (San Diego)					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/gotw/" class="bump-view" data-bump-view="tp">
						GotW					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/2018/09/20/lifetime-profile-v1-0-posted/" class="bump-view" data-bump-view="tp">
						Lifetime profile v1.0 posted					</a>
										</li>
				</ul></li><li class="sidebox"><h2>Categories</h2>		<ul>
				<li class="cat-item cat-item-291"><a href="https://herbsutter.com/category/apple/" >Apple</a>
</li>
	<li class="cat-item cat-item-49277"><a href="https://herbsutter.com/category/c-net/" >C# / .NET</a>
</li>
	<li class="cat-item cat-item-2426"><a href="https://herbsutter.com/category/c/" >C++</a>
</li>
	<li class="cat-item cat-item-69816"><a href="https://herbsutter.com/category/cloud/" >Cloud</a>
</li>
	<li class="cat-item cat-item-214618"><a href="https://herbsutter.com/category/concurrency/" >Concurrency</a>
</li>
	<li class="cat-item cat-item-8259773"><a href="https://herbsutter.com/category/effective-concurrency/" >Effective Concurrency</a>
</li>
	<li class="cat-item cat-item-3696745"><a href="https://herbsutter.com/category/friday-thoughts/" >Friday Thoughts</a>
</li>
	<li class="cat-item cat-item-3867746"><a href="https://herbsutter.com/category/c/gotw/" >GotW</a>
</li>
	<li class="cat-item cat-item-79"><a href="https://herbsutter.com/category/hardware/" >Hardware</a>
</li>
	<li class="cat-item cat-item-1017"><a href="https://herbsutter.com/category/java/" >Java</a>
</li>
	<li class="cat-item cat-item-637"><a href="https://herbsutter.com/category/microsoft/" >Microsoft</a>
</li>
	<li class="cat-item cat-item-420845"><a href="https://herbsutter.com/category/opinion-editorial/" >Opinion &amp; Editorial</a>
</li>
	<li class="cat-item cat-item-1633077"><a href="https://herbsutter.com/category/reader-qa/" >Reader Q&amp;A</a>
</li>
	<li class="cat-item cat-item-2301"><a href="https://herbsutter.com/category/software-development/" >Software Development</a>
</li>
	<li class="cat-item cat-item-393523"><a href="https://herbsutter.com/category/talks-events/" >Talks &amp; Events</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://herbsutter.com/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-151"><a href="https://herbsutter.com/category/web/" >Web</a>
</li>
		</ul>
			</li></ul>
</div><!-- end id:sidebar -->
</div><!-- end id:content -->
</div><!-- end id:container -->
<div id="footer">
	<div id="colophon">
		<p><a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></p>
		<p>WPThemes.</p>
		<br class="clear" />
	</div><!-- end #colophon-->
</div><!-- end #footer-->
<!--  -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201847y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	<div class="grofile-hash-map-c807a3c309c36a74b02b74d09341ee24">
	</div>
	<div class="grofile-hash-map-22b1c1e8ce63f27b7b32bdd701d64b04">
	</div>
	<div class="grofile-hash-map-e6238b3a86066745f5f725ebde62f383">
	</div>
	<div class="grofile-hash-map-361baa67583dc1033f2f3b3c97761c2c">
	</div>
	<div class="grofile-hash-map-0266a80d7d5fbc4df7b7f3001da53848">
	</div>
	<div class="grofile-hash-map-239e18525e4c29872d85b2b553b2e4d2">
	</div>
	<div class="grofile-hash-map-8d9023bdc5cbadf3221a0b66a46a34e6">
	</div>
	</div>
<script type='text/javascript' charset='UTF-8' id='polldaddyRatings'><!--//--><![CDATA[//><!--
PDRTJS_settings_468178_comm_978={"id":468178,"unique_id":"wp-comment-978","title":"%26%23091%3B...%26%23093%3B%20Code%3A%20A%20False%20Sense%20of%20Security%26%238221%3B%20by%20Herb%20Sutter%20%28his%20blog%20entry%20related%20to%20the%20article%20is%20here%29.%20His%20%26%238220%3BEffective%20Concurrency%26%238221%3B%20column%20is%20a%20regular%20favorite%20of%20mine.%20The%20arti...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-978","item_id":"_comm_978"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_978 == 'undefined' ){PDRTJS_468178_comm_978 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_978 );}}PDRTJS_settings_468178_comm_836={"id":468178,"unique_id":"wp-comment-836","title":"%26%23091%3B...%26%23093%3B%20info%20%20By%20Roman%20Hnatiuk%20%20%20Categories%3A%20Software%20Development%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Effective%20Concurrency%3A%20Lock-Free%20Code%20-%20A%20False%20Sense%20of%20Security%20by%20Herb%20Sutter%20talks%20about%20lock-free%20code%20and...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-836","item_id":"_comm_836"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_836 == 'undefined' ){PDRTJS_468178_comm_836 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_836 );}}PDRTJS_settings_468178_comm_802={"id":468178,"unique_id":"wp-comment-802","title":"Hi%20Herb%2CCritique%20is%20good.%20Not%20long%20ago%2C%20I%20remember%20when%20you%20and%20Alexandrescu%2C%20and%20friends%20got%20pretty%20much%20slaughtered%20on%20a%20C%2B%2B%20list%20for%20not%20figuring%20out%20atomic%20semantics%20and%20barriers%20and%20ordering...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-802","item_id":"_comm_802"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_802 == 'undefined' ){PDRTJS_468178_comm_802 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_802 );}}PDRTJS_settings_468178_comm_792={"id":468178,"unique_id":"wp-comment-792","title":"%26%23091%3B...%26%23093%3B%20%20%20lock-free%20queue%20%20.%20%20%20%20%20Herb%20Sutter%20%20%20%20%20ddj%20%20%26%23091%3B...%26%23093%3B...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-792","item_id":"_comm_792"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_792 == 'undefined' ){PDRTJS_468178_comm_792 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_792 );}}PDRTJS_settings_468178_comm_785={"id":468178,"unique_id":"wp-comment-785","title":"I%20think%20that%20the%20topic%20of%20this%20month%26%23039%3Bs%20column%20has%20already%20been%20covered%20by%20an%20enlightening%20paper%20by%20Scott%20Meyers%20and%20Andrei%20Alexandrescu%2C%20which%20appeared%20in%20Dr.%20Dobb%26%23039%3Bs%20Journal%20four%20years%20ago%3AC%2B%2B%20an...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-785","item_id":"_comm_785"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_785 == 'undefined' ){PDRTJS_468178_comm_785 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_785 );}}PDRTJS_settings_468178_comm_784={"id":468178,"unique_id":"wp-comment-784","title":"As%20others%20have%20mentioned%2C%20I%20have%20a%20hard%20time%20believing%20that%20we%20have%20to%20worry%20about%20some%20of%20the%20transformations%20and%20reorderings%20mentioned%20near%20the%20end%20of%20the%20article.%20Or%2C%20stated%20a%20different%20way%20I%20...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-784","item_id":"_comm_784"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_784 == 'undefined' ){PDRTJS_468178_comm_784 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_784 );}}PDRTJS_settings_468178_comm_772={"id":468178,"unique_id":"wp-comment-772","title":"To%20Jaroslav%20Sevcik%3AThanks%20for%20the%20explanation%21%20%20And%20I%20see%20the%20larger%20issue%20underlying%20the%20%26quot%3Bwhy%20not%20make%20%26quot%3Bdata%26quot%3B%20volatile%26quot%3B%20part%20of%20it%2C%20too%3B%20it%20may%20only%20be%20at%20very%20specific%20points%20in%20a%20program%20that%20...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-772","item_id":"_comm_772"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_772 == 'undefined' ){PDRTJS_468178_comm_772 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_772 );}}PDRTJS_settings_468178_comm_768={"id":468178,"unique_id":"wp-comment-768","title":"To%20Brooks%20Moses%3AThe%20problem%20with%20the%20C%2B%2B%20volatile%20is%20that%20it%20is%20too%20weak%20for%20safe%20multi-threading%2C%20because%20it%20only%20prevents%20optimizations%20on%20the%20volatile%20variable%20itself%2C%20but%20it%20does%20not%20prevent%20...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-768","item_id":"_comm_768"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_768 == 'undefined' ){PDRTJS_468178_comm_768 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_768 );}}PDRTJS_settings_468178_comm_767={"id":468178,"unique_id":"wp-comment-767","title":"I%26%23039%3Bm%20curious%20about%20some%20of%20the%20compiler%20code-reorganization%20that%20you%20refer%20to%20in%20the%20article%20--%20why%20isn%26%23039%3Bt%20the%20solution%20to%20this%20problem%20to%20declare%20the%20relevant%20variables%20as%20%26quot%3Bvolatile%26quot%3B%3F%20%20After%20all%2C%20...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-767","item_id":"_comm_767"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_767 == 'undefined' ){PDRTJS_468178_comm_767 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_767 );}}PDRTJS_settings_468178_comm_763={"id":468178,"unique_id":"wp-comment-763","title":"If%20we%20look%20closely%20at%20the%20queue%20constructor%20and%20Produce%20code%3A%20LockFreeQueue%28%29%20%7B%20%20%20%20list.push_back%28T%28%29%29%3B%20%20%20%20iHead%20%3D%20list.begin%28%29%3B%20%20%20%20iTail%20%3D%20list.end%28%29%3B%20%2F%2F%20%26lt%3B---%20here%20%20%7D%20%20void%20Produce%28const%20T%26amp%3Bam...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-763","item_id":"_comm_763"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_763 == 'undefined' ){PDRTJS_468178_comm_763 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_763 );}}PDRTJS_settings_468178_comm_761={"id":468178,"unique_id":"wp-comment-761","title":"Thanks%20for%20the%20nice%20article.%20While%20I%20agree%20that%20the%20code%20you%20show%20is%20flawed%2C%20I%20am%20somewhat%20skeptical%20that%20compilers%2Fprocessors%20perform%20the%20transformations%20you%20show%20on%20the%20last%20page.%20As%20for%20the%20in...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-761","item_id":"_comm_761"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_761 == 'undefined' ){PDRTJS_468178_comm_761 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_761 );}}PDRTJS_settings_468178_comm_760={"id":468178,"unique_id":"wp-comment-760","title":"I%20suppose%20I%20should%20have%20scanned%20your%20recent%20articles%20and%20read%20the%20one%20about%20deadlock%20before%20posting%20--%20I%20am%20sure%20you%20will%20correct%20me%20and%20explain%20that%20deadlock%20%2Acan%2A%20exist%20in%20lock-free%20designs.%20%20%3A...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-760","item_id":"_comm_760"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_760 == 'undefined' ){PDRTJS_468178_comm_760 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_760 );}}PDRTJS_settings_468178_comm_759={"id":468178,"unique_id":"wp-comment-759","title":"There%26%23039%3Bs%20no%20doubt%20that%20lock-free%20data%20structures%20are%20extremely%20difficult%20to%20write%20and%20get%20right.%20%20But%20I%20disagree%20with%20the%20subtext%20that%20I%20perceive%20from%20this%20blog%20entry%20and%20your%20article%20that%20says%20%26quot%3Bl...","permalink":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/#comment-759","item_id":"_comm_759"}; if ( typeof PDRTJS_RATING !== 'undefined' ){if ( typeof PDRTJS_468178_comm_759 == 'undefined' ){PDRTJS_468178_comm_759 = new PDRTJS_RATING( PDRTJS_settings_468178_comm_759 );}}
//--><!]]></script><script type='text/javascript' charset='UTF-8' src='https://polldaddy.com/js/rating/rating.js'></script><script type='text/javascript' src='https://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"3379246","siteName":"Sutter\u2019s Mill","siteURL":"https:\/\/herbsutter.com","icon":"<img alt='' src='https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=50&d=https%3A%2F%2Fs2.wp.com%2Fi%2Flogo%2Fwpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/mistylook","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2008%2F08%2F05%2Feffective-concurrency-lock-free-code-a-false-sense-of-security%2F","themeURL":"","xhrURL":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"8fb9818ae2","isSingular":"1","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"4590924cc6\" \/>","referer":"https:\/\/herbsutter.com\/2008\/08\/05\/effective-concurrency-lock-free-code-a-false-sense-of-security\/","canFollow":"1","feedID":"171936","statusMessage":"","customizeLink":"https:\/\/herbsutter.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fherbsutter.wordpress.com%2F2008%2F08%2F05%2Feffective-concurrency-lock-free-code-a-false-sense-of-security%2F","postID":"131","shortlink":"https:\/\/wp.me\/peb5Y-27","canEditPost":"","editLink":"https:\/\/wordpress.com\/post\/herbsutter.com\/131","statsLink":"https:\/\/wordpress.com\/stats\/post\/131\/herbsutter.com","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: MistyLook","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 19,532 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2008%2F08%2F05%2Feffective-concurrency-lock-free-code-a-false-sense-of-security%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVjcEOgjAQRH/IuoIYT8Zvqe2GLrQLdlvAv7ceJEYTEg+bTGbe7MA8KjNwQk7QCVicyOC47DvZwUcUshp9bokFPPUocM+Y0Wm2HuM3/CblwUkvjlrnyyWMv87GjraBWN10hKCloEWpYcIYyZb91fvzQ4ra9LJVMokGfpVWVehruFSnujo0x+Zcd0+y+3Rn'></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'3379246','blog_tz':'-8','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'3379246','v':'wpcom','tz':'-8','user_id':'0','post':'131','subd':'herbsutter'}]);
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29+Smw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8/MkNtblkvY1d1TjBELytHc0k/MXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sNGpOU1M5X0RockJaSDI2ZFhrSD8rM1orK29nTzhfNmJMWkM0fG5qXV1tSEpsLjFuWlB8c1JWNjBrfjd4NDdFMkJYJkFORnBRJVZlQmZ3NmxQQ3l+Z1gwVXdCbmJJbEo0Z0NRbi5OKyxCTyVDdWdvRWRvQXAwRzladldOOUdiLCYtL05Gaz0rc2NiT1BuNEp0dDUmb3dLUlAuWzVoWmV1S1VRWVY3Zjh+NWEyaTFXbVdRZGhPN3RaOSZJYm9qOExZOUdfWnxzUw=='}]);
_stq.push([ 'clickTrackerInit', '3379246', '131' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>