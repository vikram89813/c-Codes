<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>GotW | Sutter’s Mill</title>
<link rel="pingback" href="https://herbsutter.com/xmlrpc.php" />
<script type="text/javascript">
  WebFontConfig = {"typekit":{"id":"eyo0tqd"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://s0.wp.com/wp-content/plugins/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active #header h1{font-size:2.12em;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active body{font-size:89.7%;font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation{font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation ul li.search{font-size:1.06em}.wf-active #navigation ul li.search input#searchsubmit{font-size:1.06em}.wf-active #content .post-info, .wf-active #content .postmetadata{font-size:1.06em}.wf-active #sidebar{font-size:1.06em}.wf-active #footer p.right{font-size:1.06em}.wf-active .commentnum{font-size:1.77em}.wf-active .commentlist li .cmtinfo{font-size:1.18em}.wf-active .commentlist li .cmtinfo em{font-size:1.06em}.wf-active #respond label{font-size:11.8px}.wf-active #respond .required{font-size:11.8px}.wf-active #respond .subscribe-label{font-size:14.2px}.wf-active #respond .comment-notes{font-size:13px}.wf-active .wp-caption p.wp-caption-text{font-size:13px}.wf-active #content h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active h5, .wf-active h6{font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active #header h2{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active #content h3{font-size:1.65em;font-weight:400;font-style:normal}.wf-active #content h4{font-size:1.3em;font-style:normal;font-weight:400}.wf-active #content h5{font-size:1.18em;font-style:normal;font-weight:400}.wf-active #content .post h2{font-size:1.65em;font-weight:400;font-style:normal}.wf-active li.sidebox h2{font-weight:400;font-size:1.89em;font-style:normal}.wf-active .post h4{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active .post h4 em{font-style:normal;font-weight:400}</style>
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=herbsutter.com&amp;id=3379246&amp;t=1542965330&amp;back=https%3A%2F%2Fherbsutter.com%2Fcategory%2Fc%2Fgotw%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//herbsutter.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Feed" href="https://herbsutter.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Comments Feed" href="https://herbsutter.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; GotW Category Feed" href="https://herbsutter.com/category/c/gotw/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s1.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1532082729h&ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s0.wp.com/_static/??-eJyNkN1uwjAMhV9onrUN1qtpz5K0JpjmT4kj1LfHpeoEglXcROck53Ns4zlDn6JQFAwNsm+OY0XPI1U8kWTTj3B1732tb/g8zvHAkWX6Ey+F5UhBf8nNYuAqk09p3AL7VEjvQzYyJwINbMhrjShbWMjfKzXLo060Ocw5axqszYVqBT0DtwBLsw/cCrmm1lJxMHeJtrEf0Pp03Z4tpkw4T0gPBZ4t4Z/obY88OJKKkjLkVFW9jNTUs/HAGrk3C8wYkyyPq9iq6iiBTmmEU7wzcPCGyxZaSPfjVDrU1I2dod/w87HffXZf3W7fnS4bTgAo?cssminify=yes' type='text/css' media='all' />
<link rel='stylesheet' id='print-css-1-1' href='https://s2.wp.com/wp-content/mu-plugins/global-print/global-print.css?m=1465851035h&cssminify=yes' type='text/css' media='print' />
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??/wp-content/mu-plugins/actionbar/actionbar.css,/wp-content/themes/h4/global.css?m=1516985148j&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s2.wp.com/_static/??-eJyF0G0KwjAMBuAL2dXJxP0Rz1Lr60hdP2zaDT29FSYiVIVAIHkISeQcBDk95hNYmhLXjHhbUmN4JX8BYWmIKqGx5F5Ye5fg0tNaf6QRIjOiGkqtDDr7iguekwVzQZXu50rkJsL8lxmkoPRFRDDdUTuEw3vn7x9Y1MHu267fbfp2263NA675cvs='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://herbsutter.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress.com" />
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=114" />
<link rel='openid.server' href='https://herbsutter.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://herbsutter.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://herbsutter.com/osd.xml" title="Sutter’s Mill" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<script type="text/javascript" id="webfont-output">
  
  WebFontConfig = {"typekit":{"id":"cjs1oxc"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<meta name="application-name" content="Sutter’s Mill" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Herb Sutter on software development" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://herbsutter.com/feed/;icon-uri=https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=16" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="description" content="Posts about GotW written by Herb Sutter" />
<style type="text/css">
			#header h1 a,
		#header h2 {
			color: #265E15 !important;
		}
				#headerimage {
			background: url('https://herbsutter.files.wordpress.com/2011/10/cropped-blog-header.jpg') no-repeat;
			height: 200px;
		}
	</style>
<style type="text/css" id="syntaxhighlighteranchor"></style>
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=eb5Y&#038;cscache=6&#038;csrev=60" />
		</head>
<body id="section-index" class="archive category category-gotw category-3867746 mp6 customizer-styles-applied highlander-enabled highlander-light infinite-scroll neverending">


<div id="navigation" class="clearfix">
		<div class="menu">
		<ul>
			<li ><a href="https://herbsutter.com/" title="Home">Home</a></li>
			<li class="page_item page-item-912"><a href="https://herbsutter.com/welcome-to-the-jungle/">Welcome to the&nbsp;Jungle</a></li>
<li class="page_item page-item-864 page_item_has_children"><a href="https://herbsutter.com/gotw/">GotW</a></li>
<li class="page_item page-item-761"><a href="https://herbsutter.com/elements-of-modern-c-style/">Elements of Modern C++&nbsp;Style</a></li>
<li class="page_item page-item-2 page_item_has_children"><a href="https://herbsutter.com/about/">About</a></li>
									<li class="search"><form method="get" id="searchform" action="https://herbsutter.com"><input type="text" class="textbox" value="" name="s" id="s" /><input type="submit" id="searchsubmit" value="Search" /></form></li>
					</ul>
	</div>
</div><!-- end id:navigation -->

<div id="container">

<div id="header">
<h1><a href="https://herbsutter.com/" title="Sutter’s Mill">Sutter’s Mill</a></h1>
<h2>Herb Sutter on software development</h2>
</div><!-- end id:header -->


	
		<div id="feedarea">
	<dl>
		<dt><strong>Feeds:</strong></dt>

			<dd><a href="https://herbsutter.com/feed/">Posts</a></dd>
	
			<dd><a href="https://herbsutter.com/comments/feed/">Comments</a></dd>
		</dl>
	</div><!-- end id:feedarea -->
	
	<div id="headerimage">
</div><!-- end id:headerimage -->

<div id="content">
<div id="content-main">
	              <h2 class="pagetitle">Archive for the &#8216;GotW&#8217; Category</h2>
      		
			<div class="post-2414 post type-post status-publish format-standard hentry category-gotw" id="post-2414">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2014/01/14/gotw-96-oversharing/" rel="bookmark">GotW #96: Oversharing</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2014-01-14|
													<a href="https://herbsutter.com/2014/01/14/gotw-96-oversharing/#comments">16 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Following on from #95, let&#8217;s consider reasons and methods to avoid mutable sharing in the first place…<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<p>Consider the following code from GotW #95&#8217;s solution, where <span style="color:#2e74b5;">some_obj</span> is a shared variable visible to multiple threads which then synchronize access to it.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// thread 1<br />{<br />    lock_guard hold(mut_some_obj);     // acquire lock<br />    code_that_reads_from( some_obj );  // passes some_obj by const &amp;<br />}<br /><br />// thread 2<br />{<br />    lock_guard hold(mut_some_obj);     // acquire lock<br />    code_that_modifies( some_obj );    // passes some_obj by non-const &amp;<br />}
</code></pre>
</p>
<p>
 </p>
<h2>JG Questions<br />
</h2>
<p>1. Why do mutable shared variables like <span style="color:#2e74b5;">some_obj</span> make your code:
</p>
<p style="margin-left:36pt;">(a) more complex?
</p>
<p style="margin-left:36pt;">(b) more brittle?
</p>
<p style="margin-left:36pt;">(c) less scalable?
</p>
<p>
 </p>
<h2>Guru Questions<br />
</h2>
<p>2. Give an example of how the code that uses a mutable shared variable like <span style="color:#2e74b5;">some_obj</span> can be changed so that the variable is:
</p>
<p style="margin-left:36pt;">(a) <em>not shared</em>.
</p>
<p style="margin-left:36pt;">(b) <em>not mutable</em>.
</p>
<p>3. Let&#8217;s say we&#8217;re in a situation where we can&#8217;t apply the techniques from the answers to #2, so that the variable itself must remain shared and apparently mutable. Is there any way that the <em>internal implementation</em> of the variable can make the variable be <em>physically </em>not shared and/or not mutable, so that the calling code can treat it as a logically shared-and-mutable object yet not need to perform external synchronization? If so, explain. If not, why not?</p>
					<p><a href="https://herbsutter.com/2014/01/14/gotw-96-oversharing/" rel="bookmark" title="Permanent Link to GotW #96: Oversharing">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2411 post type-post status-publish format-standard hentry category-gotw" id="post-2411">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2014/01/13/gotw-95-solution-thread-safety-and-synchronization/" rel="bookmark">GotW #95 Solution: Thread Safety and&nbsp;Synchronization</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2014-01-13|
													<a href="https://herbsutter.com/2014/01/13/gotw-95-solution-thread-safety-and-synchronization/#comments">24 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>This GotW was written to answer a set of related frequently asked questions. So here&#8217;s a mini-FAQ on &#8220;thread safety and synchronization in a nutshell,&#8221; and the points we&#8217;ll cover apply to thread safety and synchronization in pretty much any mainstream language.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Questions<br />
</h2>
<p>1. What is a race condition, and how serious is it?
</p>
<p>2. What is a correctly synchronized program? How do you achieve it? Be specific.
</p>
<p>
 </p>
<h2>Guru Questions<br />
</h2>
<p>3. Consider the following code, where <span style="color:#2e74b5;">some_obj</span> is a shared variable visible to multiple threads.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// thread 1 (performs no additional synchronization)<br />code_that_reads_from( some_obj );  // passes some_obj by const &amp;<br /><br />// thread 2 (performs no additional synchronization)<br />code_that_modifies( some_obj );    // passes some_obj by non-const &amp;
</code></pre>
</p>
<p>If threads 1 and 2 can run concurrently, is this code correctly synchronized if the type of <span style="color:#2e74b5;">some_obj</span> is:
</p>
<p style="margin-left:36pt;">(a) <span style="color:#2e74b5;">int</span>?
</p>
<p style="margin-left:36pt;">(b) <span style="color:#2e74b5;">string</span>?
</p>
<p style="margin-left:36pt;">(c) <span style="color:#2e74b5;">vector&lt;map&lt;int,string&gt;&gt;</span>?
</p>
<p style="margin-left:36pt;">(d) <span style="color:#2e74b5;">shared_ptr&lt;widget&gt;</span>?
</p>
<p style="margin-left:36pt;">(e) <span style="color:#2e74b5;">mutex</span>?
</p>
<p style="margin-left:36pt;">(f) <span style="color:#2e74b5;">condition_variable</span>?
</p>
<p style="margin-left:36pt;">(g) <span style="color:#2e74b5;">atomic&lt;unsigned&gt;</span>?<span style="color:#2e74b5;"><br />
		</span></p>
<p>Hint: This is actually a two-part question, not a seven-part question. There are only two unique answers, each of which covers a subset of the cases.
</p>
<p>4. <em>External synchronization</em> means that the code that uses/owns a given shared object is responsible for performing synchronization on that object. Answer the following questions related to external synchronization:
</p>
<p style="margin-left:36pt;">(a) What is the normal external synchronization responsibility of code that owns and uses a given shared variable?
</p>
<p style="margin-left:36pt;">(b) What is the &#8220;basic thread safety guarantee&#8221; that all types must obey to enable calling code to perform normal external synchronization?
</p>
<p style="margin-left:36pt;">(c) What partial internal synchronization can still be required within the shared variable&#8217;s implementation?
</p>
<p>5. <em>Full internal synchronization</em> (a.k.a. &#8220;synchronized types&#8221; or &#8220;thread-safe types&#8221;) means that a shared object performs all necessary synchronization internally within that object, so that calling code does not need to perform any external synchronization. What types should be fully internally synchronized, and why?
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>Preface<br />
</h2>
<p>The discussion in this GotW applies not only to C++ but also to any mainstream language, except mainly that certain races have defined behavior in C# and Java. But the definition of what variables need to be synchronized, the tools we use to synchronize them, and the distinction between external and internal synchronization and when you use each one, are the same in all mainstream languages. If you&#8217;re a C# or Java programmer, everything here applies equally to you, with some minor renaming such as to rename C++ <span style="color:#2e74b5;">atomic</span> to C#/Java <span style="color:#2e74b5;">volatile</span>, although some concepts are harder to express in C#/Java (such as identifying the read-only methods on an otherwise mutable shared object; there are <span style="color:#2e74b5;">readonly</span> fields and &#8220;read-only&#8221; properties that have <span style="color:#2e74b5;">get</span> but not <span style="color:#2e74b5;">set</span>, but they express a subset of what you can express using C++ <span style="color:#2e74b5;">const</span> on member functions).
</p>
<p>Note: C++ <span style="color:#2e74b5;">volatile</span> variables (which have no analog in languages like C# and Java) are always beyond the scope of this and any other article about the memory model and synchronization. That&#8217;s because C++ <span style="color:#2e74b5;">volatile</span> variables aren&#8217;t about threads or communication at all and don&#8217;t interact with those things. Rather, a C++ <span style="color:#2e74b5;">volatile</span> variable should be viewed as portal into a different universe beyond the language — a memory location that by definition does not obey the language&#8217;s memory model because that memory location is accessed by hardware (e.g., written to by a daughter card), have more than one address, or is otherwise &#8220;strange&#8221; and beyond the language. So C++ <span style="color:#2e74b5;">volatile</span> variables are universally an exception to every guideline about synchronization because are always inherently &#8220;racy&#8221; and unsynchronizable using the normal tools  (mutexes, atomics, etc.) and more generally exist outside all normal of the language and compiler including that they generally cannot be optimized by the compiler (because the compiler isn&#8217;t allowed to know their semantics; a <span style="color:#2e74b5;">volatile int vi;</span> may not behave anything like a normal <span style="color:#2e74b5;">int</span>, and you can&#8217;t even assume that code like <span style="color:#2e74b5;">vi = 5; int read_back = vi;</span> is guaranteed to result in <span style="color:#2e74b5;">read_back == 5</span>, or that code like <span style="color:#2e74b5;">int i = vi; int j = vi;</span> that reads <span style="color:#2e74b5;">vi</span> twice will result in <span style="color:#2e74b5;">i == j</span> which will not be true if <span style="color:#2e74b5;">vi</span> is a hardware counter for example). For more discussion, see my article <a href="http://www.drdobbs.com/parallel/volatile-vs-volatile/212701484">&#8220;volatile vs. volatile.&#8221;</a>
	</p>
<p>
 </p>
<h2>1. What is a race condition, and how serious is it?<br />
</h2>
<p>A <em>race condition</em> occurs when two threads access the same shared variable concurrently, and at least one is a non-<span style="color:#2e74b5;">const</span> operation (writer). Concurrent <span style="color:#2e74b5;">const</span> operations are valid, and do not race with each other.
</p>
<p>Consecutive nonzero-length bitfields count as a single variable for the purpose of defining what a race condition is.
</p>
<p>Terminology note: Some people use &#8220;race&#8221; in a different sense, where in a program with no actual race conditions (as defined above) still operations on different threads could interleave in different orders in different executions of a correctly-synchronized program depending on how fast threads happen to execute relative to each other. That&#8217;s not a race condition in the sense we mean here—a better term for that might be &#8220;timing-dependent code.&#8221;
</p>
<p>If a race condition occurs, your program has <em>undefined behavior</em>. C++ does not recognize any so-called &#8220;benign races&#8221;—and in languages that have recognized some races as &#8220;benign&#8221; the community has gradually learned over time that many of them actually, well, aren&#8217;t.
</p>
<blockquote>
<p><strong>Guideline:</strong> Reads (<strong>const</strong> operations) on a shared object are safe to run concurrently with each other without synchronization.
</p>
</blockquote>
<p>
 </p>
<h2>2. What is a correctly synchronized program? How do you achieve it? Be specific.<br />
</h2>
<p>A correctly synchronized program is one that contains no race conditions. You achieve it by making sure that, for every shared variable, every thread that performs a write (non-<span style="color:#2e74b5;">const</span> operation) on that variable is synchronized so that no other reads or writes of that variable on other threads can run concurrently with that write.
</p>
<p>The shared variable usually protected by:
</p>
<ul>
<li>(commonly) using a <span style="color:#2e74b5;">mutex</span> or equivalent;
</li>
<li>(very rarely) by making it <span style="color:#2e74b5;">atomic</span> if that&#8217;s appropriate, such as in low-lock code; or
</li>
<li>(very rarely) for certain types by performing the synchronization internally, as we will see below.
</li>
</ul>
<p>
 </p>
<h2>3. Consider the following code… If threads 1 and 2 can run concurrently, is this code correctly synchronized if the type of some_obj is: (a) int? (b) string? (c) vector&lt;map&lt;int,string&gt;&gt;? (d) shared_ptr&lt;widget&gt;?<br />
</h2>
<p>No. The code has one thread reading (via <span style="color:#2e74b5;">const</span> operations) from <span style="color:#2e74b5;">some_obj</span>, and a second thread writing to the same variable. If those threads can execute at the same time, that&#8217;s a race and a direct non-stop ticket to undefined behavior land.
</p>
<p>The answer is to synchronize access to the variable, for example using a <span style="color:#2e74b5;">mutex</span>:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// thread 1<br />{<br />    lock_guard hold(mut_some_obj);     // acquire lock<br />    code_that_reads_from( some_obj );  // passes some_obj by const &amp;<br />}<br /><br />// thread 2<br />{<br />    lock_guard hold(mut_some_obj);     // acquire lock<br />    code_that_modifies( some_obj );    // passes some_obj by non-const &amp;<br />}
</code></pre>
</p>
<p>Virtually all types, including <span style="color:#2e74b5;">shared_ptr</span> and <span style="color:#2e74b5;">vector</span> and other types, are just as thread-safe as <span style="color:#2e74b5;">int</span>; they&#8217;re not special for concurrency purposes. It doesn&#8217;t matter whether <span style="color:#2e74b5;">some_obj</span> is an <span style="color:#2e74b5;">int</span>, a <span style="color:#2e74b5;">string</span>, a container, or a smart pointer… concurrent reads (<span style="color:#2e74b5;">const</span> operations) are safe without synchronization, but the shared object is writeable, then the code that owns the object has to synchronize access to it.
</p>
<p>But when I said this is true for &#8220;virtually all types,&#8221; I meant all types except for types that are not fully internally synchronized, which brings us to the types that, by design, <em>are</em> special for concurrency purposes…
</p>
<p>
 </p>
<h2>… If threads 1 and 2 can run concurrently, is this code correctly synchronized if the type of g+shared is: (e) mutex? (f) condition_variable? (g) atomic&lt;unsigned&gt;?<br />
</h2>
<p>Yes. For these types, the code is okay, because these types already perform full internal synchronization and so they are safe to access without external synchronization.
</p>
<p>In fact, these types had better be safe to use without external synchronization, because they&#8217;re synchronization primitives you need to use as tools to synchronize other variables! And its turns out that that&#8217;s no accident…
</p>
<blockquote>
<p><strong>Guideline:</strong> A type should only be fully internally synchronized if and only if its purpose is to provide  inter-thread communication (e.g., a message queue) or synchronization (e.g., a mutex).
</p>
</blockquote>
<p>
 </p>
<h2>4. <em>External synchronization</em> means that the code that uses/owns a given shared object is responsible for performing synchronization on that object. Answer the following questions related to external synchronization:<br />
</h2>
<h3>(a) What is the normal external synchronization responsibility of code that owns and uses a given shared variable?<br />
</h3>
<p>The normal synchronization duty of care is simply this: The code that knows about and owns a writeable shared variable has to synchronize access to it. It will typically do that using a <span style="color:#2e74b5;">mutex</span> or similar (~99.9% of the time), or by making it <span style="color:#2e74b5;">atomic</span> if that&#8217;s possible and appropriate (~0.1% of the time).
</p>
<blockquote>
<p><strong>Guideline:</strong> The code that knows about and owns a writeable shared variable is responsible for synchronizing access to it.
</p>
</blockquote>
<p>
 </p>
<h3>(b) What is the &#8220;basic thread safety guarantee&#8221; that all types must obey to enable calling code to perform normal external synchronization?<br />
</h3>
<p>To make it possible for the code that uses a shared variable to do the above, two basic things must be true.
</p>
<p>First, concurrent operations on different objects must be safe. For example, let&#8217;s say we have two <span style="color:#2e74b5;">X</span> objects <span style="color:#2e74b5;">x1</span> and <span style="color:#2e74b5;">x2</span>, each of which is only used by one thread. Then consider this situation:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Case A: Using distinct objects<br /><br />// thread 1 (performs no additional synchronization)<br />x1.something();                   // do something with x1<br /><br />// thread 2 (performs no additional synchronization)<br />x2 = something_else;              // do something else with x2
</code></pre>
</p>
<p>This must always be considered correctly synchronized. Remember, we stated that <span style="color:#2e74b5;">x1</span> and <span style="color:#2e74b5;">x2</span> are distinct objects, and cannot be aliases for the same object or similar hijinks.
</p>
<p>Second, concurrent <span style="color:#2e74b5;">const</span> operations that are just reading from the same variable <span style="color:#2e74b5;">x</span> must be safe:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Case B: const access to the same object<br /><br />// thread 1 (performs no additional synchronization)<br />x.something_const();              // read from x (const operation)<br /><br />// thread 2 (performs no additional synchronization)<br />x.something_else_const();         // read from x (const operation)
</code></pre>
</p>
<p>This code too must be considered correctly synchronized, and had better work without external synchronization. It&#8217;s not a race, because the two threads are both performing <span style="color:#2e74b5;">const</span> accesses and reading from the shared object.
</p>
<p>This brings us to the case where there might be a combination of internal and external synchronization required…
</p>
<p>
 </p>
<h3>(c) What partial internal synchronization can still be required within the shared variable&#8217;s implementation?<br />
</h3>
<p>In some classes, objects that from the outside appear to be distinct but still may share state under the covers, without the calling code being able to tell that two apparently distinct objects are connected under the covers. Note that this not an exception to the previous guideline—it&#8217;s the same guideline!
</p>
<blockquote>
<p><strong>Guideline:</strong> It is always true that the code that knows about and owns a writeable shared variable is responsible for synchronizing access to it. If the writeable shared state is hidden inside the implementation of some class, then it&#8217;s simply that class&#8217; internals that are the &#8216;owning code&#8217; that has to synchronize access to (just) the shared state that only it knows about.
</p>
</blockquote>
<p>A classic case of &#8220;under-the-covers shared state&#8221; is reference counting, and the two poster-child examples are <span style="color:#2e74b5;">std::shared_ptr</span> and copy-on-write. Let&#8217;s use <span style="color:#2e74b5;">shared_ptr</span> as our main example.
</p>
<p>A reference-counted smart pointer like <span style="color:#2e74b5;">shared_ptr</span> keeps a reference count under the covers. Let&#8217;s say we have two distinct <span style="color:#2e74b5;">shared_ptr</span> objects <span style="color:#2e74b5;">sp1</span> and <span style="color:#2e74b5;">sp2</span>, each of which is used by only one thread. Then consider this situation:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Case A: Using distinct objects<br /><br />// thread 1 (performs no additional synchronization)<br />auto x = sp1;                      // read from sp1 (writes the count!) <br /><br />// thread 2 (performs no additional synchronization)<br />sp2 = something_else;              // write to sp2 (writes the count!)
</code></pre>
</p>
<p>This code must be considered correctly synchronized, and had better work as shown without any external synchronization. Okay, fine …
</p>
<p>… but what if <span style="color:#2e74b5;">sp1</span> and <span style="color:#2e74b5;">sp2</span> are pointing to the same object and so share a reference count? If so, <em>that reference count is a writeable shared object</em>, and so it must be synchronized to avoid a race—but it is in general impossible for the calling code to do the right synchronization, because it is not even aware of the sharing! The code we just saw above doesn&#8217;t see the count, doesn&#8217;t know the count variable&#8217;s name, and doesn&#8217;t in general know which pointers share counts.
</p>
<p>Similarly, consider two threads just reading from the same variable <span style="color:#2e74b5;">sp</span>:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Case B: const access to the same object<br /><br />// thread 1 (performs no additional synchronization)<br />auto sp3 = sp;                     // read from sp (writes the count!)<br /><br />// thread 2 (performs no additional synchronization)<br />auto sp4 = sp;                     // read from sp (writes the count!)
</code></pre>
</p>
<p>This code too must be considered correctly synchronized, and had better work without external synchronization. It&#8217;s not a race, because the two threads are both performing <span style="color:#2e74b5;">const</span> accesses and reading from the shared object. But under the covers, reading from <span style="color:#2e74b5;">sp</span> to copy it increments the reference count, and so again <em>that reference count is a writeable shared object</em>, and so it must be synchronized to avoid a race—and again it is in general impossible for the calling code to do the right synchronization, because it is not even aware of the sharing.
</p>
<p>So to deal with these cases, the code that knows about the shared reference count, namely the <span style="color:#2e74b5;">shared_ptr</span> implementation, has to synchronize access to the reference count. For reference counting, this is typically done by making the reference count a <span style="color:#2e74b5;">mutable atomic</span> variable. (See also GotW #6a and #6b.)
</p>
<p>For completeness, yes, of course external synchronization is still required as usual if the calling code shared a given visible <span style="color:#2e74b5;">shared_ptr</span> object and makes that same shared<span style="color:#2e74b5;">_ptr</span> object writable across threads:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Case C: External synchronization still required as usual<br />//         for non-const access to same visible shared object<br /><br />// thread 1<br />{<br />    lock_guard hold(mut_sp);           // acquire lock<br />    auto sp3 = sp;                     // read from sp<br />}<br /><br />// thread 2<br />{<br />    lock_guard hold(mut_sp);           // acquire lock<br />    sp = something_else;               // modify sp<br />}
</code></pre>
</p>
<p>So it&#8217;s not like <span style="color:#2e74b5;">shared_ptr</span> is a fully internally synchronized type; if the caller is sharing an object of that type, the caller must synchronize access to it like it would do for other types, as noted in Question 3(d).
</p>
<p>So what&#8217;s the purpose of the internal synchronization? It&#8217;s only to do necessary synchronization on the parts that the internals know are shared <em>and that the internals own</em>, but that the caller can&#8217;t synchronize because he doesn&#8217;t know about the sharing and shouldn&#8217;t need to because the caller doesn&#8217;t own them, the internals do. So in the internal implementation of the type we do just enough internal synchronization to get back to the level where the caller can assume his usual duty of care and in the usual ways correctly synchronize any objects that might actually be shared.
</p>
<p>The same applies to other uses of reference counting, such as copy-on-write strategies. It also applies generally to any other internal sharing going on under the covers between objects that appear distinct and independent to the calling code.
</p>
<blockquote>
<p><strong>Guideline:</strong> If you design a class where two objects may invisibly share state under the covers, it is your class&#8217; responsibility to internally synchronize access to that <strong>mutable</strong> shared state (only) that it owns and that only it can see, because the calling code can&#8217;t. If you opt for under-the-covers-sharing strategies like copy-on-write, be aware of the duty you&#8217;re taking on for yourself and code with care.
</p>
</blockquote>
<p>For why such internal shared state should be <strong>mutable</strong>, see GotW #6a and #6b.
</p>
<p>
 </p>
<h2>5. <em>… </em>What types should be fully internally synchronized, and why?<br />
</h2>
<p>There is exactly one category of types which should be fully internally synchronized, so that any object of that type is always safe to use concurrently without external synchronization: Inter-thread synchronization and communication primitives themselves. This includes standard types like mutexes and atomics, but also inter-thread communication and synchronization types you might write yourself such as a message queue (communicating messages from one thread to another), Producer/Consumer active objects (again passing data from one concurrent entity to another), or a thread-safe counter (communicating counter increments and decrements among multiple threads).
</p>
<p>If you&#8217;re wondering if there might be other kinds of types that should be internally synchronized,  consider: The only type for which it would make sense to always internally synchronize every operation is a type where you know <em>every object</em> is going to be both (a) writeable and (b) shared across threads… and that means that the type is by definition designed to be used for inter-thread communication and/or synchronization.
</p>
<p>
 </p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: Daniel Hardman, Casey, Alb, Marcel Wid, ixache.</p>
					<p><a href="https://herbsutter.com/2014/01/13/gotw-95-solution-thread-safety-and-synchronization/" rel="bookmark" title="Permanent Link to GotW #95 Solution: Thread Safety and&nbsp;Synchronization">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2401 post type-post status-publish format-standard hentry category-gotw" id="post-2401">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2014/01/06/gotw-95-thread-safety-and-synchronization/" rel="bookmark">GotW #95: Thread Safety and&nbsp;Synchronization</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2014-01-06|
													<a href="https://herbsutter.com/2014/01/06/gotw-95-thread-safety-and-synchronization/#comments">15 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>This GotW was written to answer a set of related frequently asked questions. So here&#8217;s a mini-FAQ on &#8220;thread safety and synchronization in a nutshell,&#8221; and the points we&#8217;ll cover apply to thread safety and synchronization in pretty much any mainstream language.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Questions<br />
</h2>
<p>1. What is a race condition, and how serious is it?
</p>
<p>2. What is a correctly synchronized program? How do you achieve it? Be specific.
</p>
<p>
 </p>
<h2>Guru Questions<br />
</h2>
<p>3. Consider the following code, where <span style="color:#2e74b5;">some_obj</span> is a shared variable visible to multiple threads.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// thread 1 (performs no additional synchronization)<br />code_that_reads_from( some_obj );  // passes some_obj by const &amp;<br /><br />// thread 2 (performs no additional synchronization)<br />code_that_modifies( some_obj );    // passes some_obj by non-const &amp;
</code></pre>
</p>
<p>If threads 1 and 2 can run concurrently, is this code correctly synchronized if the type of <span style="color:#2e74b5;">some_obj</span> is:
</p>
<p style="margin-left:36pt;">(a) <span style="color:#2e74b5;">int</span>?
</p>
<p style="margin-left:36pt;">(b) <span style="color:#2e74b5;">string</span>?
</p>
<p style="margin-left:36pt;">(c) <span style="color:#2e74b5;">vector&lt;map&lt;int,string&gt;&gt;</span>?
</p>
<p style="margin-left:36pt;">(d) <span style="color:#2e74b5;">shared_ptr&lt;widget&gt;</span>?
</p>
<p style="margin-left:36pt;">(e) <span style="color:#2e74b5;">mutex</span>?
</p>
<p style="margin-left:36pt;">(f) <span style="color:#2e74b5;">condition_variable</span>?
</p>
<p style="margin-left:36pt;">(g) <span style="color:#2e74b5;">atomic&lt;unsigned&gt;</span>?<span style="color:#2e74b5;"><br />
		</span></p>
<p>Hint: This is actually a two-part question, not a seven-part question. There are only two unique answers, each of which covers a subset of the cases.
</p>
<p>4. <em>External synchronization</em> means that the code that uses/owns a given shared object is responsible for performing synchronization on that object. Answer the following questions related to external synchronization:
</p>
<p style="margin-left:36pt;">(a) What is the normal external synchronization responsibility of code that owns and uses a given shared variable?
</p>
<p style="margin-left:36pt;">(b) What is the &#8220;basic thread safety guarantee&#8221; that all types must obey to enable calling code to perform normal external synchronization?
</p>
<p style="margin-left:36pt;">(c) What partial internal synchronization can still be required within the shared variable&#8217;s implementation?
</p>
<p>5. <em>Full internal synchronization</em> (a.k.a. &#8220;synchronized types&#8221; or &#8220;thread-safe types&#8221;) means that a shared object performs all necessary synchronization internally within that object, so that calling code does not need to perform any external synchronization. What types should be fully internally synchronized, and why?</p>
					<p><a href="https://herbsutter.com/2014/01/06/gotw-95-thread-safety-and-synchronization/" rel="bookmark" title="Permanent Link to GotW #95: Thread Safety and&nbsp;Synchronization">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2399 post type-post status-publish format-standard hentry category-gotw" id="post-2399">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2014/01/06/gotw-7c-solution-minimizing-compile-time-dependencies-part-3/" rel="bookmark">GotW #7c Solution: Minimizing Compile-Time Dependencies, Part&nbsp;3</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2014-01-06|
													<a href="https://herbsutter.com/2014/01/06/gotw-7c-solution-minimizing-compile-time-dependencies-part-3/#comments">26 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Now the unnecessary headers have been removed, and avoidable dependencies on the internals of the class have been eliminated. Is there any further decoupling that can be done? The answer takes us back to basic principles of solid class design.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. What is the tightest coupling you can express in C++? And what&#8217;s the second-tightest?
</p>
<h2>Guru Question<br />
</h2>
<p>2. The Incredible Shrinking Header has now been greatly trimmed, but there may still be ways to reduce the dependencies further. What further <span style="color:#2e74b5;">#include</span>s could be removed if we made further changes to <span style="color:#2e74b5;">X</span>, and how?
</p>
<p>This time, you may make any changes at all to <span style="color:#2e74b5;">X</span> as long as they don&#8217;t change its public interface, so that existing code that uses <span style="color:#2e74b5;">X</span> is unaffected. Again, note that the comments are important.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  x.h: after converting to use a Pimpl to hide implementation details<br />//<br />#include &lt;iosfwd&gt;<br />#include &lt;memory&gt;<br />#include "a.h"  // class A (has virtual functions)<br />#include "b.h"  // class B (has no virtual functions)<br />class C;<br />class E;<br /><br />class X : public A, private B {<br />public:<br />       X( const C&amp; );<br />    B  f( int, char* );<br />    C  f( int, C );<br />    C&amp; g( B );<br />    E  h( E );<br />    virtual std::ostream&amp; print( std::ostream&amp; ) const;<br /><br />private:<br />    struct impl;<br />    std::unique_ptr&lt;impl&gt; pimpl;   // ptr to a forward-declared class<br />};<br /><br />std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, const X&amp; x ) {<br />    return x.print(os);<br />}
</code></pre>
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>1. What is the tightest coupling you can express in C++? And what&#8217;s the second-tightest?<br />
</h2>
<p>Friendship and inheritance, respectively.
</p>
<p>A friend of a class has access to everything in that class, including all of its private data and functions, and so the code in a friend depends on every detail of the type. Now that&#8217;s a close friend!
</p>
<p>A class derived from a class <span style="color:#2e74b5;">Base</span> has access to public and protected members in <span style="color:#2e74b5;">Base</span>, and depends on the size and layout of <span style="color:#2e74b5;">Base</span> because it contains a <span style="color:#2e74b5;">Base</span> subobject. Further, the inheritance relationship means that a derived type is at least by default substitutable for its <span style="color:#2e74b5;">Base</span>; whether the inheritance is public or nonpublic only changes what other code can see and make use of the substitutability. That&#8217;s pretty tight coupling, second only to friendship.
</p>
<p>
 </p>
<h2>2. What further #includes could be removed if we made further changes to X, and how?<br />
</h2>
<p>Many programmers still seem to march to the &#8220;It isn&#8217;t OO unless you inherit!&#8221; battle hymn, by which I mean that they use inheritance more than necessary. I&#8217;ll save the whole lecture for another time, but my bottom line is simply that inheritance (including but not limited to IS-A) is a much stronger relationship than HAS-A or USES-A. When it comes to managing dependencies, therefore, you should always prefer composition/membership over inheritance wherever possible. To paraphrase Einstein: &#8216;Use as strong a relationship as necessary, but no stronger.&#8217;
</p>
<p>In this code, <span style="color:#2e74b5;">X</span> is derived publicly from <span style="color:#2e74b5;">A</span> and privately from <span style="color:#2e74b5;">B</span>. Recall that public inheritance should always model IS-A and satisfy the Liskov Substitutability Principle (LSP). In this case <span style="color:#2e74b5;">X</span> IS-A <span style="color:#2e74b5;">A</span> and there&#8217;s naught wrong with it, so we&#8217;ll leave that as it is.
</p>
<p>But did you notice the curious thing about <span style="color:#2e74b5;">B</span>&#8216;s virtual functions?
</p>
<p>&#8220;What?&#8221; you might say. &#8220;<span style="color:#2e74b5;">B</span> has no virtual functions.&#8221;
</p>
<p>Right. <a href="http://en.wikipedia.org/wiki/Silver_Blaze">That is the curious thing.</a>
	</p>
<p><span style="color:#2e74b5;">B</span> is a private base class of <span style="color:#2e74b5;">X</span>. Normally, the only reason you would choose private inheritance over composition/membership is to gain access to protected members—which most of the time means &#8220;to override a virtual function.&#8221; (There are a few other rare and obscure reasons to inherit, but they&#8217;re, well, rare and obscure.) Otherwise you wouldn&#8217;t choose inheritance, because it&#8217;s almost the tightest coupling you can express in C++, second only to <span style="color:#2e74b5;">friend</span>ship.
</p>
<p>We are given that <span style="color:#2e74b5;">B</span> has no virtual functions, so there&#8217;s probably no reason to prefer the stronger relationship of inheritance—unless <span style="color:#2e74b5;">X</span> needs access to some protected function or data in <span style="color:#2e74b5;">B</span>, of course, but for now I&#8217;ll assume that this is not the case. So, instead of having a base subobject of type <span style="color:#2e74b5;">B</span>, <span style="color:#2e74b5;">X</span> probably ought to have simply a member object of type <span style="color:#2e74b5;">B</span>. Therefore, the way to further simplify the header is:
</p>
<p>
 </p>
<h2>(a) Remove unnecessary inheritance from class <span style="color:#2e74b5;">B.<br />
</span></h2>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>#include "b.h"  // class B (has no virtual functions)
</code></pre>
</p>
<p>Because the <span style="color:#2e74b5;">B</span> member object should be private (it is, after all, an implementation detail), and in order to get rid of the <span style="color:#2e74b5;">b.h</span> header entirely, this member should live in <span style="color:#2e74b5;">X</span>&#8216;s hidden <span style="color:#2e74b5;">pimpl</span> portion.
</p>
<blockquote>
<p><strong>Guideline: </strong>Never inherit when composition is sufficient.
</p>
</blockquote>
<p>
 </p>
<p>This leaves us with header code that&#8217;s vastly simplified from where we started in GotW #7a:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  x.h: after removing unnecessary inheritance<br />//<br />#include &lt;iosfwd&gt;<br />#include &lt;memory&gt;<br />#include "a.h"  // class A (has virtual functions)<br />class B;<br />class C;<br />class E;<br /><br />class X : public A {<br />public:<br />       X( const C&amp; );<br />    B  f( int, char* );<br />    C  f( int, C );<br />    C&amp; g( B );<br />    E  h( E );<br />    virtual std::ostream&amp; print( std::ostream&amp; ) const;<br /><br />private:<br />    struct impl;<br />    std::unique_ptr&lt;impl&gt; pimpl;   // this now quietly includes a B<br />};<br /><br />std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, const X&amp; x ) {<br />    return x.print(os);<br />}
</code></pre>
</p>
<p>
 </p>
<p>After three passes of progressively greater simplification, the final result is that <span style="color:#2e74b5;">x.h</span> is still using other class names all over the place, but clients of <span style="color:#2e74b5;">X</span> need only pay for three <span style="color:#2e74b5;">#include</span>s: <span style="color:#2e74b5;">a.h</span>, <span style="color:#2e74b5;">memory</span>, and <span style="color:#2e74b5;">iosfwd</span>. What an improvement over the original!
</p>
<p>
 </p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: juanchopanza, anicolaescu, Bert Rodiers.</p>
					<p><a href="https://herbsutter.com/2014/01/06/gotw-7c-solution-minimizing-compile-time-dependencies-part-3/" rel="bookmark" title="Permanent Link to GotW #7c Solution: Minimizing Compile-Time Dependencies, Part&nbsp;3">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2387 post type-post status-publish format-standard hentry category-gotw" id="post-2387">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/12/31/gotw-7c-minimizing-compile-time-dependencies-part-3/" rel="bookmark">GotW #7c: Minimizing Compile-Time Dependencies, Part&nbsp;3</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-12-31|
													<a href="https://herbsutter.com/2013/12/31/gotw-7c-minimizing-compile-time-dependencies-part-3/#comments">14 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Now the unnecessary headers have been removed, and avoidable dependencies on the internals of the class have been eliminated. Is there any further decoupling that can be done? The answer takes us back to basic principles of solid class design.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. What is the tightest coupling you can express in C++? And what&#8217;s the second-tightest?
</p>
<h2>Guru Question<br />
</h2>
<p>2. The Incredible Shrinking Header has now been greatly trimmed, but there may still be ways to reduce the dependencies further. What further <span style="color:#2e74b5;">#include</span>s could be removed if we made further changes to <span style="color:#2e74b5;">X</span>, and how?
</p>
<p>This time, you may make any changes at all to <span style="color:#2e74b5;">X</span> as long as they don&#8217;t change its public interface, so that existing code that uses <span style="color:#2e74b5;">X</span> is unaffected. Again, note that the comments are important.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  x.h: after converting to use a Pimpl to hide implementation details<br />//<br />#include &lt;iosfwd&gt;<br />#include &lt;memory&gt;<br />#include "a.h"  // class A (has virtual functions)<br />#include "b.h"  // class B (has no virtual functions)<br />class C;<br />class E;<br /><br />class X : public A, private B {<br />public:<br />       X( const C&amp; );<br />    B  f( int, char* );<br />    C  f( int, C );<br />    C&amp; g( B );<br />    E  h( E );<br />    virtual std::ostream&amp; print( std::ostream&amp; ) const;<br /><br />private:<br />    struct impl;<br />    std::unique_ptr&lt;impl&gt; pimpl;   // ptr to a forward-declared class<br />};<br /><br />std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, const X&amp; x ) {<br />    return x.print(os);<br />}
</code></pre></p>
					<p><a href="https://herbsutter.com/2013/12/31/gotw-7c-minimizing-compile-time-dependencies-part-3/" rel="bookmark" title="Permanent Link to GotW #7c: Minimizing Compile-Time Dependencies, Part&nbsp;3">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2384 post type-post status-publish format-standard hentry category-gotw" id="post-2384">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/12/31/gotw-7b-solution-minimizing-compile-time-dependencies-part-2/" rel="bookmark">GotW #7b Solution: Minimizing Compile-Time Dependencies, Part&nbsp;2</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-12-31|
													<a href="https://herbsutter.com/2013/12/31/gotw-7b-solution-minimizing-compile-time-dependencies-part-2/#comments">14 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Now that the unnecessary headers have been removed, it&#8217;s time for Phase 2: How can you limit dependencies on the internals of a class?<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Questions<br />
</h2>
<p>1. What does <span style="color:#2e74b5;">private</span> mean for a class member in C++?
</p>
<p>2. Why does changing the private members of a type cause a recompilation?
</p>
<h2>Guru Question<br />
</h2>
<p>3. Below is how the header from the previous Item looks after the initial cleanup pass. What further <span style="color:#2e74b5;">#include</span>s could be removed if we made some suitable changes, and how?
</p>
<p>This time, you may make changes to <span style="color:#2e74b5;">X</span> as long as <span style="color:#2e74b5;">X</span>&#8216;s base classes and its public interface remain unchanged; any current code that already uses <span style="color:#2e74b5;">X</span> should not be affected beyond requiring a simple recompilation.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  x.h: sans gratuitous headers<br />//<br />#include &lt;iosfwd&gt;<br />#include &lt;list&gt;<br /><br />// None of A, B, C, or D are templates.<br />// Only A and C have virtual functions.<br />#include "a.h"  // class A<br />#include "b.h"  // class B<br />#include "c.h"  // class C<br />#include "d.h"  // class D<br />class E;<br /><br />class X : public A, private B {<br />public:<br />       X( const C&amp; );<br />    B  f( int, char* );<br />    C  f( int, C );<br />    C&amp; g( B );<br />    E  h( E );<br />    virtual std::ostream&amp; print( std::ostream&amp; ) const;<br /><br />  private:<br />    std::list&lt;C&gt; clist;<br />    D            d;<br />};<br /><br />std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, const X&amp; x ) {<br />    return x.print(os);<br />}
</code></pre>
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>1. What does private mean for a class member in C++?<br />
</h2>
<p>It means that outside code cannot access that member. Specifically, it cannot name it or call it.
</p>
<p>For example, given this class:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class widget {<br />public:<br />    void f() { }<br />private:<br />    void f(int) { }<br />    int i;<br />};
</code></pre>
</p>
<p>Outside code cannot use the name of the <span style="color:#2e74b5;">private</span> members:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code> int main() {<br />    auto w = widget{};<br />    w.f();               // ok<br />    w.f(42);             // error, cannot access name "f(int)"<br />    w.i = 42;            // error, cannot access name "i"<br />}
</code></pre>
</p>
<p>
 </p>
<h2>2. Why does changing the private members of a type cause a recompilation?<br />
</h2>
<p>Because private data members can change the size of the object, and private member functions participate in overload resolution.
</p>
<p>Note that accessibility is still safely enforced: <em>Calling code</em> still doesn&#8217;t get to use the private parts of the class. However, <em>the compiler</em> gets to know all about them at all times, including as it compiles the calling code. This does increase build coupling, but it&#8217;s for a deliberate reason: C++ has always been designed for efficiency, and a little-appreciated cornerstone of that is that C++ is designed to by default expose a type&#8217;s full implementation to the compiler in order to make aggressive optimization easier. It&#8217;s one of the fundamental reasons C++ is an efficient language.
</p>
<p>
 </p>
<h2>3. What further #includes could be removed if we made some suitable changes, and how? … any current code that already uses X should not be affected beyond requiring a simple recompilation.<br />
</h2>
<p>There are a few things we weren&#8217;t able to do in the previous problem:
</p>
<ul>
<li>We had to leave <span style="color:#2e74b5;">a.h</span> and <span style="color:#2e74b5;">b.h</span>. We couldn&#8217;t get rid of these because <span style="color:#2e74b5;">X</span> inherits from both <span style="color:#2e74b5;">A</span> and <span style="color:#2e74b5;">B</span>, and you always have to have full definitions for base classes so that the compiler can determine <span style="color:#2e74b5;">X</span>&#8216;s object size, virtual functions, and other fundamentals. (Can you anticipate how to remove one of these? Think about it: Which one can you remove, and why/how? The answer will come shortly.)
</li>
<li>We had to leave <span style="color:#2e74b5;">list</span>, <span style="color:#2e74b5;">c.h</span> and <span style="color:#2e74b5;">d.h</span>. We couldn&#8217;t get rid of these right away because a <span style="color:#2e74b5;">list&lt;C&gt;</span> and a <span style="color:#2e74b5;">D</span> appear as private data members of <span style="color:#2e74b5;">X</span>. Although <span style="color:#2e74b5;">C</span> appears as neither a base class nor a member, it is being used to instantiate the <span style="color:#2e74b5;">list</span> member, and some have compilers required that when you instantiate <span style="color:#2e74b5;">list&lt;C&gt;</span> you be able to see the definition of <span style="color:#2e74b5;">C</span>. (The standard doesn&#8217;t require a definition here, though, so even if the compiler you are currently using has this restriction, you can expect the restriction to go away over time.)
</li>
</ul>
<p>Now let&#8217;s talk about the beauty of Pimpls.
</p>
<p>
 </p>
<h3>The Pimpl Idiom<br />
</h3>
<p>C++ lets us easily encapsulate the private parts of a class from unauthorized access. Unfortunately, because of the header file approach inherited from C, it can take a little more work to encapsulate dependencies on a class&#8217; privates.
</p>
<p>&#8220;But,&#8221; you say, &#8220;the whole point of encapsulation is that the client code shouldn&#8217;t have to know or care about a class&#8217; private implementation details, right?&#8221; Right, and in C++ the client code doesn&#8217;t need to know or care about access to a class&#8217; privates (because unless it&#8217;s a friend it isn&#8217;t allowed any), but because the privates are visible in the header the client code does have to depend upon any types they mention. This coupling between the caller and the class&#8217;s internal details creates dependencies on both (re)compilation and binary layout.
</p>
<p>How can we better insulate clients from a class&#8217; private implementation details? One good way is to use a special form of the handle/body idiom, popularly called the Pimpl Idiom because of the intentionally pronounceable <span style="color:#2e74b5;">pimpl</span> pointer, as a compilation firewall.
</p>
<p>A Pimpl is just an opaque pointer (a pointer to a forward-declared, but undefined, helper class) used to hide the private members of a class. That is, instead of writing this:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// file widget.h<br />//<br />class widget {<br />    // public and protected members<br />private:<br />    // private members; whenever these change,<br />    // all client code must be recompiled<br />};
</code></pre>
</p>
<p>We write instead:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// file widget.h<br />//<br />#include &lt;memory&gt;<br /><br />class widget {<br />public:<br />    widget();<br />    ~widget();<br />    // public and protected members<br />private:<br />    struct impl;<br />    std::unique_ptr&lt;impl&gt; pimpl;   // ptr to a forward-declared class<br />};<br /><br />// file widget.cpp<br />//<br />#include "widget.h"<br /><br />struct widget::impl {<br />    // private members; fully hidden, can be<br />    // changed at will without recompiling clients<br />};<br /><br />widget::widget() : pimpl{ make_unique&lt;widget::impl&gt;(/*...*/) } { }<br />widget::~widget() =default;
</code></pre>
</p>
<p>Every <span style="color:#2e74b5;">widget</span> object dynamically allocates its <span style="color:#2e74b5;">impl</span> object. If you think of an object as a physical block, we&#8217;ve essentially lopped off a large chunk of the block and in its place left only &#8220;a little bump on the side&#8221;—the opaque pointer, or Pimpl. If copy and move are appropriate for your type, write those four operations to perform a deep copy that clones the <span style="color:#2e74b5;">impl</span> state.
</p>
<p>The major advantages of this idiom come from the fact that it breaks the caller&#8217;s dependency on the private details, including breaking both compile-time dependencies and binary dependencies:
</p>
<ul>
<li>Types mentioned only in a class&#8217; implementation need no longer be defined for client code, which can eliminate extra <span style="color:#2e74b5;">#include</span>s and improve compile speeds.
</li>
<li>A class&#8217; implementation can be changed—that is, private members can be freely added or removed—without recompiling client code. This is a useful technique for providing ABI-safety or binary compatibility, so that the client code is not dependent on the exact layout of the object.
</li>
</ul>
<p>The major costs of this idiom are in performance:
</p>
<ul>
<li>Each construction/destruction must allocate/deallocate memory.
</li>
<li>Each access of a hidden member can require at least one extra indirection. (If the hidden member being accessed itself uses a back pointer to call a function in the visible class, there will be multiple indirections, but is usually easy to avoid needing a back pointer.)
</li>
</ul>
<p>And of course we&#8217;re replacing any removed headers with the <span style="color:#2e74b5;">&lt;memory&gt;</span> header.
</p>
<p>We&#8217;ll come back to these and other Pimpl issues in GotW #24. For now, in our example, there were three headers whose definitions were needed simply because they appeared as private members of <span style="color:#2e74b5;">X</span>. If we instead restructure <span style="color:#2e74b5;">X</span> to use a Pimpl, we can immediately make several further simplifications:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>#include &lt;list&gt;<br />#include "c.h"  // class C<br />#include "d.h"  // class D
</code></pre>
</p>
<p>One of these headers (<span style="color:#2e74b5;">c.h</span>) can be replaced with a forward declaration because <span style="color:#2e74b5;">C</span> is still being mentioned elsewhere as a parameter or return type, and the other two (<span style="color:#2e74b5;">list</span> and <span style="color:#2e74b5;">d.h</span>) can disappear completely.
</p>
<blockquote>
<p><strong>Guideline:</strong> For widely-included classes whose implementations may change, or to provide ABI-safety or binary compatibility, consider using the compiler-firewall idiom (Pimpl Idiom) to hide implementation details. Use an opaque pointer (a pointer to a declared but undefined class) declared as <strong>struct impl; std::unique_ptr&lt;impl&gt; pimpl;</strong> to store private nonvirtual members.
</p>
</blockquote>
<p>
 </p>
<p>Note: We can&#8217;t tell from the original code by itself whether or not <span style="color:#2e74b5;">X</span> had (default) copy or move operations. If it did, then to preserve that we would need to write them again ourselves since the move-only <span style="color:#2e74b5;">unique_ptr</span> member suppresses the implicit generation of copy construction and copy assignment, and the user-declared destructor suppresses the implicit generation of move construction and move assignment. If we do need to write them by hand, the move constructor and move assignment can be <span style="color:#2e74b5;">=default</span>ed, and the copy constructor and copy assignment will need to copy the Pimpl object.
</p>
<p>After making that additional change, the header looks like this:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  x.h: after converting to use a Pimpl<br />//<br />#include &lt;iosfwd&gt;<br />#include &lt;memory&gt;<br />#include "a.h"  // class A (has virtual functions)<br />#include "b.h"  // class B (has no virtual functions)<br />class C;<br />class E;<br /><br />class X : public A, private B {<br />public:<br />    ~X();                          // defined out of line<br />    // and copy/move operations if X had them before<br /><br />       X( const C&amp; );<br />    B  f( int, char* );<br />    C  f( int, C );<br />    C&amp; g( B );<br />    E  h( E );<br />    virtual std::ostream&amp; print( std::ostream&amp; ) const;<br /><br />private:<br />    struct impl;<br />    std::unique_ptr&lt;impl&gt; pimpl;   // ptr to a forward-declared class<br />};<br /><br />std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, const X&amp; x ) {<br />    return x.print(os);<br />}
</code></pre>
</p>
<p>Without more extensive changes, we still need the definitions for <span style="color:#2e74b5;">A</span> and <span style="color:#2e74b5;">B</span> because they are base classes, and we have to know at least their sizes in order to define the derived class <span style="color:#2e74b5;">X</span>.
</p>
<p>The private details go into <span style="color:#2e74b5;">X</span>&#8216;s implementation file where client code never sees them and therefore never depends upon them:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  Implementation file x.cpp<br />//<br />#include &lt;list&gt;<br />#include "c.h"  // class C<br />#include "d.h"  // class D<br />using namespace std;<br /><br />struct X::impl {<br />    list&lt;C&gt; clist;<br />    D       d;<br />};<br /><br />X::X() : pimpl{ make_unique&lt;X::impl&gt;(/*...*/) } { }<br />X::~X() =default;
</code></pre>
</p>
<p>That brings us down to including only four headers, which is a great improvement—but it turns out that there is still a little more we could do, if only we were allowed to change the structure of <span style="color:#2e74b5;">X</span> more extensively. This leads us nicely into Part 3…
</p>
<p>
 </p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks to the following for their feedback to improve this article: John Humphrey, thokra, Motti Lanzkron, Marcelo Pinto.</p>
					<p><a href="https://herbsutter.com/2013/12/31/gotw-7b-solution-minimizing-compile-time-dependencies-part-2/" rel="bookmark" title="Permanent Link to GotW #7b Solution: Minimizing Compile-Time Dependencies, Part&nbsp;2">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2294 post type-post status-publish format-standard hentry category-gotw" id="post-2294">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/08/19/gotw-7b-minimizing-compile-time-dependencies-part-2/" rel="bookmark">GotW #7b: Minimizing Compile-Time Dependencies, Part&nbsp;2</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-08-19|
													<a href="https://herbsutter.com/2013/08/19/gotw-7b-minimizing-compile-time-dependencies-part-2/#comments">21 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Now that the unnecessary headers have been removed, it&#8217;s time for Phase 2: How can you limit dependencies on the internals of a class?</em></span></p>
<h1>Problem</h1>
<h2>JG Questions</h2>
<p>1. What does <span style="color:#2e74b5;">private</span> mean for a class member in C++?</p>
<p>2. Why does changing the private members of a type cause a recompilation?</p>
<h2>Guru Question</h2>
<p>3. Below is how the header from the previous Item looks after the initial cleanup pass. What further <span style="color:#2e74b5;">#include</span>s could be removed if we made some suitable changes, and how?</p>
<p>This time, you may make changes to <span style="color:#2e74b5;">X</span> as long as <span style="color:#2e74b5;">X</span>&#8216;s base classes and its public interface remain unchanged; any current code that already uses <span style="color:#2e74b5;">X</span> should not be affected beyond requiring a simple recompilation.</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>//  x.h: sans gratuitous headers
//
#include &lt;iosfwd&gt;
#include &lt;list&gt;

// None of A, B, C, or D are templates.
// Only A and C have virtual functions.
#include "a.h"  // class A
#include "b.h"  // class B
#include "c.h"  // class C
#include "d.h"  // class D
class E;

class X : public A, private B {
public:
       X( const C&amp; );
    B  f( int, char* );
    C  f( int, C );
    C&amp; g( B );
    E  h( E );
    virtual std::ostream&amp; print( std::ostream&amp; ) const;

  private:
    std::list&lt;C&gt; clist;
    D            d_;
};

std::ostream&amp; operator&lt;&lt;( std::ostream&amp; os, const X&amp; x ) {
    return x.print(os);
}
</code></pre>
					<p><a href="https://herbsutter.com/2013/08/19/gotw-7b-minimizing-compile-time-dependencies-part-2/" rel="bookmark" title="Permanent Link to GotW #7b: Minimizing Compile-Time Dependencies, Part&nbsp;2">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
		<p align="center"><a href="https://herbsutter.com/category/c/gotw/page/2/" >Older Posts &raquo;</a></p>

	</div><!-- end id:content-main -->
<div id="sidebar">
<ul>
<li class="sidebox"><h2><label for="subscribe-field">Follow by email</label></h2>
				<form action="https://subscribe.wordpress.com" method="post" accept-charset="utf-8" id="subscribe-blog">
																	<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" placeholder="Enter your email address" value="" id="subscribe-field"/></p>
					
					<p>
						<input type="hidden" name="action" value="subscribe"/>
						<input type="hidden" name="blog_id" value="3379246"/>
						<input type="hidden" name="source" value="https://herbsutter.com/category/c/gotw/"/>
						<input type="hidden" name="sub-type" value="widget"/>
						<input type="hidden" name="redirect_fragment" value="blog_subscription-3" />
						<input type="hidden" id="_wpnonce" name="_wpnonce" value="4590924cc6" />						<input type="submit" value="Subscribe" />
					</p>
				</form>
			
</li><li class="sidebox"><h2><a href='http://twitter.com/herbsutter'>Tweets</a></h2><ul class='tweets'></ul><a href="http://twitter.com/herbsutter"  class='twitter-follow-button' data-show-count='false' data-link-color='#265e15' data-text-color='#333333'>Follow @herbsutter</a></li><li class="sidebox"><h2>Popular</h2><ul>				<li>
										<a href="https://herbsutter.com/2018/11/13/trip-report-fall-iso-c-standards-meeting-san-diego/" class="bump-view" data-bump-view="tp">
						Trip report: Fall ISO C++ standards meeting (San Diego)					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/gotw/" class="bump-view" data-bump-view="tp">
						GotW					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/2018/09/20/lifetime-profile-v1-0-posted/" class="bump-view" data-bump-view="tp">
						Lifetime profile v1.0 posted					</a>
										</li>
				</ul></li><li class="sidebox"><h2>Categories</h2>		<ul>
				<li class="cat-item cat-item-291"><a href="https://herbsutter.com/category/apple/" >Apple</a>
</li>
	<li class="cat-item cat-item-49277"><a href="https://herbsutter.com/category/c-net/" >C# / .NET</a>
</li>
	<li class="cat-item cat-item-2426 current-cat-parent current-cat-ancestor"><a href="https://herbsutter.com/category/c/" >C++</a>
</li>
	<li class="cat-item cat-item-69816"><a href="https://herbsutter.com/category/cloud/" >Cloud</a>
</li>
	<li class="cat-item cat-item-214618"><a href="https://herbsutter.com/category/concurrency/" >Concurrency</a>
</li>
	<li class="cat-item cat-item-8259773"><a href="https://herbsutter.com/category/effective-concurrency/" >Effective Concurrency</a>
</li>
	<li class="cat-item cat-item-3696745"><a href="https://herbsutter.com/category/friday-thoughts/" >Friday Thoughts</a>
</li>
	<li class="cat-item cat-item-3867746 current-cat"><a href="https://herbsutter.com/category/c/gotw/" >GotW</a>
</li>
	<li class="cat-item cat-item-79"><a href="https://herbsutter.com/category/hardware/" >Hardware</a>
</li>
	<li class="cat-item cat-item-1017"><a href="https://herbsutter.com/category/java/" >Java</a>
</li>
	<li class="cat-item cat-item-637"><a href="https://herbsutter.com/category/microsoft/" >Microsoft</a>
</li>
	<li class="cat-item cat-item-420845"><a href="https://herbsutter.com/category/opinion-editorial/" >Opinion &amp; Editorial</a>
</li>
	<li class="cat-item cat-item-1633077"><a href="https://herbsutter.com/category/reader-qa/" >Reader Q&amp;A</a>
</li>
	<li class="cat-item cat-item-2301"><a href="https://herbsutter.com/category/software-development/" >Software Development</a>
</li>
	<li class="cat-item cat-item-393523"><a href="https://herbsutter.com/category/talks-events/" >Talks &amp; Events</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://herbsutter.com/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-151"><a href="https://herbsutter.com/category/web/" >Web</a>
</li>
		</ul>
			</li></ul>
</div><!-- end id:sidebar -->
</div><!-- end id:content -->
</div><!-- end id:container -->
<div id="footer">
	<div id="colophon">
		<p><a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></p>
		<p>WPThemes.</p>
		<br class="clear" />
	</div><!-- end #colophon-->
</div><!-- end #footer-->
		<script type="text/javascript">
		//<![CDATA[
		var infiniteScroll = {"settings":{"id":"content-main","ajaxurl":"https:\/\/herbsutter.com\/?infinity=scrolling","type":"scroll","wrapper":true,"wrapper_class":"infinite-wrap","footer":true,"click_handle":"1","text":"Older posts","totop":"Scroll back to top","currentday":"19.08.13","order":"DESC","scripts":[],"styles":[],"google_analytics":false,"offset":0,"history":{"host":"herbsutter.com","path":"\/category\/c\/gotw\/page\/%d\/","use_trailing_slashes":true,"parameters":""},"query_args":{"category_name":"gotw","error":"","m":"","p":0,"post_parent":"","subpost":"","subpost_id":"","attachment":"","attachment_id":0,"name":"","pagename":"","page_id":0,"second":"","minute":"","hour":"","day":0,"monthnum":0,"year":0,"w":0,"tag":"","cat":3867746,"tag_id":"","author":"","author_name":"","feed":"","tb":"","paged":0,"meta_key":"","meta_value":"","preview":"","s":"","sentence":"","title":"","fields":"","menu_order":"","embed":"","category__in":[],"category__not_in":[],"category__and":[],"post__in":[],"post__not_in":[],"post_name__in":[],"tag__in":[],"tag__not_in":[],"tag__and":[],"tag_slug__in":[],"tag_slug__and":[],"post_parent__in":[],"post_parent__not_in":[],"author__in":[],"author__not_in":[],"posts_per_page":7,"ignore_sticky_posts":false,"suppress_filters":false,"cache_results":false,"update_post_term_cache":true,"lazy_load_term_meta":true,"update_post_meta_cache":true,"post_type":"","nopaging":false,"comments_per_page":"50","no_found_rows":false,"order":"DESC"},"last_post_date":"2013-08-19 02:33:12","stats":"blog=3379246&v=wpcom&tz=-8&user_id=0&subd=herbsutter&x_pagetype=infinite"}};
		//]]>
		</script>
		<!--  -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201847y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	</div>
		<div id="infinite-footer">
			<div class="container">
				<div class="blog-info">
					<a id="infinity-blog-title" href="https://herbsutter.com/" rel="home">
						Sutter’s Mill					</a>
				</div>
				<div class="blog-credits">
					<a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a> 				</div>
			</div>
		</div><!-- #infinite-footer -->
		
	<div id="carousel-reblog-box">
		<form action="#" name="carousel-reblog">
			<textarea id="carousel-reblog-content" name="carousel-reblog-content" placeholder="Add your thoughts here... (optional)"></textarea>
			<label for="carousel-reblog-to-blog-id" id="carousel-reblog-lblogid">Post to</label>
			<select name="carousel-reblog-to-blog-id" id="carousel-reblog-to-blog-id">
						</select>

			<div class="submit">
				<span class="canceltext"><a href="#" class="cancel">Cancel</a></span>
				<input type="submit" name="carousel-reblog-submit" class="button" id="carousel-reblog-submit" value="Reblog Post" />
				<input type="hidden" id="carousel-reblog-blog-id" value="3379246" />
				<input type="hidden" id="carousel-reblog-blog-url" value="https://herbsutter.com" />
				<input type="hidden" id="carousel-reblog-blog-title" value="Sutter’s Mill" />
				<input type="hidden" id="carousel-reblog-post-url" value="" />
				<input type="hidden" id="carousel-reblog-post-title" value="" />
			</div>

			<input type="hidden" id="_wpnonce" name="_wpnonce" value="c0f0a72e87" /><input type="hidden" name="_wp_http_referer" value="/category/c/gotw/" />		</form>

		<div class="arrow"></div>
	</div>
<link rel='stylesheet' id='all-css-0-2' href='https://s0.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel.css?m=1524699534h&cssminify=yes' type='text/css' media='all' />
<!--[if lte IE 8]>
<link rel='stylesheet' id='jetpack-carousel-ie8fix-css'  href='https://s1.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel-ie8fix.css?m=1412618825h&#038;ver=20121024' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='all-css-2-2' href='https://s2.wp.com/wp-content/mu-plugins/tiled-gallery/tiled-gallery.css?m=1443731146h&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"3379246","siteName":"Sutter\u2019s Mill","siteURL":"https:\/\/herbsutter.com","icon":"<img alt='' src='https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=50&d=https%3A%2F%2Fs2.wp.com%2Fi%2Flogo%2Fwpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/mistylook","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2014%2F01%2F14%2Fgotw-96-oversharing%2F","themeURL":"","xhrURL":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"8fb9818ae2","isSingular":"","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"4590924cc6\" \/>","referer":"https:\/\/herbsutter.com\/category\/c\/gotw\/","canFollow":"1","feedID":"171936","statusMessage":"","customizeLink":"https:\/\/herbsutter.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fherbsutter.wordpress.com%2Fcategory%2Fc%2Fgotw%2F","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: MistyLook","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 19,532 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2014%2F01%2F14%2Fgotw-96-oversharing%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"665015e67f","display_exif":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F08%2F19%2Fgotw-7b-minimizing-compile-time-dependencies-part-2%2F","blog_id":"3379246","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>","reblog":"Reblog","reblogged":"Reblogged","reblog_add_thoughts":"Add your thoughts here... (optional)","reblogging":"Reblogging...","post_reblog":"Post Reblog","stats_query_args":"blog=3379246&v=wpcom&tz=-8&user_id=0&subd=herbsutter","is_public":"1","reblog_enabled":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVUNEOwiAM/CGxGqM+Gb8FWXVFVpCWqX8vmmwxGpf4QHJc77ijcE3GRVZkBS/QYE8O023uZQZvo66YFMqJWCDQGQUuBQu2lpuAeUJMfCQmvY/gUzsI5c5qby2d2lCPYv5mJmJs0xGbg83QWanSikzsMWdqateR+/MFzdadZcrklCI/TSMa1MQulGd4Xapcj/Hg0emvz/e1ZgQrgvoyvO4po0yFO5tjEQzgUVMtagaievbdbrlebZbb7WK98A97a7cy'></script>
<script type='text/javascript' src='https://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVy0sOQEAMANALqcYvYSHOgmkmpWoyirg9WyuxfIuHZ4BxVSM1XHYIsnvWDe1kM4owSD/OA0cHgQmVDoqkjtWn05bgnxu+Hws58L0IxeutZ3VLm1V5WRVlU+fTDQ0qQ9Y='></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script type="text/javascript">
			jQuery.extend( infiniteScroll.settings.scripts, ["jquery-core","jquery-migrate","jquery","mobile-useragent-info","postmessage","jquery_inview","jetpack_resize","spin","jquery.spin","grofiles-cards","wpgroho","devicepx","jetpack_likes_queuehandler","the-neverending-homepage","syntaxhighlighter","wpcom-masterbar-js","wpcom-masterbar-tracks-js","wpcom-actionbar-bar","swfobject","videopress","jetpack-carousel","twitter-widgets","twitter-widgets-infinity","twitter-widgets-pending","tiled-gallery"] );
			jQuery.extend( infiniteScroll.settings.styles, ["jetpack_likes","the-neverending-homepage","infinity-mistylook","wpcom-core-compat-playlist-styles","mp6hacks","wpcom-bbpress2-staff-css","wp-block-library","mistylook","jetpack-top-posts-widget","jetpack-widget-social-icons-styles","noticons","geo-location-flair","reblogging","a8c-global-print","wpcom-actionbar-bar","h4-global","jetpack-carousel","tiled-gallery","jetpack-carousel-ie8fix"] );
		</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'3379246','blog_tz':'-8','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'3379246','v':'wpcom','tz':'-8','user_id':'0','subd':'herbsutter'}]);
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29+Smw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8/MkNtblkvY1d1TjBELytHc0k/MXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sLlVOY2ZzcS9MM3N2cDh4Yk40dCZtMERWRHZldWt5LHprU2QlSU9QVFZRYS55UGRjL3BiVHptfjZoM3Y2QW1GQXNLWCVDUG4tOGlhUzYlW0t1eSY4V3w9ZmMvP1dUeXpbQmJLSlpobXFiWiZ2dlY1RzlWJWhPbVpuSVIvLld8XUYyfDlKWDRFK3lTeDFqMWt2cklsb1BLSlFlVW83dzEvSDZiUkpwYV1yVjFEOVYwW19ldzVf'}]);
_stq.push([ 'clickTrackerInit', '3379246', '0' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>