<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>GotW | Sutter’s Mill | Page 4</title>
<link rel="pingback" href="https://herbsutter.com/xmlrpc.php" />
<script type="text/javascript">
  WebFontConfig = {"typekit":{"id":"eyo0tqd"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://s0.wp.com/wp-content/plugins/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active #header h1{font-size:2.12em;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active body{font-size:89.7%;font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation{font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation ul li.search{font-size:1.06em}.wf-active #navigation ul li.search input#searchsubmit{font-size:1.06em}.wf-active #content .post-info, .wf-active #content .postmetadata{font-size:1.06em}.wf-active #sidebar{font-size:1.06em}.wf-active #footer p.right{font-size:1.06em}.wf-active .commentnum{font-size:1.77em}.wf-active .commentlist li .cmtinfo{font-size:1.18em}.wf-active .commentlist li .cmtinfo em{font-size:1.06em}.wf-active #respond label{font-size:11.8px}.wf-active #respond .required{font-size:11.8px}.wf-active #respond .subscribe-label{font-size:14.2px}.wf-active #respond .comment-notes{font-size:13px}.wf-active .wp-caption p.wp-caption-text{font-size:13px}.wf-active #content h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active h5, .wf-active h6{font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active #header h2{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active #content h3{font-size:1.65em;font-weight:400;font-style:normal}.wf-active #content h4{font-size:1.3em;font-style:normal;font-weight:400}.wf-active #content h5{font-size:1.18em;font-style:normal;font-weight:400}.wf-active #content .post h2{font-size:1.65em;font-weight:400;font-style:normal}.wf-active li.sidebox h2{font-weight:400;font-size:1.89em;font-style:normal}.wf-active .post h4{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active .post h4 em{font-style:normal;font-weight:400}</style>
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=herbsutter.com&amp;id=3379246&amp;t=1542966146&amp;back=https%3A%2F%2Fherbsutter.com%2Fcategory%2Fc%2Fgotw%2Fpage%2F4%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//herbsutter.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Feed" href="https://herbsutter.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Comments Feed" href="https://herbsutter.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; GotW Category Feed" href="https://herbsutter.com/category/c/gotw/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s1.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1532082729h&ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s0.wp.com/_static/??-eJyNkN1uwjAMhV9onrUN1qtpz5K0JpjmT4kj1LfHpeoEglXcROck53Ns4zlDn6JQFAwNsm+OY0XPI1U8kWTTj3B1732tb/g8zvHAkWX6Ey+F5UhBf8nNYuAqk09p3AL7VEjvQzYyJwINbMhrjShbWMjfKzXLo060Ocw5axqszYVqBT0DtwBLsw/cCrmm1lJxMHeJtrEf0Pp03Z4tpkw4T0gPBZ4t4Z/obY88OJKKkjLkVFW9jNTUs/HAGrk3C8wYkyyPq9iq6iiBTmmEU7wzcPCGyxZaSPfjVDrU1I2dod/w87HffXZf3W7fnS4bTgAo?cssminify=yes' type='text/css' media='all' />
<link rel='stylesheet' id='print-css-1-1' href='https://s2.wp.com/wp-content/mu-plugins/global-print/global-print.css?m=1465851035h&cssminify=yes' type='text/css' media='print' />
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??/wp-content/mu-plugins/actionbar/actionbar.css,/wp-content/themes/h4/global.css?m=1516985148j&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s2.wp.com/_static/??-eJyF0G0KwjAMBuAL2dXJxP0Rz1Lr60hdP2zaDT29FSYiVIVAIHkISeQcBDk95hNYmhLXjHhbUmN4JX8BYWmIKqGx5F5Ye5fg0tNaf6QRIjOiGkqtDDr7iguekwVzQZXu50rkJsL8lxmkoPRFRDDdUTuEw3vn7x9Y1MHu267fbfp2263NA675cvs='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://herbsutter.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress.com" />
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=114" />
<link rel='openid.server' href='https://herbsutter.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://herbsutter.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://herbsutter.com/osd.xml" title="Sutter’s Mill" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<script type="text/javascript" id="webfont-output">
  
  WebFontConfig = {"typekit":{"id":"cjs1oxc"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<meta name="application-name" content="Sutter’s Mill" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Herb Sutter on software development" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://herbsutter.com/feed/;icon-uri=https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=16" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="description" content="Posts about GotW written by Herb Sutter" />
<style type="text/css">
			#header h1 a,
		#header h2 {
			color: #265E15 !important;
		}
				#headerimage {
			background: url('https://herbsutter.files.wordpress.com/2011/10/cropped-blog-header.jpg') no-repeat;
			height: 200px;
		}
	</style>
<style type="text/css" id="syntaxhighlighteranchor"></style>
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=eb5Y&#038;cscache=6&#038;csrev=60" />
		</head>
<body id="section-index" class="archive paged category category-gotw category-3867746 paged-4 category-paged-4 mp6 customizer-styles-applied highlander-enabled highlander-light infinite-scroll neverending">


<div id="navigation" class="clearfix">
		<div class="menu">
		<ul>
			<li ><a href="https://herbsutter.com/" title="Home">Home</a></li>
			<li class="page_item page-item-912"><a href="https://herbsutter.com/welcome-to-the-jungle/">Welcome to the&nbsp;Jungle</a></li>
<li class="page_item page-item-864 page_item_has_children"><a href="https://herbsutter.com/gotw/">GotW</a></li>
<li class="page_item page-item-761"><a href="https://herbsutter.com/elements-of-modern-c-style/">Elements of Modern C++&nbsp;Style</a></li>
<li class="page_item page-item-2 page_item_has_children"><a href="https://herbsutter.com/about/">About</a></li>
									<li class="search"><form method="get" id="searchform" action="https://herbsutter.com"><input type="text" class="textbox" value="" name="s" id="s" /><input type="submit" id="searchsubmit" value="Search" /></form></li>
					</ul>
	</div>
</div><!-- end id:navigation -->

<div id="container">

<div id="header">
<h1><a href="https://herbsutter.com/" title="Sutter’s Mill">Sutter’s Mill</a></h1>
<h2>Herb Sutter on software development</h2>
</div><!-- end id:header -->


	
		<div id="feedarea">
	<dl>
		<dt><strong>Feeds:</strong></dt>

			<dd><a href="https://herbsutter.com/feed/">Posts</a></dd>
	
			<dd><a href="https://herbsutter.com/comments/feed/">Comments</a></dd>
		</dl>
	</div><!-- end id:feedarea -->
	
	<div id="headerimage">
</div><!-- end id:headerimage -->

<div id="content">
<div id="content-main">
	              <h2 class="pagetitle">Archive for the &#8216;GotW&#8217; Category</h2>
      		
			<div class="post-2023 post type-post status-publish format-standard hentry category-gotw" id="post-2023">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/28/gotw-6b-solution-const-correctness-part-2/" rel="bookmark">GotW #6b Solution: Const-Correctness, Part&nbsp;2</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-28|
													<a href="https://herbsutter.com/2013/05/28/gotw-6b-solution-const-correctness-part-2/#comments">54 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>const and mutable are powerful tools for writing safer code. Use them consistently.</em></span>
	</p>
<h1>Problem<br />
</h1>
<h2>Guru Question<br />
</h2>
<p>In the following code, add or remove <span style="color:#2e74b5;">const</span> (including minor variants and related keywords) wherever appropriate. Note: Don&#8217;t comment on or change the structure of this program. It&#8217;s contrived and condensed for illustration only.
</p>
<p>For bonus points: In what places are the program&#8217;s results undefined or uncompilable due to <span style="color:#2e74b5;">const</span> errors?
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class polygon {<br />public:<br />    polygon() : area{-1} {}<br /><br />    void add_point( const point pt ) { area = -1;<br />                                       points.push_back(pt); }<br /><br />    point get_point( const int i ) { return points[i]; }<br /><br />    int get_num_points() { return points.size(); }<br /><br />    double get_area() {<br />        if( area &lt; 0 )   // if not yet calculated and cached<br />            calc_area();     // calculate now<br />        return area;<br />    }<br /><br />private:<br />    void calc_area() {<br />        area = 0;<br />        vector&lt;point&gt;::iterator i;<br />        for( i = begin(points); i != end(points); ++i )<br />            area += /* some work using *i */;<br />    }<br /><br />    vector&lt;point&gt; points;<br />    double        area;<br />};<br /><br />polygon operator+( polygon&amp; lhs, polygon&amp; rhs ) {<br />    auto ret = lhs;<br />    auto last = rhs.get_num_points();<br />    for( auto i = 0; i &lt; last; ++i ) // concatenate<br />        ret.add_point( rhs.get_point(i) );<br />    return ret;<br />}<br /><br />void f( const polygon&amp; poly ) {<br />    const_cast&lt;polygon&amp;&gt;(poly).add_point( {0,0} );<br />}<br /><br />void g( polygon&amp; const poly ) { poly.add_point( {1,1} ); }<br /><br />void h( polygon* const poly ) { poly-&gt;add_point( {2,2} ); }<br /><br />int main() {<br />    polygon poly;<br />    const polygon cpoly;<br /><br />    f(poly);<br />    f(cpoly);<br />    g(poly);<br />    h(&amp;poly);<br />}
</code></pre>
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<p>When I pose this kind of problem, I find that most people think the problem is on the easy side and address only the more-usual <span style="color:#2e74b5;">const</span> issues. There are, however, subtleties that are worth knowing, and hence this Item.
</p>
<h3>1. The point object is passed by value, so there is little benefit to declaring it const.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    void  add_point( const point pt )<span style="color:#2e74b5;">
				</span></code></pre>
</p>
<p>In this particular case, because the function is defined inline, the <span style="color:#2e74b5;">const</span> value parameter can make sense. This is because for inline functions the declaration and definition are the same. Otherwise, <span style="color:#2e74b5;">const</span> value parameters should appear only on the definition, not on the declaration. Let&#8217;s see why.
</p>
<p>Putting the <span style="color:#2e74b5;">const</span> on a value parameter in a function declaration is irrelevant <em>outside</em> the function—it makes no difference to the caller and can only confuse readers. To the compiler, the function signature is the same whether you include this <span style="color:#2e74b5;">const</span> in front of a value parameter or not. For example:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// value parameter: top-level const is not part of function signature<br />int f( int );<br />int f( const int );    // <span style="text-decoration:underline;">redeclares</span> f(int): this is the same function<br /><br />// non-value parameter: top-level const is part of function signature<br />int g( int&amp; );<br />int g( const int&amp; );   // overloads g(int&amp;): these are two functions<span style="color:#2e74b5;">
				</span></code></pre>
</p>
<p>But putting the <span style="color:#2e74b5;">const</span> on the value parameter does make a difference to how it can be used <em>inside</em> the function&#8217;s actual definition. Remember that, inside a function, the parameters are just the first set of local variables, so putting a <span style="color:#2e74b5;">const</span> on a value parameter simply means that the function can&#8217;t modify its local variable, which only happens to be a parameter. Here&#8217;s an example that declares and then defines the same function <span style="color:#2e74b5;">f</span>:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>int f( int );          // declaration: no const<br /><br />int f( const int i ) { // definition: use const to express "read-only"<br /><br />    vector&lt;int&gt; v;<br />    v.push_back(i);    // ok, only reads from i<br /><br />    i = 42;            // error, attempts to modify i<br /><br />}
</code></pre>
</p>
<blockquote>
<p><strong>Guideline:</strong> Consider not writing <strong>const</strong> on pass-by-value function parameters when only forward-declaring a function. You can always add it on the definition to express a read-only parameter.
</p>
</blockquote>
<h3>2. get_point and get_num_points should be const.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    point get_point( const int i ) { return points[i]; }<br /><br />    int   get_num_points() { return points.size(); }
</code></pre>
</p>
<p>These functions should be marked <span style="color:#2e74b5;">const</span>, because they don&#8217;t change the state of the object.
</p>
<h3>3. get_area should be const.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    double get_area() {<br />        if( area &lt; 0 )   // if not yet calculated and cached<br />            calc_area();     // calculate now<br />        return area;<br />    }
</code></pre>
</p>
<p>Even though this function modifies the object&#8217;s internal state, we should consider making it <span style="color:#2e74b5;">const</span>. Why? Because this function does not modify the object&#8217;s <em>observable</em> state; we are doing some caching here, but that&#8217;s an internal implementation detail and the object is logically <span style="color:#2e74b5;">const</span> even if it isn&#8217;t physically <span style="color:#2e74b5;">const</span>.
</p>
<h3>4. Therefore calc_area should also be const.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    void calc_area() {<br />        area = 0;<br />        vector&lt;point&gt;::iterator i;<br />        for( i = begin(points); i != end(points); ++i )<br />            area += /* some work using *i */;<br />    }
</code></pre>
</p>
<p>Once we make <span style="color:#2e74b5;">get_area</span> be <span style="color:#2e74b5;">const</span>, this private helper function ought also to be <span style="color:#2e74b5;">const</span>.
</p>
<p>In turn, once you make this function <span style="color:#2e74b5;">const</span>, the compiler will tell you that you also need to do something about the member variable <span style="color:#2e74b5;">area</span>, which should be:
</p>
<ul>
<li>declared <span style="color:#2e74b5;">mutable</span>, so that it&#8217;s writable in a <span style="color:#2e74b5;">const</span> member function; and
</li>
<li>synchronized using a <span style="color:#2e74b5;">mutex</span> or made <span style="color:#2e74b5;">atomic&lt;&gt;</span>, so that it&#8217;s concurrency-safe, as discussed in GotW #6a.
</li>
</ul>
<h3>5. Also, calc_area should use a const_iterator.<br />
</h3>
<p>The iterator should not change the state of the <span style="color:#2e74b5;">points</span> collection, and so it ought to be a <span style="color:#2e74b5;">const_iterator</span>. We&#8217;re now forced to make this change anyway if we&#8217;re making <span style="color:#2e74b5;">calc_area</span> be a <span style="color:#2e74b5;">const</span> member function, but note that if we had said <span style="color:#2e74b5;">auto</span> for the iterator&#8217;s type we wouldn&#8217;t have had to make any change at all. While we&#8217;re at it, the <span style="color:#2e74b5;">for</span> loop inside <span style="color:#2e74b5;">calc_area</span>: It should prefer to use the range-based <span style="color:#2e74b5;">for</span> loop, as well as <span style="color:#2e74b5;">auto</span>.
</p>
<p>Combining all that, we get this simpler and <span style="color:#2e74b5;">const</span>-correct code:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>      for( auto&amp; pt : points )<br />          area += /* some work using pt */;
</code></pre>
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer declaring variables using <strong>auto</strong>.
</p>
</blockquote>
<blockquote>
<p><strong>Guideline:</strong> Prefer range-based <strong>for</strong> loops to naked iterator-incrementing <strong>for</strong> loops when visiting the elements of the range in order.
</p>
</blockquote>
<h3>6. area should be mutable and synchronized.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    double        area;
</code></pre>
</p>
<p>As noted already, in conjunction with the other changes the internal cache variable will <span style="color:#2e74b5;">area</span> now want to be <span style="color:#2e74b5;">mutable </span>so that it can be used correctly and safely inside <span style="color:#2e74b5;">const</span> member functions, and because it is now a shared variable potentially used by multiple concurrent <span style="color:#2e74b5;">const</span> operations it must also be synchronized—protected with a mutex or made <span style="color:#2e74b5;">atomic</span>.
</p>
<p><strong>Bonus Question: Before reading on, which should it be: Protected by a mutex? or made atomic&lt;double&gt;?<br />
</strong></p>
<p>Have you thought about it? All right, let&#8217;s continue…
</p>
<p>Both work, but a mutex is usually overkill for a single variable.
</p>
<p>Option 1 is to use a mutex in the perhaps-soon-to-be-canonical &#8220;<span style="color:#2e74b5;">mutable mutex mutables</span>&#8221; pattern:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Option 1: Use a mutex <br /><br />    double get_area() const {<br />        auto lock = unique_lock&lt;mutex&gt;{mutables};<br />        if( area &lt; 0 )   // if not yet calculated and cached<br />            calc_area();     // calculate now<br />        return area;<br />    }<br /><br />private:<br />    // ...<br />    mutable mutex  mutables;      // canonical pattern: mutex that<br />    mutable double area;          //   covers all mutable members
</code></pre>
</p>
<p>Option 1 generalizes well if you add more data members in the future. However, it&#8217;s also more invasive and generalizes less well if you add more <span style="color:#2e74b5;">const</span> member functions in the future that use <span style="color:#2e74b5;">area</span>, because they will all have to remember to acquire a lock on the mutex before using <span style="color:#2e74b5;">area</span>.
</p>
<p>Option 2 is to just change <span style="color:#2e74b5;">double</span> to <span style="color:#2e74b5;">mutable atomic&lt;double&gt;</span>. This is attractive because the &#8220;<span style="color:#2e74b5;">mutable</span> part&#8221; of <span style="color:#2e74b5;">polygon</span> is just a single variable. That can work, but you have to be careful because that&#8217;s not the only necessary change, for two reasons:
</p>
<ul>
<li>The minor reason is that <span style="color:#2e74b5;">atomic&lt;double&gt;</span> doesn&#8217;t support <span style="color:#2e74b5;">+=</span>, so if we only change <span style="color:#2e74b5;">area</span>&#8216;s type then <span style="color:#2e74b5;">calc_area</span> will no longer compile. That can be worked around, but leads us to the major reason…
</li>
<li>The major reason is that, because <span style="color:#2e74b5;">calc_area</span> is a compound operation and must be safe to run on multiple threads concurrently, we must restructure <span style="color:#2e74b5;">calc_area</span> to be safe to run concurrently. In particular it should not perform intermediate updates to <span style="color:#2e74b5;">area</span>, and should ensure that multiple competing concurrent updates to <span style="color:#2e74b5;">area</span> don&#8217;t cause overwrites that lose written values.
</li>
</ul>
<p>There are several ways to do it, but the simplest is probably to allow benign redundant recalculations in the case of concurrent calls to <span style="color:#2e74b5;">calc_area</span>, on the grounds that it&#8217;s probably no worse than blocking the concurrent calls which would have to wait anyway.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Option 2: Use an atomic<br /><br />    void calc_area() const {<br />        auto tmp = 0.0;              // do all the work off to the side<br />        for( auto&amp; pt : points )<br />            tmp += /* some work using pt */;<br />        area = tmp;                  // then commit with a single write<br />    }<br /><br />private:<br />    // ...<br />    mutable atomic&lt;double&gt; area;
</code></pre>
</p>
<p>Notice that concurrent <span style="color:#2e74b5;">const</span> operations that call to <span style="color:#2e74b5;">calc_area</span> can still overlap and overwrite each other&#8217;s results, but that&#8217;s benign because they&#8217;re <em>concurrent <span style="color:#2e74b5;">const</span> operations</em> so they will all calculate the same value. Also, concurrent <span style="color:#2e74b5;">calc_area</span> calls use the shared <span style="color:#2e74b5;">points</span> variable in a loop which should make us mentally check that it doesn&#8217;t cause cache contention, but because they&#8217;re all readers it won&#8217;t and so this too is fine.
</p>
<h3>7. operator+&#8217;s rhs parameter should be a reference to const.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>polygon operator+( polygon&amp; lhs, polygon&amp; rhs ) {
</code></pre>
</p>
<p>The <span style="color:#2e74b5;">rhs</span> parameter should be passed by reference to <span style="color:#2e74b5;">const</span>, of course.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer passing a read-only parameter by <strong>const&amp;</strong> if you are only going to read from it (not make a copy of it).
</p>
</blockquote>
<p>&#8220;But wait!&#8221; I can just hear some of you saying, &#8220;you forgot about <span style="color:#2e74b5;">lhs</span>! Shouldn&#8217;t it be <span style="color:#2e74b5;">const&amp;</span> too?&#8221; Actually, not so much:
</p>
<h3>8. operator+&#8217;s lhs parameter should be passed by value.<br />
</h3>
<p>The key point is that we&#8217;re going to copy from it anyway, in this case immediately:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    auto ret = lhs;
</code></pre>
</p>
<p>When you&#8217;re in the special case of &#8220;read-only parameter that you&#8217;re going to take copy of anyway,&#8221; there are several ways to accept the parameter, which I&#8217;ll cover in detail in another GotW. For now, suffice it to say that usually you shouldn&#8217;t overthink these options, and just use pass-by-value as the simplest method, which offers some advantages that we also touched on in GotW #4:
</p>
<ul>
<li>If the caller passes a named <span style="color:#2e74b5;">polygon</span> object (an lvalue), there&#8217;s no difference. Both pass-by-<span style="color:#2e74b5;">const&amp;</span> followed by an explicit copy and pass-by-value will perform one copy.
</li>
<li>
<div>If the caller passes a temporary <span style="color:#2e74b5;">polygon</span> object (an rvalue), the compiler automatically move-constructs <span style="color:#2e74b5;">lhs</span> from that, which probably makes no difference for a small type like <span style="color:#2e74b5;">polygon</span> but can be considerably cheaper for many types.
</div>
<blockquote>
<p><strong>Guideline:</strong> Prefer passing a read-only parameter by value if you&#8217;re going to make a copy of the parameter anyway, because it enables move from rvalue arguments.
</p>
</blockquote>
</li>
</ul>
<h3>9. Also in operator+, last should be const.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    auto last = rhs.get_num_points();<br />    for( auto i = 0; i &lt; last; ++i ) // concatenate<br />        ret.add_point( rhs.get_point(i) );<br />    return ret;<br />}
</code></pre>
</p>
<p>Since <span style="color:#2e74b5;">last</span> should never change, prefer to say so by making it <span style="color:#2e74b5;">const</span>.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer to make variables, including locals, <strong>const</strong> if they should not change.
</p>
</blockquote>
<p>Incidentally, notice that once we make <span style="color:#2e74b5;">rhs</span> a reference-to-<span style="color:#2e74b5;">const</span> parameter as noted above, we see another reason why <span style="color:#2e74b5;">get_point</span> should be a <span style="color:#2e74b5;">const</span> member function.
</p>
<h3>10. f&#8217;s const_cast may give undefined behavior, and is morally wrong anyway.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void f( const polygon&amp; poly ) {<br />    const_cast&lt;polygon&amp;&gt;(poly).add_point( {0,0} );<br />}
</code></pre>
</p>
<p>Bonus: The result of the <span style="color:#2e74b5;">const_cast</span> is undefined if the referenced object was declared as <span style="color:#2e74b5;">const</span>—which it is in the case of <span style="color:#2e74b5;">f(cpoly)</span> below.
</p>
<p>The parameter isn&#8217;t really <span style="color:#2e74b5;">const</span>, so don&#8217;t declare it as <span style="color:#2e74b5;">const</span> and then try to modify it anyway. Lying to the compiler, never mind to the caller, is a bad idea, never mind morally reprehensible in most value systems.
</p>
<h3>11. g&#8217;s const is illegal and useless.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void g( polygon&amp; const poly ) { poly.add_point( {1,1} ); }
</code></pre>
</p>
<p>This <span style="color:#2e74b5;">const</span> is illegal; you can&#8217;t apply <span style="color:#2e74b5;">const</span> directly to the reference itself, besides which references are already <span style="color:#2e74b5;">const</span> inasmuch as they cannot be reseated to refer to a different object.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void h( polygon* const poly ) { poly-&gt;add_point( {2,2} ); }
</code></pre>
</p>
<p>Note that <span style="color:#2e74b5;">h</span>&#8216;s <span style="color:#2e74b5;">const</span> merely ensures that <span style="color:#2e74b5;">h</span>&#8216;s body won&#8217;t modify the pointer value. This is the same as the <span style="color:#2e74b5;">const</span> value parameters in <span style="color:#2e74b5;">add_point</span> and <span style="color:#2e74b5;">get_point</span>, and perfectly fine on the definition.
</p>
<h3>12. Examining the mainline.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>int main() {<br />    polygon poly;<br />    const polygon cpoly;<br /><br />    f(poly);
</code></pre>
</p>
<p>This is fine.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    f(cpoly);
</code></pre>
</p>
<p>As already noted, this causes undefined results when <span style="color:#2e74b5;">f</span> tries to cast away the <span style="color:#2e74b5;">const</span>-ness of its parameter and then modify it.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    g(poly);
</code></pre>
</p>
<p>This is fine.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    h(&amp;poly);<br />}
</code></pre>
</p>
<p>This is fine.
</p>
<h3>Summary<br />
</h3>
<p>Here is a revised version of the code that corrects the <span style="color:#2e74b5;">const</span> issues noted above, but does not attempt to correct any other poor style. Note that because of the <span style="color:#2e74b5;">atomic</span> member, which is not copyable, we now provide <span style="color:#2e74b5;">polygon</span>&#8216;s copy and move operations explicitly.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class polygon {<br />public:<br />    polygon() : area{-1} {}<br /><br />    polygon( const polygon&amp; other ) : points{other.points}, area{-1} { }<br /><br />    polygon( polygon&amp;&amp; other ) <br />        : points{move(other.points)}, area{other.area.load()}<br />        { other.area = -1; }<br /><br />    polygon&amp; operator=( const polygon&amp; other )<br />        { points = other.points; area = -1; return *this; }<br /><br />    polygon&amp; operator=( polygon&amp;&amp; other ) {<br />        points = move(other.points);<br />        area = other.area.load();<br />        other.area = -1;<br />        return *this;<br />    }<br /><br />    void add_point( point pt ) <br />        { area = -1; points.push_back(pt); }<br /><br />    point get_point( int i ) const { return points[i]; }<br /><br />    int get_num_points() const { return points.size(); }<br /><br />    double get_area() const {<br />        if( area &lt; 0 )   // if not yet calculated and cached<br />            calc_area();     // calculate now<br />        return area;<br />    }<br /><br />private:<br />    void calc_area() const {<br />        auto tmp = 0.0;<br />        for( auto&amp; pt : points )<br />            tmp += /* some work using pt */;<br />        area = tmp;<br />    }<br /><br />    vector&lt;point&gt;          points;<br />    mutable atomic&lt;double&gt; area;<br />};<br /><br />polygon operator+( polygon lhs, const polygon&amp; rhs ) {<br />    const auto last = rhs.get_num_points();<br />    for( auto i = 0; i &lt; last; ++i ) // concatenate<br />        lhs.add_point( rhs.get_point(i) );<br />    return lhs;<br />}<br /><br />void f( polygon&amp; poly ) { poly.add_point( {0,0} ); }<br /><br />void g( polygon&amp; poly ) { poly.add_point( {1,1} ); }<br /><br />void h( polygon* poly ) { poly-&gt;add_point( {2,2} ); }<br /><br />int main() {<br />    auto poly = polygon{};<br /><br />    f(poly);<br />    g(poly);<br />    h(&amp;poly);<br />}
</code></pre>
</p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: mttpd, Vincent Lascaux, jlehrer, Motti, Fernando Pelliccioni, Leo, Mathias Stearn.</p>
					<p><a href="https://herbsutter.com/2013/05/28/gotw-6b-solution-const-correctness-part-2/" rel="bookmark" title="Permanent Link to GotW #6b Solution: Const-Correctness, Part&nbsp;2">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2002 post type-post status-publish format-standard hentry category-gotw" id="post-2002">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/24/gotw-6b-const-correctness-part-2/" rel="bookmark">GotW #6b: Const-Correctness, Part&nbsp;2</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-24|
													<a href="https://herbsutter.com/2013/05/24/gotw-6b-const-correctness-part-2/#comments">8 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>const and mutable are powerful tools for writing safer code. Use them consistently.</em></span>
	</p>
<h1>Problem<br />
</h1>
<h2>Guru Question<br />
</h2>
<p>In the following code, add or remove <span style="color:#2e74b5;">const</span> (including minor variants and related keywords) wherever appropriate. Note: Don&#8217;t comment on or change the structure of this program. It&#8217;s contrived and condensed for illustration only.
</p>
<p>For bonus points: In what places are the program&#8217;s results undefined or uncompilable due to <span style="color:#2e74b5;">const</span> errors?
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class polygon {<br />public:<br />    polygon() : area{-1} {}<br /><br />    void add_point( const point pt ) { area = -1;<br />                                       points.push_back(pt); }<br /><br />    point get_point( const int i ) { return points[i]; }<br /><br />    int get_num_points() { return points.size(); }<br /><br />    double get_area() {<br />        if( area &lt; 0 )   // if not yet calculated and cached<br />            calc_area();     // calculate now<br />        return area;<br />    }<br /><br />private:<br />    void calc_area() {<br />        area = 0;<br />        vector&lt;point&gt;::iterator i;<br />        for( i = begin(points); i != end(points); ++i )<br />            area += /* some work using *i */;<br />    }<br /><br />    vector&lt;point&gt; points;<br />    double        area;<br />};<br /><br />polygon operator+( polygon&amp; lhs, polygon&amp; rhs ) {<br />    auto ret = lhs;<br />    auto last = rhs.get_num_points();<br />    for( auto i = 0; i &lt; last; ++i ) // concatenate<br />        ret.add_point( rhs.get_point(i) );<br />    return ret;<br />}<br /><br />void f( const polygon&amp; poly ) {<br />    const_cast&lt;polygon&amp;&gt;(poly).add_point( {0,0} );<br />}<br /><br />void g( polygon&amp; const poly ) { poly.add_point( {1,1} ); }<br /><br />void h( polygon* const poly ) { poly-&gt;add_point( {2,2} ); }<br /><br />int main() {<br />    polygon poly;<br />    const polygon cpoly;<br /><br />    f(poly);<br />    f(cpoly);<br />    g(poly);<br />    h(&amp;poly);<br />}
</code></pre></p>
					<p><a href="https://herbsutter.com/2013/05/24/gotw-6b-const-correctness-part-2/" rel="bookmark" title="Permanent Link to GotW #6b: Const-Correctness, Part&nbsp;2">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2000 post type-post status-publish format-standard hentry category-gotw" id="post-2000">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/24/gotw-6a-const-correctness-part-1-3/" rel="bookmark">GotW #6a Solution: Const-Correctness, Part&nbsp;1</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-24|
													<a href="https://herbsutter.com/2013/05/24/gotw-6a-const-correctness-part-1-3/#comments">15 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>const and mutable have been in C++ for many years. How well do you know what they mean today?<br />
</em></span></p>
<h1>Problem</h1>
<h2>JG Question</h2>
<p>1. What is a &#8220;shared variable&#8221;?</p>
<h2>Guru Questions</h2>
<p>2. What do <span style="color:#2e74b5;">const</span> and <span style="color:#2e74b5;">mutable</span> mean on shared variables?</p>
<p>3. How are <span style="color:#2e74b5;">const</span> and <span style="color:#2e74b5;">mutable</span> different in C++98 and C++11?</p>
<h1>Solution</h1>
<h2>1. What is a &#8220;shared variable&#8221;?</h2>
<p>A &#8220;shared variable&#8221; is one that could be accessed from more than one thread at the same time.</p>
<p>This concept is important in the C++ memory model. For example, the C++ memory model (the core of which is described in ISO C++ §1.10) prohibits the invention of a write to a &#8220;potentially shared memory location&#8221; that would not have been written to in a sequentially consistent execution of the program, and the C++ standard library refers to this section when it prohibits &#8220;modify[ing] objects accessible by [other] threads&#8221; through a <span style="color:#2e74b5;">const</span> function, as we will see in #2.</p>
<h2>2. What do const and mutable mean on shared variables?</h2>
<p>Starting with C++11, <span style="color:#2e74b5;">const</span> on a variable that is possibly shared means &#8220;read-only or as good as read-only&#8221; for the purposes of concurrency. Concurrent <span style="color:#2e74b5;">const</span> operations on the same object are required to be safe without the calling code doing external synchronization.</p>
<p>If you are implementing a type, unless you know objects of the type can never be shared (which is generally impossible), this means that each of your <span style="color:#2e74b5;">const</span> member functions must be either:</p>
<ul>
<li>truly physically/bitwise <span style="color:#2e74b5;">const</span> with respect to this object, meaning that they perform no writes to the object&#8217;s data; or else</li>
<li>internally synchronized so that if it does perform any actual writes to the object&#8217;s data, that data is correctly protected with a mutex or equivalent (or if appropriate are <span style="color:#2e74b5;">atomic&lt;&gt;</span>) so that any possible concurrent <span style="color:#2e74b5;">const</span> accesses by multiple callers can&#8217;t tell the difference.</li>
</ul>
<p>Types that do not respect this cannot be used with the standard library, which requires that:</p>
<blockquote><p>&#8220;… to prevent data races (1.10). … [a] C++ standard library function shall not directly or indirectly modify objects (1.10) accessible by threads other than the current thread unless the objects are accessed directly or indirectly via the function&#8217;s non-<strong>const</strong> arguments, including <strong>this</strong>.&#8221;—ISO C++ §17.6.5.9</p></blockquote>
<p>Similarly, writing <span style="color:#2e74b5;">mutable</span> on a member variable means what it has always meant: The variable is &#8220;writable but logically <span style="color:#2e74b5;">const</span>.&#8221; Note what this implies:</p>
<ul>
<li>The &#8220;logically <span style="color:#2e74b5;">const</span>&#8221; part now means &#8220;can be used safely by multiple concurrent <span style="color:#2e74b5;">const</span> operations.&#8221;</li>
<li>The &#8220;<span style="color:#2e74b5;">mutable</span>&#8221; and &#8220;writable&#8221; part further means that some <span style="color:#2e74b5;">const</span> operations may actually be writers of the shared variable, which means it&#8217;s inherently got to be correct to read and write concurrently, so it should be protected with a mutex or similar, or made <span style="color:#2e74b5;">atomic&lt;&gt;</span>.</li>
</ul>
<p>In general, remember:</p>
<blockquote><p><strong>Guideline:</strong> Remember the &#8220;M&amp;M rule&#8221;: For a member variable, <strong>mutable</strong> and <strong>mutex</strong> (or <strong>atomic)</strong> go together.</p></blockquote>
<p>This applies in both directions, to wit:</p>
<blockquote><p><strong>(1) For a member variable, mutable implies mutex (or equivalent):</strong> A <strong>mutable</strong> member variable is presumed to be a mutable shared variable and so must be synchronized internally—protected with a <strong>mutex,</strong> made <strong>atomic,</strong> or similar.</p></blockquote>
<blockquote><p><strong>(2) For a member variable, mutex (or similar synchronization type) implies mutable<span style="color:#2e74b5;">:</span></strong> A member variable that is itself of a synchronization type, such as a <strong>mutex</strong> or a condition variable, naturally wants to be <strong>mutable,</strong> because you will want to use it in a non-<strong>const</strong> way (e.g., take a <strong>std::lock_guard&lt;mutex&gt;</strong>) inside concurrent <strong>const</strong> member functions.</p></blockquote>
<p>We&#8217;ll see an example of (2) in Part 2, GotW #6b.</p>
<h2>3. How are const and mutable different in C++98 and C++11?</h2>
<p>First, let&#8217;s be clear: C++98 single-threaded code still works. C++11 has excellent C++98 compatibility, and even though the meaning of <span style="color:#2e74b5;">const</span> has evolved, C++98 single-threaded code that uses the old &#8220;logically <span style="color:#2e74b5;">const</span>&#8221; meaning of <span style="color:#2e74b5;">const</span> is still valid.</p>
<p>With C++98, we taught a generation of C++ developers that &#8220;<span style="color:#2e74b5;">const</span> means logically <span style="color:#2e74b5;">const</span>, not physically/bitwise <span style="color:#2e74b5;">const</span>.&#8221; That is, in C++98 we taught that <span style="color:#2e74b5;">const</span> meant only that the observable state of the object (say, via its non-private member functions) should not change as far as the caller could tell, but its internal bits might change in order to update counters and instrumentation and other data not accessible via the type&#8217;s public or protected interface.</p>
<p>That definition is not sufficient for concurrency. With C++11 and onward, which now includes a concurrency memory model and thread safety specification for the standard library, this is now much simpler: <span style="color:#2e74b5;">const</span> now really does mean &#8220;read-only, or safe to read concurrently&#8221;—either truly physically/bitwise <span style="color:#2e74b5;">const</span>, or internally synchronized so that any actual writes are synchronized with any possible concurrent <span style="color:#2e74b5;">const</span> accesses so the callers can&#8217;t tell the difference.</p>
<p>Although existing C++98-era types still work just fine in C++98-era single-threaded code for compatibility, those types and any new ones you write today should obey the new stricter requirement if they could be used on multiple threads. The good news is that most existing types already followed that rule, and code that relies on casting away <span style="color:#2e74b5;">const</span> and/or using <span style="color:#2e74b5;">mutable</span> data members in single-threaded code has already been generally questionable and relatively rare.</p>
<h2>Summary</h2>
<p>Don&#8217;t shoot yourself (or your fellow programmers) in the foot. Write <span style="color:#2e74b5;">const</span>-correct code.</p>
<p>Using <span style="color:#2e74b5;">const</span> consistently is simply necessary for correctly-synchronized code. That by itself is ample reason to be consistently <span style="color:#2e74b5;">const</span>-correct, but there&#8217;s more: It lets you document interfaces and invariants far more effectively than any mere <span style="color:#2e74b5;">/* I promise not to change this */</span> comment can accomplish. It&#8217;s a powerful part of &#8220;design by contract.&#8221; It helps the compiler to stop you from accidentally writing bad code. It can even help the compiler generate tighter, faster, smaller code. That being the case, there&#8217;s no reason why you shouldn&#8217;t use it as much as possible, and every reason why you should.</p>
<p>Remember that the correct use of <span style="color:#2e74b5;">mutable</span> is a key part of <span style="color:#2e74b5;">const</span>-correctness. If your class contains a member that could change even for <span style="color:#2e74b5;">const</span> objects and operations, make that member <span style="color:#2e74b5;">mutable</span> and protect it with a mutex or make it <span style="color:#2e74b5;">atomic</span>. That way, you will be able to write your class&#8217; <span style="color:#2e74b5;">const</span> member functions easily and correctly, and users of your class will be able to correctly create and use <span style="color:#2e74b5;">const</span> and non-<span style="color:#2e74b5;">const</span> objects of your class&#8217; type.</p>
<p>It&#8217;s true that not all commercial libraries&#8217; interfaces are <span style="color:#2e74b5;">const</span>-correct. That isn&#8217;t an excuse for you to write <span style="color:#2e74b5;">const</span>-incorrect code, though. It is, however, one of the few good excuses to write <span style="color:#2e74b5;">const_cast</span>, plus a detailed comment nearby grumbling about the library vendor&#8217;s laziness and how you&#8217;re looking for a replacement product.</p>
<h2>Acknowledgments</h2>
<p>Thanks in particular to the following for their feedback to improve this article: mttpd, jlehrer, Chris Vine.</p>
					<p><a href="https://herbsutter.com/2013/05/24/gotw-6a-const-correctness-part-1-3/" rel="bookmark" title="Permanent Link to GotW #6a Solution: Const-Correctness, Part&nbsp;1">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-1986 post type-post status-publish format-standard hentry category-gotw" id="post-1986">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/22/gotw-6a-const-correctness-part-1/" rel="bookmark">GotW #6a: Const-Correctness, Part&nbsp;1</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-22|
													<a href="https://herbsutter.com/2013/05/22/gotw-6a-const-correctness-part-1/#comments">12 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>const and mutable have been in C++ for many years. How well do you know what they mean today?<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. What is a &#8220;shared variable&#8221;?
</p>
<h2>Guru Questions<br />
</h2>
<p>2. What do <span style="color:#2e74b5;">const</span> and <span style="color:#2e74b5;">mutable</span> mean on shared variables?
</p>
<p>3. How are <span style="color:#2e74b5;">const</span> and <span style="color:#2e74b5;">mutable</span> different in C++98 and C++11?</p>
					<p><a href="https://herbsutter.com/2013/05/22/gotw-6a-const-correctness-part-1/" rel="bookmark" title="Permanent Link to GotW #6a: Const-Correctness, Part&nbsp;1">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-1984 post type-post status-publish format-standard hentry category-gotw" id="post-1984">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/22/gotw-5-solution-overriding-virtual-functions/" rel="bookmark">GotW #5 Solution: Overriding Virtual&nbsp;Functions</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-22|
													<a href="https://herbsutter.com/2013/05/22/gotw-5-solution-overriding-virtual-functions/#comments">45 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Virtual functions are a pretty basic feature, but they occasionally harbor subtleties that trap the unwary. If you can answer questions like this one, then you know virtual functions cold, and you&#8217;re less likely to waste a lot of time debugging problems like the ones illustrated below.<br />
</em></span></p>
<h1>Problem</h1>
<h2>JG Question</h2>
<p>1. What do the <span style="color:#2e74b5;">override</span> and <span style="color:#2e74b5;">final</span> keywords do? Why are they useful?</p>
<h2>Guru Question</h2>
<p>2. In your travels through the dusty corners of your company&#8217;s code archives, you come across the following program fragment written by an unknown programmer. The programmer seems to have been experimenting to see how some C++ features worked.</p>
<p style="margin-left:14pt;">(a) What could be improved in the code&#8217;s correctness or style?</p>
<p style="margin-left:14pt;">(b) What did the programmer probably expect the program to print, but what is the actual result?</p>
<pre><code>class base {
public:
    virtual void f( int );
    virtual void f( double );
    virtual void g( int i = 10 );
};

void base::f( int ) {
    cout &lt;&lt; "base::f(int)" &lt;&lt; endl;
}

void base::f( double ) {
    cout &lt;&lt; "base::f(double)" &lt;&lt; endl;
}

void base::g( int i ) {
    cout &lt;&lt; i &lt;&lt; endl;
}

class derived: public base {
public:
    void f( complex&lt;double&gt; );
    void g( int i = 20 );
};

void derived::f( complex&lt;double&gt; ) {
    cout &lt;&lt; "derived::f(complex)" &lt;&lt; endl;
}

void derived::g( int i ) {
    cout &lt;&lt; "derived::g() " &lt;&lt; i &lt;&lt; endl;
}

int main() {
    base    b;
    derived d;
    base*   pb = new derived;

    b.f(1.0);
    d.f(1.0);
    pb-&gt;f(1.0);

    b.g();
    d.g();
    pb-&gt;g();

    delete pb;
}
</code></pre>
<h1>Solution</h1>
<h2>1. What do the override and final keywords do? Why are they useful?</h2>
<p>These keywords give explicit control over virtual function overriding. Writing <span style="color:#2e74b5;">override</span> declares the intent to override a base class virtual function. Writing <span style="color:#2e74b5;">final</span> makes a virtual function no longer overrideable in further-derived classes, or a class no longer permitted to have further-derived classes.</p>
<p>They are useful because they let the programmer explicitly declare intent in a way the language can enforce at compile time. If you write <span style="color:#2e74b5;">override</span> but there is no matching base class function, or you write <span style="color:#2e74b5;">final</span> and a further-derived class tries to implicitly or explicitly override the function anyway, you get a compile-time error.</p>
<p>Of the two, by far the more commonly useful is <span style="color:#2e74b5;">override</span>; uses for <span style="color:#2e74b5;">final</span> are rarer.</p>
<h2>2. (a) What could be improved in the code&#8217;s correctness or style?</h2>
<p>First, let&#8217;s consider some style issues, and one real error:</p>
<h3>1. The code uses explicit new, delete, and an owning *.</h3>
<p>Avoid using owning raw pointers and explicit <span style="color:#2e74b5;">new</span> and <span style="color:#2e74b5;">delete</span> except in rare cases like when you&#8217;re writing the internal implementation details of a low-level data structure.</p>
<pre><code>{
    base*   pb = new derived;

    ...

    delete pb;
}
</code></pre>
<p>Instead of <span style="color:#2e74b5;">new</span> and <span style="color:#2e74b5;">base*</span>, use <span style="color:#2e74b5;">make_unique</span> and <span style="color:#2e74b5;">unique_ptr&lt;base&gt;</span>.</p>
<pre><code>{
    auto pb = unique_ptr&lt;base&gt;{ make_unique&lt;derived&gt;() };

    ...

} // automatic delete here
</code></pre>
<blockquote><p><strong>Guideline:</strong> Don&#8217;t use explicit <strong>new</strong>, <strong>delete</strong>, and owning <strong>*</strong> pointers, except in rare cases encapsulated inside the implementation of a low-level data structure.</p></blockquote>
<p>However, that <span style="color:#2e74b5;">delete</span> brings us to another issue unrelated to how we allocate and manage the lifetime of the object, namely:</p>
<h3>2. base&#8217;s destructor should be virtual or protected.</h3>
<pre><code>class base {
public:
    virtual void f( int );
    virtual void f( double );
    virtual void g( int i = 10 );
};
</code></pre>
<p>This looks innocuous, but the writer of <span style="color:#2e74b5;">base</span> forgot to make the destructor either <span style="color:#2e74b5;">virtual</span> or <span style="color:#2e74b5;">protected</span>. As it is, deleting via a pointer-to-base without a virtual destructor is evil, pure and simple, and corruption is the best thing you can hope for because the wrong destructor will get called, <span style="color:#2e74b5;">derived</span> class members won&#8217;t be destroyed, and <span style="color:#2e74b5;">operator delete</span> will be invoked with the wrong object size.</p>
<blockquote><p><strong>Guideline: </strong>Make base class destructors public and virtual, or protected and nonvirtual.</p></blockquote>
<p>Exactly one of the following can be true for a polymorphic type:</p>
<ul>
<li>Either destruction via a pointer to base is allowed, in which case the function has to be <span style="color:#2e74b5;">public</span> and had better be <span style="color:#2e74b5;">virtual</span>;</li>
<li>or else it isn&#8217;t, in which case the function has to be <span style="color:#2e74b5;">protected</span> (<span style="color:#2e74b5;">private</span> is not allowed because the derived destructor must be able to invoke the base destructor) and would naturally also be nonvirtual (when the derived destructor invokes the base destructor, it does so nonvirtually whether declared <span style="color:#2e74b5;">virtual</span> or not).</li>
</ul>
<h3>Interlude</h3>
<p>For the next few points, it&#8217;s important to differentiate three terms:</p>
<ul>
<li>To <strong>overload</strong> a function <span style="color:#2e74b5;">f</span> means to provide another function with the same name in the same scope but with different parameter types. When <span style="color:#2e74b5;">f</span> is actually called, the compiler will try to pick the best match based on the actual parameters that are supplied.</li>
<li>To <strong>override</strong> a virtual function <span style="color:#2e74b5;">f</span> means to provide another function with the same name and the same parameter types in a derived class.</li>
<li>To <strong>hide</strong> a function <span style="color:#2e74b5;">f</span> that exists in an enclosing scope (base class, outer class, or namespace) means to provide another function with the same name in an inner scope (derived class, nested class, or namespace), which will hide the same function name in an enclosing scope.</li>
</ul>
<h3>3. derived::f is neither an override nor an overload.</h3>
<pre><code>    void derived::f( complex&lt;double&gt; )
</code></pre>
<p><span style="color:#2e74b5;">derived</span> does not overload the <span style="color:#2e74b5;">base::f</span> functions, it hides them. This distinction is very important, because it means that <span style="color:#2e74b5;">base::f(int)</span> and <span style="color:#2e74b5;">base::f(double)</span> are not visible in the scope of <span style="color:#2e74b5;">derived</span>.</p>
<p>If the author of <span style="color:#2e74b5;">derived</span> intended to hide the base functions named <span style="color:#2e74b5;">f</span>, then this is all right. Usually, however, the hiding is inadvertent and surprising, and the correct way to bring the names into the scope of derived is to write the using-declaration <span style="color:#2e74b5;">using base::f;</span> inside <span style="color:#2e74b5;">derived</span>.</p>
<blockquote><p><strong>Guideline: </strong>When providing a non-overridden function with the same name as an inherited function, be sure to bring the inherited functions into scope with a <strong>using</strong>-declaration if you don&#8217;t want to hide them.</p></blockquote>
<h3>4. derived::g overrides base::g but doesn&#8217;t say &#8220;override.&#8221;</h3>
<pre><code>    void g( int i = 20 )  /* override */
</code></pre>
<p>This function overrides the base function, so it should say <span style="color:#2e74b5;">override</span> explicitly. This documents the intent, and lets the compiler tell you if you&#8217;re trying to override something that&#8217;s not virtual or you got the signature wrong by mistake.</p>
<blockquote><p><strong>Guideline: </strong>Always write<strong> override</strong> when you intend to override a virtual function.</p></blockquote>
<h3>5. derived::g overrides base::g but changes the default argument.</h3>
<pre><code>    void g( int i = 20 )
</code></pre>
<p>Changing the default argument is decidedly user-unfriendly. Unless you&#8217;re really out to confuse people, don&#8217;t change the default arguments of the inherited functions you override. Yes, this is legal C++, and yes, the result is well-defined; and no, don&#8217;t do it. Further below, we&#8217;ll see just how confusing this can be.</p>
<blockquote><p><strong>Guideline: </strong>Never change the default arguments of overridden inherited functions.</p></blockquote>
<p>We could go one step further:</p>
<blockquote><p><strong>Guideline:</strong> Avoid default arguments on virtual functions in general.</p></blockquote>
<p>Finally, public virtual functions are great when a class is acting as a pure abstract base class (ABC) that only specifies the virtual interface without implementations, like a C# or Java <span style="color:#2e74b5;">interface</span> does.</p>
<blockquote><p><strong>Guideline:</strong> Prefer to have a class contain only public virtual functions, or no public virtual functions (other than the destructor which is special).</p></blockquote>
<blockquote><p>A pure abstract base class should have only public virtual functions. …</p></blockquote>
<p>But when a class is both providing virtual functions and their implementations, consider the Non-Virtual Interface pattern (NVI) that makes the public interface and the virtual interface separate and distinct.</p>
<blockquote><p>… For any other base class, prefer making public member functions non-virtual, and virtual member functions non-public; the former should have any default arguments and can be implemented in terms of the latter.</p></blockquote>
<p>This cleanly separates the public interface from the derivation interface, lets each follow its natural form best suited for its distinct audience, and avoids having one function exist in tension from doing double duty with two responsibilities. Among other benefits, using NVI will often clarify your class&#8217;s design in important ways, including for example that the default arguments which matter to the caller therefore naturally belong on the public interface, not on the virtual interface. Following this pattern means that several classes of potential problems, including this one of virtuals with default arguments, just naturally don&#8217;t arise.</p>
<p>The C++ standard library follows NVI nearly universally, and other modern OO languages and environments have rediscovered this principle for their own library design guidelines, such as in the .NET <a href="http://www.amazon.com/Framework-Design-Guidelines-Conventions-Libraries/dp/0321545613"><em>Framework Design Guidelines</em></a>.</p>
<h2>2. (b) What did the programmer probably expect the program to print, but what is the actual result?</h2>
<p>Now that we have those issues out of the way, let&#8217;s look at the mainline and see whether it does that the programmer intended:</p>
<pre><code>int main() {
    base    b;
    derived d;
    base*   pb = new derived;

    b.f(1.0);
</code></pre>
<p>No problem. This first call invokes <span style="color:#2e74b5;">base::f( double )</span>, as expected.</p>
<pre><code>    d.f(1.0);
</code></pre>
<p>This calls <span style="color:#2e74b5;">derived::f( complex&lt;double&gt; )</span>. Why? Well, remember that <span style="color:#2e74b5;">derived</span> doesn&#8217;t declare <span style="color:#2e74b5;">using base::f;</span> to bring the base functions named <span style="color:#2e74b5;">f</span> into scope, and so clearly <span style="color:#2e74b5;">base::f( int )</span> and <span style="color:#2e74b5;">base::f( double )</span> can&#8217;t be called. They are not present in the same scope as <span style="color:#2e74b5;">derived::f( complex&lt;double&gt; )</span> so as to participate in overloading.</p>
<p>The programmer may have expected this to call <span style="color:#2e74b5;">base::f( double )</span>, but in this case there won&#8217;t even be a compile error because fortunately(?) <span style="color:#2e74b5;">complex&lt;double&gt;</span> provides an implicit conversion from <span style="color:#2e74b5;">double</span>, and so the compiler interprets this call to mean <span style="color:#2e74b5;">derived::f( complex&lt;double&gt;(1.0) )</span>.</p>
<pre><code>    pb-&gt;f(1.0);
</code></pre>
<p>Interestingly, even though the <span style="color:#2e74b5;">base* pb</span> is pointing to a <span style="color:#2e74b5;">derived</span> object, this calls <span style="color:#2e74b5;">base::f( double )</span> because overload resolution is done on the static type (here <span style="color:#2e74b5;">base</span>), not the dynamic type (here <span style="color:#2e74b5;">derived</span>). You have a <span style="color:#2e74b5;">base</span> pointer, you get the <span style="color:#2e74b5;">base</span> interface.</p>
<p>For the same reason, the call <span style="color:#2e74b5;">pb-&gt;f(complex&lt;double&gt;(1.0));</span> would not compile, because there is no satisfactory function in the base interface.</p>
<pre><code>    b.g();
</code></pre>
<p>This prints <span style="color:#2e74b5;">10</span>, because it simply invokes <span style="color:#2e74b5;">base::g( int )</span> whose parameter defaults to the value <span style="color:#2e74b5;">10</span>. No sweat.</p>
<pre><code>    d.g();
</code></pre>
<p>This prints <span style="color:#2e74b5;">derived::g() 20</span>, because it simply invokes <span style="color:#2e74b5;">derived::g( int )</span> whose parameter defaults to the value <span style="color:#2e74b5;">20</span>. Also no sweat.</p>
<pre><code>    pb-&gt;g();
</code></pre>
<p>This prints <span style="color:#2e74b5;">derived::g() 10</span>.</p>
<p>&#8220;Wait a minute!&#8221; you might protest. &#8220;What&#8217;s going on here?&#8221; This result may temporarily lock your mental brakes and bring you to a screeching halt until you realize that what the compiler has done is quite proper. (Although, of course, the programmer of <span style="color:#2e74b5;">derived</span> ought to be taken out into the back parking lot and yelled at.) The thing to remember is that, like overloads, default parameters are taken from the static type (here <span style="color:#2e74b5;">base</span>) of the object, hence the default value of <span style="color:#2e74b5;">10</span> is taken. However, the function happens to be virtual, and so the function actually called is based on the dynamic type (here <span style="color:#2e74b5;">derived</span>) of the object. Again, this can be avoided by avoiding default arguments on virtual functions, such as by following NVI and avoiding public virtual functions entirely.</p>
<pre><code>    delete pb;
}
</code></pre>
<p>Finally, as noted, this shouldn&#8217;t be needed because you should be using <span style="color:#2e74b5;">unique_ptr</span>s which do the cleanup for you, and <span style="color:#2e74b5;">base</span> should have a virtual destructor so that destruction via any pointer to <span style="color:#2e74b5;">base</span> is correct.</p>
<h2>Acknowledgments</h2>
<p>Thanks in particular to the following for their feedback to improve this article: litb1, KrzaQ, mttpd.</p>
					<p><a href="https://herbsutter.com/2013/05/22/gotw-5-solution-overriding-virtual-functions/" rel="bookmark" title="Permanent Link to GotW #5 Solution: Overriding Virtual&nbsp;Functions">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-1960 post type-post status-publish format-standard hentry category-gotw" id="post-1960">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/20/gotw-5-overriding-virtual-functions/" rel="bookmark">GotW #5: Overriding Virtual&nbsp;Functions</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-20|
													<a href="https://herbsutter.com/2013/05/20/gotw-5-overriding-virtual-functions/#comments">11 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>Virtual functions are a pretty basic feature, but they occasionally harbor subtleties that trap the unwary. If you can answer questions like this one, then you know virtual functions cold, and you&#8217;re less likely to waste a lot of time debugging problems like the ones illustrated below.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. What do the <span style="color:#2e74b5;">override</span> and <span style="color:#2e74b5;">final</span> keywords do? Why are they useful?
</p>
<h2>Guru Question<br />
</h2>
<p>2. In your travels through the dusty corners of your company&#8217;s code archives, you come across the following program fragment written by an unknown programmer. The programmer seems to have been experimenting to see how some C++ features worked.
</p>
<p style="margin-left:14pt;">(a) What could be improved in the code&#8217;s correctness or style?
</p>
<p style="margin-left:14pt;">(b) What did the programmer probably expect the program to print, but what is the actual result?
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class base {<br />public:<br />    virtual void f( int );<br />    virtual void f( double );<br />    virtual void g( int i = 10 );<br />};<br /><br />void base::f( int ) {<br />    cout &lt;&lt; "base::f(int)" &lt;&lt; endl;<br />}<br /><br />void base::f( double ) {<br />    cout &lt;&lt; "base::f(double)" &lt;&lt; endl;<br />}<br /><br />void base::g( int i ) {<br />    cout &lt;&lt; i &lt;&lt; endl;<br />}<br /><br />class derived: public base {<br />public:<br />    void f( complex&lt;double&gt; );<br />    void g( int i = 20 );<br />};<br /><br />void derived::f( complex&lt;double&gt; ) {<br />    cout &lt;&lt; "derived::f(complex)" &lt;&lt; endl;<br />}<br /><br />void derived::g( int i ) {<br />    cout &lt;&lt; "derived::g() " &lt;&lt; i &lt;&lt; endl;<br />}<br /><br />int main() {<br />    base    b;<br />    derived d;<br />    base*   pb = new derived;<br /><br />    b.f(1.0);<br />    d.f(1.0);<br />    pb-&gt;f(1.0);<br /><br />    b.g();<br />    d.g();<br />    pb-&gt;g();<br /><br />    delete pb;<br />}
</code></pre></p>
					<p><a href="https://herbsutter.com/2013/05/20/gotw-5-overriding-virtual-functions/" rel="bookmark" title="Permanent Link to GotW #5: Overriding Virtual&nbsp;Functions">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-1957 post type-post status-publish format-standard hentry category-gotw" id="post-1957">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/20/gotw-4-class-mechanics/" rel="bookmark">GotW #4 Solution: Class&nbsp;Mechanics</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-20|
													<a href="https://herbsutter.com/2013/05/20/gotw-4-class-mechanics/#comments">39 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>How good are you at the details of writing classes? This item focuses not only on blatant errors, but even more so on professional style. Understanding these principles will help you to design classes that are easier to use and easier to maintain.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. What makes interfaces &#8220;easy to use correctly, hard to use incorrectly&#8221;? Explain.
</p>
<h2>Guru Question<br />
</h2>
<p>2. You are doing a code review. A programmer has written the following class, which shows some poor style and has some real errors. How many can you find, and how would you fix them?
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class complex {<br />public:<br />    complex( double r, double i = 0 )<br />        : real(r), imag(i)<br />    { }<br /><br />    void operator+ ( complex other ) {<br />        real = real + other.real;<br />        imag = imag + other.imag;<br />    }<br /><br />    void operator&lt;&lt;( ostream os ) {<br />        os &lt;&lt; "(" &lt;&lt; real &lt;&lt; "," &lt;&lt; imag &lt;&lt; ")";<br />    }<br /><br />    complex operator++() {<br />        ++real;<br />        return *this;<br />    }<br /><br />    complex operator++( int ) {<br />        auto temp = *this;<br />        ++real;<br />        return temp;<br />    }<br /><br />    // ... more functions that complement the above ...<br /><br />private:<br />    double real, imag;<br />};
</code></pre>
</p>
<p>Note: This is not intended to be a complete class. For example, if you provide <span style="color:#2e74b5;">operator++</span> you would normally also provide <span style="color:#2e74b5;">operator&#8211;</span>. Rather, this is an instructive example to focus on the mechanics of writing correctly the kinds of functions this class is trying to support.
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>1. What makes interfaces &#8220;easy to use correctly, hard to use incorrectly&#8221;? Explain.<br />
</h2>
<p>We want to enable a <a href="http://blogs.msdn.com/b/brada/archive/2003/10/02/50420.aspx">&#8220;pit of success&#8221;</a> where users of our type just naturally fall into good practices—they just naturally write code that is valid, correct, and efficient.
</p>
<p>On the other hand, we want to make it hard for our users to get into trouble—we want code that would be incorrect or inefficient to be invalid (a compile time error if possible) or at least inconvenient and hard to write silently so that we can protect the user from unwelcome surprises.
</p>
<p>Scott Meyers <a href="http://programmer.97things.oreilly.com/wiki/index.php/Make_Interfaces_Easy_to_Use_Correctly_and_Hard_to_Use_Incorrectly">popularized</a> this guidance. See his concise writeup for further examples.
</p>
<p>
 </p>
<h2>2. You are doing a code review. A programmer has written the following class, which shows some poor style and has some real errors. How many can you find, and how would you fix them?<br />
</h2>
<p>This class has a lot of problems—even more than I will show explicitly here. The point of this puzzle was primarily to highlight class mechanics (issues like &#8220;what is the canonical form of <span style="color:#2e74b5;">operator&lt;&lt;</span>?&#8221; and &#8220;should <span style="color:#2e74b5;">operator+</span> be a member?&#8221;) rather than point out where the interface is just plain poorly designed. However, I will start off with perhaps the two most useful observation first:
</p>
<p>First, this is a code review but the developer doesn&#8217;t seem to have tried to even unit-test his code, else he would have found some glaring problems.
</p>
<p>Second, why write a <span style="color:#2e74b5;">complex</span> class when one already exists in the standard library? And, what&#8217;s more, when the standard one isn&#8217;t plagued with any of the following problems and has been crafted based on years of practice by the best people in our industry? Humble thyself and reuse.
</p>
<blockquote>
<p><strong>Guideline:</strong> Reuse code—especially standard library code—instead of handcrafting your own. It&#8217;s faster, easier, and safer.
</p>
</blockquote>
<p>Perhaps the best way to fix the problems in the <span style="color:#2e74b5;">complex</span> code is to avoid using the class at all, and use the <span style="color:#2e74b5;">std::complex</span> template instead.
</p>
<p>Having said that, it&#8217;s an instructive example, so let&#8217;s go through the class as written and fix the problems as we go. First, the constructor:
</p>
<h3>1. The default constructor is missing.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    complex( double r, double i = 0 )<br />        : real(r), imag(i)<br />    { }
</code></pre>
</p>
<p>Once we supply a user-written constructor, we suppress the implicit generation of the default constructor. Beyond &#8220;easy to use correctly,&#8221; not having a default constructor makes the class annoying to use at all. In this case, we could either default both parameters, or provide a <span style="color:#2e74b5;">complex() = default;</span> and declare the data members with initializers such as <span style="color:#2e74b5;">double real = 0, imag = 0;</span> , or just delegate with <span style="color:#2e74b5;">complex() : complex(0) { }</span> . Just defaulting the parameter is the simplest here.
</p>
<p>Also, as explained in GotW #1, prefer to use <span style="color:#2e74b5;">{ }</span> consistently for initialization rather than <span style="color:#2e74b5;">( )</span> just as a good modern habit. The two mean exactly the same thing in this case, but <span style="color:#2e74b5;">{ }</span> lets us be more consistent, and could catch a few errors during maintenance, such as typos that would invoke <span style="color:#2e74b5;">double</span>-to-<span style="color:#2e74b5;">float</span> narrowing conversions.
</p>
<h3>2. operator+ passes by value.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    void operator+ ( complex other ) {<br />        real = real + other.real;<br />        imag = imag + other.imag;<br />    }
</code></pre>
</p>
<p>Although we&#8217;re about make other changes to this function in a moment, as written this parameter should be passed by <span style="color:#2e74b5;">const&amp;</span> because all we do is read from it.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer passing a read-only parameter by <strong>const&amp;</strong> if you are only going to read from it (not make a copy of it).
</p>
</blockquote>
<h3>3. operator+ modifies this object&#8217;s value.<br />
</h3>
<p>Instead of returning <span style="color:#2e74b5;">void</span>, <span style="color:#2e74b5;">operator+</span> should return a <span style="color:#2e74b5;">complex</span> containing the sum and not modify this object&#8217;s value. Users who write <span style="color:#2e74b5;">val1 + val2</span> and see <span style="color:#2e74b5;">val1</span> changed are unlikely to be impressed by these gratuitously weird semantics. As Scott Meyers is wont to say, when writing a value type, &#8220;do as the <span style="color:#2e74b5;">int</span>s do&#8221; and follow the conventions of the built-in types.
</p>
<h3>4. operator+ is not written in terms of operator+= (which is missing).<br />
</h3>
<p>Really, this <span style="color:#2e74b5;">operator+</span> is trying to be <span style="color:#2e74b5;">operator+=</span>. It should be split into an actual <span style="color:#2e74b5;">operator+</span> and <span style="color:#2e74b5;">operator+=</span>, with the former calling the latter.
</p>
<blockquote>
<p><strong>Guideline: </strong>If you supply a standalone version of an operator (e.g., <strong>operator+</strong>), always supply an assignment version of the same operator (e.g., <strong>operator+=</strong>) and prefer implementing the former in terms of the latter. Also, always preserve the natural relationship between op and op= (where op stands for any operator).
</p>
</blockquote>
<p>Having <span style="color:#2e74b5;">+=</span> is good, because users should prefer using it. Even in the above code, <span style="color:#2e74b5;">real = real + other.real;</span> should be <span style="color:#2e74b5;">real += other.real;</span> and similarly for the second line.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer writing <strong>a op= b</strong> instead of <strong>a = a op b</strong> (where op stands for any operator). It&#8217;s clearer, and it&#8217;s often more efficient.
</p>
</blockquote>
<p>The reason why <span style="color:#2e74b5;">operator+=</span> is more efficient is that it operates on the left-hand object directly and returns only a reference, not a temporary object. On the other hand, <span style="color:#2e74b5;">operator+</span> must return a temporary object. To see why, consider the following canonical forms for how <span style="color:#2e74b5;">operator+=</span> and <span style="color:#2e74b5;">operator+</span> should normally be implemented for some type <span style="color:#2e74b5;">T</span>.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>T&amp; T::operator+=( const T&amp; other ) {<br />    //...<br />    return *this;<br />}<br /><br />T operator+( T a, const T&amp; b ) {<br />    a += b;<br />    return a;<br />}
</code></pre>
</p>
<p>Did you notice that one parameter is passed by value, and one by reference? That&#8217;s because if you&#8217;re going to copy from a parameter anyway, it&#8217;s often better to pass it by value, which will naturally enable a move operation if the caller passes a temporary object such as in expressions like <span style="color:#2e74b5;">(val1 * val2) + val3</span>. This is a good habit to follow even in cases like <span style="color:#2e74b5;">complex</span> where a move is the same cost as a copy, since it doesn&#8217;t cost any efficiency when move and copy are the same, and arguably makes for cleaner code than passing by reference and adding an extra named local object. We&#8217;ll see more on parameter passing in a future GotW.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer passing a read-only parameter by value if you&#8217;re going to make a copy of the parameter anyway, because it enables move from rvalue arguments.
</p>
</blockquote>
<p>Implementing <span style="color:#2e74b5;">+</span> in terms of <span style="color:#2e74b5;">+=</span> both makes the code simpler and guarantees consistent semantics as the two functions are less likely to diverge during maintenance.
</p>
<h3>5. operator+ should not be a member function.<br />
</h3>
<p>If <span style="color:#2e74b5;">operator+</span> is made a member function, as it is here, then it won&#8217;t work as naturally as your users may expect when you do decide to allow implicit conversions from other types. Here, an implicit conversion from <span style="color:#2e74b5;">double</span> to <span style="color:#2e74b5;">complex</span> makes sense, but with the original class users have an asymmetry: Specifically, when adding <span style="color:#2e74b5;">complex</span> objects to numeric values, you can write <span style="color:#2e74b5;">a = b + 1.0</span> but not <span style="color:#2e74b5;">a = 1.0 + b</span> because a member <span style="color:#2e74b5;">operator+</span> requires a <span style="color:#2e74b5;">complex</span> (and not a <span style="color:#2e74b5;">double</span>) as its left-hand argument.
</p>
<p>Finally, the other reason to prefer non-members is because they provide better encapsulation, as <a href="http://www.drdobbs.com/cpp/how-non-member-functions-improve-encapsu/184401197">pointed out by Scott Meyers</a>.
</p>
<blockquote>
<p><strong>Guideline: </strong>Prefer these guidelines for making an operator a member vs. nonmember function: unary operators are members; <strong>= () []</strong> and <strong>-&gt;</strong> must be members; the assignment operators (<strong>+= –= /= *=</strong> etc.) must be members; all other binary operators are nonmembers.
</p>
</blockquote>
<h3>6. operator&lt;&lt; should not be a member function.<br />
</h3>
<p>The author of this code didn&#8217;t really mean to enable the syntax <span style="color:#2e74b5;">my_complex &lt;&lt; cout</span>, did they?
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    void operator&lt;&lt;( ostream os ) {<br />        os &lt;&lt; "(" &lt;&lt; real &lt;&lt; "," &lt;&lt; imag &lt;&lt; ")";<br />    }
</code></pre>
</p>
<p>The same reasons already given to show why <span style="color:#2e74b5;">operator+</span> should be a nonmember apply also to <span style="color:#2e74b5;">operator&lt;&lt;</span>, only more so because a member the first parameter has to be a stream, not a <span style="color:#2e74b5;">complex</span>. Further, the parameters should be references: <span style="color:#2e74b5;">(ostream&amp;, const complex &amp;)</span>.
</p>
<p>Note also that the nonmember <span style="color:#2e74b5;">operator&lt;&lt;</span> should normally be implemented in terms of a(n often virtual) <span style="color:#2e74b5;">const</span> member function that does the work, usually named something like <span style="color:#2e74b5;">print</span>.
</p>
<h3>7. operator&lt;&lt; should return ostream&amp;.<br />
</h3>
<p>Further, <span style="color:#2e74b5;">operator&lt;&lt;</span> should have a return type of <span style="color:#2e74b5;">ostream&amp;</span> and should return a reference to the stream in order to permit chaining. That way, users can use your <span style="color:#2e74b5;">operator&lt;&lt;</span> naturally in code like <span style="color:#2e74b5;">cout &lt;&lt; a &lt;&lt; b;</span>.
</p>
<blockquote>
<p><strong>Guideline: </strong>Always return stream references from <strong>operator&lt;&lt;</strong> and <strong>operator&gt;&gt;</strong>.
</p>
</blockquote>
<h3>8. The preincrement operator&#8217;s return type is incorrect.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    complex operator++() {<br />        ++real;<br />        return *this;<br />    }
</code></pre>
</p>
<p>Ignoring for the sake of argument whether preincrement is meaningful for <span style="color:#2e74b5;">complex</span> numbers, if the function exists it should return a reference. This lets client code operate more intuitively and avoids needless inefficiency.
</p>
<blockquote>
<p><strong>Guideline: </strong>When you <strong>return *this</strong>, the return type should usually be a reference.
</p>
</blockquote>
<h3>9. Postincrement should be implemented in terms of preincrement.<br />
</h3>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>    complex operator++( int ) {<br />        auto temp = *this;<br />        ++real;<br />        return temp;<br />    }
</code></pre>
</p>
<p>Instead of repeating the work, prefer to call <span style="color:#2e74b5;">++*this</span>. See GotW #2 for the full canonical form for postincrement.
</p>
<blockquote>
<p><strong>Guideline: </strong>For consistency, always implement postincrement in terms of preincrement, otherwise your users will get surprising (and often unpleasant) results.
</p>
</blockquote>
<h3>Summary<br />
</h3>
<p>That&#8217;s it. There are other modern C++ features we could apply here, but they would be arguably gratuitous and not appropriate for general recommendations. For example, this is a value type not designed to be inherited from, so we could prevent inheritance by making the class <span style="color:#2e74b5;">final</span>, but that would be protecting against Machiavelli, not Murphy, and there&#8217;s no need for a general guideline that tells everyone they should now write <span style="color:#2e74b5;">final</span> on every value type; that would just be tedious and unnecessary.
</p>
<p>Here&#8217;s a corrected version of the class, ignoring design and style issues not explicitly noted above:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>class complex {<br />public:<br />    complex( double r = 0, double i = 0 )<br />        : real{r}, imag{i}<br />    { }<br /><br />    complex&amp; operator+=( const complex&amp; other ) {<br />        real += other.real;<br />        imag += other.imag;<br />        return *this;<br />    }<br /><br />    complex&amp; operator++() {<br />        ++real;<br />        return *this;<br />    }<br /><br />    complex operator++( int ) {<br />        auto temp = *this;<br />        ++*this;<br />        return temp;<br />    }<br /><br />    ostream&amp; print( ostream&amp; os ) const {<br />        return os &lt;&lt; "(" &lt;&lt; real &lt;&lt; "," &lt;&lt; imag &lt;&lt; ")";<br />    }<br /><br />private:<br />    double real, imag;<br />};<br /><br />complex operator+( complex lhs, const complex&amp; rhs ) {<br />    lhs += rhs;<br />    return lhs;<br />}<br /><br />ostream&amp; operator&lt;&lt;( ostream&amp; os, const complex&amp; c ) {<br />    return c.print(os);<br />}
</code></pre>
</p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: Mikhail Belyaev, jlehrer, Olaf van der Spek, Marshall, litb1, hm, Dave Harris, nosenseetal.</p>
					<p><a href="https://herbsutter.com/2013/05/20/gotw-4-class-mechanics/" rel="bookmark" title="Permanent Link to GotW #4 Solution: Class&nbsp;Mechanics">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
		<p align="center"><a href="https://herbsutter.com/category/c/gotw/page/3/" >&laquo; Newer Posts</a> - <a href="https://herbsutter.com/category/c/gotw/page/5/" >Older Posts &raquo;</a></p>

	</div><!-- end id:content-main -->
<div id="sidebar">
<ul>
<li class="sidebox"><h2><label for="subscribe-field">Follow by email</label></h2>
				<form action="https://subscribe.wordpress.com" method="post" accept-charset="utf-8" id="subscribe-blog">
																	<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" placeholder="Enter your email address" value="" id="subscribe-field"/></p>
					
					<p>
						<input type="hidden" name="action" value="subscribe"/>
						<input type="hidden" name="blog_id" value="3379246"/>
						<input type="hidden" name="source" value="https://herbsutter.com/category/c/gotw/page/4/"/>
						<input type="hidden" name="sub-type" value="widget"/>
						<input type="hidden" name="redirect_fragment" value="blog_subscription-3" />
						<input type="hidden" id="_wpnonce" name="_wpnonce" value="4590924cc6" />						<input type="submit" value="Subscribe" />
					</p>
				</form>
			
</li><li class="sidebox"><h2><a href='http://twitter.com/herbsutter'>Tweets</a></h2><ul class='tweets'></ul><a href="http://twitter.com/herbsutter"  class='twitter-follow-button' data-show-count='false' data-link-color='#265e15' data-text-color='#333333'>Follow @herbsutter</a></li><li class="sidebox"><h2>Popular</h2><ul>				<li>
										<a href="https://herbsutter.com/2018/11/13/trip-report-fall-iso-c-standards-meeting-san-diego/" class="bump-view" data-bump-view="tp">
						Trip report: Fall ISO C++ standards meeting (San Diego)					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/gotw/" class="bump-view" data-bump-view="tp">
						GotW					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/2018/09/20/lifetime-profile-v1-0-posted/" class="bump-view" data-bump-view="tp">
						Lifetime profile v1.0 posted					</a>
										</li>
				</ul></li><li class="sidebox"><h2>Categories</h2>		<ul>
				<li class="cat-item cat-item-291"><a href="https://herbsutter.com/category/apple/" >Apple</a>
</li>
	<li class="cat-item cat-item-49277"><a href="https://herbsutter.com/category/c-net/" >C# / .NET</a>
</li>
	<li class="cat-item cat-item-2426 current-cat-parent current-cat-ancestor"><a href="https://herbsutter.com/category/c/" >C++</a>
</li>
	<li class="cat-item cat-item-69816"><a href="https://herbsutter.com/category/cloud/" >Cloud</a>
</li>
	<li class="cat-item cat-item-214618"><a href="https://herbsutter.com/category/concurrency/" >Concurrency</a>
</li>
	<li class="cat-item cat-item-8259773"><a href="https://herbsutter.com/category/effective-concurrency/" >Effective Concurrency</a>
</li>
	<li class="cat-item cat-item-3696745"><a href="https://herbsutter.com/category/friday-thoughts/" >Friday Thoughts</a>
</li>
	<li class="cat-item cat-item-3867746 current-cat"><a href="https://herbsutter.com/category/c/gotw/" >GotW</a>
</li>
	<li class="cat-item cat-item-79"><a href="https://herbsutter.com/category/hardware/" >Hardware</a>
</li>
	<li class="cat-item cat-item-1017"><a href="https://herbsutter.com/category/java/" >Java</a>
</li>
	<li class="cat-item cat-item-637"><a href="https://herbsutter.com/category/microsoft/" >Microsoft</a>
</li>
	<li class="cat-item cat-item-420845"><a href="https://herbsutter.com/category/opinion-editorial/" >Opinion &amp; Editorial</a>
</li>
	<li class="cat-item cat-item-1633077"><a href="https://herbsutter.com/category/reader-qa/" >Reader Q&amp;A</a>
</li>
	<li class="cat-item cat-item-2301"><a href="https://herbsutter.com/category/software-development/" >Software Development</a>
</li>
	<li class="cat-item cat-item-393523"><a href="https://herbsutter.com/category/talks-events/" >Talks &amp; Events</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://herbsutter.com/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-151"><a href="https://herbsutter.com/category/web/" >Web</a>
</li>
		</ul>
			</li></ul>
</div><!-- end id:sidebar -->
</div><!-- end id:content -->
</div><!-- end id:container -->
<div id="footer">
	<div id="colophon">
		<p><a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></p>
		<p>WPThemes.</p>
		<br class="clear" />
	</div><!-- end #colophon-->
</div><!-- end #footer-->
		<script type="text/javascript">
		//<![CDATA[
		var infiniteScroll = {"settings":{"id":"content-main","ajaxurl":"https:\/\/herbsutter.com\/?infinity=scrolling","type":"scroll","wrapper":true,"wrapper_class":"infinite-wrap","footer":true,"click_handle":"1","text":"Older posts","totop":"Scroll back to top","currentday":"20.05.13","order":"DESC","scripts":[],"styles":[],"google_analytics":false,"offset":4,"history":{"host":"herbsutter.com","path":"\/category\/c\/gotw\/page\/%d\/","use_trailing_slashes":true,"parameters":""},"query_args":{"paged":4,"category_name":"gotw","error":"","m":"","p":0,"post_parent":"","subpost":"","subpost_id":"","attachment":"","attachment_id":0,"name":"","pagename":"","page_id":0,"second":"","minute":"","hour":"","day":0,"monthnum":0,"year":0,"w":0,"tag":"","cat":3867746,"tag_id":"","author":"","author_name":"","feed":"","tb":"","meta_key":"","meta_value":"","preview":"","s":"","sentence":"","title":"","fields":"","menu_order":"","embed":"","category__in":[],"category__not_in":[],"category__and":[],"post__in":[],"post__not_in":[],"post_name__in":[],"tag__in":[],"tag__not_in":[],"tag__and":[],"tag_slug__in":[],"tag_slug__and":[],"post_parent__in":[],"post_parent__not_in":[],"author__in":[],"author__not_in":[],"posts_per_page":7,"ignore_sticky_posts":false,"suppress_filters":false,"cache_results":false,"update_post_term_cache":true,"lazy_load_term_meta":true,"update_post_meta_cache":true,"post_type":"","nopaging":false,"comments_per_page":"50","no_found_rows":false,"order":"DESC"},"last_post_date":"2013-05-20 10:22:22","stats":"blog=3379246&v=wpcom&tz=-8&user_id=0&subd=herbsutter&x_pagetype=infinite"}};
		//]]>
		</script>
		<!--  -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201847y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	</div>
		<div id="infinite-footer">
			<div class="container">
				<div class="blog-info">
					<a id="infinity-blog-title" href="https://herbsutter.com/" rel="home">
						Sutter’s Mill					</a>
				</div>
				<div class="blog-credits">
					<a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a> 				</div>
			</div>
		</div><!-- #infinite-footer -->
		
	<div id="carousel-reblog-box">
		<form action="#" name="carousel-reblog">
			<textarea id="carousel-reblog-content" name="carousel-reblog-content" placeholder="Add your thoughts here... (optional)"></textarea>
			<label for="carousel-reblog-to-blog-id" id="carousel-reblog-lblogid">Post to</label>
			<select name="carousel-reblog-to-blog-id" id="carousel-reblog-to-blog-id">
						</select>

			<div class="submit">
				<span class="canceltext"><a href="#" class="cancel">Cancel</a></span>
				<input type="submit" name="carousel-reblog-submit" class="button" id="carousel-reblog-submit" value="Reblog Post" />
				<input type="hidden" id="carousel-reblog-blog-id" value="3379246" />
				<input type="hidden" id="carousel-reblog-blog-url" value="https://herbsutter.com" />
				<input type="hidden" id="carousel-reblog-blog-title" value="Sutter’s Mill" />
				<input type="hidden" id="carousel-reblog-post-url" value="" />
				<input type="hidden" id="carousel-reblog-post-title" value="" />
			</div>

			<input type="hidden" id="_wpnonce" name="_wpnonce" value="c0f0a72e87" /><input type="hidden" name="_wp_http_referer" value="/category/c/gotw/page/4/" />		</form>

		<div class="arrow"></div>
	</div>
<link rel='stylesheet' id='all-css-0-2' href='https://s0.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel.css?m=1524699534h&cssminify=yes' type='text/css' media='all' />
<!--[if lte IE 8]>
<link rel='stylesheet' id='jetpack-carousel-ie8fix-css'  href='https://s1.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel-ie8fix.css?m=1412618825h&#038;ver=20121024' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='all-css-2-2' href='https://s2.wp.com/wp-content/mu-plugins/tiled-gallery/tiled-gallery.css?m=1443731146h&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"3379246","siteName":"Sutter\u2019s Mill","siteURL":"https:\/\/herbsutter.com","icon":"<img alt='' src='https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=50&d=https%3A%2F%2Fs2.wp.com%2Fi%2Flogo%2Fwpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/mistylook","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F28%2Fgotw-6b-solution-const-correctness-part-2%2F","themeURL":"","xhrURL":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"8fb9818ae2","isSingular":"","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"4590924cc6\" \/>","referer":"https:\/\/herbsutter.com\/category\/c\/gotw\/page\/4\/","canFollow":"1","feedID":"171936","statusMessage":"","customizeLink":"https:\/\/herbsutter.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fherbsutter.wordpress.com%2Fcategory%2Fc%2Fgotw%2Fpage%2F4%2F","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: MistyLook","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 19,532 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F28%2Fgotw-6b-solution-const-correctness-part-2%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"665015e67f","display_exif":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F20%2Fgotw-4-class-mechanics%2F","blog_id":"3379246","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>","reblog":"Reblog","reblogged":"Reblogged","reblog_add_thoughts":"Add your thoughts here... (optional)","reblogging":"Reblogging...","post_reblog":"Post Reblog","stats_query_args":"blog=3379246&v=wpcom&tz=-8&user_id=0&subd=herbsutter","is_public":"1","reblog_enabled":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVUNEOwiAM/CGxGqM+Gb8FWXVFVpCWqX8vmmwxGpf4QHJc77ijcE3GRVZkBS/QYE8O023uZQZvo66YFMqJWCDQGQUuBQu2lpuAeUJMfCQmvY/gUzsI5c5qby2d2lCPYv5mJmJs0xGbg83QWanSikzsMWdqateR+/MFzdadZcrklCI/TSMa1MQulGd4Xapcj/Hg0emvz/e1ZgQrgvoyvO4po0yFO5tjEQzgUVMtagaievbdbrlebZbb7WK98A97a7cy'></script>
<script type='text/javascript' src='https://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVy0sOQEAMANALqcYvYSHOgmkmpWoyirg9WyuxfIuHZ4BxVSM1XHYIsnvWDe1kM4owSD/OA0cHgQmVDoqkjtWn05bgnxu+Hws58L0IxeutZ3VLm1V5WRVlU+fTDQ0qQ9Y='></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script type="text/javascript">
			jQuery.extend( infiniteScroll.settings.scripts, ["jquery-core","jquery-migrate","jquery","mobile-useragent-info","postmessage","jquery_inview","jetpack_resize","spin","jquery.spin","grofiles-cards","wpgroho","devicepx","jetpack_likes_queuehandler","the-neverending-homepage","syntaxhighlighter","wpcom-masterbar-js","wpcom-masterbar-tracks-js","wpcom-actionbar-bar","swfobject","videopress","jetpack-carousel","twitter-widgets","twitter-widgets-infinity","twitter-widgets-pending","tiled-gallery"] );
			jQuery.extend( infiniteScroll.settings.styles, ["jetpack_likes","the-neverending-homepage","infinity-mistylook","wpcom-core-compat-playlist-styles","mp6hacks","wpcom-bbpress2-staff-css","wp-block-library","mistylook","jetpack-top-posts-widget","jetpack-widget-social-icons-styles","noticons","geo-location-flair","reblogging","a8c-global-print","wpcom-actionbar-bar","h4-global","jetpack-carousel","tiled-gallery","jetpack-carousel-ie8fix"] );
		</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'3379246','blog_tz':'-8','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'3379246','v':'wpcom','tz':'-8','user_id':'0','subd':'herbsutter'}]);
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29+Smw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8/MkNtblkvY1d1TjBELytHc0k/MXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sJjZwfjVPOXd0MXRdUmJDYn54WlVLT0RuOVBZZTZsU2JSPV16TGlJPUgvOWFaOEd1cFpzaUZ0WFVQSC01dXYld214Nk0uZmpTZzlQVEJoMTB8UUMtMTF4VTdzREomSldfbUxUZE5+cUFuYS5jeXlNVTNOUVZyXUMzaGdxaSticFQlU19adWUzfDBDbXNUNGJlMWt+VXlRUEdwQX5xUDR2YzUmUkFyJmpVN1hPdVZfYyxvL3w='}]);
_stq.push([ 'clickTrackerInit', '3379246', '0' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>