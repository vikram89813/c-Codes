<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>GotW | Sutter’s Mill | Page 3</title>
<link rel="pingback" href="https://herbsutter.com/xmlrpc.php" />
<script type="text/javascript">
  WebFontConfig = {"typekit":{"id":"eyo0tqd"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = 'https://s0.wp.com/wp-content/plugins/custom-fonts/js/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style id="jetpack-custom-fonts-css">.wf-active #header h1{font-size:2.12em;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active body{font-size:89.7%;font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation{font-family:"ff-basic-gothic-web-pro-1","ff-basic-gothic-web-pro-2",sans-serif}.wf-active #navigation ul li.search{font-size:1.06em}.wf-active #navigation ul li.search input#searchsubmit{font-size:1.06em}.wf-active #content .post-info, .wf-active #content .postmetadata{font-size:1.06em}.wf-active #sidebar{font-size:1.06em}.wf-active #footer p.right{font-size:1.06em}.wf-active .commentnum{font-size:1.77em}.wf-active .commentlist li .cmtinfo{font-size:1.18em}.wf-active .commentlist li .cmtinfo em{font-size:1.06em}.wf-active #respond label{font-size:11.8px}.wf-active #respond .required{font-size:11.8px}.wf-active #respond .subscribe-label{font-size:14.2px}.wf-active #respond .comment-notes{font-size:13px}.wf-active .wp-caption p.wp-caption-text{font-size:13px}.wf-active #content h1, .wf-active h2, .wf-active h3, .wf-active h4, .wf-active h5, .wf-active h6{font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal;font-weight:400}.wf-active #header h2{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active #content h3{font-size:1.65em;font-weight:400;font-style:normal}.wf-active #content h4{font-size:1.3em;font-style:normal;font-weight:400}.wf-active #content h5{font-size:1.18em;font-style:normal;font-weight:400}.wf-active #content .post h2{font-size:1.65em;font-weight:400;font-style:normal}.wf-active li.sidebox h2{font-weight:400;font-size:1.89em;font-style:normal}.wf-active .post h4{font-size:1.18em;font-weight:400;font-family:"ff-dagny-web-pro-1","ff-dagny-web-pro-2",sans-serif;font-style:normal}.wf-active .post h4 em{font-style:normal;font-weight:400}</style>
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=herbsutter.com&amp;id=3379246&amp;t=1542965829&amp;back=https%3A%2F%2Fherbsutter.com%2Fcategory%2Fc%2Fgotw%2Fpage%2F3%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//herbsutter.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Feed" href="https://herbsutter.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; Comments Feed" href="https://herbsutter.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Sutter’s Mill &raquo; GotW Category Feed" href="https://herbsutter.com/category/c/gotw/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s1.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1532082729h&ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s0.wp.com/_static/??-eJyNkN1uwjAMhV9onrUN1qtpz5K0JpjmT4kj1LfHpeoEglXcROck53Ns4zlDn6JQFAwNsm+OY0XPI1U8kWTTj3B1732tb/g8zvHAkWX6Ey+F5UhBf8nNYuAqk09p3AL7VEjvQzYyJwINbMhrjShbWMjfKzXLo060Ocw5axqszYVqBT0DtwBLsw/cCrmm1lJxMHeJtrEf0Pp03Z4tpkw4T0gPBZ4t4Z/obY88OJKKkjLkVFW9jNTUs/HAGrk3C8wYkyyPq9iq6iiBTmmEU7wzcPCGyxZaSPfjVDrU1I2dod/w87HffXZf3W7fnS4bTgAo?cssminify=yes' type='text/css' media='all' />
<link rel='stylesheet' id='print-css-1-1' href='https://s2.wp.com/wp-content/mu-plugins/global-print/global-print.css?m=1465851035h&cssminify=yes' type='text/css' media='print' />
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??/wp-content/mu-plugins/actionbar/actionbar.css,/wp-content/themes/h4/global.css?m=1516985148j&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s2.wp.com/_static/??-eJyF0G0KwjAMBuAL2dXJxP0Rz1Lr60hdP2zaDT29FSYiVIVAIHkISeQcBDk95hNYmhLXjHhbUmN4JX8BYWmIKqGx5F5Ye5fg0tNaf6QRIjOiGkqtDDr7iguekwVzQZXu50rkJsL8lxmkoPRFRDDdUTuEw3vn7x9Y1MHu267fbfp2263NA675cvs='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://herbsutter.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress.com" />
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=114" />
<link rel='openid.server' href='https://herbsutter.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://herbsutter.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://herbsutter.com/osd.xml" title="Sutter’s Mill" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<script type="text/javascript" id="webfont-output">
  
  WebFontConfig = {"typekit":{"id":"cjs1oxc"}};
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
	})();
</script><style type="text/css">
.widget_twitter li {
	word-wrap: break-word;
}
</style>
<meta name="application-name" content="Sutter’s Mill" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Herb Sutter on software development" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://herbsutter.com/feed/;icon-uri=https://secure.gravatar.com/blavatar/4554b8d24c7f200dc5e2e1b18db1893f?s=16" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s1.wp.com/i/favicon.ico" /><meta name="description" content="Posts about GotW written by Herb Sutter" />
<style type="text/css">
			#header h1 a,
		#header h2 {
			color: #265E15 !important;
		}
				#headerimage {
			background: url('https://herbsutter.files.wordpress.com/2011/10/cropped-blog-header.jpg') no-repeat;
			height: 200px;
		}
	</style>
<style type="text/css" id="syntaxhighlighteranchor"></style>
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=eb5Y&#038;cscache=6&#038;csrev=60" />
		</head>
<body id="section-index" class="archive paged category category-gotw category-3867746 paged-3 category-paged-3 mp6 customizer-styles-applied highlander-enabled highlander-light infinite-scroll neverending">


<div id="navigation" class="clearfix">
		<div class="menu">
		<ul>
			<li ><a href="https://herbsutter.com/" title="Home">Home</a></li>
			<li class="page_item page-item-912"><a href="https://herbsutter.com/welcome-to-the-jungle/">Welcome to the&nbsp;Jungle</a></li>
<li class="page_item page-item-864 page_item_has_children"><a href="https://herbsutter.com/gotw/">GotW</a></li>
<li class="page_item page-item-761"><a href="https://herbsutter.com/elements-of-modern-c-style/">Elements of Modern C++&nbsp;Style</a></li>
<li class="page_item page-item-2 page_item_has_children"><a href="https://herbsutter.com/about/">About</a></li>
									<li class="search"><form method="get" id="searchform" action="https://herbsutter.com"><input type="text" class="textbox" value="" name="s" id="s" /><input type="submit" id="searchsubmit" value="Search" /></form></li>
					</ul>
	</div>
</div><!-- end id:navigation -->

<div id="container">

<div id="header">
<h1><a href="https://herbsutter.com/" title="Sutter’s Mill">Sutter’s Mill</a></h1>
<h2>Herb Sutter on software development</h2>
</div><!-- end id:header -->


	
		<div id="feedarea">
	<dl>
		<dt><strong>Feeds:</strong></dt>

			<dd><a href="https://herbsutter.com/feed/">Posts</a></dd>
	
			<dd><a href="https://herbsutter.com/comments/feed/">Comments</a></dd>
		</dl>
	</div><!-- end id:feedarea -->
	
	<div id="headerimage">
</div><!-- end id:headerimage -->

<div id="content">
<div id="content-main">
	              <h2 class="pagetitle">Archive for the &#8216;GotW&#8217; Category</h2>
      		
			<div class="post-2100 post type-post status-publish format-standard hentry category-gotw" id="post-2100">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/06/05/gotw-92-auto-variables-part-1/" rel="bookmark">GotW #92: Auto Variables, Part&nbsp;1</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-06-05|
													<a href="https://herbsutter.com/2013/06/05/gotw-92-auto-variables-part-1/#comments">22 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<p><span style="color:#5a5a5a;"><em>What does auto do on variable declarations, exactly? And how should we think about auto? In this GotW, we&#8217;ll start taking a look at C++&#8217;s oldest new feature.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Questions<br />
</h2>
<p>1. What is the oldest C++11 feature? Explain.
</p>
<p>2. What does <span style="color:#2e74b5;">auto</span> mean when declaring a local variable?
</p>
<h2>Guru Questions<br />
</h2>
<p>3. In the following code, what is the type of variables <span style="color:#2e74b5;">a</span> through <span style="color:#2e74b5;">k</span>, and why? Explain.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>int         val = 0;<br />auto        a   = val;<br />auto&amp;       b   = val;<br />const auto  c   = val;<br />const auto&amp; d   = val;<br /><br />int&amp;        ir  = val;<br />auto        e   = ir;<br /><br />int*        ip  = &amp;val; <br />auto        f   = ip;<br /><br />const int   ci  = val;<br />auto        g   = ci;<br /><br />const int&amp;  cir = val;<br />auto        h   = cir;<br /><br />const int*  cip = &amp;val;<br />auto        i   = cip;<br /><br />int* const  ipc = &amp;val;<br />auto        j   = ipc;<br /><br />const int* const cipc = &amp;val;<br />auto             k    = cipc;
</code></pre>
</p>
<p>4. In the following code, what type does <span style="color:#2e74b5;">auto</span> deduce for variables <span style="color:#2e74b5;">a</span> and <span style="color:#2e74b5;">b</span>, and why? Explain.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>int val = 0;<br /><br />auto a { val };<br />auto b = { val };
</code></pre></p>
					<p><a href="https://herbsutter.com/2013/06/05/gotw-92-auto-variables-part-1/" rel="bookmark" title="Permanent Link to GotW #92: Auto Variables, Part&nbsp;1">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2090 post type-post status-publish format-standard hentry category-gotw" id="post-2090">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/06/05/gotw-91-solution-smart-pointer-parameters/" rel="bookmark">GotW #91 Solution: Smart Pointer&nbsp;Parameters</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-06-05|
													<a href="https://herbsutter.com/2013/06/05/gotw-91-solution-smart-pointer-parameters/#comments">57 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<blockquote><p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #105.</p></blockquote>
<p><span style="color:#5a5a5a;"><em>How should you prefer to pass smart pointers, and why?<br />
</em></span></p>
<h1>Problem</h1>
<h2>JG Question</h2>
<p>1. What are the <em>performance</em> implications of the following function declaration? Explain.</p>
<pre><code>void f( shared_ptr&lt;widget&gt; );
</code></pre>
<h2>Guru Questions</h2>
<p>2. What are the <em>correctness</em> implications of the function declaration in #1? Explain with clear examples.</p>
<p>3. A colleague is writing a function <span style="color:#2e74b5;">f</span> that takes an existing object of type <span style="color:#2e74b5;">widget</span> as a required input-only parameter, and trying to decide among the following basic ways to take the parameter (omitting <span style="color:#2e74b5;">const</span>):</p>
<pre><code>void f( widget* );              (a)
void f( widget&amp; );              (b)
void f( unique_ptr&lt;widget&gt; );   (c)
void f( unique_ptr&lt;widget&gt;&amp; );  (d)
void f( shared_ptr&lt;widget&gt; );   (e)
void f( shared_ptr&lt;widget&gt;&amp; );  (f)
</code></pre>
<p>Under what circumstances is each appropriate? Explain your answer, including where <span style="color:#2e74b5;">const</span> should or should not be added anywhere in the parameter type.</p>
<p>(There are other ways to pass the parameter, but we will consider only the ones shown above.)</p>
<h1>Solution</h1>
<h2>1. What are the <em>performance</em> implications of the following function declaration? Explain.</h2>
<pre><code>void f( shared_ptr&lt;widget&gt; );
</code></pre>
<p>A <span style="color:#2e74b5;">shared_ptr</span> stores strong and weak reference counts (see GotW #89). When you pass by value, you have to copy the argument (usually) on entry to the function, and then destroy it (always) on function exit. Let&#8217;s dig into what this means.</p>
<p>When you enter the function, the <span style="color:#2e74b5;">shared_ptr</span> is copy-constructed, and this requires incrementing the strong reference count. (Yes, if the caller passes a temporary <span style="color:#2e74b5;">shared_ptr</span>, you <em>move</em>-construct and so don&#8217;t have to update the count. But: (a) it&#8217;s quite rare to get a temporary <span style="color:#2e74b5;">shared_ptr</span> in normal code, other than taking one function&#8217;s return value and immediately passing that to a second function; and (b) besides as we&#8217;ll see most of the expense is on the destruction of the parameter anyway.)</p>
<p>When exiting the function, the <span style="color:#2e74b5;">shared_ptr</span> is destroyed, and this requires decrementing its internal reference count.</p>
<p>What&#8217;s so bad about a &#8220;shared reference count increment and decrement?&#8221; Two things, one related to the &#8220;shared reference count&#8221; and one related to the &#8220;increment and decrement.&#8221; It&#8217;s good to be aware of how this can incur performance costs for two reasons: one major and common, and one less likely in well-designed code and so probably more minor.</p>
<p>First, the major reason is the performance cost of the &#8220;increment and decrement&#8221;: Because the reference count is an <span style="color:#2e74b5;">atomic</span> shared variable (or equivalent), incrementing and decrementing it are internally-synchronized read-modify-write shared memory operations.</p>
<p>Second, the less-likely minor reason is the potentially scalability-bustingly contentious nature of the &#8220;shared reference count&#8221;: Both increment and decrement update the reference count, which means that at the processor and memory level only one core at a time can be executing such an instruction on the same reference count because it needs exclusive access to the count&#8217;s cache line. The net result is that this causes some contention on the count&#8217;s cache line, which can affect scalability if it&#8217;s a popular cache line being touched by multiple threads in tight loops—such as if two threads are calling functions like this one in tight loops and accessing <span style="color:#2e74b5;">shared_ptr</span>s that own the same object. &#8220;So don&#8217;t do that, thou heretic caller!&#8221; we might righteously say. Well and good, but the caller doesn&#8217;t always know when two <span style="color:#2e74b5;">shared_ptr</span>s used on two different threads refer to the same object, so let&#8217;s not be quick to pile the wood around his stake just yet.</p>
<p>As we will see, an essential best practice for any reference-counted smart pointer type is to <i>avoid copying it unless you really mean to add a new reference</i>. This cannot be stressed enough. This directly addresses both of these costs and pushes their performance impact down into the noise for most applications, and especially eliminates the second cost because it is an antipattern to add and remove references in tight loops.</p>
<p>At this point, we will be tempted to solve the problem by passing the <span style="color:#2e74b5;">shared_ptr</span> by reference. But is that really the right thing to do? It depends.</p>
<h2>2. What are the <em>correctness</em> implications of the function declaration in #1?</h2>
<p>The only correctness implication is that the function advertises in a clear type-enforced way that it will (or could) retain a copy of the <span style="color:#2e74b5;">shared_ptr</span>.</p>
<p>That this is the only correctness implication might surprise some people, because there would seem to be one other major correctness benefit to taking a copy of the argument, namely lifetime: Assuming the pointer is not already null, taking a copy of the <span style="color:#2e74b5;">shared_ptr</span> guarantees that the function itself holds a strong refcount on the owned object, and that therefore the object will remain alive for the duration of the function body, or until the function itself chooses to modify its parameter.</p>
<p>However, we already get this for free—thanks to structured lifetimes, the called function&#8217;s lifetime is a strict subset of the calling function&#8217;s call expression. Even if we passed the <span style="color:#2e74b5;">shared_ptr</span> by reference, our function would as good as hold a strong refcount because <em>the caller already has one</em>—he passed us the <span style="color:#2e74b5;">shared_ptr</span> in the first place, and won&#8217;t release it until we return. (Note this assumes the pointer is not aliased. You have to be careful if the smart pointer parameter could be aliased, but in this respect it&#8217;s no different than any other aliased object.)</p>
<blockquote><p><strong>Guideline:</strong> Don&#8217;t pass a smart pointer as a function parameter unless you want to use or manipulate the smart pointer itself, such as to share or transfer ownership.</p></blockquote>
<blockquote><p><strong>Guideline: </strong>Prefer passing objects by value, <strong>*</strong>, or <strong>&amp;</strong>, not by smart pointer.</p></blockquote>
<p>If you&#8217;re saying, &#8220;hey, aren&#8217;t raw pointers evil?&#8221;, that&#8217;s excellent, because we&#8217;ll address that next.</p>
<h2>3. A colleague is writing a function f that takes an existing object of type widget as a required input-only parameter, and trying to decide among the following basic ways to take the parameter (omitting const). Under what circumstances is each appropriate? Explain your answer, including where const should or should not be added anywhere in the parameter type.</h2>
<h3>(a) and (b): Prefer passing parameters by * or &amp;.</h3>
<pre><code>void f( widget* );              (a)
void f( widget&amp; );              (b)
</code></pre>
<p>These are the preferred way to pass normal object parameters, because they stay agnostic of whatever lifetime policy the caller happens to be using.</p>
<p>Non-owning raw <span style="color:#2e74b5;">*</span> pointers and <span style="color:#2e74b5;">&amp;</span> references are okay to observe an object whose lifetime we know exceeds that of the pointer or reference, which is usually true for function parameters. Thanks to structured lifetimes, by default arguments passed to <span style="color:#2e74b5;">f</span> in the caller outlive <span style="color:#2e74b5;">f</span>&#8216;s function call lifetime, which is extremely useful (not to mention efficient) and makes non-owning <span style="color:#2e74b5;">*</span> and <span style="color:#2e74b5;">&amp;</span> appropriate for parameters.</p>
<p>Pass by <span style="color:#2e74b5;">*</span> or <span style="color:#2e74b5;">&amp;</span> to accept a <span style="color:#2e74b5;">widget</span> independently of how the caller is managing its lifetime. Most of the time, we don&#8217;t want to commit to a lifetime policy in the parameter type, such as requiring the object be held by a specific smart pointer, because this is usually needlessly restrictive. As usual, use a <span style="color:#2e74b5;">*</span> if you need to express null (no <span style="color:#2e74b5;">widget</span>), otherwise prefer to use a <span style="color:#2e74b5;">&amp;</span>; and if the object is input-only, write <span style="color:#2e74b5;">const widget*</span> or <span style="color:#2e74b5;">const widget&amp;</span>.</p>
<h3>(c) Passing unique_ptr by value means &#8220;sink.&#8221;</h3>
<pre><code>void f( unique_ptr&lt;widget&gt; );   (c)
</code></pre>
<p>This is the preferred way to express a <span style="color:#2e74b5;">widget</span>-consuming function, also known as a &#8220;sink.&#8221;</p>
<p>Passing a <span style="color:#2e74b5;">unique_ptr</span> by value is only possible by moving the object and its unique ownership from the caller to the callee. Any function like (c) takes ownership of the object away from the caller, and either destroys it or moves it onward to somewhere else.</p>
<p>Note that, unlike some of the other options below, this use of a by-value <span style="color:#2e74b5;">unique_ptr</span> parameter actually doesn&#8217;t limit the kind of object that can be passed to those managed by a <span style="color:#2e74b5;">unique_ptr</span>. Why not? Because any pointer can be explicitly converted to a <span style="color:#2e74b5;">unique_ptr</span>. If we didn&#8217;t use a <span style="color:#2e74b5;">unique_ptr</span> here we would still have to express &#8220;sink&#8221; semantics, just in a more brittle way such as by accepting a raw <em>owning</em> pointer (anathema!) and documenting the semantics in comments. Using (c) is vastly superior because it documents the semantics in code, and requires the caller to explicitly move ownership.</p>
<p>Consider the major alternative:</p>
<pre><code>// Smelly 20th-century alternative
void bad_sink( widget* p );  // will destroy p; PLEASE READ THIS COMMENT

// Sweet self-documenting self-enforcing modern version (c)
void good_sink( unique_ptr&lt;widget&gt; p );
</code></pre>
<p>And how much better (c) is:</p>
<pre><code>// Older calling code that calls the new good_sink is safer, because
// it's clearer in the calling code that ownership transfer is going on
// (this older code has an owning * which we shouldn't do in new code)
//
widget* pw = ... ; 

bad_sink ( pw );             // compiles: remember not to use pw again!

good_sink( pw );             // error: good
good_sink( unique_ptr&lt;widget&gt;{pw} );  // need explicit conversion: good

// Modern calling code that calls good_sink is safer, and cleaner too
//
unique_ptr&lt;widget&gt; pw = ... ;

bad_sink ( pw.get() );       // compiles: icky! doesn't reset pw
bad_sink ( pw.release() );   // compiles: must remember to use this way

good_sink( pw );             // error: good!
good_sink( move(pw) );       // compiles: crystal clear what's going on
</code></pre>
<blockquote><p><strong>Guideline:</strong> Express a &#8220;sink&#8221; function using a by-value <strong>unique_ptr</strong> parameter.</p></blockquote>
<p>Because the callee will now own the object, usually there should be no <span style="color:#2e74b5;">const</span> on the parameter because the <span style="color:#2e74b5;">const</span> should be irrelevant.</p>
<h3>(d) Passing unique_ptr by reference is for in/out unique_ptr parameters.</h3>
<pre><code>void f( unique_ptr&lt;widget&gt;&amp; );  (d)
</code></pre>
<p>This should only be used to accept an in/out <span style="color:#2e74b5;">unique_ptr</span>, when the function is supposed to actually accept an existing <span style="color:#2e74b5;">unique_ptr</span> and potentially modify it to refer to a different object. It is a bad way to just accept a <span style="color:#2e74b5;">widget</span>, because it is restricted to a particular lifetime strategy in the caller.</p>
<blockquote><p><strong>Guideline:</strong> Use a non-const <strong>unique_ptr&amp;</strong> parameter only to modify the <strong>unique_ptr</strong>.</p></blockquote>
<p>Passing a <span style="color:#2e74b5;">const unique_ptr&lt;widget&gt;&amp;</span> is strange because it can accept only either null or a <span style="color:#2e74b5;">widget</span> whose lifetime happens to be managed in the calling code via a <span style="color:#2e74b5;">unique_ptr</span>, and the callee generally shouldn&#8217;t care about the caller&#8217;s lifetime management choice. Passing <span style="color:#2e74b5;">widget*</span> covers a strict superset of these cases and can accept &#8220;null or a <span style="color:#2e74b5;">widget</span>&#8221; regardless of the lifetime policy the caller happens to be using.</p>
<blockquote><p><strong>Guideline:</strong> Don&#8217;t use a <strong>const unique_ptr&amp;</strong> as a parameter; use <strong>widget*</strong> instead.</p></blockquote>
<p>I mention <span style="color:#2e74b5;">widget*</span> because that doesn&#8217;t change the (nullable) semantics; if you&#8217;re being tempted to pass <span style="color:#2e74b5;">const shared_ptr&lt;widget&gt;&amp;</span>, what you really meant was <span style="color:#2e74b5;">widget*</span> which expresses the same information. If you additionally know it can&#8217;t be null, though, of course use <span style="color:#2e74b5;">widget&amp;</span>.</p>
<h3>(e) Passing shared_ptr by value implies taking shared ownership.</h3>
<pre><code>void f( shared_ptr&lt;widget&gt; );   (e)
</code></pre>
<p>As we saw in #2, this is recommended only when the function wants to retain a copy of the <span style="color:#2e74b5;">shared_ptr</span> and share ownership. In that case, a copy is needed anyway so the copying cost is fine. If the local scope is not the final destination, just <span style="color:#2e74b5;">std::move</span> the <span style="color:#2e74b5;">shared_ptr</span> onward to wherever it needs to go.</p>
<blockquote><p><strong>Guideline:</strong> Express that a function will store and share ownership of a heap object using a by-value <strong>shared_ptr</strong> parameter.</p></blockquote>
<p>Otherwise, prefer passing a <span style="color:#2e74b5;">*</span> or <span style="color:#2e74b5;">&amp;</span> (possibly to <span style="color:#2e74b5;">const</span>) instead, since that doesn&#8217;t restrict the function to only objects that happen to be owned by <span style="color:#2e74b5;">shared_ptr</span>s.</p>
<h3>(f) Passing shared_ptr&amp; is useful for in/out shared_ptr manipulation.</h3>
<pre><code>void f( shared_ptr&lt;widget&gt;&amp; );  (f)
</code></pre>
<p>Similarly to (d), this should mainly be used to accept an in/out <span style="color:#2e74b5;">shared_ptr</span>, when the function is supposed to actually modify the <span style="color:#2e74b5;">shared_ptr</span> itself. It&#8217;s usually a bad way to accept a <span style="color:#2e74b5;">widget</span>, because it is restricted to a particular lifetime strategy in the caller.</p>
<p>Note that per (e) we pass a <span style="color:#2e74b5;">shared_ptr</span> by value if the function will share ownership. In the special case where the function <em>might</em> share ownership, but doesn&#8217;t necessarily take a copy of its parameter on a given call, then pass a <span style="color:#2e74b5;">const shared_ptr&amp;</span> to avoid the copy on the calls that don&#8217;t need it, and take a copy of the parameter if and when needed.</p>
<blockquote><p><strong>Guideline:</strong> Use a non-const <strong>shared_ptr&amp;</strong> parameter only to modify the <strong>shared_ptr</strong>. Use a <strong>const shared_ptr&amp;</strong> as a parameter only if you&#8217;re not sure whether or not you&#8217;ll take a copy and share ownership; otherwise use <strong>widget*</strong> instead (or if not nullable, a <strong>widget&amp;</strong>).</p></blockquote>
<h2>Acknowledgments</h2>
<p>Thanks in particular to the following for their feedback to improve this article: mttpd, zahirtezcan, Jon, GregM, Andrei Alexandrescu.</p>
					<p><a href="https://herbsutter.com/2013/06/05/gotw-91-solution-smart-pointer-parameters/" rel="bookmark" title="Permanent Link to GotW #91 Solution: Smart Pointer&nbsp;Parameters">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2070 post type-post status-publish format-standard hentry category-gotw" id="post-2070">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/30/gotw-91-smart-pointer-parameters/" rel="bookmark">GotW #91: Smart Pointer&nbsp;Parameters</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-30|
													<a href="https://herbsutter.com/2013/05/30/gotw-91-smart-pointer-parameters/#comments">14 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #105.
</p>
</blockquote>
<p>
 </p>
<p><span style="color:#5a5a5a;"><em>How should you prefer to pass smart pointers, and why?<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. What are the <em>performance</em> implications of the following function declaration? Explain.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void f( shared_ptr&lt;widget&gt; );
</code></pre>
</p>
<h2>Guru Questions<br />
</h2>
<p>2. What are the <em>correctness</em> implications of the function declaration in #1? Explain with clear examples.
</p>
<p>3. A colleague is writing a function <span style="color:#2e74b5;">f</span> that takes an existing object of type <span style="color:#2e74b5;">widget</span> as a required input-only parameter, and trying to decide among the following basic ways to take the parameter (omitting <span style="color:#2e74b5;">const</span>):
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void f( widget* );              (a)<br />void f( widget&amp; );              (b)<br />void f( unique_ptr&lt;widget&gt; );   (c)<br />void f( unique_ptr&lt;widget&gt;&amp; );  (d)<br />void f( shared_ptr&lt;widget&gt; );   (e)<br />void f( shared_ptr&lt;widget&gt;&amp; );  (f)
</code></pre>
</p>
<p>Under what circumstances is each appropriate? Explain your answer, including where <span style="color:#2e74b5;">const</span> should or should not be added anywhere in the parameter type.
</p>
<p>(There are other ways to pass the parameter, but we will consider only the ones shown above.)</p>
					<p><a href="https://herbsutter.com/2013/05/30/gotw-91-smart-pointer-parameters/" rel="bookmark" title="Permanent Link to GotW #91: Smart Pointer&nbsp;Parameters">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2068 post type-post status-publish format-standard hentry category-gotw" id="post-2068">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/" rel="bookmark">GotW #90 Solution:&nbsp;Factories</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-30|
													<a href="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/#comments">29 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #104.
</p>
</blockquote>
<p>
 </p>
<p><span style="color:#5a5a5a;"><em>What should factory functions return, and why?<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<p>While spelunking through the code of a new project you recently joined, you find the following factory function declaration:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>widget* load_widget( widget::id desired );
</code></pre>
</p>
<h2>JG Question<br />
</h2>
<p>1. What&#8217;s wrong with this return type?
</p>
<h2>Guru Questions<br />
</h2>
<p>2. Assuming that <span style="color:#2e74b5;">widget</span> is a polymorphic type, what is the recommended return type? Explain your answer, including any tradeoffs.
</p>
<p>3. You&#8217;d like to actually change the return type to match the recommendation in #2, but at first you worry about breaking source compatibility with existing calling code; recompiling existing callers is fine, but having to go change them all is not. Then you have an &#8220;aha!&#8221; moment, realizing that this is a fairly new project and all of your calling code is written using modern C++ idioms, and you go ahead and change the return type without fear, knowing it will require few or no code changes to callers. What makes you so confident?
</p>
<p>4. If <span style="color:#2e74b5;">widget</span> is not a polymorphic type, what is the recommended return type? Explain.
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>1. What&#8217;s wrong with this return type?<br />
</h2>
<p>First, what can we know or reasonably expect from the two-line problem description?
</p>
<p>We&#8217;re told <span style="color:#2e74b5;">load_widget</span> is a factory function. It produces an object by &#8220;loading&#8221; it in some way and then returning it to the caller. Since the return type is a pointer, the result might be null.
</p>
<p>The caller will reasonably expect to use the object, whether by calling member functions on it or passing it to other functions or in some other way. That isn&#8217;t safe unless the caller owns the object to ensure it is alive—either the caller gets exclusive ownership, or it gets shared ownership if the factory also maintains an internal strong or weak reference.
</p>
<p>Because the caller has or shares ownership, he has to do something when the object is no longer needed. If the ownership is exclusive, he should destroy the object somehow. Otherwise, if the ownership is shared, he should decrement some shared reference count.
</p>
<p>Unfortunately, returning a <span style="color:#2e74b5;">widget*</span> has two major problems. First, it&#8217;s unsafe by default, because the default mode of operation (i.e., when the caller writes whitespace) is to leak a <span style="color:#2e74b5;">widget</span>:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 1: Leak by default. Really, this is just so 20th-century...<br />// <br />widget* load_widget( widget::id desired );<br /><br />:::<br /><br />load_widget( some_id ); // oops
</code></pre>
</p>
<p>The Example 1 code compiles cleanly, runs, and (un)happily leaks the <span style="color:#2e74b5;">widget</span>.
</p>
<blockquote>
<p><strong>Guideline:</strong> Don&#8217;t use explicit <strong>new</strong>, <strong>delete</strong>, and owning <strong>*</strong> pointers, except in rare cases encapsulated inside the implementation of a low-level data structure.
</p>
</blockquote>
<p>Second, the signature conveys absolutely no information other than &#8220;a <span style="color:#2e74b5;">widget</span>? sure, here you go! enjoy.&#8221; The documentation may state that (and how) the caller is to own the object, but the function declaration doesn&#8217;t—it&#8217;s either exclusive ownership or shared ownership, but which? Read and remember the function&#8217;s documentation, because the function declaration isn&#8217;t telling. The signature alone doesn&#8217;t even say whether the caller shares in ownership at all.
</p>
<h2>2. Assuming that widget is a polymorphic type, what is the recommended return type? Explain your answer, including any tradeoffs.<br />
</h2>
<p>If <span style="color:#2e74b5;">widget</span> is a type that&#8217;s intended to be used polymorphically and held by pointer or reference, the factory should normally return a <span style="color:#2e74b5;">unique_ptr</span> to transfer ownership to the caller, or a <span style="color:#2e74b5;">shared_ptr</span> if the factory shares ownership by retaining a strong reference inside its internal data structures.
</p>
<blockquote>
<p><strong>Guideline:</strong> A factory that produces a reference type should return a <strong>unique_ptr</strong> by default, or a <strong>shared_ptr</strong> if ownership is to be shared with the factory.
</p>
</blockquote>
<p>This solves both problems: safety, and self-documentation.
</p>
<p>First, consider how this immediately solves the safety problem in Example 1:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 2: Clean up by default. Much better...<br />// <br />unique_ptr&lt;widget&gt; load_widget( widget::id desired );<br /><br />:::<br /><br />load_widget( some_id ); // cleans up
</code></pre>
</p>
<p>The Example 2 code compiles cleanly, runs, and happily cleans up the <span style="color:#2e74b5;">widget</span>. But it&#8217;s not just correct by default—it&#8217;s correct by construction, because there&#8217;s no way to make a mistake that results in a leak.
</p>
<p>Aside: Someone might say, &#8220;but can&#8217;t someone still write <span style="color:#2e74b5;">load_widget(some_id).release()</span>?&#8221; Of course they can, if they&#8217;re pathological; the correct answer is, &#8220;don&#8217;t do that.&#8221; Remember, our concern is to protect against Murphy, not Machiavelli—against bugs and mistakes, not deliberate crimes—and such pathological abuses fall into the latter category. That&#8217;s no different from, and doesn&#8217;t violate type safety any more than, explicitly calling <span style="color:#2e74b5;">Dispose</span> early in a C# <span style="color:#2e74b5;">using</span> block or explicitly calling <span style="color:#2e74b5;">close</span> early in a Java <span style="color:#2e74b5;">try</span>-with-resources block.
</p>
<p>What if the cleanup should be done by something other than a plain <span style="color:#2e74b5;">delete</span> call? Easy: Just use a custom deleter. The icing on the cake is that the factory itself knows which deleter is appropriate and can state it at the time it constructs the return value; the caller doesn&#8217;t need to worry about it, especially if he takes the result using an <span style="color:#2e74b5;">auto</span> variable.
</p>
<p>Second, this is self-documenting: A function that returns a <span style="color:#2e74b5;">unique_ptr</span> or a value clearly documents that it&#8217;s a pure &#8220;source&#8221; function, and one that returns a <span style="color:#2e74b5;">shared_ptr</span> clearly documents that it&#8217;s returning shared ownership and/or observation.
</p>
<p>Finally, why prefer <span style="color:#2e74b5;">unique_ptr</span> by default, if you don&#8217;t need to express shared ownership? Because it&#8217;s the Right Thing To Do for both performance and correctness, as noted in GotW #89, and leaves all options open to the caller:
</p>
<ul>
<li>Returning <span style="color:#2e74b5;">unique_ptr</span> expresses returning unique ownership, which is the norm for a pure &#8220;source&#8221; factory function.
</li>
<li><span style="color:#2e74b5;">unique_ptr</span> can&#8217;t be beat in efficiency—moving one is about as cheap as moving/copying a raw pointer.
</li>
<li>If the caller wants to manage the produced object&#8217;s lifetime via <span style="color:#2e74b5;">shared_ptr</span>, they can easily convert to <span style="color:#2e74b5;">shared_ptr</span> via an implicit move operation—no need to say <span style="color:#2e74b5;">std::move</span> because the compiler already knows that the returned value is a temporary object.
</li>
<li>If the caller is using any other arbitrary method of maintaining the object&#8217;s lifetime, he can convert to a custom smart pointer or other lifetime management scheme simply by calling <span style="color:#2e74b5;">.release()</span>. This can be useful, and isn&#8217;t  possible with <span style="color:#2e74b5;">shared_ptr</span>.
</li>
</ul>
<p>Here it is in action:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 2, continued<br />//<br /><br />// Accept as a unique_ptr (by default)<br />auto up = load_widget(1);<br /><br />// Accept as a shared_ptr (if desired)<br />auto sp = shared_ptr&lt;widget&gt;{ load_widget(2) };<br /><br />// Accept as your own smart pointer (if desired)<br />auto msp = my::smart_ptr&lt;widget&gt;{ load_widget(3).release() };
</code></pre>
</p>
<p>Of course, if the factory retains some shared ownership or observation, whether via an internal <span style="color:#2e74b5;">shared_ptr</span> or <span style="color:#2e74b5;">weak_ptr</span>, return <span style="color:#2e74b5;">shared_ptr</span>. The caller will be forced to continue using it as a <span style="color:#2e74b5;">shared_ptr</span>, but in that case that&#8217;s appropriate.
</p>
<h2>3. […] you go ahead and change the return type without fear, knowing it will require few or no code changes to callers. What makes you so confident?<br />
</h2>
<p>Modern portable C++ code uses <span style="color:#2e74b5;">unique_ptr</span>, <span style="color:#2e74b5;">shared_ptr</span>, and <span style="color:#2e74b5;">auto</span>. Returning <span style="color:#2e74b5;">unique_ptr</span> works with all three; returning <span style="color:#2e74b5;">shared_ptr</span> works with the last two.
</p>
<p>If the caller accepts the return value in an <span style="color:#2e74b5;">auto</span> variables, such as <span style="color:#2e74b5;">auto w = load_widget(whatever);</span>, then the type will just naturally be correct, normal dereferencing will just work, and the only source ripple will be if the caller tries to explicitly <span style="color:#2e74b5;">delete</span> (if so, the <span style="color:#2e74b5;">delete</span> line can rather appropriately be deleted) or tries to store into a non-local object of a different type.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer declaring variables using <strong>auto</strong>. It&#8217;s shorter, and helps to insulate your code from needless source ripples due to minor type changes.
</p>
</blockquote>
<p>Otherwise, if the caller isn&#8217;t using <span style="color:#2e74b5;">auto</span>, then it&#8217;s likely already using the result to initialize a <span style="color:#2e74b5;">unique_ptr</span> or <span style="color:#2e74b5;">shared_ptr</span> because modern C++ calling code does not traffick in raw pointers for non-parameter variables (more on this next time). In either case, returning a <span style="color:#2e74b5;">unique_ptr</span> just works: A <span style="color:#2e74b5;">unique_ptr</span> can be seamlessly moved into either of those types, and if the semantics are to return shared ownership and then the caller should already be using a <span style="color:#2e74b5;">shared_ptr</span> and things will again work just fine (only probably better than before, because for the original return by raw pointer to work correctly the return type was probably forced to jump through the <span style="color:#2e74b5;">enable_shared_from_this</span> hoop, which isn&#8217;t needed if we just return a <span style="color:#2e74b5;">shared_ptr</span> explicitly).
</p>
<h2>4. If widget is not a polymorphic type, what is the recommended return type? Explain.<br />
</h2>
<p>If <span style="color:#2e74b5;">widget</span> is not a polymorphic type, which typically means it&#8217;s a copyable value type or a move-only type, the factory should return a <span style="color:#2e74b5;">widget</span> by value. But what kind of value?
</p>
<p>In C++98, programmers would often resort to returning a large object by pointer just to avoid the penalty of copying its state:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 4(a): Obsolete convention: return a * just to avoid a copy <br />//<br />/*BAD*/ vector&lt;gadget&gt;* load_gadgets() {<br />    vector&lt;gadget&gt;* ret = new vector&lt;gadget&gt;();<br />    // ... populate *ret ...<br />    return ret;<br />}<br /><br />// Obsolete calling code (note: NOT exception-safe) <br />vector&lt;gadget&gt;* p = load_gadgets();<br />if(p) use(*p);<br />delete p;
</code></pre>
</p>
<p>This has all of the usability and fragility problems discussed in #1. Today, normally we should just return by value, because we will incur only a cheap move operation, not a deep copy, to hand the result to the caller:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 4(b): Default recommendation: return the value<br />//<br />vector&lt;gadget&gt; load_gadgets() {<br />    vector&lt;gadget&gt; ret;<br />    // ... populate ret ...<br />    return ret;<br />}<br /><br />// Calling code (exception-safe)<br />auto v = load_gadgets();<br />use(v);
</code></pre>
</p>
<p>Most of the time, return movable objects by value. That&#8217;s all there is to it, if the only reason for the pointer on the return type was to avoid the copy.
</p>
<p>There could be one additional reason the function might have returned a pointer, namely to return <span style="color:#2e74b5;">nullptr</span> to indicate failure to produce an object. Normally it&#8217;s better throw an exception to report an error if we fail to load the <span style="color:#2e74b5;">widget</span>. However, if not being able to load the <span style="color:#2e74b5;">widget</span> is normal operation and should not be considered an error, return an <span style="color:#2e74b5;">optional&lt;widget&gt;</span>, and probably make the factory <span style="color:#2e74b5;">noexcept</span> if no other kinds of errors need to be reported than are communicated well by returning an empty <span style="color:#2e74b5;">optional&lt;widget&gt;</span>.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 4(c): Alternative if not returning an object is normal<br />//<br />optional&lt;vector&lt;gadget&gt;&gt; load_gadgets() noexcept {<br />    vector&lt;gadget&gt; ret;<br />    // ... populate ret ...<br />    if( success )            // return vector (might be empty)<br />        return move(ret);    // note: move() here to avoid a silent copy<br />    else<br />        return {};           // not returning anything<br />}<br /><br />// Calling code (exception-safe)<br />auto v = load_gadgets();<br />if(v) use(*v);
</code></pre>
</p>
<blockquote>
<p><strong>Guideline:</strong> A factory that produces a non-reference type should return a value by default, and throw an exception if it fails to create the object. If not creating the object can be a normal result, return an <strong>optional&lt;&gt;</strong> value.
</p>
</blockquote>
<h2>Coda<br />
</h2>
<p>By the way, see that test for <span style="color:#2e74b5;">if(v)</span> in the last line of Example 4(c)? It calls a cool function of <span style="color:#2e74b5;">optional&lt;T&gt;</span>, namely <span style="color:#2e74b5;">operator bool</span>. What makes bool so cool? In part because of how many C++ features it exercises. Here is its declaration… just think of what this lets you safely do, including at compile time! Enjoy.
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>constexpr explicit optional&lt;T&gt;::operator bool() const noexcept;
</code></pre>
</p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: Johannes Schaub, Leo, Vincent Jacquet.</p>
					<p><a href="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/" rel="bookmark" title="Permanent Link to GotW #90 Solution:&nbsp;Factories">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2040 post type-post status-publish format-standard hentry category-gotw" id="post-2040">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/29/gotw-90-factories/" rel="bookmark">GotW #90: Factories</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-29|
													<a href="https://herbsutter.com/2013/05/29/gotw-90-factories/#comments">16 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #104.
</p>
</blockquote>
<p>
 </p>
<p><span style="color:#5a5a5a;"><em>What should factory functions return, and why?<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<p>While spelunking through the code of a new project you recently joined, you find the following factory function declaration:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>widget* load_widget( widget::id desired );
</code></pre>
</p>
<h2>JG Question<br />
</h2>
<p>1. What&#8217;s wrong with this return type?
</p>
<h2>Guru Questions<br />
</h2>
<p>2. Assuming that <span style="color:#2e74b5;">widget</span> is a polymorphic type, what is the recommended return type? Explain your answer, including any tradeoffs.
</p>
<p>3. You&#8217;d like to actually change the return type to match the recommendation in #2, but at first you worry about breaking source compatibility with existing calling code; recompiling existing callers is fine, but having to go change them all is not. Then you have an &#8220;aha!&#8221; moment, realizing that this is a fairly new project and all of your calling code is written using modern C++ idioms, and you go ahead and change the return type without fear, knowing it will require few or no code changes to callers. What makes you so confident?
</p>
<p>4. If <span style="color:#2e74b5;">widget</span> is not a polymorphic type, what is the recommended return type? Explain.</p>
					<p><a href="https://herbsutter.com/2013/05/29/gotw-90-factories/" rel="bookmark" title="Permanent Link to GotW #90: Factories">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2035 post type-post status-publish format-standard hentry category-gotw" id="post-2035">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/" rel="bookmark">GotW #89 Solution: Smart&nbsp;Pointers</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-29|
													<a href="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/#comments">53 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #103.
</p>
</blockquote>
<p>
 </p>
<p><span style="color:#5a5a5a;"><em>There&#8217;s a lot to love about standard smart pointers in general, and unique_ptr in particular.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. When should you use <span style="color:#2e74b5;">shared_ptr</span> vs. <span style="color:#2e74b5;">unique_ptr</span>? List as many considerations as you can.
</p>
<h2>Guru Question<br />
</h2>
<p>2. Why should you almost always use <span style="color:#2e74b5;">make_shared</span> to create an object to be owned by <span style="color:#2e74b5;">shared_ptr</span>s? Explain.
</p>
<p>3. Why should you almost always use <span style="color:#2e74b5;">make_unique</span> to create an object to be initially owned by a <span style="color:#2e74b5;">unique_ptr</span>? Explain.
</p>
<p>4. What&#8217;s the deal with <span style="color:#2e74b5;">auto_ptr</span>?
</p>
<p>
 </p>
<h1>Solution<br />
</h1>
<h2>1. When should you use shared_ptr vs. unique_ptr?<br />
</h2>
<p>When in doubt, prefer <span style="color:#2e74b5;">unique_ptr</span> by default, and you can always later move-convert to <span style="color:#2e74b5;">shared_ptr</span> if you need it. If you do know from the start you need shared ownership, however, go directly to <span style="color:#2e74b5;">shared_ptr</span> via <span style="color:#2e74b5;">make_shared</span> (see #2 below).
</p>
<p>There are three major reasons to say &#8220;when in doubt, prefer <span style="color:#2e74b5;">unique_ptr</span>.&#8221;
</p>
<p>First, use the simplest semantics that are sufficient<em>:</em> Choose the right smart pointer to most directly express your intent, and what you need (now). If you are creating a new object and don&#8217;t know that you&#8217;ll eventually need shared ownership, use <span style="color:#2e74b5;">unique_ptr</span> which expresses unique ownership. You can still put it in a container (e.g., <span style="color:#2e74b5;">vector&lt;unique_ptr&lt;widget&gt;&gt;</span>) and do most other things you want to do with a raw pointer, only safely. If you later need shared ownership, you can always move-convert the <span style="color:#2e74b5;">unique_ptr</span> to a <span style="color:#2e74b5;">shared_ptr</span>.
</p>
<p>Second, a  <span style="color:#2e74b5;">unique_ptr</span> is more efficient than a <span style="color:#2e74b5;">shared_ptr</span>. A <span style="color:#2e74b5;">unique_ptr</span> doesn&#8217;t need to maintain reference count information and a control block under the covers, and is designed to be just about as cheap to move and use as a raw pointer. When you don&#8217;t ask for more than you need, you don&#8217;t incur overheads you won&#8217;t use.
</p>
<p>Third, starting with <span style="color:#2e74b5;">unique_ptr</span> is more flexible and keeps your options open. If you start with a <span style="color:#2e74b5;">unique_ptr</span>, you can always later convert to a <span style="color:#2e74b5;">shared_ptr</span> via move, or to another custom smart pointer (or even to a raw pointer) via <span style="color:#2e74b5;">.get()</span> or <span style="color:#2e74b5;">.release()</span>.
</p>
<blockquote>
<p><strong>Guideline:</strong> Prefer to use the standard smart pointers, <strong>unique_ptr</strong> by default and <strong>shared_ptr</strong> if sharing is needed. They are the common types that all C++ libraries can understand. Use other smart pointer types only if necessary for interoperability with other libraries, or when necessary for custom behavior you can&#8217;t achieve with deleters and allocators on the standard pointers.
</p>
</blockquote>
<h2>2. Why should you almost always use make_shared to create an object to be owned by shared_ptrs? Explain.<br />
</h2>
<p>Note: If you need to create an object using a custom allocator, which is rare, you can use <span style="color:#2e74b5;">allocate_shared</span>. Note that even though its name is slightly different, <span style="color:#2e74b5;">allocate_shared</span> should be viewed as &#8220;just the flavor of <span style="color:#2e74b5;">make_shared</span> that lets you specify an allocator,&#8221; so I&#8217;m mainly going to talk about them both as <span style="color:#2e74b5;">make_shared</span> here and not distinguish much between them.
</p>
<p>There are two main cases where you can&#8217;t use <span style="color:#2e74b5;">make_shared</span> (or <span style="color:#2e74b5;">allocate_shared</span>) to create an object that you know will be owned by <span style="color:#2e74b5;">shared_ptr</span>s: (a) if you need a custom deleter, such as because of using <span style="color:#2e74b5;">shared_ptr</span>s to manage a non-memory resource or an object allocated in a nonstandard memory area, you can&#8217;t use <span style="color:#2e74b5;">make_shared</span> because it doesn&#8217;t support specifying a deleter; and (b) if you are adopting a raw pointer to an object being handed to you from other (usually legacy) code, you would construct a <span style="color:#2e74b5;">shared_ptr</span> from that raw pointer directly.
</p>
<blockquote>
<p><strong>Guideline:</strong> Use <strong>make_shared</strong> (or, if you need a custom allocator, <strong>allocate_shared</strong>) to create an object you know will be owned by <strong>shared_ptr</strong>s, unless you need a custom deleter or are adopting a raw pointer from elsewhere.
</p>
</blockquote>
<p>So, why use <span style="color:#2e74b5;">make_shared</span> (or, if you need a custom allocator, <span style="color:#2e74b5;">allocate_shared</span>) whenever you can, which is nearly always? There are two main reasons: simplicity, and efficiency.
</p>
<p>First, with <span style="color:#2e74b5;">make_shared</span> the code is simpler. Write for clarity and correctness first.
</p>
<p>Second, using <span style="color:#2e74b5;">make_shared</span> is more efficient. The <span style="color:#2e74b5;">shared_ptr</span> implementation has to maintain housekeeping information in a control block shared by all <span style="color:#2e74b5;">shared_ptr</span>s and <span style="color:#2e74b5;">weak_ptr</span>s referring to a given object. In particular, that housekeeping information has to include not just one but two reference counts:
</p>
<ul>
<li>A &#8220;strong reference&#8221; count to track the number of <span style="color:#2e74b5;">shared_ptr</span>s currently keeping the object alive. The shared object is destroyed (and possibly deallocated) when the last strong reference goes away.
</li>
<li>A &#8220;weak reference&#8221; count to track the number of <span style="color:#2e74b5;">weak_ptr</span>s currently observing the object. The shared housekeeping control block is destroyed and deallocated (and the shared object is deallocated if it was not already) when the last weak reference goes away.
</li>
</ul>
<p>If you allocate the object separately via a raw <span style="color:#2e74b5;">new</span> expression, then pass it to <span style="color:#2e74b5;">a shared_ptr</span>, the <span style="color:#2e74b5;">shared_ptr</span> implementation has no alternative but to allocate the control block separately, as shown in Example 2(a) and Figure 2(a).
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 2(a): Separate allocation<br />auto sp1 = shared_ptr&lt;widget&gt;{ new widget{} };<br />auto sp2 = sp1;
</code></pre>
</p>
<p style="text-align:center;"><img src="https://herbsutter.files.wordpress.com/2013/05/053013_2139_gotw89solut1.png?w=500" alt="" />
	</p>
<p style="text-align:center;">Figure 2(a): Approximate memory layout for Example 2(a).
</p>
<p>We&#8217;d like to avoid doing two separate allocations here. If you use <span style="color:#2e74b5;">make_shared</span> to allocate the object and the <span style="color:#2e74b5;">shared_ptr</span> all in one go, then the implementation can fold them together in a single allocation, as shown in Example 2(b) and Figure 2(b).
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>// Example 2(b): Single allocation<br />auto sp1 = make_shared&lt;widget&gt;();<br />auto sp2 = sp1;
</code></pre>
</p>
<p style="text-align:center;"><img src="https://herbsutter.files.wordpress.com/2013/05/053013_2139_gotw89solut2.png?w=500" alt="" />
	</p>
<p style="text-align:center;">Figure 2(b): Approximate memory layout for Example 2(b).
</p>
<p>Note that combining the allocations has two major advantages:
</p>
<ul>
<li>It reduces allocation overhead, including memory fragmentation. First, the most obvious way it does this is by reducing the number of allocation requests, which are typically more expensive operations. This also helps reduce contention on allocators (some allocators don&#8217;t scale well). Second, using only one chunk of memory instead of two reduces the per-allocation overhead. Whenever you ask for a chunk of memory, the system must give you at least that many bytes, and often gives you a few more because of using fixed-size pools or tacking on housekeeping information per allocation. So by using a single chunk of memory, we tend to reduce the total extra overhead. Finally, we also naturally reduce the number of &#8220;dead&#8221; extra in-between gaps that cause fragmentation.
</li>
<li>It improves locality. The reference counts are frequently used with the object, and for small objects are likely to be on the same cache line, which improves cache performance (as long as there isn&#8217;t some thread copying the smart pointer in a tight loop; don&#8217;t do that).
</li>
</ul>
<p>As always, when you can express more of what you&#8217;re trying to achieve as a single function call, you&#8217;re giving the system a better chance to figure out a way to do the job more efficiently. This is just as true when inserting 100 elements into a <span style="color:#2e74b5;">vector</span> using a single range-insert call to <span style="color:#2e74b5;">v.insert( first, last )</span> instead of 100 calls to <span style="color:#2e74b5;">v.insert( value )</span> as it is when using a single call to <span style="color:#2e74b5;">make_shared</span> instead of separate calls to <span style="color:#2e74b5;">new widget()</span> and <span style="color:#2e74b5;">shared_ptr( widget* )</span>.
</p>
<p>There are two more advantages: Using <span style="color:#2e74b5;">make_shared</span> avoids explicit <span style="color:#2e74b5;">new</span> and avoids an exception safety issue. Both of these also apply to <span style="color:#2e74b5;">make_unique</span>, so we&#8217;ll cover them under #3.
</p>
<h2>3. Why should you almost always use make_unique to create an object to be initially owned by a unique_ptr? Explain.<br />
</h2>
<p>As with <span style="color:#2e74b5;">make_shared</span>, there are two main cases where you can&#8217;t use <span style="color:#2e74b5;">make_unique</span> to create an object that you know will be owned (at least initially) by a <span style="color:#2e74b5;">unique_ptr</span>: if you need a custom deleter, or if you are adopting a raw pointer.
</p>
<p>Otherwise, which is nearly always, prefer <span style="color:#2e74b5;">make_unique</span>.
</p>
<blockquote>
<p><strong>Guideline:</strong> Use <strong>make_unique</strong> to create an object that isn&#8217;t shared (at least not yet), unless you need a custom deleter or are adopting a raw pointer from elsewhere.
</p>
</blockquote>
<p>Besides symmetry with <span style="color:#2e74b5;">make_shared</span>, <span style="color:#2e74b5;">make_unique</span> offers at least two other advantages. First, you should prefer use <span style="color:#2e74b5;">make_unique&lt;T&gt;()</span>  instead of the more-verbose <span style="color:#2e74b5;">unique_ptr&lt;T&gt;{ new T{} }</span> because you should avoid explicit <span style="color:#2e74b5;">new</span> in general:
</p>
<blockquote>
<p><strong>Guideline:</strong> Don&#8217;t use explicit <strong>new</strong>, <strong>delete</strong>, and owning <strong>*</strong> pointers, except in rare cases encapsulated inside the implementation of a low-level data structure.
</p>
</blockquote>
<p>Second, it avoids some known exception safety issues with naked <span style="color:#2e74b5;">new</span>. Here&#8217;s an example:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>void sink( unique_ptr&lt;widget&gt;, unique_ptr&lt;gadget&gt; );<br /><br />sink( unique_ptr&lt;widget&gt;{new widget{}},<br />      unique_ptr&lt;gadget&gt;{new gadget{}} ); // Q1: do you see the problem?
</code></pre>
</p>
<p>Briefly, if you allocate and construct the <span style="color:#2e74b5;">new widget</span> first, then get an exception while allocating or constructing the <span style="color:#2e74b5;">new gadget</span>, the <span style="color:#2e74b5;">widget</span> is leaked. You might think: &#8220;Well, I could just change <span style="color:#2e74b5;">new widget{}</span> to <span style="color:#2e74b5;">make_unique&lt;widget&gt;()</span> and this problem would go away, right?&#8221; To wit:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>sink( make_unique&lt;widget&gt;(),<br />      unique_ptr&lt;gadget&gt;{new gadget{}} );         // Q2: is this better?
</code></pre>
</p>
<p>The answer is no, because C++ leaves the order of evaluation of function arguments unspecified and so either the <span style="color:#2e74b5;">new widget</span> or the <span style="color:#2e74b5;">new gadget</span> could be performed first. If the <span style="color:#2e74b5;">new gadget</span> is allocated and constructed first, then the <span style="color:#2e74b5;">make_unique&lt;widget&gt;</span> throws, we have the same problem.
</p>
<p>But while just changing one of the arguments to use <span style="color:#2e74b5;">make_unique</span> doesn&#8217;t close the hole, changing them both to <span style="color:#2e74b5;">make_unique</span> really does completely eliminate the problem:
</p>
<p style="background:#ffffcc;margin-left:14pt;">
<pre><code>sink( make_unique&lt;widget&gt;(), make_unique&lt;gadget&gt;() );  // exception-safe
</code></pre>
</p>
<p>This exception safety issue is covered in more detail in GotW #56.
</p>
<blockquote>
<p><strong>Guideline:</strong> To allocate an object, prefer to write <strong>make_unique</strong> by default, and write <strong>make_shared</strong> when you know the object&#8217;s lifetime is going to be managed by using <strong>shared_ptr</strong>s.
</p>
</blockquote>
<h2>4. What&#8217;s the deal with auto_ptr?<br />
</h2>
<p><span style="color:#2e74b5;">auto_ptr</span> is most charitably characterized as a valiant attempt to create a <span style="color:#2e74b5;">unique_ptr</span> before C++ had move semantics. <span style="color:#2e74b5;">auto_ptr</span> is now deprecated, and should not be used in new code.
</p>
<p>If you have <span style="color:#2e74b5;">auto_ptr</span> in an existing code base, when you get a chance try doing a global search-and-replace of <span style="color:#2e74b5;">auto_ptr</span> to <span style="color:#2e74b5;">unique_ptr</span>; the vast majority of uses will work the same, and it might expose (as a compile-time error) or fix (silently) a bug or two you didn&#8217;t know you had.
</p>
<h2>Acknowledgments<br />
</h2>
<p>Thanks in particular to the following for their feedback to improve this article: celeborn2bealive, Andy Prowl, Chris Vine, Marek.</p>
					<p><a href="https://herbsutter.com/2013/05/29/gotw-89-solution-smart-pointers/" rel="bookmark" title="Permanent Link to GotW #89 Solution: Smart&nbsp;Pointers">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
			<div class="post-2025 post type-post status-publish format-standard hentry category-gotw" id="post-2025">
				<div class="posttitle">
					<h2><a href="https://herbsutter.com/2013/05/28/gotw-89-smart-pointers/" rel="bookmark">GotW #89: Smart&nbsp;Pointers</a></h2>
					<p class="post-info">
					Posted in <a href="https://herbsutter.com/category/c/gotw/" rel="category tag">GotW</a> on 2013-05-28|
													<a href="https://herbsutter.com/2013/05/28/gotw-89-smart-pointers/#comments">9 Comments &#187;</a>											</p>
				</div>

				<div class="entry">
					<blockquote>
<p><strong>NOTE:</strong> Last year, I posted three new GotWs numbered #103-105. I decided leaving a gap in the numbers wasn&#8217;t best after all, so I am renumbering them to #89-91 to continue the sequence. Here is the updated version of what was GotW #103.
</p>
</blockquote>
<p>
 </p>
<p><span style="color:#5a5a5a;"><em>There&#8217;s a lot to love about standard smart pointers in general, and unique_ptr in particular.<br />
</em></span></p>
<p>
 </p>
<h1>Problem<br />
</h1>
<h2>JG Question<br />
</h2>
<p>1. When should you use <span style="color:#2e74b5;">shared_ptr</span> vs. <span style="color:#2e74b5;">unique_ptr</span>? List as many considerations as you can.
</p>
<h2>Guru Question<br />
</h2>
<p>2. Why should you almost always use <span style="color:#2e74b5;">make_shared</span> to create an object to be owned by <span style="color:#2e74b5;">shared_ptr</span>s? Explain.
</p>
<p>3. Why should you almost always use <span style="color:#2e74b5;">make_unique</span> to create an object to be initially owned by a <span style="color:#2e74b5;">unique_ptr</span>? Explain.
</p>
<p>4. What&#8217;s the deal with <span style="color:#2e74b5;">auto_ptr</span>?</p>
					<p><a href="https://herbsutter.com/2013/05/28/gotw-89-smart-pointers/" rel="bookmark" title="Permanent Link to GotW #89: Smart&nbsp;Pointers">Read Full Post &raquo;</a></p>
				</div>
							</div>

		
		<p align="center"><a href="https://herbsutter.com/category/c/gotw/page/2/" >&laquo; Newer Posts</a> - <a href="https://herbsutter.com/category/c/gotw/page/4/" >Older Posts &raquo;</a></p>

	</div><!-- end id:content-main -->
<div id="sidebar">
<ul>
<li class="sidebox"><h2><label for="subscribe-field">Follow by email</label></h2>
				<form action="https://subscribe.wordpress.com" method="post" accept-charset="utf-8" id="subscribe-blog">
																	<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" placeholder="Enter your email address" value="" id="subscribe-field"/></p>
					
					<p>
						<input type="hidden" name="action" value="subscribe"/>
						<input type="hidden" name="blog_id" value="3379246"/>
						<input type="hidden" name="source" value="https://herbsutter.com/category/c/gotw/page/3/"/>
						<input type="hidden" name="sub-type" value="widget"/>
						<input type="hidden" name="redirect_fragment" value="blog_subscription-3" />
						<input type="hidden" id="_wpnonce" name="_wpnonce" value="4590924cc6" />						<input type="submit" value="Subscribe" />
					</p>
				</form>
			
</li><li class="sidebox"><h2><a href='http://twitter.com/herbsutter'>Tweets</a></h2><ul class='tweets'></ul><a href="http://twitter.com/herbsutter"  class='twitter-follow-button' data-show-count='false' data-link-color='#265e15' data-text-color='#333333'>Follow @herbsutter</a></li><li class="sidebox"><h2>Popular</h2><ul>				<li>
										<a href="https://herbsutter.com/2018/11/13/trip-report-fall-iso-c-standards-meeting-san-diego/" class="bump-view" data-bump-view="tp">
						Trip report: Fall ISO C++ standards meeting (San Diego)					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/gotw/" class="bump-view" data-bump-view="tp">
						GotW					</a>
										</li>
								<li>
										<a href="https://herbsutter.com/2018/09/20/lifetime-profile-v1-0-posted/" class="bump-view" data-bump-view="tp">
						Lifetime profile v1.0 posted					</a>
										</li>
				</ul></li><li class="sidebox"><h2>Categories</h2>		<ul>
				<li class="cat-item cat-item-291"><a href="https://herbsutter.com/category/apple/" >Apple</a>
</li>
	<li class="cat-item cat-item-49277"><a href="https://herbsutter.com/category/c-net/" >C# / .NET</a>
</li>
	<li class="cat-item cat-item-2426 current-cat-parent current-cat-ancestor"><a href="https://herbsutter.com/category/c/" >C++</a>
</li>
	<li class="cat-item cat-item-69816"><a href="https://herbsutter.com/category/cloud/" >Cloud</a>
</li>
	<li class="cat-item cat-item-214618"><a href="https://herbsutter.com/category/concurrency/" >Concurrency</a>
</li>
	<li class="cat-item cat-item-8259773"><a href="https://herbsutter.com/category/effective-concurrency/" >Effective Concurrency</a>
</li>
	<li class="cat-item cat-item-3696745"><a href="https://herbsutter.com/category/friday-thoughts/" >Friday Thoughts</a>
</li>
	<li class="cat-item cat-item-3867746 current-cat"><a href="https://herbsutter.com/category/c/gotw/" >GotW</a>
</li>
	<li class="cat-item cat-item-79"><a href="https://herbsutter.com/category/hardware/" >Hardware</a>
</li>
	<li class="cat-item cat-item-1017"><a href="https://herbsutter.com/category/java/" >Java</a>
</li>
	<li class="cat-item cat-item-637"><a href="https://herbsutter.com/category/microsoft/" >Microsoft</a>
</li>
	<li class="cat-item cat-item-420845"><a href="https://herbsutter.com/category/opinion-editorial/" >Opinion &amp; Editorial</a>
</li>
	<li class="cat-item cat-item-1633077"><a href="https://herbsutter.com/category/reader-qa/" >Reader Q&amp;A</a>
</li>
	<li class="cat-item cat-item-2301"><a href="https://herbsutter.com/category/software-development/" >Software Development</a>
</li>
	<li class="cat-item cat-item-393523"><a href="https://herbsutter.com/category/talks-events/" >Talks &amp; Events</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://herbsutter.com/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-151"><a href="https://herbsutter.com/category/web/" >Web</a>
</li>
		</ul>
			</li></ul>
</div><!-- end id:sidebar -->
</div><!-- end id:content -->
</div><!-- end id:container -->
<div id="footer">
	<div id="colophon">
		<p><a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></p>
		<p>WPThemes.</p>
		<br class="clear" />
	</div><!-- end #colophon-->
</div><!-- end #footer-->
		<script type="text/javascript">
		//<![CDATA[
		var infiniteScroll = {"settings":{"id":"content-main","ajaxurl":"https:\/\/herbsutter.com\/?infinity=scrolling","type":"scroll","wrapper":true,"wrapper_class":"infinite-wrap","footer":true,"click_handle":"1","text":"Older posts","totop":"Scroll back to top","currentday":"28.05.13","order":"DESC","scripts":[],"styles":[],"google_analytics":false,"offset":3,"history":{"host":"herbsutter.com","path":"\/category\/c\/gotw\/page\/%d\/","use_trailing_slashes":true,"parameters":""},"query_args":{"paged":3,"category_name":"gotw","error":"","m":"","p":0,"post_parent":"","subpost":"","subpost_id":"","attachment":"","attachment_id":0,"name":"","pagename":"","page_id":0,"second":"","minute":"","hour":"","day":0,"monthnum":0,"year":0,"w":0,"tag":"","cat":3867746,"tag_id":"","author":"","author_name":"","feed":"","tb":"","meta_key":"","meta_value":"","preview":"","s":"","sentence":"","title":"","fields":"","menu_order":"","embed":"","category__in":[],"category__not_in":[],"category__and":[],"post__in":[],"post__not_in":[],"post_name__in":[],"tag__in":[],"tag__not_in":[],"tag__and":[],"tag_slug__in":[],"tag_slug__and":[],"post_parent__in":[],"post_parent__not_in":[],"author__in":[],"author__not_in":[],"posts_per_page":7,"ignore_sticky_posts":false,"suppress_filters":false,"cache_results":false,"update_post_term_cache":true,"lazy_load_term_meta":true,"update_post_meta_cache":true,"post_type":"","nopaging":false,"comments_per_page":"50","no_found_rows":false,"order":"DESC"},"last_post_date":"2013-05-28 16:08:38","stats":"blog=3379246&v=wpcom&tz=-8&user_id=0&subd=herbsutter&x_pagetype=infinite"}};
		//]]>
		</script>
		<!--  -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201847y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	</div>
		<div id="infinite-footer">
			<div class="container">
				<div class="blog-info">
					<a id="infinity-blog-title" href="https://herbsutter.com/" rel="home">
						Sutter’s Mill					</a>
				</div>
				<div class="blog-credits">
					<a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a> 				</div>
			</div>
		</div><!-- #infinite-footer -->
		
	<div id="carousel-reblog-box">
		<form action="#" name="carousel-reblog">
			<textarea id="carousel-reblog-content" name="carousel-reblog-content" placeholder="Add your thoughts here... (optional)"></textarea>
			<label for="carousel-reblog-to-blog-id" id="carousel-reblog-lblogid">Post to</label>
			<select name="carousel-reblog-to-blog-id" id="carousel-reblog-to-blog-id">
						</select>

			<div class="submit">
				<span class="canceltext"><a href="#" class="cancel">Cancel</a></span>
				<input type="submit" name="carousel-reblog-submit" class="button" id="carousel-reblog-submit" value="Reblog Post" />
				<input type="hidden" id="carousel-reblog-blog-id" value="3379246" />
				<input type="hidden" id="carousel-reblog-blog-url" value="https://herbsutter.com" />
				<input type="hidden" id="carousel-reblog-blog-title" value="Sutter’s Mill" />
				<input type="hidden" id="carousel-reblog-post-url" value="" />
				<input type="hidden" id="carousel-reblog-post-title" value="" />
			</div>

			<input type="hidden" id="_wpnonce" name="_wpnonce" value="c0f0a72e87" /><input type="hidden" name="_wp_http_referer" value="/category/c/gotw/page/3/" />		</form>

		<div class="arrow"></div>
	</div>
<link rel='stylesheet' id='all-css-0-2' href='https://s0.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel.css?m=1524699534h&cssminify=yes' type='text/css' media='all' />
<!--[if lte IE 8]>
<link rel='stylesheet' id='jetpack-carousel-ie8fix-css'  href='https://s1.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel-ie8fix.css?m=1412618825h&#038;ver=20121024' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='all-css-2-2' href='https://s2.wp.com/wp-content/mu-plugins/tiled-gallery/tiled-gallery.css?m=1443731146h&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"3379246","siteName":"Sutter\u2019s Mill","siteURL":"https:\/\/herbsutter.com","icon":"<img alt='' src='https:\/\/secure.gravatar.com\/blavatar\/4554b8d24c7f200dc5e2e1b18db1893f?s=50&d=https%3A%2F%2Fs2.wp.com%2Fi%2Flogo%2Fwpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/mistylook","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F06%2F05%2Fgotw-92-auto-variables-part-1%2F","themeURL":"","xhrURL":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"8fb9818ae2","isSingular":"","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"4590924cc6\" \/>","referer":"https:\/\/herbsutter.com\/category\/c\/gotw\/page\/3\/","canFollow":"1","feedID":"171936","statusMessage":"","customizeLink":"https:\/\/herbsutter.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fherbsutter.wordpress.com%2Fcategory%2Fc%2Fgotw%2Fpage%2F3%2F","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: MistyLook","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 19,532 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F06%2F05%2Fgotw-92-auto-variables-part-1%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/herbsutter.com\/wp-admin\/admin-ajax.php","nonce":"665015e67f","display_exif":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/herbsutter.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fherbsutter.com%2F2013%2F05%2F28%2Fgotw-89-smart-pointers%2F","blog_id":"3379246","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>","reblog":"Reblog","reblogged":"Reblogged","reblog_add_thoughts":"Add your thoughts here... (optional)","reblogging":"Reblogging...","post_reblog":"Post Reblog","stats_query_args":"blog=3379246&v=wpcom&tz=-8&user_id=0&subd=herbsutter","is_public":"1","reblog_enabled":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVUNEOwiAM/CGxGqM+Gb8FWXVFVpCWqX8vmmwxGpf4QHJc77ijcE3GRVZkBS/QYE8O023uZQZvo66YFMqJWCDQGQUuBQu2lpuAeUJMfCQmvY/gUzsI5c5qby2d2lCPYv5mJmJs0xGbg83QWanSikzsMWdqateR+/MFzdadZcrklCI/TSMa1MQulGd4Xapcj/Hg0emvz/e1ZgQrgvoyvO4po0yFO5tjEQzgUVMtagaievbdbrlebZbb7WK98A97a7cy'></script>
<script type='text/javascript' src='https://platform.twitter.com/widgets.js?ver=20111117'></script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyVy0sOQEAMANALqcYvYSHOgmkmpWoyirg9WyuxfIuHZ4BxVSM1XHYIsnvWDe1kM4owSD/OA0cHgQmVDoqkjtWn05bgnxu+Hws58L0IxeutZ3VLm1V5WRVlU+fTDQ0qQ9Y='></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script type="text/javascript">
			jQuery.extend( infiniteScroll.settings.scripts, ["jquery-core","jquery-migrate","jquery","mobile-useragent-info","postmessage","jquery_inview","jetpack_resize","spin","jquery.spin","grofiles-cards","wpgroho","devicepx","jetpack_likes_queuehandler","the-neverending-homepage","syntaxhighlighter","wpcom-masterbar-js","wpcom-masterbar-tracks-js","wpcom-actionbar-bar","swfobject","videopress","jetpack-carousel","twitter-widgets","twitter-widgets-infinity","twitter-widgets-pending","tiled-gallery"] );
			jQuery.extend( infiniteScroll.settings.styles, ["jetpack_likes","the-neverending-homepage","infinity-mistylook","wpcom-core-compat-playlist-styles","mp6hacks","wpcom-bbpress2-staff-css","wp-block-library","mistylook","jetpack-top-posts-widget","jetpack-widget-social-icons-styles","noticons","geo-location-flair","reblogging","a8c-global-print","wpcom-actionbar-bar","h4-global","jetpack-carousel","tiled-gallery","jetpack-carousel-ie8fix"] );
		</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'3379246','blog_tz':'-8','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'3379246','v':'wpcom','tz':'-8','user_id':'0','subd':'herbsutter'}]);
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1TaVhzUzFMbjdWNHpwZGhTayxPSUFCMGNrd29+Smw0TDhnZmRTK0hlRi9QSGh6bi9GXVhBJWIlZlR5U1JMLU8/MkNtblkvY1d1TjBELytHc0k/MXdHUVQyK2IyUVA5SjU1bj9VX3ExLHYsREFpcnlfNHYtXV1HSUIsLkJrcnp0eS5sNmdYa3VnLX5PX2MrR3FkWHdMQj96Y0JwLWFITyxJN3F6a1FfQW1sMGFdLUUtQU50dVNRdm5lST9XZ2lXYVQyMGkzeFZKMldUdURXOS8yJjhsVnxvTkMsJlpCb2VOUGNiVltTemQ9JjRZdTVKXzFRQzhYRHNMc3xBNEVSdk1DRlZBXXFUYVlbMTNfWlRaJXlXfGYwQ1VzdXouTEFOSjBvZXB5Q35bcXB6OTFuZ2huW3FsL3M='}]);
_stq.push([ 'clickTrackerInit', '3379246', '0' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>